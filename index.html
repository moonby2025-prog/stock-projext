import React, { useState, useEffect, useRef } from 'react';

// --- ìƒìˆ˜ ë°ì´í„° ---
const DEFAULT_QUICK_LINKS = {
  "ğŸŒ… ì•„ì¹¨ í•„ìˆ˜ ì²´í¬ (Morning Routine)": [
    { name: "ë¯¸êµ­ ì‹œì¥ ì ê²€", url: "https://kr.investing.com/portfolio/?portfolioID=OT4%2BZDRrZTFjM2thYTthYg%3D%3D", icon: "fa-list-check", color: "bg-blue-100 text-blue-700" },
    { name: "Finviz (ë¯¸êµ­ ë§µ)", url: "https://finviz.com/map.ashx", icon: "fa-map", color: "bg-emerald-100 text-emerald-700" },
    { name: "í•„ë¼ë¸í”¼ì•„ ë°˜ë„ì²´", url: "https://kr.investing.com/indices/phlx-semiconductor", icon: "fa-microchip", color: "bg-teal-100 text-teal-700" },
    { name: "ê³µí¬ íƒìš• ì§€ìˆ˜ (CNN)", url: "https://edition.cnn.com/markets/fear-and-greed", icon: "fa-gauge-high", color: "bg-orange-100 text-orange-700" },
    { name: "í¬ë¦½í†  ì§€í‘œ (MVRV)", url: "https://www.bitcoinmagazinepro.com/charts/mvrv-zscore/", icon: "fa-chart-area", color: "bg-amber-100 text-amber-700" },
    { name: "SILVER (ì€)", url: "https://kr.investing.com/currencies/xag-usd", icon: "fa-coins", color: "bg-slate-100 text-slate-700" },
    { name: "ì€ì‹œì„¸(ìˆœìˆ˜í•œê¸ˆ)", url: "https://blog.naver.com/wolfkickbox", icon: "fa-blog", color: "bg-yellow-100 text-yellow-700" }
  ],
  "ğŸ’° ê³µëª¨ì£¼ & ì‹¤ì  (IPO & Earnings)": [
    { name: "38 ì»¤ë®¤ë‹ˆì¼€ì´ì…˜", url: "http://www.38.co.kr/html/fund/index.htm?gjbcd=1460", icon: "fa-building", color: "bg-purple-100 text-purple-700" },
    { name: "DART (ì „ìê³µì‹œ)", url: "https://dart.fss.or.kr/", icon: "fa-file-signature", color: "bg-yellow-100 text-yellow-700" },
    { name: "KRX ì •ë³´ì‹œìŠ¤í…œ", url: "http://data.krx.co.kr/", icon: "fa-database", color: "bg-slate-100 text-slate-700" },
    { name: "KIND (ê¸°ì—…ê³µì‹œ)", url: "https://kind.krx.co.kr/", icon: "fa-file-invoice", color: "bg-blue-50 text-blue-600" },
    { name: "Seibro (ì¦ê¶Œí¬í„¸)", url: "https://seibro.or.kr/", icon: "fa-server", color: "bg-indigo-50 text-indigo-600" },
    { name: "ì¢…ëª©ë³„ ì™¸êµ­ì¸ êµ­ì  ë¶„ë¥˜", url: "https://data.krx.co.kr/contents/MDC/HARD/hardController/MDCHARD053.cmd", icon: "fa-globe", color: "bg-cyan-50 text-cyan-700" }
  ],
  "ğŸ“ˆ êµ­ë‚´ ì‹œì¥ ì‹¬ì¸µ (Korea Market)": [
    { name: "ë„¤ì´ë²„ ê¸ˆìœµ", url: "https://finance.naver.com/", icon: "fa-n", color: "bg-green-50 text-green-600" },
    { name: "ë„¤ì´ë²„ ê¸ˆìœµ ë‰´ìŠ¤", url: "https://finance.naver.com/news/", icon: "fa-magnifying-glass", color: "bg-blue-100 text-blue-700" },
    { name: "ë§¤ì¼ê²½ì œ", url: "https://media.naver.com/press/009/newspaper", icon: "fa-newspaper", color: "bg-red-50 text-red-600" },
    { name: "í•œêµ­ê²½ì œ", url: "https://media.naver.com/press/015/newspaper", icon: "fa-newspaper", color: "bg-teal-50 text-teal-600" },
    { name: "ë²„í‹€ëŸ¬ (Butler)", url: "https://www.butler.works/ko/home", icon: "fa-chart-line", color: "bg-purple-50 text-purple-600" },
    { name: "í•œê²½ ì»¨ì„¼ì„œìŠ¤", url: "https://markets.hankyung.com/consensus", icon: "fa-book-open", color: "bg-red-50 text-red-600" },
    { name: "SMIC (ì„œìš¸ëŒ€)", url: "http://snusmic.com/research/", icon: "fa-graduation-cap", color: "bg-slate-200 text-slate-800" },
    { name: "FDAìŠ¹ì¸ ì‹¤ì‹œê°„ì˜ìƒ", url: "https://www.youtube.com/user/USFoodandDrugAdmin", icon: "fa-youtube", color: "bg-red-100 text-red-700" },
    { name: "ì£¼ì‹/ë¶€ë™ì‚° ëª¨ì•„ë´", url: "http://moabbs.com/blogs/lists", icon: "fa-layer-group", color: "bg-amber-50 text-amber-700" },
    { name: "ì „ìë„ì„œê´€/ì „ìì¡ì§€", url: "https://lib.ice.go.kr/elib/module/elib/moazine.do?menu_idx=37", icon: "fa-book-open", color: "bg-pink-100 text-pink-700" }
  ],
  "ğŸ¡ ì¼ìƒ & ë¶€ë™ì‚° (Daily Life)": [
    { name: "í˜¸ê°±ë…¸ë…¸", url: "https://hogangnono.com/", icon: "fa-map-pin", color: "bg-red-50 text-red-600" },
    { name: "ë„¤ì´ë²„ ë¶€ë™ì‚°", url: "https://land.naver.com/", icon: "fa-building", color: "bg-green-50 text-green-600" },
    { name: "ë„¤ì´ë²„ ì§€ë„", url: "https://map.naver.com/", icon: "fa-location-dot", color: "bg-blue-50 text-blue-600" },
    { name: "êµ¬ê¸€ ì§€ë„", url: "https://maps.google.com/", icon: "fa-location-dot", color: "bg-amber-50 text-amber-600" }
  ]
};

const DEFAULT_BLOG_MAP_DATA = {
  "ğŸ§¬ íë¦¬ì˜¥ìŠ¤ë°”ì´ì˜¤ì‹œìŠ¤í…œì¦ˆ": [
    {name: "í•œê³„ë¥¼ ê¹¨ëŠ” ì‚¬ëŒ", url: "https://blog.naver.com/unlimitedi"},
    {name: "ë‚˜ëŠ” ì „ì„¤ì´ë‹¤", url: "https://blog.naver.com/legendyu"},
    {name: "ì´ê³µê³„", url: "https://blog.naver.com/shyny38"},
    {name: "ê³µëŒ€ìƒ ì£¼ì ‘ë…¸íŠ¸", url: "https://blog.naver.com/b_g-duck"},
    {name: "ì—¬ë¦„", url: "https://blog.naver.com/parkcnt"},
    {name: "ëŒ•ì˜¤ì˜¤ì˜¤", url: "https://blog.naver.com/b_g-duck"},
    {name: "ìµœê³ í›ˆë‚¨", url: "https://blog.naver.com/apxk1000"},
    {name: "ì½”ì½”íŒœ", url: "https://blog.naver.com/cocopalm9419"},
    {name: "ìœ ì—”ìºìŠ¬", url: "https://blog.naver.com/uncastle0426"},
    {name: "ë¹µì‹", url: "https://blog.naver.com/bangsigi"},
    {name: "ëˆˆì¹˜íˆ¬ìì", url: "https://blog.naver.com/ncinvestor"},
    {name: "í˜ë¡œì•„ë¹ ", url: "https://blog.naver.com/perittopapa"}
  ],
  "ğŸ’Š ì—ìŠ¤í‹°íŒœ": [
    {name: "ì˜¤ì¬ë³µ", url: "https://blog.naver.com/hym090206"},
    {name: "ì™ ì§€ìƒì¾Œí•œì‚¬ëŒ", url: "https://blog.naver.com/aphorism86"},
    {name: "Chan", url: "https://blog.naver.com/chany2do"}
  ]
};

const DEFAULT_FAVORITE_SYMBOLS = [
  { code: "445680", name: "íë¦¬ì˜¥ìŠ¤ë°”ì´ì˜¤ì‹œìŠ¤í…œì¦ˆ" },
  { code: "237690", name: "ì—ìŠ¤í‹°íŒœ" },
  { code: "005930", name: "ì‚¼ì„±ì „ì" },
  { code: "005380", name: "í˜„ëŒ€ì°¨" },
  { code: "000810", name: "ì‚¼ì„±í™”ì¬" },
  { code: "001450", name: "í˜„ëŒ€í•´ìƒ" }
];

const EXCHANGE_RATES = {
  'USD': { krw: 1380, name: "ë¯¸êµ­ ë‹¬ëŸ¬" },
  'JPY': { krw: 8.90, name: "ì¼ë³¸ ì—”" },
  'CNY': { krw: 190, name: "ì¤‘êµ­ ìœ„ì•ˆ" },
  'EUR': { krw: 1480, name: "ìœ ë¡œ" },
  'VND': { krw: 0.054, name: "ë² íŠ¸ë‚¨ ë™" },
  'THB': { krw: 37.5, name: "íƒœêµ­ ë°”íŠ¸" },
  'PHP': { krw: 23.5, name: "í•„ë¦¬í•€ í˜ì†Œ" },
  'INR': { krw: 16.5, name: "ì¸ë„ ë£¨í”¼" },
  'ARS': { krw: 1.5, name: "ì•„ë¥´í—¨í‹°ë‚˜ í˜ì†Œ" }
};

const TAX_THRESHOLD = 20000000;

// --- ìœ í‹¸ë¦¬í‹°: ì•ˆì „í•œ LocalStorage ---
const storage = {
  get: (key) => {
    try {
      if (typeof window === 'undefined') return null;
      return localStorage.getItem(key);
    } catch (e) {
      console.warn('LocalStorage access denied:', e);
      return null;
    }
  },
  getJSON: (key) => {
    try {
      if (typeof window === 'undefined') return null;
      const item = localStorage.getItem(key);
      return item ? JSON.parse(item) : null;
    } catch (e) {
      console.warn('LocalStorage JSON parse error:', e);
      return null;
    }
  },
  set: (key, value) => {
    try {
      if (typeof window === 'undefined') return;
      localStorage.setItem(key, typeof value === 'string' ? value : JSON.stringify(value));
    } catch (e) {
      console.warn('LocalStorage write error:', e);
    }
  },
  remove: (key) => {
    try {
      if (typeof window === 'undefined') return;
      localStorage.removeItem(key);
    } catch (e) {
      console.warn('LocalStorage remove error:', e);
    }
  }
};

// --- íŠ¸ë ˆì´ë”©ë·° ìœ„ì ¯ ì»´í¬ë„ŒíŠ¸ (ê°•í™”ëœ ë°©ì–´ ì½”ë“œ) ---
const TradingViewTicker = React.memo(({ theme }) => {
  const containerRef = useRef(null);
  const scriptRef = useRef(null);
  
  useEffect(() => {
    const container = containerRef.current;
    if (!container) return;
    
    // ì´ˆê¸°í™”
    container.innerHTML = '';
    
    // ë¹„ë™ê¸° ì‹¤í–‰ìœ¼ë¡œ ë Œë”ë§ ì¶©ëŒ ë°©ì§€
    const timer = setTimeout(() => {
        if (!containerRef.current) return;

        try {
            const widgetContainer = document.createElement('div');
            widgetContainer.className = 'tradingview-widget-container__widget';
            container.appendChild(widgetContainer);

            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js';
            script.async = true;
            // ì—ëŸ¬ í•¸ë“¤ë§ ì¶”ê°€
            script.onerror = () => {
                if(containerRef.current) {
                    containerRef.current.innerHTML = '<div style="font-size:12px; color:#999; padding:10px;">ìœ„ì ¯ ë¡œë”© ì‹¤íŒ¨</div>';
                }
            };
            
            script.innerHTML = JSON.stringify({
                "symbols": [
                    { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500" },
                    { "proName": "NASDAQ:QQQ", "title": "ë‚˜ìŠ¤ë‹¥ QQQ" },
                    { "proName": "FX_IDC:USDKRW", "title": "ì›ë‹¬ëŸ¬ í™˜ìœ¨" },
                    { "proName": "BINANCE:BTCUSDT", "title": "ë¹„íŠ¸ì½”ì¸" },
                    { "proName": "CRYPTOCAP:BTC.D", "title": "ë¹„íŠ¸ì½”ì¸ ë„ë¯¸ë„ŒìŠ¤" },
                    { "proName": "OANDA:XAGUSD", "title": "ì€ í˜„ë¬¼" },
                    { "proName": "NASDAQ:IBB", "title": "ë°”ì´ì˜¤í… ETF" }
                ],
                "showSymbolLogo": true,
                "colorTheme": theme ? 'dark' : 'light',
                "isTransparent": true,
                "displayMode": "adaptive",
                "locale": "kr",
                "speed": "fast",
                "move_on_hover": false
            });
            
            container.appendChild(script);
            scriptRef.current = script;
        } catch (e) {
            console.error("Ticker Widget Error:", e);
        }
    }, 100);

    return () => {
        clearTimeout(timer);
        if (container) container.innerHTML = '';
    };
  }, [theme]);
  
  return <div className="tradingview-widget-container" ref={containerRef} />;
});

const TradingViewHeatmap = React.memo(({ theme, source }) => {
  const containerRef = useRef(null);
  const scriptRef = useRef(null);
  
  useEffect(() => {
    const container = containerRef.current;
    if (!container) return;
    
    // ì´ˆê¸°í™”
    container.innerHTML = '';
    
    // ë¹„ë™ê¸° ì‹¤í–‰ìœ¼ë¡œ ë Œë”ë§ ì¶©ëŒ ë°©ì§€
    const timer = setTimeout(() => {
        if (!containerRef.current) return;
        
        try {
            const widgetContainer = document.createElement('div');
            widgetContainer.className = 'tradingview-widget-container__widget';
            container.appendChild(widgetContainer);

            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-stock-heatmap.js';
            script.async = true;
            // ì—ëŸ¬ í•¸ë“¤ë§ ì¶”ê°€
            script.onerror = () => {
                if(containerRef.current) {
                    containerRef.current.innerHTML = '<div style="font-size:12px; color:#999; padding:20px; text-align:center;">íˆíŠ¸ë§µ ë¡œë”© ì‹¤íŒ¨</div>';
                }
            };

            script.innerHTML = JSON.stringify({
                "exchanges": [],
                "dataSource": "SPX500",
                "grouping": "sector",
                "blockSize": "market_cap_basic",
                "blockColor": "change",
                "locale": "kr",
                "symbolUrl": "",
                "colorTheme": theme ? 'dark' : 'light',
                "hasTopBar": false,
                "isTransparent": true,
                "width": "100%",
                "height": "100%"
            });
            
            container.appendChild(script);
            scriptRef.current = script;
        } catch (e) {
            console.error("Heatmap Widget Error:", e);
        }
    }, 150); // Tickerë³´ë‹¤ ì¡°ê¸ˆ ë” ëŠ¦ê²Œ ì‹¤í–‰í•˜ì—¬ ë¶€í•˜ ë¶„ì‚°

    return () => {
        clearTimeout(timer);
        if (container) container.innerHTML = '';
    };
  }, [theme, source]);
  
  return <div className="tradingview-widget-container w-full h-full" ref={containerRef} />;
});

// --- ë©”ì¸ ì•± ì»´í¬ë„ŒíŠ¸ ---
export default function App() {
  // --- ìƒíƒœ ê´€ë¦¬ (State) ---
  const [activeTab, setActiveTab] = useState('dashboard');
  const [isDark, setIsDark] = useState(false);
  const [currentTime, setCurrentTime] = useState('');
  
  // ë°ì´í„° ìƒíƒœ
  const [quickLinks, setQuickLinks] = useState(DEFAULT_QUICK_LINKS);
  const [blogMapData, setBlogMapData] = useState(DEFAULT_BLOG_MAP_DATA);
  const [favoriteSymbols, setFavoriteSymbols] = useState(DEFAULT_FAVORITE_SYMBOLS);
  const [linkMode, setLinkMode] = useState('investment');
  const [isEditMode, setIsEditMode] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');

  // ì‹œì¥ ìƒíƒœ
  const [marketStatus, setMarketStatus] = useState({ text: 'ìƒíƒœ í™•ì¸ ì¤‘', color: 'bg-slate-500', reason: '', source: 'KRX' });

  // ê³„ì‚°ê¸° ìƒíƒœ
  const [targetInputs, setTargetInputs] = useState({ price: '', shares: '', currentCap: '', targetCap: '', targetRate: '' });
  const [targetMode, setTargetMode] = useState('cap'); 
  const [targetResult, setTargetResult] = useState({ price: 0, valuation: 0, profit: 0, rateChange: 0 });

  const [pnlInputs, setPnlInputs] = useState({ buy: '', sell: '', fee: 0.3 });
  const [pnlResult, setPnlResult] = useState({ net: 0, rate: 0, feeTotal: 0 });

  const [ipoInputs, setIpoInputs] = useState({ type: 0.5, price: '', qty: 10, people: 1 });
  const [ipoResult, setIpoResult] = useState(0);

  const [exchBase, setExchBase] = useState('USD');
  const [exchTarget, setExchTarget] = useState('KRW');
  const [exchInputs, setExchInputs] = useState({ foreign: '', krw: '' });

  const [avgRows, setAvgRows] = useState([{ q: '', p: '' }, { q: '', p: '' }, { q: '', p: '' }, { q: '', p: '' }]);
  const [avgResult, setAvgResult] = useState(0);

  const [divMode, setDivMode] = useState('KOR');
  const [divInputs, setDivInputs] = useState({ shares: '', perShare: '', tax: 15.4 });
  const [divResult, setDivResult] = useState({ gross: 0, net: 0 });

  // ì„¸ê¸ˆ ìƒíƒœ
  const [finData, setFinData] = useState([]);
  const [otherData, setOtherData] = useState([]);
  const [taxCalc, setTaxCalc] = useState({ step1: 0, step2: 0, total: 0, finTotal: 0, otherTotal: 0, grandTotal: 0, isTaxable: false });
  const [finInput, setFinInput] = useState({ type: 'ì´ì', desc: '', amount: '' });
  const [otherInput, setOtherInput] = useState({ desc: '', rev: '', exp: '' });

  // ëª¨ë‹¬ ìƒíƒœ
  const [modalState, setModalState] = useState({ type: null, category: null });
  const [modalInputs, setModalInputs] = useState({ name: '', url: '', icon: 'fa-link', color: 'bg-slate-100 text-slate-700' });

  // --- Effects ---
  // [NEW] ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬ ì¶”ê°€: "Script error" ë¬´ì‹œ
  useEffect(() => {
    const handleGlobalError = (event) => {
      // Script errorëŠ” ì£¼ë¡œ ì„œë“œíŒŒí‹° ìŠ¤í¬ë¦½íŠ¸(íŠ¸ë ˆì´ë”©ë·° ë“±)ì˜ CORS ë¬¸ì œë¡œ ë°œìƒí•˜ë©°
      // ì‹¤ì œ ì•± ë™ì‘ì— ì¹˜ëª…ì ì´ì§€ ì•Šìœ¼ë‚˜, ì‚¬ìš©ìì—ê²Œ ì—ëŸ¬ ì˜¤ë²„ë ˆì´ë¥¼ ë„ìš¸ ìˆ˜ ìˆìŒ.
      if (event.message === 'Script error.' || (event.message && event.message.indexOf('Script error') > -1)) {
        console.warn('Suppressing external script error:', event.message);
        // ì—ëŸ¬ ì´ë²¤íŠ¸ë¥¼ ì·¨ì†Œí•˜ì—¬ ë¶‰ì€ìƒ‰ ì—ëŸ¬ ì˜¤ë²„ë ˆì´ê°€ ëœ¨ì§€ ì•Šë„ë¡ ì‹œë„
        event.preventDefault ? event.preventDefault() : (event.returnValue = false);
        return true; 
      }
    };

    window.addEventListener('error', handleGlobalError);
    return () => window.removeEventListener('error', handleGlobalError);
  }, []);

  useEffect(() => {
    // í…Œë§ˆ ì„¤ì •
    try {
      const savedTheme = storage.get('theme');
      const sysDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (savedTheme === 'dark' || (!savedTheme && sysDark)) setIsDark(true);
    } catch (e) { console.error('Theme Error', e); }

    // ë°ì´í„° ë¡œë“œ (ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš©)
    try {
      const savedLinks = storage.getJSON('myQuickLinks');
      if (savedLinks) setQuickLinks(prev => ({...prev, ...savedLinks}));
    } catch (e) { console.warn('Links Load Error', e); }

    try {
      const savedBlogs = storage.getJSON('myBlogMapData');
      if (savedBlogs) setBlogMapData(savedBlogs);
    } catch (e) { console.warn('Blogs Load Error', e); }

    try {
      const savedFavs = storage.getJSON('favoriteSymbols');
      if (savedFavs) setFavoriteSymbols(savedFavs);
    } catch (e) { console.warn('Favs Load Error', e); }

    try {
      const savedFin = storage.getJSON('finData');
      if (savedFin) setFinData(savedFin);
    } catch (e) { console.warn('Fin Load Error', e); }
    
    try {
      const savedOther = storage.getJSON('otherData');
      if (savedOther) setOtherData(savedOther);
    } catch (e) { console.warn('Other Load Error', e); }

    // FontAwesome ë¡œë“œ
    const link = document.createElement('link');
    link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css';
    link.rel = 'stylesheet';
    document.head.appendChild(link);

    // ì‹œê³„ ë° ì‹œì¥ ìƒíƒœ ì²´í¬ íƒ€ì´ë¨¸
    const timer = setInterval(() => {
      const now = new Date();
      setCurrentTime(now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }));
      checkMarketStatus();
    }, 1000);
    checkMarketStatus();

    return () => clearInterval(timer);
  }, []);

  useEffect(() => {
    if (isDark) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');
    storage.set('theme', isDark ? 'dark' : 'light');
  }, [isDark]);

  useEffect(() => {
    calculateTax();
  }, [finData, otherData]);

  // --- ë¡œì§ í•¨ìˆ˜ë“¤ ---

  const checkMarketStatus = () => {
    try {
        const now = new Date();
        const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
        const kstOffset = 9 * 60;
        const kstNow = new Date(utc + (kstOffset * 60000));
        
        const day = kstNow.getDay();
        const hours = kstNow.getHours();
        const minutes = kstNow.getMinutes();
        const totalMinutes = hours * 60 + minutes;

        let newStatus = { text: "ìƒíƒœ í™•ì¸ ì¤‘", color: "bg-slate-500", reason: "", source: 'KRX' };

        if (hours >= 8 && hours < 19) {
            newStatus.source = 'KRX';
            if (day === 0 || day === 6) newStatus = { ...newStatus, text: "ì£¼ë§ íœ´ì¥", color: "bg-slate-600", reason: "ì£¼ë§" };
            else if (totalMinutes >= 540 && totalMinutes <= 930) newStatus = { ...newStatus, text: "ì •ê·œì¥ ìš´ì˜ ì¤‘", color: "bg-green-600", reason: "09:00~15:30" };
            else if (totalMinutes >= 510 && totalMinutes < 540) newStatus = { ...newStatus, text: "ì¥ì „ ë™ì‹œí˜¸ê°€", color: "bg-cyan-600", reason: "08:30~09:00" };
            else if (totalMinutes > 930 && totalMinutes <= 1080) newStatus = { ...newStatus, text: "ì‹œê°„ ì™¸ ê±°ë˜", color: "bg-blue-600", reason: "15:40~18:00" };
            else newStatus = { ...newStatus, text: "ì¥ ë§ˆê°", color: "bg-red-600", reason: "ì •ê·œì‹œê°„ ì¢…ë£Œ" };
        } else { 
            newStatus.source = 'US';
            if (day === 6 || (day === 0 && hours < 22)) newStatus = { ...newStatus, text: "ì£¼ë§ íœ´ì¥", color: "bg-slate-600", reason: "ì£¼ë§" };
            else if (hours >= 22 || hours < 6) newStatus = { ...newStatus, text: "ì •ê·œì¥ ìš´ì˜ ì¤‘", color: "bg-green-600", reason: "US Market Open" }; 
            else newStatus = { ...newStatus, text: "ì¥ ë§ˆê°", color: "bg-red-600", reason: "Pre/After Close" };
        }
        
        setMarketStatus(prev => {
            if (JSON.stringify(prev) !== JSON.stringify(newStatus)) {
                return newStatus;
            }
            return prev;
        });
    } catch (e) {
        console.error("Market Status Check Error", e);
    }
  };

  const handleTargetCalc = () => {
    const current = parseFloat(targetInputs.price) || 0;
    const shares = parseFloat(targetInputs.shares) || 0;
    
    let targetPrice = current;
    let rateChange = 0;

    if (targetMode === 'cap') {
      const curCap = parseFloat(targetInputs.currentCap) || 0;
      const tarCap = parseFloat(targetInputs.targetCap) || 0;
      if (curCap > 0) {
        targetPrice = current * (tarCap / curCap);
        rateChange = ((tarCap / curCap) - 1) * 100;
      }
    } else {
      const tarSell = parseFloat(targetInputs.targetRate) || 0; 
      if (current > 0) {
        rateChange = ((tarSell - current) / current) * 100;
        targetPrice = tarSell;
      }
    }

    const initVal = current * shares;
    const finalVal = targetPrice * shares;
    
    setTargetResult({
      price: targetMode === 'cap' ? targetPrice : rateChange, 
      valuation: finalVal,
      profit: finalVal - initVal,
      rateChange: rateChange
    });
  };

  const handlePnlCalc = () => {
    const buy = parseFloat(pnlInputs.buy) || 0;
    const sell = parseFloat(pnlInputs.sell) || 0;
    const feeRate = (parseFloat(pnlInputs.fee) || 0) / 100;
    
    const feeTotal = (buy * feeRate) + (sell * feeRate);
    const net = sell - buy - feeTotal;
    const rate = buy > 0 ? (net / buy) * 100 : 0;
    
    setPnlResult({ net, rate, feeTotal });
  };

  const handleIpoCalc = () => {
    const p = parseFloat(ipoInputs.price) || 0;
    const q = parseFloat(ipoInputs.qty) || 0;
    const pp = parseFloat(ipoInputs.people) || 0;
    setIpoResult((p * q * pp) * ipoInputs.type);
  };

  const handleAvgCalc = (index, field, value) => {
    const newRows = avgRows.map((row, i) => 
        i === index ? { ...row, [field]: value } : row
    );
    setAvgRows(newRows);
    
    let totalQ = 0, totalC = 0;
    newRows.forEach(r => {
      const q = parseFloat(r.q) || 0;
      const p = parseFloat(r.p) || 0;
      totalQ += q;
      totalC += q * p;
    });
    setAvgResult(totalQ > 0 ? totalC / totalQ : 0);
  };

  const handleExchange = (source, value) => {
      const val = parseFloat(value) || 0;
      let rate = 1;
      let newInputs = { ...exchInputs };

      if (exchBase === 'KRW') {
           rate = EXCHANGE_RATES[exchTarget]?.krw || 1;
           if (source === 'krw') {
               newInputs.krw = value;
               newInputs.foreign = (val / rate).toFixed(2);
           } else {
               newInputs.foreign = value;
               newInputs.krw = Math.round(val * rate);
           }
      } else {
           rate = EXCHANGE_RATES[exchBase]?.krw || 1;
           if (source === 'foreign') {
               newInputs.foreign = value;
               newInputs.krw = Math.round(val * rate);
           } else {
               newInputs.krw = value;
               newInputs.foreign = (val / rate).toFixed(2);
           }
      }
      setExchInputs(newInputs);
  };

  const handleDividendCalc = () => {
      const shares = parseFloat(divInputs.shares) || 0;
      const perShare = parseFloat(divInputs.perShare) || 0;
      const taxRate = parseFloat(divInputs.tax) || 0;
      
      const gross = shares * perShare;
      const tax = gross * (taxRate / 100);
      const net = gross - tax;
      setDivResult({ gross, net });
  };

  const getIncomeTax = (income) => {
      if (income <= 0) return 0;
      if (income <= 14000000) return income * 0.06;
      if (income <= 50000000) return income * 0.15 - 1260000;
      if (income <= 88000000) return income * 0.24 - 5860000;
      if (income <= 150000000) return income * 0.35 - 15440000;
      if (income <= 300000000) return income * 0.38 - 19940000;
      if (income <= 500000000) return income * 0.40 - 25940000;
      if (income <= 1000000000) return income * 0.42 - 35940000;
      return income * 0.45 - 65940000;
  };

  const calculateTax = () => {
    const fTotal = finData.reduce((acc, cur) => acc + cur.amount, 0);
    const oTotal = otherData.reduce((acc, cur) => acc + cur.net, 0);
    
    const limit = TAX_THRESHOLD;
    let s1 = 0, s2 = 0;

    if (fTotal <= limit) {
      s1 = fTotal * 0.154;
      s2 = 0;
    } else {
      s1 = limit * 0.154;
      const excess = fTotal - limit;
      
      const totalIncome = oTotal + excess;
      const taxTotalRaw = getIncomeTax(totalIncome);
      const taxBaseOther = getIncomeTax(oTotal);
      
      const taxOnlyExcess = (taxTotalRaw - taxBaseOther) * 1.1; // ì§€ë°©ì„¸ 10%
      const minTax = excess * 0.154;
      
      s2 = Math.max(taxOnlyExcess, minTax);
    }

    setTaxCalc({
      step1: s1, step2: s2, total: s1 + s2,
      finTotal: fTotal, otherTotal: oTotal, grandTotal: fTotal + oTotal,
      isTaxable: fTotal > limit
    });
  };

  const formatCurrency = (val, unit='ì›') => Math.round(val || 0).toLocaleString() + (unit ? ` ${unit}` : '');
  
  const searchSymbol = (query) => {
    const code = query.trim();
    if (/[a-zA-Z]/.test(code)) window.open(`https://finance.naver.com/world/sise.naver?symbol=${code}`, '_blank');
    else window.open(`https://finance.naver.com/item/main.naver?code=${code}`, '_blank');
  };

  // --- UI RENDER FUNCTIONS (Separated for Cleanliness) ---

  const renderDashboard = () => (
    <div className="space-y-6 animate-fade-in">
        <div className="bg-white dark:bg-slate-800 rounded-xl shadow border border-slate-200 dark:border-slate-700 overflow-hidden h-14">
            <TradingViewTicker theme={isDark} />
        </div>

        <div className="flex flex-col">
            <div className="bg-white dark:bg-slate-800 p-1 rounded-xl shadow-xl border border-slate-200 dark:border-slate-700 flex flex-col h-[600px]">
                <div className="p-3 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800 rounded-t-xl">
                    <h2 className="text-lg font-bold flex items-center gap-2 text-slate-700 dark:text-slate-300">
                        <i className={`fa-solid fa-fire ${marketStatus.source === 'US' ? 'text-red-500' : 'text-blue-500'}`}></i>
                        S&P 500 íˆíŠ¸ë§µ
                        <span className={`ml-2 px-2 py-0.5 rounded-full text-xs text-white ${marketStatus.color}`}>
                            {marketStatus.source === 'KRX' ? '[KRX]' : '[US]'} {marketStatus.text}
                        </span>
                        {marketStatus.reason && !marketStatus.text.includes('ì •ê·œì¥') && (
                            <span className="text-xs text-slate-400 ml-1">({marketStatus.reason})</span>
                        )}
                    </h2>
                </div>
                <div className="flex-1 bg-slate-100 dark:bg-slate-900 rounded-b-xl overflow-hidden relative">
                    <div className="hidden md:block h-full w-full">
                        <TradingViewHeatmap theme={isDark} source={marketStatus.source} />
                    </div>
                    <div className="md:hidden h-full flex flex-col items-center justify-center text-slate-500 text-center p-4">
                        <i className="fa-solid fa-mobile-screen-button text-4xl mb-2 text-indigo-300"></i>
                        <p>ëª¨ë°”ì¼ì—ì„œëŠ” íˆíŠ¸ë§µì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br/>ë°ìŠ¤í¬íƒ‘ í™˜ê²½ì„ ì´ìš©í•´ì£¼ì„¸ìš”.</p>
                    </div>
                </div>
            </div>
        </div>

        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 p-5">
            <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-slate-800 dark:text-white"><i className="fa-solid fa-magnifying-glass-chart text-indigo-500"></i> ê°„í¸ ì¢…ëª© ê²€ìƒ‰</h3>
            <div className="flex gap-2">
                <input 
                    type="text" 
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && searchSymbol(searchQuery)}
                    placeholder="ì¢…ëª© ì½”ë“œ (ì˜ˆ: 005930) ë˜ëŠ” ì¢…ëª©ëª…" 
                    className="flex-1 p-3 border-2 border-indigo-300 dark:border-indigo-600 rounded-lg dark:bg-slate-700 dark:text-white focus:outline-none focus:border-indigo-500 transition-colors"
                />
                <button 
                    onClick={() => searchSymbol(searchQuery)}
                    className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 rounded-lg font-bold"
                >ì´ë™</button>
                <button onClick={() => setModalState({ type: 'fav' })} className="bg-slate-200 dark:bg-slate-700 p-3 rounded-lg text-slate-600 dark:text-slate-300 hover:bg-slate-300 dark:hover:bg-slate-600">
                    <i className="fa-solid fa-gear"></i>
                </button>
            </div>
            <div className="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                <span className="text-sm font-bold text-slate-500 mb-2 block">ìì£¼ ì°¾ëŠ” ì¢…ëª©</span>
                <div className="flex flex-wrap gap-2">
                    {favoriteSymbols.map((sym, idx) => (
                        <button 
                            key={idx}
                            onClick={() => searchSymbol(sym.code)}
                            className="bg-white border border-slate-200 dark:bg-slate-700 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-600 px-3 py-1.5 rounded-lg text-xs font-bold text-slate-700 dark:text-slate-300 transition shadow-sm"
                        >
                            <span className="text-slate-400 mr-1">{sym.code}</span> {sym.name}
                        </button>
                    ))}
                </div>
            </div>
        </div>
    </div>
  );

  const renderRoutine = () => (
    <div className="animate-fade-in space-y-6">
        <div className="flex flex-col sm:flex-row justify-between items-end pb-4 border-b border-slate-200 dark:border-slate-700 gap-4">
            <div>
                <h2 className="text-2xl font-extrabold text-slate-800 dark:text-white">ì˜¤ëŠ˜ì˜ ë£¨í‹´ ëª©ë¡</h2>
            </div>
            <div className="flex items-center gap-3">
                <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
                    {['investment', 'blogs', 'daily'].map(mode => (
                        <button 
                            key={mode}
                            onClick={() => setLinkMode(mode)}
                            className={`px-3 py-1.5 text-xs font-bold rounded-lg transition-all ${linkMode === mode ? 'bg-white dark:bg-slate-900 shadow text-blue-600 dark:text-blue-400' : 'text-slate-500'}`}
                        >
                            {mode === 'investment' ? <><i className="fa-solid fa-chart-line mr-1"></i>íˆ¬ì</> : mode === 'blogs' ? <><i className="fa-solid fa-sitemap mr-1"></i>ì¸ì‚¬ì´íŠ¸</> : <><i className="fa-solid fa-home mr-1"></i>ì¼ìƒ</>}
                        </button>
                    ))}
                </div>
                <div className="flex items-center gap-2">
                    <span className="text-xs font-bold text-slate-500">í¸ì§‘</span>
                    <button onClick={() => setIsEditMode(!isEditMode)} className={`w-10 h-5 rounded-full relative transition-colors ${isEditMode ? 'bg-blue-600' : 'bg-slate-300'}`}>
                        <div className={`w-3 h-3 bg-white rounded-full absolute top-1 transition-all shadow-sm ${isEditMode ? 'left-6' : 'left-1'}`}></div>
                    </button>
                </div>
            </div>
        </div>

        <div className={`${linkMode === 'blogs' ? 'flex flex-col gap-8' : 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'}`}>
            {linkMode === 'blogs' ? (
                Object.entries(blogMapData).map(([category, links]) => (
                    <div key={category} className="bg-white dark:bg-slate-800 rounded-2xl p-8 shadow-inner border border-slate-200 dark:border-slate-700 flex flex-col md:flex-row items-center gap-6 relative group">
                        <div className="mindmap-node-main text-white px-6 py-3 rounded-xl font-bold min-w-[150px] text-center z-10 relative">
                            {category}
                            {isEditMode && <button onClick={() => {
                                const newData = {...blogMapData}; delete newData[category]; setBlogMapData(newData); storage.set('myBlogMapData', newData);
                            }} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs"><i className="fa-solid fa-times"></i></button>}
                        </div>
                        <div className="hidden md:block w-8 h-0.5 bg-slate-300 dark:bg-slate-600"></div>
                        <div className="flex flex-wrap gap-3 justify-center md:justify-start flex-1 pl-4 md:pl-0 border-l-2 md:border-l-0 border-dashed border-slate-300 dark:border-slate-600 md:items-center">
                            {links.map((link, idx) => (
                                <div key={idx} className="relative group/link">
                                    <a href={link.url} target="_blank" rel="noreferrer" className="flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-600 rounded-full text-sm font-bold text-slate-600 dark:text-slate-300 hover:border-indigo-500 hover:text-indigo-500 transition shadow-sm">
                                        <i className="fa-solid fa-link text-xs text-slate-400"></i>
                                        {link.name}
                                    </a>
                                    {isEditMode && <button onClick={() => {
                                        const newData = {...blogMapData};
                                        newData[category].splice(idx, 1);
                                        setBlogMapData(newData);
                                        storage.set('myBlogMapData', newData);
                                    }} className="absolute -top-1 -right-1 bg-red-400 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px]"><i className="fa-solid fa-minus"></i></button>}
                                </div>
                            ))}
                            {isEditMode && <button onClick={() => setModalState({ type: 'addLink', category })} className="px-3 py-1 border border-dashed border-slate-300 text-slate-400 rounded-full text-xs hover:text-blue-500 hover:border-blue-500"><i className="fa-solid fa-plus"></i> ì¶”ê°€</button>}
                        </div>
                    </div>
                ))
            ) : (
                Object.entries(quickLinks).filter(([key]) => {
                    const isDaily = key.includes('Daily') || key.includes('ë¶€ë™ì‚°');
                    return linkMode === 'daily' ? isDaily : !isDaily;
                }).map(([category, links]) => (
                    <div key={category} className="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg border border-slate-100 dark:border-slate-700 flex flex-col h-full relative group">
                        <h3 className="text-lg font-bold mb-4 pb-2 border-b border-slate-100 dark:border-slate-700 text-slate-800 dark:text-white flex justify-between">
                            {category}
                            {isEditMode && <div className="flex gap-2">
                                <button onClick={() => setModalState({ type: 'addLink', category })} className="text-blue-500 text-xs bg-blue-50 p-1 rounded"><i className="fa-solid fa-plus"></i></button>
                                <button onClick={() => {
                                    const newData = {...quickLinks}; delete newData[category]; setQuickLinks(newData); storage.set('myQuickLinks', newData);
                                }} className="text-red-500 text-xs bg-red-50 p-1 rounded"><i className="fa-solid fa-trash"></i></button>
                            </div>}
                        </h3>
                        <div className="space-y-3 flex-1">
                            {links.map((link, idx) => (
                                <div key={idx} className="relative group/item">
                                    <a href={link.url} target="_blank" rel="noreferrer" className={`block p-3 rounded-xl border border-slate-100 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 hover:bg-white dark:hover:bg-slate-600 hover:shadow-md transition flex items-center gap-3 ${isEditMode ? 'opacity-50 pointer-events-none' : ''}`}>
                                        <div className={`w-8 h-8 rounded flex items-center justify-center ${link.color} bg-opacity-20`}>
                                            <i className={`fa-solid ${link.icon}`}></i>
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <div className="font-bold text-sm text-slate-700 dark:text-slate-200 truncate">{link.name}</div>
                                        </div>
                                        {!isEditMode && <i className="fa-solid fa-arrow-up-right-from-square text-xs text-slate-300"></i>}
                                    </a>
                                    {isEditMode && (
                                        <div className="absolute inset-y-0 right-2 flex items-center gap-2">
                                            <button onClick={() => {
                                                const newData = {...quickLinks};
                                                newData[category].splice(idx, 1);
                                                setQuickLinks(newData);
                                                storage.set('myQuickLinks', newData);
                                            }} className="bg-white border border-red-200 text-red-500 rounded p-1 shadow-sm hover:bg-red-50"><i className="fa-solid fa-trash text-xs"></i></button>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                ))
            )}
            
            {isEditMode && (
                <button onClick={() => setModalState({ type: 'addCat' })} className="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-2xl p-6 flex flex-col items-center justify-center text-slate-400 hover:text-blue-500 hover:border-blue-500 transition min-h-[200px]">
                    <i className="fa-solid fa-plus-circle text-3xl mb-2"></i>
                    <span className="font-bold">ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</span>
                </button>
            )}
        </div>
    </div>
  );

  const renderTools = () => (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6 animate-fade-in">
        <div className="bg-white dark:bg-slate-800 rounded-2xl border-2 border-indigo-200 dark:border-indigo-900 overflow-hidden shadow-lg">
            <div className="p-4 bg-indigo-50 dark:bg-indigo-900/20 border-b border-indigo-100 dark:border-slate-700 font-bold text-indigo-800 dark:text-indigo-200">
                <i className="fa-solid fa-bullseye mr-2"></i> ëª©í‘œ ë‹¨ê°€ & ê°€ì¹˜ ë¶„ì„
            </div>
            <div className="p-6 space-y-4">
                <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg mb-4">
                    <button onClick={() => setTargetMode('cap')} className={`flex-1 py-1.5 text-sm font-bold rounded-md transition ${targetMode === 'cap' ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500'}`}>ì‹œê°€ì´ì•¡ ê¸°ë°˜</button>
                    <button onClick={() => setTargetMode('rate')} className={`flex-1 py-1.5 text-sm font-bold rounded-md transition ${targetMode === 'rate' ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500'}`}>ìˆ˜ìµë¥  ê¸°ë°˜</button>
                </div>
                
                <div className="space-y-3">
                    <div className="flex justify-between items-center">
                        <label className="text-sm font-medium text-slate-500 w-24">í˜„ì¬ê°€/ë§¤ìˆ˜ê°€</label>
                        <input type="number" value={targetInputs.price} onChange={e => { setTargetInputs({...targetInputs, price: e.target.value}); }} onBlur={handleTargetCalc} className="flex-1 p-2 border rounded dark:bg-slate-700 dark:border-slate-600 text-right" placeholder="0" />
                    </div>
                    <div className="flex justify-between items-center">
                        <label className="text-sm font-medium text-slate-500 w-24">ë³´ìœ  ìˆ˜ëŸ‰</label>
                        <input type="number" value={targetInputs.shares} onChange={e => { setTargetInputs({...targetInputs, shares: e.target.value}); }} onBlur={handleTargetCalc} className="flex-1 p-2 border rounded dark:bg-slate-700 dark:border-slate-600 text-right" placeholder="0" />
                    </div>

                    {targetMode === 'cap' ? (
                        <>
                        <div className="flex justify-between items-center">
                            <label className="text-sm font-medium text-slate-500 w-24">í˜„ì¬ ì‹œì´ (ì¡°)</label>
                            <input type="number" value={targetInputs.currentCap} onChange={e => { setTargetInputs({...targetInputs, currentCap: e.target.value}); }} onBlur={handleTargetCalc} className="flex-1 p-2 border rounded dark:bg-slate-700 dark:border-slate-600 text-right" placeholder="350.00" />
                        </div>
                        <div className="flex justify-between items-center">
                            <label className="text-sm font-medium text-slate-500 w-24">ëª©í‘œ ì‹œì´ (ì¡°)</label>
                            <input type="number" value={targetInputs.targetCap} onChange={e => { setTargetInputs({...targetInputs, targetCap: e.target.value}); }} onBlur={handleTargetCalc} className="flex-1 p-2 border rounded dark:bg-slate-700 dark:border-slate-600 text-right" placeholder="500.00" />
                        </div>
                        </>
                    ) : (
                        <div className="flex justify-between items-center">
                            <label className="text-sm font-medium text-slate-500 w-24">ëª©í‘œ ë§¤ë„ê°€</label>
                            <input type="number" value={targetInputs.targetRate} onChange={e => { setTargetInputs({...targetInputs, targetRate: e.target.value}); }} onBlur={handleTargetCalc} className="flex-1 p-2 border rounded dark:bg-slate-700 dark:border-slate-600 text-right" placeholder="ëª©í‘œ ê°€ê²©" />
                        </div>
                    )}
                </div>
                
                <button onClick={handleTargetCalc} className="w-full bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700 shadow-md mt-2">ê³„ì‚°í•˜ê¸°</button>

                <div className="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg space-y-2">
                    <div className="flex justify-between">
                        <span className="text-sm font-bold text-slate-700 dark:text-slate-300">{targetMode === 'cap' ? 'ëª©í‘œ ë‹¨ê°€' : 'ëª©í‘œ ìˆ˜ìµë¥ '}</span>
                        <span className={`font-mono text-xl font-extrabold ${targetMode === 'cap' ? 'text-indigo-600 dark:text-indigo-400' : (targetResult.price >= 0 ? 'text-green-600' : 'text-red-500')}`}>
                            {targetMode === 'cap' ? formatCurrency(targetResult.price) : `${targetResult.price.toFixed(2)}%`}
                        </span>
                    </div>
                    <div className="flex justify-between text-sm">
                        <span className="text-slate-500">ì˜ˆìƒ ìˆ˜ìµê¸ˆ</span>
                        <span className={`font-bold ${targetResult.profit >= 0 ? 'text-green-600' : 'text-red-500'}`}>{formatCurrency(targetResult.profit)}</span>
                    </div>
                    {targetMode === 'cap' && <div className="flex justify-between text-xs text-slate-400"><span>ì˜ˆìƒ ìˆ˜ìµë¥ </span><span>{targetResult.rateChange.toFixed(2)}%</span></div>}
                </div>
            </div>
        </div>

        <div className="bg-white dark:bg-slate-800 rounded-2xl border-2 border-red-200 dark:border-red-900 overflow-hidden shadow-lg">
            <div className="p-4 bg-red-50 dark:bg-red-900/20 border-b border-red-100 dark:border-slate-700 font-bold text-red-800 dark:text-red-200">
                <i className="fa-solid fa-percent mr-2"></i> ì‹¤í˜„ ì†ìµ (P&L)
            </div>
            <div className="p-6 grid grid-cols-1 gap-6">
                <div className="space-y-4">
                    <div className="flex justify-between items-center">
                        <label className="text-sm font-medium text-slate-500 w-24">ë§¤ìˆ˜ ì´ì•¡</label>
                        <input type="number" value={pnlInputs.buy} onChange={e => setPnlInputs({...pnlInputs, buy: e.target.value})} onBlur={handlePnlCalc} className="flex-1 p-2 border rounded dark:bg-slate-700 dark:border-slate-600 text-right" placeholder="0" />
                    </div>
                    <div className="flex justify-between items-center">
                        <label className="text-sm font-medium text-slate-500 w-24">ë§¤ë„ ì´ì•¡</label>
                        <input type="number" value={pnlInputs.sell} onChange={e => setPnlInputs({...pnlInputs, sell: e.target.value})} onBlur={handlePnlCalc} className="flex-1 p-2 border rounded dark:bg-slate-700 dark:border-slate-600 text-right" placeholder="0" />
                    </div>
                    <div className="flex justify-between items-center">
                        <label className="text-sm font-medium text-slate-500 w-24">ìˆ˜ìˆ˜ë£Œìœ¨(%)</label>
                        <input type="number" value={pnlInputs.fee} onChange={e => setPnlInputs({...pnlInputs, fee: e.target.value})} onBlur={handlePnlCalc} className="flex-1 p-2 border rounded dark:bg-slate-700 dark:border-slate-600 text-right" placeholder="0.3" step="0.01" />
                    </div>
                    <button onClick={handlePnlCalc} className="w-full bg-red-600 text-white py-2 rounded-lg font-bold hover:bg-red-700 shadow-md">ê³„ì‚°í•˜ê¸°</button>
                </div>
                
                <div className="bg-red-50 dark:bg-red-900/20 rounded-xl p-4 text-center flex flex-col justify-center">
                    <div className="text-sm text-slate-500 dark:text-slate-400 mb-1">ìˆœ ì‹¤í˜„ ì†ìµ (ì„¸í›„)</div>
                    <div className={`text-3xl font-extrabold font-mono ${pnlResult.net >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                        {formatCurrency(pnlResult.net)}
                    </div>
                    <div className="w-full border-t border-red-200 dark:border-red-800/30 my-3"></div>
                    <div className="text-sm text-slate-500">ìˆ˜ìµë¥ </div>
                    <div className={`text-xl font-bold ${pnlResult.net >= 0 ? 'text-green-600' : 'text-red-600'}`}>{pnlResult.rate.toFixed(2)}%</div>
                </div>
            </div>
        </div>
        
        <div className="bg-white dark:bg-slate-800 rounded-2xl border-2 border-purple-200 dark:border-purple-900 overflow-hidden shadow-lg">
            <div className="p-4 bg-purple-50 dark:bg-purple-900/20 border-b border-purple-100 font-bold text-purple-800 dark:text-purple-200">
                <i className="fa-solid fa-piggy-bank mr-2"></i> ê³µëª¨ì£¼/ìŠ¤íŒ© ì²­ì•½
            </div>
            <div className="p-6 space-y-4">
                <div className="flex gap-2">
                    <select value={ipoInputs.type} onChange={e => setIpoInputs({...ipoInputs, type: parseFloat(e.target.value)})} className="p-2 border rounded dark:bg-slate-700 dark:text-white flex-1">
                        <option value={0.5}>ì¼ë°˜ ê³µëª¨ì£¼ (50%)</option>
                        <option value={1.0}>ìŠ¤íŒ© (100%)</option>
                    </select>
                </div>
                <div className="flex gap-2">
                    <input type="number" value={ipoInputs.price} onChange={e => setIpoInputs({...ipoInputs, price: e.target.value})} placeholder="ê³µëª¨ê°€" className="flex-1 p-2 border rounded dark:bg-slate-700 text-right" />
                    <input type="number" value={ipoInputs.qty} onChange={e => setIpoInputs({...ipoInputs, qty: e.target.value})} placeholder="ìˆ˜ëŸ‰" className="flex-1 p-2 border rounded dark:bg-slate-700 text-right" />
                    <input type="number" value={ipoInputs.people} onChange={e => setIpoInputs({...ipoInputs, people: e.target.value})} placeholder="ì¸ì›" className="w-20 p-2 border rounded dark:bg-slate-700 text-right" />
                </div>
                <button onClick={handleIpoCalc} className="w-full bg-purple-600 text-white py-2 rounded-lg font-bold hover:bg-purple-700">ê³„ì‚°í•˜ê¸°</button>
                <div className="text-right bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg">
                    <span className="text-sm text-slate-500 mr-2">í•„ìš” í˜„ê¸ˆ:</span>
                    <span className="text-2xl font-extrabold text-purple-600 dark:text-purple-300 font-mono">{formatCurrency(ipoResult)}</span>
                </div>
            </div>
        </div>

        <div className="bg-white dark:bg-slate-800 rounded-2xl border-2 border-green-200 dark:border-green-900 overflow-hidden shadow-lg">
            <div className="p-4 bg-green-50 dark:bg-green-900/20 border-b border-green-100 font-bold text-green-800 dark:text-green-200 flex justify-between items-center">
                <span><i className="fa-solid fa-scale-balanced mr-2"></i> í‰ë‹¨ê°€ ê³„ì‚°ê¸°</span>
                <button onClick={() => setAvgRows([...avgRows, {q:'', p:''}])} className="text-xs bg-white text-green-600 px-2 py-1 rounded border border-green-300 shadow-sm hover:bg-green-50"><i className="fa-solid fa-plus"></i> ì¶”ê°€</button>
            </div>
            <div className="p-6 space-y-2">
                <div className="flex text-xs text-slate-400 px-1">
                    <span className="w-1/2">ìˆ˜ëŸ‰</span>
                    <span className="w-1/2">ë‹¨ê°€</span>
                </div>
                {avgRows.map((row, idx) => (
                    <div key={idx} className="flex gap-2">
                        <input type="number" value={row.q} onChange={e => handleAvgCalc(idx, 'q', e.target.value)} className="w-1/2 p-2 border rounded dark:bg-slate-700 text-right" />
                        <input type="number" value={row.p} onChange={e => handleAvgCalc(idx, 'p', e.target.value)} className="w-1/2 p-2 border rounded dark:bg-slate-700 text-right" />
                    </div>
                ))}
                <div className="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700 text-right bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg">
                    <span className="text-sm text-slate-500 mr-2">í‰ê·  ë‹¨ê°€:</span>
                    <span className="text-2xl font-extrabold text-green-600 dark:text-green-400 font-mono">{formatCurrency(avgResult)}</span>
                </div>
            </div>
        </div>

        <div className="bg-white dark:bg-slate-800 rounded-2xl border-2 border-blue-200 dark:border-blue-900 overflow-hidden shadow-lg">
            <div className="p-4 bg-blue-50 dark:bg-blue-900/20 border-b border-blue-100 dark:border-slate-700 font-bold text-blue-800 dark:text-blue-200">
                <i className="fa-solid fa-money-bill-transfer mr-2"></i> í™˜ìœ¨ ê³„ì‚°ê¸°
            </div>
            <div className="p-6 space-y-4">
                <div className="flex items-center gap-2">
                    <select value={exchBase} onChange={(e) => setExchBase(e.target.value)} className="w-32 p-2 border rounded dark:bg-slate-700 dark:text-white font-bold">
                        {Object.keys(EXCHANGE_RATES).map(k => <option key={k} value={k}>{k}</option>)}
                        <option value="KRW">KRW</option>
                    </select>
                    <input type="number" value={exchInputs.foreign} onChange={(e) => handleExchange(exchBase === 'KRW' ? 'krw' : 'foreign', e.target.value)} className="flex-1 p-2 border rounded dark:bg-slate-700 text-right" placeholder="0" />
                </div>
                <div className="flex items-center gap-2">
                    {exchBase === 'KRW' ? (
                        <select value={exchTarget} onChange={(e) => setExchTarget(e.target.value)} className="w-32 p-2 border rounded dark:bg-slate-700 dark:text-white font-bold">
                            {Object.keys(EXCHANGE_RATES).map(k => <option key={k} value={k}>{k}</option>)}
                        </select>
                    ) : (
                        <div className="w-32 p-2 font-bold text-center text-slate-500">KRW</div>
                    )}
                    <input type="number" value={exchInputs.krw} onChange={(e) => handleExchange(exchBase === 'KRW' ? 'foreign' : 'krw', e.target.value)} className="flex-1 p-2 border rounded dark:bg-slate-700 text-right" placeholder="0" readOnly={exchBase !== 'KRW'} />
                </div>
                <p className="text-xs text-slate-400 text-center">* ëŒ€ëµì ì¸ ê¸°ì¤€ í™˜ìœ¨ ì ìš© (ì‹¤ì‹œê°„ ì•„ë‹˜)</p>
            </div>
        </div>

        <div className="bg-white dark:bg-slate-800 rounded-2xl border-2 border-amber-200 dark:border-amber-900 overflow-hidden shadow-lg">
            <div className="p-4 bg-amber-50 dark:bg-amber-900/20 border-b border-amber-100 dark:border-slate-700 font-bold text-amber-800 dark:text-amber-200">
                <i className="fa-solid fa-sack-dollar mr-2"></i> ë°°ë‹¹ê¸ˆ ê³„ì‚°ê¸°
            </div>
            <div className="p-3 bg-slate-50 dark:bg-slate-800 border-b border-slate-100 dark:border-slate-700">
                <div className="flex space-x-1 bg-slate-200 dark:bg-slate-700 p-1 rounded-lg">
                    <button onClick={() => setDivMode('KOR')} className={`flex-1 py-1.5 text-sm font-bold rounded-lg transition ${divMode === 'KOR' ? 'bg-white shadow text-slate-800' : 'text-slate-500'}`}>êµ­ë‚´ (KOR)</button>
                    <button onClick={() => setDivMode('US')} className={`flex-1 py-1.5 text-sm font-bold rounded-lg transition ${divMode === 'US' ? 'bg-white shadow text-slate-800' : 'text-slate-500'}`}>í•´ì™¸ (US)</button>
                </div>
            </div>
            <div className="p-6 space-y-4">
                <div className="flex justify-between items-center">
                    <label className="text-sm w-24">ì£¼ì‹ ìˆ˜</label>
                    <input type="number" value={divInputs.shares} onChange={e => setDivInputs({...divInputs, shares: e.target.value})} onBlur={handleDividendCalc} className="flex-1 p-2 border rounded dark:bg-slate-700 text-right" />
                </div>
                <div className="flex justify-between items-center">
                    <label className="text-sm w-24">ì£¼ë‹¹ ë°°ë‹¹ê¸ˆ</label>
                    <input type="number" value={divInputs.perShare} onChange={e => setDivInputs({...divInputs, perShare: e.target.value})} onBlur={handleDividendCalc} className="flex-1 p-2 border rounded dark:bg-slate-700 text-right" />
                </div>
                <div className="flex justify-between items-center">
                    <label className="text-sm w-24">ì„¸ìœ¨ (%)</label>
                    <input type="number" value={divInputs.tax} onChange={e => setDivInputs({...divInputs, tax: e.target.value})} onBlur={handleDividendCalc} className="flex-1 p-2 border rounded dark:bg-slate-700 text-right" placeholder="15.4" />
                </div>
                
                <div className="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700 bg-amber-50 dark:bg-amber-900/10 p-3 rounded-lg text-right">
                    <div className="text-xs text-slate-500 mb-1">ì´ ë°°ë‹¹ê¸ˆ (ì„¸ì „): {formatCurrency(divResult.gross, divMode === 'US' ? 'USD' : 'ì›')}</div>
                    <div className="flex justify-between items-center">
                        <span className="text-sm font-bold text-slate-700 dark:text-slate-200">ì‹¤ìˆ˜ë ¹ì•¡ (ì„¸í›„):</span>
                        <span className="text-2xl font-extrabold text-amber-600 dark:text-amber-400 font-mono">
                            {divMode === 'US' ? divResult.net.toFixed(2) : formatCurrency(divResult.net)}
                            <span className="text-sm ml-1 text-slate-500">{divMode === 'US' ? 'USD' : 'ì›'}</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
  );

  const renderModalContent = () => {
    if (modalState.type === 'fav') {
      return (
        <>
            <div className="flex gap-2">
                <input type="text" placeholder="ì½”ë“œ" className="w-1/3 p-2 border rounded dark:bg-slate-700" id="fav-code" />
                <input type="text" placeholder="ì¢…ëª©ëª…" className="flex-1 p-2 border rounded dark:bg-slate-700" id="fav-name" />
            </div>
            <button onClick={() => {
                const c = document.getElementById('fav-code').value;
                const n = document.getElementById('fav-name').value;
                if(c && n) {
                    const newData = [...favoriteSymbols, { code: c, name: n }];
                    setFavoriteSymbols(newData); storage.set('favoriteSymbols', newData);
                    document.getElementById('fav-code').value = ''; document.getElementById('fav-name').value = '';
                }
            }} className="w-full bg-indigo-600 text-white py-2 rounded font-bold mt-2">ì¶”ê°€</button>
            <div className="max-h-60 overflow-y-auto space-y-2 mt-4">
                {favoriteSymbols.map((item, idx) => (
                    <div key={idx} className="flex justify-between items-center bg-white dark:bg-slate-700 p-2 rounded border border-slate-200 dark:border-slate-600">
                        <span className="text-sm font-bold"><span className="text-slate-400 mr-2 text-xs">{item.code}</span>{item.name}</span>
                        <button onClick={() => {
                            const newData = favoriteSymbols.filter((_, i) => i !== idx);
                            setFavoriteSymbols(newData); storage.set('favoriteSymbols', newData);
                        }} className="text-slate-400 hover:text-red-500"><i className="fa-solid fa-trash"></i></button>
                    </div>
                ))}
            </div>
        </>
      );
    } 
    
    // addCat or addLink
    const isAddCat = modalState.type === 'addCat';
    return (
        <>
            {isAddCat ? (
                <input type="text" value={modalInputs.name} onChange={e => setModalInputs({...modalInputs, name: e.target.value})} placeholder="ì¹´í…Œê³ ë¦¬ ì´ë¦„" className="w-full p-3 border rounded dark:bg-slate-700" />
            ) : (
                <>
                    <input type="text" value={modalInputs.name} onChange={e => setModalInputs({...modalInputs, name: e.target.value})} placeholder="ë§í¬ ì´ë¦„" className="w-full p-2 border rounded dark:bg-slate-700" />
                    <input type="text" value={modalInputs.url} onChange={e => setModalInputs({...modalInputs, url: e.target.value})} placeholder="URL" className="w-full p-2 border rounded dark:bg-slate-700" />
                    {linkMode !== 'blogs' && (
                        <div className="flex gap-2">
                            <input type="text" value={modalInputs.icon} onChange={e => setModalInputs({...modalInputs, icon: e.target.value})} placeholder="fa-icon" className="w-1/2 p-2 border rounded dark:bg-slate-700 text-sm" />
                            <input type="text" value={modalInputs.color} onChange={e => setModalInputs({...modalInputs, color: e.target.value})} placeholder="bg-color text-color" className="w-1/2 p-2 border rounded dark:bg-slate-700 text-sm" />
                        </div>
                    )}
                </>
            )}
            <button onClick={() => {
                if (isAddCat) {
                    if(!modalInputs.name) return;
                    if(linkMode === 'blogs') {
                        const newData = {...blogMapData, [modalInputs.name]: []};
                        setBlogMapData(newData); storage.set('myBlogMapData', newData);
                    } else {
                        const newData = {...quickLinks, [modalInputs.name]: []};
                        setQuickLinks(newData); storage.set('myQuickLinks', newData);
                    }
                } else {
                    if(!modalInputs.name || !modalInputs.url) return;
                    const newLink = { name: modalInputs.name, url: modalInputs.url, icon: modalInputs.icon, color: modalInputs.color };
                    if(linkMode === 'blogs') {
                        const newData = {...blogMapData};
                        newData[modalState.category].push(newLink);
                        setBlogMapData(newData); storage.set('myBlogMapData', newData);
                    } else {
                        const newData = {...quickLinks};
                        newData[modalState.category].push(newLink);
                        setQuickLinks(newData); storage.set('myQuickLinks', newData);
                    }
                }
                setModalState({ type: null, category: null });
                setModalInputs({ name: '', url: '', icon: 'fa-link', color: 'bg-slate-100 text-slate-700' });
            }} className="w-full bg-blue-600 text-white py-2 rounded font-bold hover:bg-blue-700 mt-4">ì €ì¥</button>
        </>
    );
  };

  return (
    <div className={`min-h-screen flex flex-col transition-colors duration-200 ${isDark ? 'dark bg-slate-900 text-slate-100' : 'bg-slate-50 text-slate-800'}`}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .dark ::webkit-scrollbar-thumb { background: #475569; }
        .nav-tab.active { background-color: #eff6ff; color: #2563eb; font-weight: 700; box-shadow: 0 1px 2px rgba(37,99,235,0.2); }
        .dark .nav-tab.active { background-color: #1e293b; color: #60a5fa; }
        .mindmap-node-main { background: linear-gradient(135deg, #4f46e5, #3b82f6); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .mindmap-branch { position: relative; }
        .mindmap-line { position: absolute; left: 0; top: 50%; width: 2rem; height: 2px; background: #cbd5e1; z-index: 0; }
        .dark .mindmap-line { background: #475569; }
        .tax-gauge-container { border-radius: 9999px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.06); }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
      `}</style>

      {/* Header */}
      <header className="sticky top-0 z-50 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 shadow-md">
        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="bg-blue-600 text-white p-2 rounded-lg shadow-lg">
              <i className="fa-solid fa-compass text-lg"></i>
            </div>
            <div>
              <h1 className="font-bold text-xl leading-none">Investment Navigator</h1>
              <span className="text-xs text-slate-500 dark:text-slate-400">ë‚˜ë§Œì˜ íˆ¬ì ë¹„ì„œ</span>
            </div>
          </div>
          
          <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-xl overflow-x-auto">
            {['dashboard', 'routine', 'tools', 'tax'].map(tab => (
              <button 
                key={tab} 
                onClick={() => setActiveTab(tab)}
                className={`nav-tab px-4 py-2 text-sm flex items-center gap-2 whitespace-nowrap rounded-lg transition-all ${activeTab === tab ? 'active' : 'text-slate-500 dark:text-slate-400'}`}
              >
                <i className={`fa-solid ${tab === 'dashboard' ? 'fa-chart-bar' : tab === 'routine' ? 'fa-clipboard-list' : tab === 'tools' ? 'fa-calculator' : 'fa-file-invoice-dollar'}`}></i>
                <span className="hidden sm:inline">{tab === 'dashboard' ? 'ëŒ€ì‹œë³´ë“œ' : tab === 'routine' ? 'ë£¨í‹´' : tab === 'tools' ? 'ë„êµ¬' : 'ê¸ˆìœµê³¼ì„¸'}</span>
              </button>
            ))}
          </div>

          <div className="flex items-center gap-4">
            <span className="text-sm font-mono font-bold text-slate-500 hidden md:block">{currentTime}</span>
            <button onClick={() => setIsDark(!isDark)} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
              <i className={`fa-solid ${isDark ? 'fa-sun text-amber-400' : 'fa-moon text-slate-600'}`}></i>
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-7xl w-full mx-auto px-4 py-6 flex-1">
        {activeTab === 'dashboard' && renderDashboard()}
        {activeTab === 'routine' && renderRoutine()}
        {activeTab === 'tools' && renderTools()}
        {activeTab === 'tax' && renderTax()}
      </main>

      {/* --- MODALS --- */}
      {modalState.type && (
          <div className="fixed inset-0 bg-slate-900/70 z-[100] flex items-center justify-center animate-fade-in px-4">
              <div className="bg-white dark:bg-slate-800 rounded-xl w-full max-w-md shadow-2xl overflow-hidden">
                  <div className="p-5 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                      <h3 className="font-bold text-lg text-slate-800 dark:text-white">
                          {modalState.type === 'fav' ? 'ìì£¼ ì°¾ëŠ” ì¢…ëª© ê´€ë¦¬' : modalState.type === 'addCat' ? 'ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€' : 'ìƒˆ ë§í¬ ì¶”ê°€'}
                      </h3>
                      <button onClick={() => setModalState({ type: null, category: null })} className="text-slate-400 hover:text-slate-600"><i className="fa-solid fa-xmark text-xl"></i></button>
                  </div>
                  
                  <div className="p-5 space-y-4 bg-slate-50 dark:bg-slate-900/50">
                      {renderModalContent()}
                  </div>
              </div>
          </div>
      )}
    </div>
  );
}