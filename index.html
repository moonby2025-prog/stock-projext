<!DOCTYPE html>
<html lang="ko" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Navigator Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        
        /* 스크롤바 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .dark ::webkit-scrollbar-thumb { background: #475569; }
        
        /* 메인 네비게이션 탭 */
        .nav-tab {
            position: relative;
            transition: all 0.2s;
            border-radius: 0.5rem;
        }
        .nav-tab.active {
            background-color: #eff6ff;
            color: #2563eb;
            font-weight: 700;
            box-shadow: 0 1px 2px 0 rgba(37, 99, 235, 0.2); 
        }
        .dark .nav-tab.active {
            background-color: #1e293b;
            color: #60a5fa;
             box-shadow: 0 1px 2px 0 rgba(96, 165, 250, 0.3);
        }

        /* 링크 카드 스타일 */
        .link-card {
            transition: all 0.2s;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.08), 0 1px 2px 0 rgba(0, 0, 0, 0.04);
        }
        .link-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
        }
        
        /* 편집 모드 애니메이션 */
        .edit-controls { display: none; animation: fadeIn 0.2s; }
        .editing .edit-controls { display: flex; }
        .editing .link-content { pointer-events: none; opacity: 0.7; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* 숨김 클래스 */
        .page-hidden { display: none !important; }

        /* 히트맵 컨테이너 높이 설정 (모바일 최적화) */
        .market-widget-area { 
            min-height: 200px; /* Mobile min-height for placeholder */
            height: auto; 
        }
        @media (min-width: 768px) {
            .market-widget-area {
                min-height: 600px;
                height: 600px;
            }
        }
        
        /* [NEW] 장운영 정보 배지 스타일 */
        .market-status-badge {
            display: inline-flex; align-items: center; padding: 0.2rem 0.5rem;
            border-radius: 9999px; font-weight: 700; font-size: 0.75rem; line-height: 1;
            transition: all 0.3s;
        }
        
        #market-tools-section {
            background-color: #f7f9fb; border: 1px solid #e2e8f0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .dark #market-tools-section {
            background-color: #0f172a; border: 1px solid #334155;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15); 
        }
        
        .search-input-focus { box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
        
        .pnl-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;
        }
        .pnl-grid > div:first-child {
            border-right: 1px solid #e2e8f0; padding-right: 1.5rem;
        }
        .dark .pnl-grid > div:first-child { border-right: 1px solid #334155; }
        
        .calc-input {
            transition: all 0.2s; padding: 0.75rem; border-radius: 0.75rem;
            text-align: right; font-family: monospace; font-weight: 700; font-size: 1.125rem;
        }
        .calc-input:read-only {
            background-color: #eff6ff; border-color: #bfdbfe; color: #2563eb;
        }
        .dark .calc-input:read-only {
            background-color: #1e3a8a30; border-color: #1d4ed8; color: #93c5fd;
        }
        .calc-input:not(:read-only) {
            background-color: #f8fafc; border-color: #cbd5e1; color: #1e293b;
        }
        .dark .calc-input:not(:read-only) {
            background-color: #334155; border-color: #475569; color: #f8fafc;
        }
        
        .mode-toggle-radio:checked + label {
            background-color: #4f46e5; color: white; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
        }
        .dark .mode-toggle-radio:checked + label { background-color: #6366f1; }

        #div-tab-nav button { transition: all 0.2s; }
        #div-tab-nav button.active-tab {
            background-color: white; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            color: #1e293b; font-weight: 700;
        }
        .dark #div-tab-nav button.active-tab {
            background-color: #0f172a; color: #f8fafc;
        }

        /* 금융소득 계산기 스타일 강화 */
        .tax-gauge-container {
            position: relative; height: 1.5rem; background: #e2e8f0;
            border-radius: 9999px; overflow: hidden; box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.06);
        }
        .dark .tax-gauge-container { background: #334155; }
        
        .tax-gauge-fill {
            height: 100%; transition: width 0.5s ease-out;
            background: linear-gradient(90deg, #4ade80 0%, #22c55e 50%, #f87171 50%, #ef4444 100%);
            background-size: 200% 100%;
            background-position: 0% 0; /* JS로 조절 */
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        
        /* TradingView Widget Containers */
        .tradingview-widget-container { width: 100%; height: 100%; }

        /* Mind Map Style CSS */
        .mindmap-root {
            display: flex; flex-direction: column; gap: 2rem;
        }
        .mindmap-branch {
            display: flex; align-items: flex-start; gap: 1rem; position: relative;
        }
        @media (min-width: 768px) {
            .mindmap-branch { flex-direction: row; align-items: center; }
            .mindmap-line { position: absolute; left: 0; top: 50%; width: 2rem; height: 2px; background: #cbd5e1; z-index: 0; }
        }
        /* Mobile Tree Line Style */
        .mindmap-mobile-line {
            width: 2px; background: #cbd5e1; flex-grow: 1; margin: 0 auto;
        }
        
        .mindmap-node-main {
            z-index: 10; min-width: 140px; text-align: center;
            background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
            color: white; padding: 0.75rem 1rem; border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            font-weight: 700; font-size: 0.95rem; position: relative;
        }
        .dark .mindmap-node-main {
             background: linear-gradient(135deg, #4338ca 0%, #2563eb 100%);
             border: 1px solid #475569;
        }
        
        .mindmap-leaves-container {
            display: flex; flex-wrap: wrap; gap: 0.75rem; flex: 1;
            padding-left: 1rem; border-left: 2px dashed #cbd5e1; margin-left: 1rem;
        }
        @media (min-width: 768px) {
            .mindmap-leaves-container {
                border-left: none; margin-left: 0; padding-left: 0; align-items: center;
            }
        }
        
        .mindmap-leaf {
            background: white; border: 1px solid #e2e8f0; border-radius: 9999px;
            padding: 0.5rem 1rem; font-size: 0.85rem; font-weight: 600;
            color: #475569; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem;
            text-decoration: none; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .dark .mindmap-leaf {
            background: #1e293b; border-color: #334155; color: #cbd5e1;
        }
        .mindmap-leaf:hover {
            transform: translateY(-2px); border-color: #6366f1; color: #4f46e5;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .dark .mindmap-leaf:hover { border-color: #818cf8; color: #a5b4fc; }

        /* Connector for Desktop */
        @media (min-width: 768px) {
            .mindmap-connector {
                width: 2rem; height: 2px; background: #cbd5e1;
            }
            .dark .mindmap-connector { background: #475569; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 transition-colors duration-200 dark:bg-slate-900 dark:text-slate-100 min-h-screen flex flex-col">

    <!-- 상단 헤더 & 네비게이션 -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50 dark:bg-slate-800 dark:border-slate-700 shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 text-white p-2 rounded-lg shadow-xl shadow-blue-500/30">
                        <i class="fa-solid fa-compass text-lg"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-xl tracking-tight leading-none">Investment Navigator</h1>
                        <span class="text-xs text-slate-500 dark:text-slate-400">나만의 투자 비서</span>
                    </div>
                </div>
                
                <!-- 중앙 네비게이션 탭 -->
                <div class="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-xl overflow-x-auto max-w-[50vw] sm:max-w-none">
                    <button onclick="switchPage('dashboard')" id="nav-dashboard" class="nav-tab active px-4 py-2 text-sm flex items-center gap-2 whitespace-nowrap">
                        <i class="fa-solid fa-chart-bar"></i> 대시보드
                    </button>
                    <!-- [수정] 오늘의 루틴 -> 루틴 -->
                    <button onclick="switchPage('routine')" id="nav-routine" class="nav-tab px-4 py-2 text-sm flex items-center gap-2 whitespace-nowrap">
                        <i class="fa-solid fa-clipboard-list"></i> 루틴
                    </button>
                    <!-- [수정] 도구/계산기 -> 도구 -->
                    <button onclick="switchPage('tools')" id="nav-tools" class="nav-tab px-4 py-2 text-sm flex items-center gap-2 whitespace-nowrap">
                        <i class="fa-solid fa-calculator"></i> 도구
                    </button>
                    <!-- [수정] 금융소득종합과세 -> 금융과세 -->
                    <button onclick="switchPage('tax')" id="nav-tax" class="nav-tab px-4 py-2 text-sm flex items-center gap-2 whitespace-nowrap">
                        <i class="fa-solid fa-file-invoice-dollar"></i> 금융과세
                    </button>
                </div>

                <div class="flex items-center gap-4">
                    <span id="current-time" class="text-sm font-mono font-bold text-slate-500 dark:text-slate-400 hidden md:block"></span>
                    <button onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">
                        <i id="theme-icon" class="fa-solid fa-moon text-slate-600"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl w-full mx-auto px-4 py-6 flex-1">
        
        <!-- PAGE 1: 통합 대시보드 (루틴 섹션 제거) -->
        <div id="page-dashboard" class="space-y-6 animate-fade-in">
            
            <!-- 3. 장중 증시 상황 (Ticker Tape Widget) -->
            <!-- 주의: KRX 데이터는 로컬 파일(file://) 실행 시 차단될 수 있으며, Vercel에서도 종종 문제가 발생합니다. -->
            <div class="w-full bg-white dark:bg-slate-800 rounded-xl shadow-md border border-slate-200 dark:border-slate-700 overflow-hidden h-14">
                <div class="tradingview-widget-container">
                    <div id="ticker-tape-container"></div>
                </div>
            </div>

             <!-- 메인 히트맵 섹션 -->
            <div id="market-analysis-section" class="flex flex-col">
                <div class="bg-white p-1 rounded-xl shadow-xl border border-slate-200 dark:bg-slate-800 dark:border-slate-700 flex-1 flex flex-col">
                    <div class="p-3 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800 rounded-t-xl">
                        <div class="flex items-center gap-3">
                            <h2 class="text-lg font-bold flex items-center gap-2 text-slate-700 dark:text-slate-300">
                                <i id="main-widget-icon" class="fa-solid fa-fire text-red-500"></i> 
                                <span id="main-widget-title">S&P 500 히트맵</span>
                                <!-- [NEW] 장운영 정보 배지 추가 -->
                                <span id="market-status-badge" class="market-status-badge bg-slate-500 text-white ml-2">상태 확인 중</span>
                                <!-- [NEW] 장운영 사유 추가 -->
                                <span id="market-status-reason" class="text-sm font-medium text-slate-500 dark:text-slate-400 ml-2"></span> 
                                <span id="widget-update-time" class="text-xs font-normal text-slate-400 dark:text-slate-500 ml-2"></span>
                            </h2>
                        </div>
                        <div class="flex gap-2">
                             <!-- KRX Heatmap 링크는 유지 -->
                             <a href="https://kr.tradingview.com/heatmap/stock/#%7B%22dataSource%22%3A%22KOSPI200%22%2C%22blockColor%22%3A%22change%22%2C%22blockSize%22%3A%22market_cap_basic%22%2C%22grouping%22%3A%22sector%22%7D" target="_blank" class="flex items-center gap-1 bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 hover:text-blue-600 text-xs font-bold px-3 py-1.5 rounded-lg shadow-sm transition-all dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300 dark:hover:text-blue-400">KOSPI 200 <i class="fa-solid fa-arrow-up-right-from-square text-[10px]"></i></a>
                             <a href="https://kr.tradingview.com/heatmap/stock/#%7B%22dataSource%22%3A%22KOSDAQ150%22%2C%22blockColor%22%3A%22change%22%2C%22blockSize%22%3A%22market_cap_basic%22%2C%22grouping%22%3A%22sector%22%7D" target="_blank" class="flex items-center gap-1 bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 hover:text-blue-600 text-xs font-bold px-3 py-1.5 rounded-lg shadow-sm transition-all dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300 dark:hover:text-blue-400">KOSDAQ 150 <i class="fa-solid fa-arrow-up-right-from-square text-[10px]"></i></a>
                        </div>
                    </div>
                    
                    <div id="main-widget-area" class="w-full market-widget-area relative bg-slate-100 dark:bg-slate-900 rounded-b-xl overflow-hidden">
                        <!-- PC 환경(md 이상)에서만 표시되는 Heatmap -->
                        <div id="heatmap-container" class="tradingview-widget-container hidden md:block">
                            <div class="tradingview-widget-container__widget"></div>
                        </div>
                        <!-- 모바일 환경(md 미만)에서만 표시되는 간이 요약 -->
                        <div id="mobile-market-summary" class="md:hidden p-4 bg-slate-50 dark:bg-slate-900/50 min-h-[200px] flex items-center justify-center">
                            <div class="text-center space-y-2">
                                <i class="fa-solid fa-mobile-screen-button text-4xl text-indigo-400"></i>
                                <p class="font-bold text-slate-600 dark:text-slate-300">화면 크기로 인해 히트맵은 미표시</p>
                                <p class="text-xs text-slate-400">데스크톱 환경에서 전체 시장 히트맵을 확인하실 수 있습니다.</p>
                                <a href="https://kr.tradingview.com/markets/stocks-all/heat-map/" target="_blank" class="text-indigo-500 hover:text-indigo-600 text-sm font-medium inline-block mt-2"><i class="fa-solid fa-arrow-up-right-from-square text-[10px] mr-1"></i> TradingView에서 전체보기</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="market-tools-section" class="rounded-xl shadow-xl border-slate-200 dark:border-slate-700 mt-0 p-5">
                <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-magnifying-glass-chart text-indigo-500"></i> 간편 종목 검색</h3>
                <div class="flex">
                    <div class="relative flex-1">
                        <input type="text" id="symbol-search-input" placeholder="종목 코드 (예: 005930) 또는 종목명 (예: 삼성전자)" class="w-full p-3 pl-12 border-2 border-indigo-300 dark:border-indigo-600 rounded-l-lg dark:bg-slate-700 dark:text-white transition-all duration-200 focus:outline-none focus:border-indigo-500 search-input-focus" onkeypress="if(event.key==='Enter') searchSymbolFromInput()">
                        <i class="fa-solid fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-indigo-500"></i>
                    </div>
                    <button onclick="searchSymbolFromInput()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-r-lg text-sm font-bold transition-colors shadow-md"><i class="fa-solid fa-arrow-right-to-bracket mr-1"></i> 이동</button>
                    <button onclick="openFavoriteSymbolsModal()" title="자주 찾는 종목 관리" class="ml-2 bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-800 dark:text-slate-200 p-3 rounded-lg text-lg font-bold transition-colors shadow-md"><i class="fa-solid fa-gear"></i></button>
                </div>
                <div id="favorite-symbols-container" class="mt-4 pt-4 border-t border-slate-300 dark:border-slate-700">
                    <span class="text-sm font-bold text-slate-600 dark:text-slate-300 mb-2 block">자주 찾는 종목 (클릭 시 즉시 검색)</span>
                    <div id="favorite-symbols-list" class="flex flex-wrap gap-2 max-h-[120px] overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <!-- PAGE 2: 오늘의 루틴/링크 (분리된 탭) -->
        <div id="page-routine" class="page-hidden space-y-6 animate-fade-in">
             <div id="quick-links-section" class="space-y-6 pt-4 border-t border-slate-200 dark:border-slate-700">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-end mb-6 pt-4 pb-4">
                    <div class="flex flex-col sm:flex-row sm:items-end sm:gap-4">
                        <h2 class="text-2xl font-extrabold text-slate-800 dark:text-white mb-1 leading-tight">오늘의 루틴 목록</h2>
                        <div class="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-xl shadow-inner mt-2 sm:mt-0" id="link-mode-switch">
                            <button onclick="switchLinkMode('investment')" id="mode-investment" class="nav-tab active px-3 py-1.5 text-xs font-bold rounded-lg transition-all text-slate-600 dark:text-slate-300"><i class="fa-solid fa-chart-line mr-1"></i> 투자</button>
                            <button onclick="switchLinkMode('blogs')" id="mode-blogs" class="nav-tab px-3 py-1.5 text-xs font-bold rounded-lg transition-all text-slate-600 dark:text-slate-300"><i class="fa-solid fa-sitemap mr-1"></i> 인사이트 맵</button>
                            <button onclick="switchLinkMode('daily')" id="mode-daily" class="nav-tab px-3 py-1.5 text-xs font-bold rounded-lg transition-all text-slate-600 dark:text-slate-300"><i class="fa-solid fa-home mr-1"></i> 일상</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 mt-4 sm:mt-0">
                        <span class="text-sm font-bold text-slate-600 dark:text-slate-300">편집 모드</span>
                        <button onclick="toggleEditMode()" id="edit-mode-btn" class="w-12 h-6 bg-slate-300 rounded-full relative transition-colors duration-200">
                            <div class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-transform duration-200 shadow-sm" id="edit-mode-knob"></div>
                        </button>
                    </div>
                </div>
                <!-- REMOVED: 새 카테고리/주제 추가 버튼 (편집 모드 시 노출) - 이제 목록 내부에서 처리 -->
                <div id="home-links-container" class="min-h-[300px]"></div>
            </div>
        </div>

        <!-- PAGE 3: 도구 (계산기 모음) -->
        <div id="page-tools" class="page-hidden">
             <!-- (기존 공모주, 평단가, 환율, 배당금, 손익, 목표단가 계산기 유지) -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6"> 
                <!-- 1. 공모주/스팩 계산기 -->
                <div class="bg-white rounded-2xl border-2 border-purple-200 shadow-lg dark:bg-slate-800 dark:border-purple-900 overflow-hidden">
                    <div class="p-4 bg-purple-50 dark:bg-purple-900/20 border-b border-purple-100 dark:border-slate-700"><h3 class="font-bold text-purple-800 dark:text-purple-200 flex items-center gap-2"><i class="fa-solid fa-piggy-bank"></i> 공모주/스팩 청약</h3></div>
                    <div class="p-6 space-y-4">
                        <div class="flex items-center justify-between"><label class="text-sm font-medium text-slate-500 w-20 dark:text-slate-400">종류</label><select id="ipo-type" onchange="calculateIPO()" class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg text-sm font-bold dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-purple-500 focus:ring-2 focus:ring-purple-200"><option value="0.5">일반 공모주 (50%)</option><option value="1.0">스팩 (SPAC) (100%)</option></select></div>
                        <div class="flex items-center justify-between"><label class="text-sm font-medium text-slate-500 w-20 dark:text-slate-400">공모가</label><input type="number" id="ipo-price" placeholder="예: 2000" class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg text-right dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-purple-500 focus:ring-2 focus:ring-purple-200" oninput="calculateIPO()"></div>
                        <div class="flex items-center justify-between"><label class="text-sm font-medium text-slate-500 w-20 dark:text-slate-400">최소수량</label><input type="number" id="ipo-qty" placeholder="보통 10주" value="10" class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg text-right dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-purple-500 focus:ring-2 focus:ring-purple-200" oninput="calculateIPO()"></div>
                        <div class="flex items-center justify-between"><label class="text-sm font-medium text-slate-500 w-20 dark:text-slate-400">인원수</label><input type="number" id="ipo-people" placeholder="계좌 수" value="1" class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg text-right dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-purple-500 focus:ring-2 focus:ring-purple-200" oninput="calculateIPO()"></div>
                        <div class="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700 text-right bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg"><span id="ipo-rate-text" class="text-xs text-slate-400 mr-1 block mb-1">(증거금률 50%)</span><div class="flex justify-between items-center"><span class="text-sm text-slate-500 dark:text-slate-400">필요 현금:</span><div><span id="ipo-result" class="font-mono text-2xl font-extrabold text-purple-600 dark:text-purple-300">0</span> <span class="text-sm font-bold dark:text-white">원</span></div></div></div>
                    </div>
                </div>
                <!-- 2. 평단가 계산기 -->
                <div class="bg-white rounded-2xl border-2 border-green-200 shadow-lg dark:bg-slate-800 dark:border-green-900 overflow-hidden">
                    <div class="p-4 bg-green-50 dark:bg-green-900/20 border-b border-green-100 dark:border-slate-700 flex justify-between items-center"><h3 class="font-bold text-green-800 dark:text-green-200 flex items-center gap-2"><i class="fa-solid fa-scale-balanced"></i> 평단가 계산기</h3><button onclick="addPurchaseRow()" class="text-xs bg-white text-green-600 px-3 py-1.5 rounded-lg border border-green-300 hover:bg-green-100 dark:bg-green-900/50 dark:text-green-300 dark:border-green-700 dark:hover:bg-green-800 transition-all font-bold shadow-md"><i class="fa-solid fa-plus text-xs mr-1"></i> 추가</button></div>
                    <div class="p-6">
                        <div class="flex justify-between text-xs text-slate-400 mb-2 px-1"><span>수량</span><span>매수 단가</span></div>
                        <div id="average-calculator-inputs" class="space-y-2 mb-4 max-h-[250px] overflow-y-auto"></div>
                        <div class="pt-4 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg"><div class="flex justify-between items-center"><span class="text-sm text-slate-500 dark:text-slate-400">평균 단가:</span><div><span id="average-price" class="font-mono text-2xl font-extrabold text-green-600 dark:text-green-400">-</span> <span class="text-sm text-slate-400">원</span></div></div></div>
                    </div>
                </div>
                <!-- 3. 환율 계산기 -->
                <div class="bg-white rounded-2xl border-2 border-blue-200 shadow-lg dark:bg-slate-800 dark:border-blue-900 overflow-hidden">
                    <div class="p-4 bg-blue-50 dark:bg-blue-900/20 border-b border-blue-100 dark:border-slate-700"><h3 class="font-bold text-blue-800 dark:text-blue-200 flex items-center gap-2"><i class="fa-solid fa-money-bill-transfer"></i> 환율 계산기</h3></div>
                    <div class="p-6 space-y-4">
                        <div class="flex items-center gap-2"><select id="calc-currency-select" onchange="updateExchangeUI()" class="w-40 p-3 border border-slate-300 rounded-xl bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-white text-sm font-bold focus:border-blue-500 focus:ring-2 focus:ring-blue-200"><option value="USD">USD (미국 달러)</option><option value="KRW">KRW (원화)</option><option value="JPY">JPY (일본 엔)</option><option value="CNY">CNY (중국 위안)</option><option value="EUR">EUR (유로)</option><option value="VND">VND (베트남 동)</option><option value="THB">THB (태국 바트)</option><option value="PHP">PHP (필리핀 페소)</option><option value="INR">INR (인도 루피)</option><option value="ARS">ARS (아르헨티나 페소)</option></select><div class="flex-1 relative"><input type="number" id="calc-input-foreign" placeholder="외화 입력" oninput="calculateExchange('foreign')" class="w-full calc-input pr-10" value="0"><span id="foreign-unit" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-sm text-slate-400 dark:text-slate-500 pointer-events-none">USD</span></div></div>
                        <div class="flex items-center gap-2"><div id="calc-bottom-unit-container" class="w-40 flex items-center justify-center"><span id="krw-label" class="text-sm font-bold text-slate-500 dark:text-slate-400">KRW (원화)</span><select id="calc-target-currency-select" onchange="calculateExchange('krw')" class="hidden p-2.5 w-full bg-slate-50 border border-slate-300 rounded-xl text-sm font-bold dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-blue-500 focus:ring-2 focus:ring-blue-200"></select></div><div class="flex-1 relative"><input type="text" id="calc-input-krw" placeholder="원화 입력" oninput="calculateExchange('krw')" class="w-full calc-input pr-10" value=""><span id="krw-output-unit" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-sm text-slate-400 dark:text-slate-500 pointer-events-none">원</span></div></div>
                        <p class="text-[10px] text-slate-400 text-center mt-2" id="exchange-rate-note">* 대략적인 기준 환율 적용 (실시간 환율 아님)</p>
                    </div>
                </div>
                <!-- 4. 배당금 계산기 -->
                <div class="bg-white rounded-2xl border-2 border-amber-200 shadow-lg dark:bg-slate-800 dark:border-amber-900 overflow-hidden">
                    <div class="p-4 bg-amber-50 dark:bg-amber-900/20 border-b border-amber-100 dark:border-slate-700"><h3 class="font-bold text-amber-800 dark:text-amber-200 flex items-center gap-2"><i class="fa-solid fa-sack-dollar"></i> 배당금 계산기</h3></div>
                    <div class="p-3 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800"><div id="div-tab-nav" class="flex space-x-1 bg-slate-200 dark:bg-slate-700 rounded-lg p-1"><button id="tab-kor" onclick="switchDividendMode('KOR')" class="flex-1 py-1.5 text-sm font-bold rounded-lg transition-all text-slate-700 dark:text-slate-200 bg-white shadow dark:bg-slate-900 active-tab">국내 주식 (KOR)</button><button id="tab-us" onclick="switchDividendMode('US')" class="flex-1 py-1.5 text-sm font-bold rounded-lg transition-all text-slate-600 dark:text-slate-300">해외 주식 (US)</button></div></div>
                    <div id="dividend-tab-content">
                        <div id="div-content-kor" class="p-6 space-y-4"><p class="text-xs text-slate-400 mb-4 bg-slate-100 dark:bg-slate-700 p-2 rounded-lg italic">* 국내 주식은 원화를 기준으로 계산합니다.</p><div class="flex items-center justify-between"><label class="text-sm font-medium text-slate-500 w-20 dark:text-slate-400">주식 수</label><input type="number" id="div-shares-kor" placeholder="100" class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg text-right dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-amber-500 focus:ring-2 focus:ring-amber-200" oninput="calculateDividend()"></div><div class="flex items-center justify-between"><label class="text-sm font-medium text-slate-500 w-20 dark:text-slate-400">주당 배당금 (원)</label><input type="number" id="div-per-share-kor" placeholder="500" class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg text-right dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-amber-500 focus:ring-2 focus:ring-amber-200" oninput="calculateDividend()"></div><div class="flex items-center justify-between"><label class="text-sm font-medium text-slate-500 w-20 dark:text-slate-400" id="div-tax-label-kor">세율 (%)</label><input type="number" id="div-tax-rate-kor" placeholder="15.4" value="15.4" class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg text-right dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-amber-500 focus:ring-2 focus:ring-amber-200" oninput="calculateDividend()"></div></div>
                        <div id="div-content-us" class="p-6 space-y-4 hidden"><p class="text-xs text-red-400 mb-4 bg-red-50 dark:bg-red-900/20 p-2 rounded-lg italic">* 해외 주식은 USD를 기준으로 계산합니다.</p><div class="flex items-center justify-between"><label class="text-sm font-medium text-slate-500 w-20 dark:text-slate-400">주식 수</label><input type="number" id="div-shares-us" placeholder="100" class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg text-right dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-amber-500 focus:ring-2 focus:ring-amber-200" oninput="calculateDividend()"></div><div class="flex items-center justify-between"><label class="text-sm font-medium text-slate-500 w-20 dark:text-slate-400">주당 배당금 (USD)</label><input type="number" id="div-per-share-us" placeholder="1.50" class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg text-right dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-amber-500 focus:ring-2 focus:ring-amber-200" oninput="calculateDividend()" step="0.01"></div><div class="flex items-center justify-between"><label class="text-sm font-medium text-slate-500 w-20 dark:text-slate-400" id="div-tax-label-us">세율 (%)</label><input type="number" id="div-tax-rate-us" placeholder="15.0" value="15.0" class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg text-right dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-amber-500 focus:ring-2 focus:ring-amber-200" oninput="calculateDividend()" step="0.1"></div></div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700 text-right bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg"><div class="flex justify-between items-center mb-1"><span class="text-xs text-slate-500 dark:text-slate-400">총 배당금 (세전):</span><span id="div-gross" class="font-mono text-base font-bold text-amber-600 dark:text-amber-400">0원</span></div><div class="flex justify-between items-center"><span class="text-sm text-slate-700 dark:text-slate-200">실수령액 (세후):</span><div><span id="div-net-result-value" class="font-mono text-2xl font-extrabold text-amber-700 dark:text-amber-300">0</span> <span id="div-net-result-unit" class="text-sm font-bold dark:text-white">원</span></div></div></div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6 mt-6"> 
                <!-- 5. 손익 분석 (P&L) 계산기 -->
                <div class="bg-white rounded-2xl border-2 border-red-200 shadow-lg dark:bg-slate-800 dark:border-red-900 overflow-hidden">
                    <div class="p-4 bg-red-50 dark:bg-red-900/20 border-b border-red-100 dark:border-slate-700"><h3 class="font-bold text-red-800 dark:text-red-200 flex items-center gap-2"><i class="fa-solid fa-percent"></i> 실현 손익 & 수익률 (P&L)</h3></div>
                    <div class="pnl-grid p-6">
                        <div class="space-y-4"><div class="flex items-center justify-between"><label class="text-sm font-medium text-slate-500 w-24 dark:text-slate-400">총 매수 금액</label><input type="number" id="pl-buy-cost" placeholder="매수 비용" class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg text-right dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-red-500 focus:ring-2 focus:ring-red-200" oninput="calculatePnL()"></div><div class="flex items-center justify-between"><label class="text-sm font-medium text-slate-500 w-24 dark:text-slate-400">총 매도 금액</label><input type="number" id="pl-sell-revenue" placeholder="매도 금액" class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg text-right dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-red-500 focus:ring-2 focus:ring-red-200" oninput="calculatePnL()"></div><div class="flex items-center justify-between"><label class="text-sm font-medium text-slate-500 w-24 dark:text-slate-400">총 수수료율(%)</label><input type="number" id="pl-fee-rate" placeholder="0.3" value="0.3" step="0.01" class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg text-right dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-red-500 focus:ring-2 focus:ring-red-200" oninput="calculatePnL()"></div><div class="flex justify-between items-center pt-2 border-t border-slate-100 dark:border-slate-700"><span class="text-sm text-slate-500 dark:text-slate-400">총 수수료/세금:</span><span id="pl-fee-total" class="font-mono text-base font-bold text-slate-600 dark:text-slate-300">0원</span></div></div>
                        <div class="flex flex-col justify-center items-center space-y-4"><div class="text-center"><span class="text-sm text-slate-500 dark:text-slate-400 block mb-1">순 실현 손익 (세후/수수료 후)</span><span id="pl-profit-loss" class="font-mono text-4xl font-extrabold text-green-700 dark:text-green-300">-</span></div><div class="text-center"><span class="text-sm text-slate-500 dark:text-slate-400 block mb-1">순 수익률</span><span id="pl-return-rate" class="font-mono text-3xl font-bold text-green-700 dark:text-green-300">-</span> <span class="text-lg font-bold">%</span></div></div>
                    </div>
                </div>
                <!-- 6. 목표 단가 분석 -->
                <div class="bg-white rounded-2xl border-2 border-indigo-200 shadow-lg dark:bg-slate-800 dark:border-indigo-900 overflow-hidden">
                    <div class="p-4 bg-indigo-50 dark:bg-indigo-900/20 border-b border-indigo-100 dark:border-slate-700"><h3 class="font-bold text-indigo-800 dark:text-indigo-200 flex items-center gap-2"><i class="fa-solid fa-bullseye"></i> 목표 단가 & 가치 분석</h3></div>
                    <div class="p-6 space-y-4">
                        <div class="flex justify-center mb-4 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg"><input type="radio" id="mode-cap" name="target-mode" value="cap" class="mode-toggle-radio hidden" onchange="toggleTargetMode('cap')" checked><label for="mode-cap" class="flex-1 text-center py-1.5 text-sm font-bold rounded-lg cursor-pointer transition-colors">시가총액 기반</label><input type="radio" id="mode-rate" name="target-mode" value="rate" class="mode-toggle-radio hidden" onchange="toggleTargetMode('rate')"><label for="mode-rate" class="flex-1 text-center py-1.5 text-sm font-bold rounded-lg cursor-pointer transition-colors">수익률 기반</label></div>
                        <div class="space-y-3"><div class="flex items-center justify-between"><label id="current-price-label" class="text-sm font-medium text-slate-500 w-32 dark:text-slate-400">현재가 (매수가)</label><input type="number" id="target-current-price" placeholder="현재 주가" class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg text-right dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" oninput="calculateTargetAnalysis()"></div><div class="flex items-center justify-between"><label class="text-sm font-medium text-slate-500 w-32 dark:text-slate-400">보유 수량</label><input type="number" id="target-shares" placeholder="보유 주식 수" class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg text-right dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" oninput="calculateTargetAnalysis()"></div></div>
                        <div id="target-input-current-cap-row" class="flex items-center justify-between space-y-3"><label class="text-sm font-medium text-slate-500 w-32 dark:text-slate-400">현재 시가총액 (조)</label><input type="number" id="target-current-cap" placeholder="예: 350.00" step="0.01" class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg text-right dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" oninput="calculateTargetAnalysis()"></div>
                        <div id="target-cap-input-row" class="flex items-center justify-between"><label class="text-sm font-medium text-slate-500 w-32 dark:text-slate-400">목표 시가총액 (조)</label><input type="number" id="target-cap" placeholder="예: 500.00" step="0.01" class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg text-right dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" oninput="calculateTargetAnalysis()"></div>
                        <div id="target-return-rate-input-row" class="flex items-center justify-between hidden">
                            <!-- [수정] 목표 수익률 입력 필드의 레이블에 ID 추가 -->
                            <label id="target-rate-input-label" class="text-sm font-medium text-slate-500 w-32 dark:text-slate-400">목표 수익률 (%)</label>
                            <input type="number" id="target-return-rate" placeholder="예: 20" class="flex-1 p-2.5 bg-slate-50 border border-slate-300 rounded-lg text-right dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200" oninput="calculateTargetAnalysis()">
                        </div>
                        <div class="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700 space-y-3 bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg"><div class="flex justify-between items-center"><span id="target-price-label" class="text-sm text-slate-700 dark:text-slate-200 font-bold">목표 단가:</span><div><span id="target-price" class="font-mono text-2xl font-extrabold text-indigo-700 dark:text-indigo-300">0원</span></div></div><div class="flex justify-between items-center"><span class="text-sm text-slate-500 dark:text-slate-400">총 평가 금액:</span><div><span id="target-valuation" class="font-mono text-base font-bold text-indigo-700 dark:text-indigo-300">0</span><span class="text-sm text-slate-400">원</span></div></div><div class="flex justify-between items-center"><span class="text-sm text-slate-500 dark:text-slate-400">예상 수익금:</span><div><span id="target-profit" class="font-mono text-base font-bold text-green-700 dark:text-green-300">0</span><span class="text-sm text-slate-400">원</span></div></div><div id="target-rate-row" class="flex justify-between items-center"><span class="text-xs text-slate-500 dark:text-slate-400">시총/수익률 변화:</span><span id="target-rate" class="font-mono text-sm font-bold text-slate-600 dark:text-slate-300">0.00%</span></div></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PAGE 4: 금융소득 종합과세 전용 페이지 -->
        <div id="page-tax" class="page-hidden mt-6 animate-fade-in pb-6">
            <!-- 1. 상단 요약 카드 (3열) -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- 금융소득 합계 -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 relative overflow-hidden group">
                    <div class="absolute right-0 top-0 w-24 h-24 bg-blue-50 dark:bg-blue-900/30 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                    <p class="text-sm text-slate-500 dark:text-slate-400 font-medium relative z-10">연간 금융소득 합계</p>
                    <h3 class="text-3xl font-bold text-slate-800 dark:text-white mt-2 relative z-10" id="summary-fin-total">0 원</h3>
                    <p class="text-xs text-slate-400 mt-1 relative z-10">이자 + 배당 소득</p>
                    <div id="badge-tax-type" class="inline-block mt-4 px-3 py-1 bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 text-xs font-bold rounded-full">
                        계산 대기 중
                    </div>
                </div>

                <!-- 기타소득 합계 -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 relative overflow-hidden group">
                    <div class="absolute right-0 top-0 w-24 h-24 bg-emerald-50 dark:bg-emerald-900/30 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                    <p class="text-sm text-slate-500 dark:text-slate-400 font-medium relative z-10">연간 기타소득 금액 합계</p>
                    <h3 class="text-3xl font-bold text-slate-800 dark:text-white mt-2 relative z-10" id="summary-other-total">0 원</h3>
                    <p class="text-xs text-slate-400 mt-1 relative z-10">총수입 - 필요경비</p>
                    <div class="mt-4 h-6"></div> 
                </div>

                <!-- 총 종합소득 -->
                <div class="bg-slate-800 dark:bg-slate-700 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden border border-slate-700 dark:border-slate-600">
                    <div class="absolute -right-6 -bottom-6 text-slate-700 dark:text-slate-800 opacity-30">
                        <i class="fa-solid fa-won-sign text-9xl"></i>
                    </div>
                    <p class="text-sm text-slate-400 font-medium">총 합산 소득 (종합과세 기준)</p>
                    <h3 class="text-3xl font-bold text-white mt-2" id="summary-grand-total">0 원</h3>
                    <div class="mt-4 pt-4 border-t border-slate-700 dark:border-slate-600 flex justify-between items-center text-xs text-slate-400">
                        <span>* 2천만원 초과 금융소득 포함</span>
                        <span id="tax-flag" class="text-emerald-400 hidden"><i class="fa-solid fa-check"></i> 합산대상</span>
                    </div>
                </div>
            </div>
            
            <!-- 2. 입력 섹션 (좌우 2열 배치) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- [Left] 금융소득 상세 -->
                <section class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col h-auto">
                    <div class="p-5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50 rounded-t-2xl">
                        <h3 class="font-bold text-lg text-slate-700 dark:text-slate-200 flex items-center">
                            <span class="w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400 flex items-center justify-center mr-3 text-sm"><i class="fa-solid fa-coins"></i></span>
                            금융소득 상세
                        </h3>
                         <button onclick="resetFinancial()" class="text-xs text-slate-400 hover:text-red-500 transition"><i class="fa-solid fa-rotate-left mr-1"></i>초기화</button>
                    </div>
                    <div class="p-5 bg-slate-50 dark:bg-slate-800/50 border-b border-slate-100 dark:border-slate-700 space-y-3">
                        <div class="flex gap-2">
                            <select id="fin-type" class="w-24 p-2.5 text-sm border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-700 dark:text-white">
                                <option value="이자">이자</option>
                                <option value="배당">배당</option>
                            </select>
                            <input type="text" id="fin-desc" placeholder="내용 (예: 예금)" class="flex-1 p-2.5 text-sm border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-700 dark:text-white">
                        </div>
                        <div class="flex gap-2">
                             <div class="relative flex-1">
                                <input type="number" id="fin-amount" placeholder="금액 입력" class="w-full p-2.5 pl-3 pr-8 text-sm border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-right font-bold text-slate-700 dark:text-white bg-white dark:bg-slate-700" onkeypress="if(event.key==='Enter') addFinancial()">
                                <span class="absolute right-3 top-2.5 text-xs text-slate-400">원</span>
                            </div>
                            <button onclick="addFinancial()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 rounded-lg text-sm font-bold transition shadow-sm">추가</button>
                        </div>
                    </div>
                     <!-- 리스트 영역: 내용에 따라 자연스럽게 늘어남 -->
                     <div class="p-2"> 
                        <table class="w-full text-sm text-left text-slate-600 dark:text-slate-300">
                             <tbody id="fin-list-body" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                        </table>
                    </div>
                </section>
                <!-- [Right] 기타소득 상세 -->
                <section class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 flex flex-col h-auto">
                     <div class="p-5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50 rounded-t-2xl">
                        <h3 class="font-bold text-lg text-slate-700 dark:text-slate-200 flex items-center">
                            <span class="w-8 h-8 rounded-lg bg-emerald-100 dark:bg-emerald-900/50 text-emerald-600 dark:text-emerald-400 flex items-center justify-center mr-3 text-sm"><i class="fa-solid fa-file-invoice-dollar"></i></span>
                            기타소득 상세
                        </h3>
                        <button onclick="resetOther()" class="text-xs text-slate-400 hover:text-red-500 transition"><i class="fa-solid fa-rotate-left mr-1"></i>초기화</button>
                    </div>
                     <div class="p-5 bg-slate-50 dark:bg-slate-800/50 border-b border-slate-100 dark:border-slate-700 space-y-3">
                         <input type="text" id="other-desc" placeholder="내용" class="w-full p-2.5 text-sm border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 dark:text-white">
                         <div class="grid grid-cols-2 gap-3">
                             <input type="number" id="other-revenue" placeholder="수입" class="w-full p-2.5 text-sm border border-slate-300 dark:border-slate-600 rounded-lg text-right bg-white dark:bg-slate-700 dark:text-white">
                             <input type="number" id="other-expense" placeholder="경비" class="w-full p-2.5 text-sm border border-slate-300 dark:border-slate-600 rounded-lg text-right bg-white dark:bg-slate-700 dark:text-white" onkeypress="if(event.key==='Enter') addOther()">
                         </div>
                         <button onclick="addOther()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-2.5 rounded-lg text-sm font-bold transition shadow-sm">추가</button>
                     </div>
                      <!-- 리스트 영역: 내용에 따라 자연스럽게 늘어남 -->
                      <div class="p-2">
                        <table class="w-full text-sm text-left text-slate-600 dark:text-slate-300">
                             <tbody id="other-list-body" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                        </table>
                    </div>
                </section>
            </div>
            
            <!-- 3. 세금 결과 UI (아래 배치 - Full Width) -->
             <div class="flex flex-col lg:flex-row gap-6 mb-6">
                 <div class="flex-1 bg-white rounded-2xl border-2 border-cyan-200 shadow-lg dark:bg-slate-800 dark:border-cyan-900 p-6">
                      <h3 class="text-xl font-bold text-cyan-800 dark:text-cyan-200 mb-4 flex items-center gap-2"><i class="fa-solid fa-calculator"></i> 예상 납부 세액 결과</h3>
                      
                      <!-- [NEW] 직관적인 게이지바 섹션 -->
                      <div class="py-6 border-t border-slate-100 dark:border-slate-700">
                           <div class="flex justify-between text-xs text-slate-400 mb-1 font-bold">
                                <span>0</span>
                                <span class="text-red-500">2,000만 원 (기준)</span>
                                <span>4,000만 원</span>
                           </div>
                           <div class="tax-gauge-container h-6 bg-slate-100 dark:bg-slate-700 rounded-full relative overflow-visible">
                                <div id="tax-progress-bar" class="absolute top-0 left-0 h-full rounded-full transition-all duration-500 ease-out" style="width: 0%; background: linear-gradient(90deg, #4ade80, #22c55e);"></div>
                                <!-- 기준선 마커 -->
                                <div class="absolute top-0 bottom-0 w-0.5 bg-red-500 z-10" style="left: 50%; transform: translateX(-50%); height: 140%; top: -20%;"></div>
                           </div>
                           <div id="tax-status-msg" class="text-center mt-3 text-sm font-bold text-slate-500">
                                아직 데이터가 없습니다.
                           </div>
                      </div>

                      <!-- [NEW] 상세 계산 내역 (영수증 스타일) -->
                      <div class="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-5 border border-slate-200 dark:border-slate-600 space-y-3">
                           <div class="flex justify-between text-sm items-center">
                               <span class="text-slate-600 dark:text-slate-400"><i class="fa-solid fa-circle text-[8px] mr-2 text-green-500"></i>분리과세 (15.4%)</span>
                               <span id="tax-step-1-val" class="font-mono font-bold text-slate-800 dark:text-white">0 원</span>
                           </div>
                           <div class="flex justify-between text-sm items-center">
                               <span class="text-slate-600 dark:text-slate-400"><i class="fa-solid fa-circle text-[8px] mr-2 text-red-500"></i>종합과세 (누진세율)</span>
                               <span id="tax-step-2-val" class="font-mono text-xs font-bold text-slate-800 dark:text-white">0 원</span>
                           </div>
                           <div class="border-t border-dashed border-slate-300 dark:border-slate-600 my-2"></div>
                           <div class="flex justify-between items-end">
                               <span class="font-bold text-lg text-slate-800 dark:text-slate-200">총 예상 세금</span>
                               <span id="tax-total-result" class="font-mono text-3xl font-extrabold text-cyan-700 dark:text-cyan-300">0 원</span>
                           </div>
                      </div>

                      <!-- [NEW] 건강보험료 경고 박스 -->
                      <div id="health-warning" class="hidden mt-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 flex items-start gap-3 animate-fade-in">
                          <i class="fa-solid fa-triangle-exclamation text-red-500 mt-1"></i>
                          <div>
                              <h4 class="font-bold text-red-700 dark:text-red-300 text-sm">건강보험 피부양자 자격 박탈 주의</h4>
                              <p class="text-xs text-red-600 dark:text-red-400 mt-1 leading-relaxed">
                                  금융소득이 연 2,000만 원을 초과하면 <strong>건강보험 피부양자 자격이 상실</strong>되어 지역가입자로 전환될 수 있습니다. (재산 요건 등 추가 확인 필요)
                              </p>
                          </div>
                      </div>
                 </div>
             </div>

            <!-- 4. 세법 관련 상세 정보 (스크롤 시 보이게 - 요청 반영) -->
            <section class="mt-8 pt-6 border-t border-slate-200 dark:border-slate-700 space-y-8">
                <h2 class="text-2xl font-extrabold text-slate-800 dark:text-white flex items-center gap-3">
                    <i class="fa-solid fa-book-open-reader text-indigo-500"></i> 금융소득 종합과세 세법 가이드: 초보자 이해하기
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                    <!-- 핵심 가이드 1: 2천만원 기준의 중요성 -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border border-blue-100 dark:border-blue-900/50">
                        <h3 class="font-bold text-lg text-blue-700 dark:text-blue-300 mb-3 flex items-center gap-2"><i class="fa-solid fa-dollar-sign text-blue-500 text-sm"></i> 핵심 기준: 2천만원의 마법</h3>
                        <p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed mb-4">
                            금융소득 (이자 + 배당)의 연간 합계액이 **2,000만 원**을 초과하는지 여부에 따라 세금 부과 방식이 완전히 달라집니다.
                        </p>
                        <div class="space-y-3">
                            <div class="p-3 border-l-4 border-green-500 bg-green-50 dark:bg-green-900/20 rounded">
                                <span class="font-bold text-green-700 dark:text-green-300">① 2,000만원 이하: 분리과세</span>
                                <p class="text-xs text-slate-600 dark:text-slate-400 mt-0.5">15.4% (지방세 포함) 원천징수로 과세가 종결되어, 다른 소득과 합산되지 않습니다.</p>
                            </div>
                            <div class="p-3 border-l-4 border-red-500 bg-red-50 dark:bg-red-900/20 rounded">
                                <span class="font-bold text-red-700 dark:text-red-300">② 2,000만원 초과분: 종합과세</span>
                                <p class="text-xs text-slate-600 dark:text-slate-400 mt-0.5">초과분은 근로/사업 소득 등과 합산되어 **최대 45%의 누진세율**이 적용됩니다.</p>
                            </div>
                        </div>
                        <p class="mt-4 text-xs text-slate-500 dark:text-slate-400 text-center">
                             
                        </p>
                    </div>

                    <!-- 핵심 가이드 2: 건강보험료 피부양자 자격 주의사항 (기존 3번 항목을 2번 위치로 이동 및 통합) -->
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border border-pink-100 dark:border-pink-900/50">
                        <h3 class="font-bold text-lg text-pink-700 dark:text-pink-300 mb-3 flex items-center gap-2"><i class="fa-solid fa-heart-pulse text-pink-500 text-sm"></i> 숨겨진 위험: 건강보험 피부양자 자격</h3>
                        <p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed mb-4">
                            세금 외에도 건강보험료 자격 상실이라는 중요한 문제가 발생할 수 있습니다.
                        </p>
                        <ul class="list-disc pl-5 space-y-2 text-sm text-slate-600 dark:text-slate-400">
                            <li>**주요 기준**: 연간 금융소득 (이자/배당 합계) 및 사업/근로 소득 등 **종합소득이 2,000만 원을 초과**하면 자격이 상실됩니다. (세금 기준과 동일)</li>
                            <li>**결과**: 자격 상실 시, 소득에 따라 지역가입자로 전환되어 건강보험료를 별도로 납부해야 하므로, 실수령액이 크게 줄어들 수 있습니다.</li>
                            <li>**팁**: 금융소득이 2,000만원 이하라도 다른 소득과 합산하여 2,000만원을 초과하면 자격이 상실되니 주의하세요.</li>
                        </ul>
                    </div>
                </div>
                
                <!-- 상세 가이드 3: 종합소득세율표 -->
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-100 dark:border-slate-700">
                    <h3 class="font-bold text-lg text-slate-700 dark:text-slate-300 mb-4 flex items-center gap-2"><i class="fa-solid fa-percent text-red-500 text-sm"></i> 2024년 종합소득세율표 (합산 소득에 적용)</h3>
                    <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">
                        금융소득 중 **2,000만 원을 초과하는 부분**과 다른 종합소득을 합친 금액에 대해 아래의 누진세율이 적용됩니다. (지방소득세 10% 별도)
                    </p>
                    <div class="overflow-x-auto rounded-lg border border-slate-200 dark:border-slate-600">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                            <thead class="bg-slate-50 dark:bg-slate-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">과세표준</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">세율</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">누진공제액</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-slate-100 dark:bg-slate-800 dark:divide-slate-700">
                                <tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 dark:text-white">1,400만원 이하</td><td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 dark:text-green-400">6%</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">없음</td></tr>
                                <tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 dark:text-white">1,400만원 초과 ~ 5,000만원 이하</td><td class="px-6 py-4 whitespace-nowrap text-sm text-amber-600 dark:text-amber-400">15%</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">126만원</td></tr>
                                <tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 dark:text-white">5,000만원 초과 ~ 8,800만원 이하</td><td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 dark:text-red-400">24%</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">586만원</td></tr>
                                <tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 dark:text-white">8,800만원 초과 ~ 1억 5천만원 이하</td><td class="px-6 py-4 whitespace-nowrap text-sm text-red-700 dark:text-red-300">35%</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">1,544만원</td></tr>
                                <tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 dark:text-white">1억 5천만원 초과 ~ 3억원 이하</td><td class="px-6 py-4 whitespace-nowrap text-sm text-red-800 dark:text-red-200">38%</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">1,994만원</td></tr>
                                <tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 dark:text-white">3억원 초과 ~ 5억원 이하</td><td class="px-6 py-4 whitespace-nowrap text-sm text-red-900 dark:text-red-100">40%</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">2,594만원</td></tr>
                                <tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 dark:text-white">5억원 초과 ~ 10억원 이하</td><td class="px-6 py-4 whitespace-nowrap text-sm text-red-900 dark:text-red-100">42%</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">3,594만원</td></tr>
                                <tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 dark:text-white">10억원 초과</td><td class="px-6 py-4 whitespace-nowrap text-sm text-red-900 dark:text-red-100">45%</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">6,594만원</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <p class="mt-4 text-xs text-slate-500 dark:text-slate-400">* **지방소득세**: 산출된 종합소득세의 10%가 별도로 부과됩니다. (예: 세율 15% 구간의 실질세율은 16.5%)</p>
                </div>
            </section>
        </div>
        
        <!-- 자주 찾는 종목 관리 모달 -->
        <div id="favorite-symbols-modal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-70 z-[100] flex items-center justify-center transition-opacity duration-300">
            <div class="bg-white dark:bg-slate-800 rounded-xl w-full max-w-lg shadow-2xl transform scale-100 transition-transform duration-300">
                <div class="p-5 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2"><i class="fa-solid fa-star text-amber-500"></i> 자주 찾는 종목 관리</h3 >
                    <button onclick="closeFavoriteSymbolsModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors"><i class="fa-solid fa-xmark text-2xl"></i></button>
                </div>
                <div class="p-5 border-b border-slate-200 dark:border-slate-700 space-y-4">
                    <h4 class="font-bold text-lg text-slate-700 dark:text-slate-300">새 종목 추가</h4>
                    <div class="flex flex-col gap-3">
                        <input type="text" id="modal-new-code" placeholder="종목 코드 (6자리 숫자, 예: 005930)" class="p-3 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        <input type="text" id="modal-new-name" placeholder="종목명 (예: 삼성전자)" class="p-3 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        <button onclick="addSymbolFromModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-lg text-sm font-bold transition-colors"><i class="fa-solid fa-plus mr-1"></i> 종목 추가</button>
                    </div>
                </div>
                <div class="p-5 max-h-64 overflow-y-auto">
                    <h4 class="font-bold text-lg text-slate-700 dark:text-slate-300 mb-3">현재 등록된 종목</h4>
                    <div id="modal-favorite-list" class="space-y-2"></div>
                </div>
                <div class="p-4 border-t border-slate-200 dark:border-slate-700 text-right">
                    <button onclick="closeFavoriteSymbolsModal()" class="bg-slate-200 hover:bg-slate-300 text-slate-800 px-4 py-2 rounded-lg text-sm font-bold transition-colors dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600">닫기</button>
                </div>
            </div>
        </div>

        <!-- 링크/카테고리 추가/편집 범용 모달 -->
        <div id="add-edit-modal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-70 z-[100] flex items-center justify-center transition-opacity duration-300">
            <div class="bg-white dark:bg-slate-800 rounded-xl w-full max-w-md shadow-2xl transform scale-100 transition-transform duration-300">
                <div class="p-5 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                    <h3 id="add-edit-modal-title" class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2">새 링크 추가</h3>
                    <button onclick="closeAddEditModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors"><i class="fa-solid fa-xmark text-2xl"></i></button>
                </div>
                <div class="p-5 space-y-5">
                    
                    <!-- 카테고리 추가 시 노출되는 그룹 -->
                    <div id="add-category-input-group" class="hidden">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">카테고리 이름 (새 섹션/주제)</label>
                        <input type="text" id="modal-category-name" placeholder="예: 해외주식 분석 채널" class="w-full p-3 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-slate-400 mt-2">새로운 분류 섹션(큰 제목)을 만듭니다. (예: 아침 필수 체크)</p>
                    </div>

                    <!-- 링크 추가 시 노출되는 그룹 -->
                    <div id="add-link-input-group">
                        <p id="add-link-category-display" class="text-sm font-bold text-indigo-600 dark:text-indigo-400 mb-3"></p>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">링크 이름</label>
                                <input type="text" id="modal-link-name" placeholder="예: 매일경제 뉴스" class="w-full p-3 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">URL 주소</label>
                                <input type="url" id="modal-link-url" placeholder="예: https://media.naver.com/press/009/newspaper" class="w-full p-3 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div id="icon-color-group">
                                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">아이콘 (FontAwesome) & 색상 코드</label>
                                <div class="flex gap-3">
                                    <input type="text" id="modal-link-icon" placeholder="fa-chart-bar" class="w-1/2 p-3 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white text-xs">
                                    <input type="text" id="modal-link-color" placeholder="bg-blue-100 text-blue-700" class="w-1/2 p-3 border border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white text-xs">
                                </div>
                                <p class="text-xs text-slate-400 mt-1">FontAwesome 아이콘 이름과 Tailwind CSS 색상 클래스 입력</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3">
                    <button onclick="closeAddEditModal()" class="bg-slate-200 hover:bg-slate-300 text-slate-800 px-4 py-2 rounded-lg text-sm font-bold transition-colors dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600">취소</button>
                    <button id="add-edit-modal-save-btn" onclick="saveNewItem()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors shadow-md"><i class="fa-solid fa-save mr-1"></i> 저장</button>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal (Alert replacement) -->
        <div id="confirm-modal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-70 z-[110] flex items-center justify-center transition-opacity duration-300">
            <div class="bg-white dark:bg-slate-800 rounded-xl w-full max-w-sm shadow-2xl transform scale-100 transition-transform duration-300">
                <div class="p-5 border-b border-slate-200 dark:border-slate-700">
                    <h3 class="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2"><i class="fa-solid fa-circle-question text-red-500"></i> 확인 필요</h3>
                </div>
                <div class="p-5">
                    <p id="confirm-modal-message" class="text-slate-700 dark:text-slate-300 mb-6"></p>
                </div>
                <div class="p-4 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3">
                    <button onclick="closeConfirmModal(false)" class="bg-slate-200 hover:bg-slate-300 text-slate-800 px-4 py-2 rounded-lg text-sm font-bold transition-colors dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600">취소</button>
                    <button id="confirm-modal-yes-btn" onclick="closeConfirmModal(true)" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors shadow-md"><i class="fa-solid fa-trash-can mr-1"></i> 삭제</button>
                </div>
            </div>
        </div>

    </main>

    <script>
        // === 변수 선언 ===
        const DEFAULT_QUICK_LINKS = {
            "🌅 아침 필수 체크 (Morning Routine)": [
                { name: "미국 시장 점검", url: "https://kr.investing.com/portfolio/?portfolioID=OT4%2BZDRrZTFjM2thYTthYg%3D%3D", icon: "fa-list-check", color: "bg-blue-100 text-blue-700" },
                { name: "Finviz (미국 맵)", url: "https://finviz.com/map.ashx", icon: "fa-map", color: "bg-emerald-100 text-emerald-700" }, 
                { name: "필라델피아 반도체", url: "https://kr.investing.com/indices/phlx-semiconductor", icon: "fa-microchip", color: "bg-teal-100 text-teal-700" }, 
                { name: "공포 탐욕 지수 (CNN)", url: "https://edition.cnn.com/markets/fear-and-greed", icon: "fa-gauge-high", color: "bg-orange-100 text-orange-700" },
                { name: "크립토 지표 (MVRV Z-Score)", url: "https://www.bitcoinmagazinepro.com/charts/mvrv-zscore/", icon: "fa-chart-area", color: "bg-amber-100 text-amber-700" },
                { name: "SILVER (은)", url: "https://kr.investing.com/currencies/xag-usd", icon: "fa-coins", color: "bg-slate-100 text-slate-700" }, 
                { name: "은시세(순수한금)", url: "https://blog.naver.com/wolfkickbox", icon: "fa-blog", color: "bg-yellow-100 text-yellow-700" }
            ],
            "💰 공모주 & 실적 (IPO & Earnings)": [
                { name: "38 커뮤니케이션 (청약일정)", url: "http://www.38.co.kr/html/fund/index.htm?gjbcd=1460", icon: "fa-building", color: "bg-purple-100 text-purple-700" },
                { name: "DART (전자공시)", url: "https://dart.fss.or.kr/", icon: "fa-file-signature", color: "bg-yellow-100 text-yellow-700" },
                { name: "KRX 정보데이터시스템", url: "http://data.krx.co.kr/", icon: "fa-database", color: "bg-slate-100 text-slate-700" },
                { name: "KIND (기업공시채널)", url: "https://kind.krx.co.kr/", icon: "fa-file-invoice", color: "bg-blue-50 text-blue-600" },
                { name: "Seibro (증권정보포털)", url: "https://seibro.or.kr/", icon: "fa-server", color: "bg-indigo-50 text-indigo-600" }
            ],
            "📈 국내 시장 심층 (Korea Market)": [
                { name: "네이버 금융 (국내)", url: "https://finance.naver.com/", icon: "fa-n", color: "bg-green-50 text-green-600" },
                { name: "네이버 금융 뉴스", url: "https://finance.naver.com/news/", icon: "fa-magnifying-glass", color: "bg-blue-100 text-blue-700" },
                { name: "매일경제 신문 (네이버)", url: "https://media.naver.com/press/009/newspaper", icon: "fa-newspaper", color: "bg-red-50 text-red-600" }, 
                { name: "한국경제 신문 (네이버)", url: "https://media.naver.com/press/015/newspaper", icon: "fa-newspaper", color: "bg-teal-50 text-teal-600" }, 
                { name: "버틀러 (Butler)", url: "https://www.butler.works/ko/home", icon: "fa-chart-line", color: "bg-purple-50 text-purple-600" }, 
                { name: "한경 컨센서스 (리포트)", url: "https://markets.hankyung.com/consensus", icon: "fa-book-open", color: "bg-red-50 text-red-600" },
                { name: "SMIC (서울대투자동아리)", url: "http://snusmic.com/research/", icon: "fa-graduation-cap", color: "bg-slate-200 text-slate-800" }
            ],
            "🏡 일상 & 부동산 (Daily Life & Real Estate)": [
                { name: "호갱노노", url: "https://hogangnono.com/", icon: "fa-map-pin", color: "bg-red-50 text-red-600" },
                { name: "네이버 부동산", url: "https://land.naver.com/", icon: "fa-building", color: "bg-green-50 text-green-600" },
                { name: "네이버 지도", url: "https://map.naver.com/", icon: "fa-location-dot", color: "bg-blue-50 text-blue-600" },
                { name: "구글 지도", url: "https://maps.google.com/", icon: "fa-location-dot", color: "bg-amber-50 text-amber-600" }
            ]
        };

        const DEFAULT_BLOG_MAP_DATA = {
            "🧬 큐리옥스바이오시스템즈": [
                {name: "한계를 깨는 사람", url: "https://blog.naver.com/unlimitedi"},
                {name: "나는 전설이다", url: "https://blog.naver.com/legendyu"},
                {name: "이공계", url: "https://blog.naver.com/shyny38"},
                {name: "공대생 주접노트", url: "https://blog.naver.com/b_g-duck"},
                {name: "여름", url: "https://blog.naver.com/parkcnt"},
                {name: "댕오오오", url: "https://blog.naver.com/b_g-duck"},
                {name: "최고훈남", url: "https://blog.naver.com/apxk1000"},
                {name: "코코팜", url: "https://blog.naver.com/cocopalm9419"},
                {name: "유엔캐슬", url: "https://blog.naver.com/uncastle0426"},
                {name: "빵식", url: "https://blog.naver.com/bangsigi"},
                {name: "눈치투자자", url: "https://blog.naver.com/ncinvestor"},
                {name: "페로아빠", url: "https://blog.naver.com/perittopapa"}
            ],
            "💊 에스티팜": [
                {name: "오재복", url: "https://blog.naver.com/hym090206"},
                {name: "왠지상쾌한사람", url: "https://blog.naver.com/aphorism86"},
                {name: "Chan", url: "https://blog.naver.com/chany2do"}
            ]
        };

        const DEFAULT_FAVORITE_SYMBOLS = [
            { code: "445680", name: "큐리옥스바이오시스템즈" },
            { code: "237690", name: "에스티팜" },
            { code: "005930", name: "삼성전자" },
            { code: "005380", name: "현대차" },
            { code: "000810", name: "삼성화재" },
            { code: "MRNA", name: "모더나 (NASDAQ)" },
            { code: "PFE", name: "화이자 (NYSE)" }
        ];

        const EXCHANGE_RATES = { 'USD': { krw: 1380, name: "미국 달러" }, 'JPY': { krw: 8.90, name: "일본 엔" }, 'CNY': { krw: 190, name: "중국 위안" }, 'EUR': { krw: 1480, name: "유로" }, 'VND': { krw: 0.054, name: "베트남 동" }, 'THB': { krw: 37.5, name: "태국 바트" }, 'PHP': { krw: 23.5, name: "필리핀 페소" }, 'INR': { krw: 16.5, name: "인도 루피" }, 'ARS': { krw: 1.5, name: "아르헨티나 페소" } };
        const TAX_THRESHOLD = 20000000; // 금융소득 종합과세 기준 금액 (2천만원)

        let quickLinks = {}, blogMapData = {}, favoriteSymbols = [], isEditMode = false, currentLinkMode = 'investment', currentDividendMode = 'KOR', currentBaseCurrency = 'USD', currentTargetCurrency = 'KRW';
        let calculatorsInitialized = false;
        let finData = [];
        let otherData = [];
        let currentEditingCategory = ''; // 현재 편집 중인 카테고리 (링크 추가/삭제용)
        let confirmCallback = null; // Confirmation callback
        let marketStatusInterval = null; // 장 운영 정보 업데이트 인터벌 ID
        let currentMarketSource = ''; // 'KRX' or 'US'

        // === 유틸리티 함수 ===
        // 문자열에서 쉼표 제거 후 숫자로 파싱, 실패 시 0 반환
        function safeParseNumber(value) { 
            if (typeof value === 'string') { 
                const cleaned = value.replace(/,/g, ''); 
                return cleaned === '' ? 0 : parseFloat(cleaned); 
            } 
            return Number(value) || 0; 
        }

        // 금액을 한국 통화 형식으로 포맷
        function formatCurrency(amount, unit = '원') {
            const num = Math.round(amount);
            if (isNaN(num)) return '-';
            return new Intl.NumberFormat('ko-KR').format(num) + unit;
        }

        function saveLinks() { 
            localStorage.setItem('myQuickLinks', JSON.stringify(quickLinks)); 
            renderHomeLinks(); 
        }
        
        function saveBlogMap() {
            localStorage.setItem('myBlogMapData', JSON.stringify(blogMapData));
            renderHomeLinks();
        }

        // === Dark Mode 토글 함수 수정 ===
        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon(isDark);
            
            // 테마 변경 시 위젯도 새로 로드 (색상 반영)
            // 현재 활성화된 페이지가 대시보드일 때만 위젯 로드
            if (document.getElementById('page-dashboard').classList.contains('page-hidden') === false) { 
                 // 현재 시장 소스를 유지하여 위젯 로드
                 loadHeatmapWidget(getCurrentTheme(), currentMarketSource);
                 loadTickerWidget(getCurrentTheme()); // Ticker is generic enough to not need source switch
            }
        }

        function updateThemeIcon(isDark) {
            const icon = document.getElementById('theme-icon');
            if (icon) {
                icon.classList.toggle('fa-moon', !isDark);
                icon.classList.toggle('fa-sun', isDark);
                icon.classList.toggle('text-slate-600', !isDark);
                icon.classList.toggle('text-amber-400', isDark);
            }
        }
        
        // Confirmation Modal Functions (alert/confirm 대체)
        function openConfirmModal(message, callback) {
            confirmCallback = callback;
            document.getElementById('confirm-modal-message').textContent = message;
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function closeConfirmModal(confirmed) {
            document.getElementById('confirm-modal').classList.add('hidden');
            if (confirmed && confirmCallback) {
                confirmCallback();
            }
            confirmCallback = null;
        }


        // === 초기화 및 대시보드 함수 ===
        function initLinks() { 
            const savedLinks = localStorage.getItem('myQuickLinks'); 
            const allLinks = savedLinks ? JSON.parse(savedLinks) : {};

            // 기본 링크를 병합 (사용자 커스텀을 보존하기 위해)
            quickLinks = {
                ...DEFAULT_QUICK_LINKS,
                ...allLinks
            };

            const savedBlogs = localStorage.getItem('myBlogMapData');
            blogMapData = savedBlogs ? JSON.parse(savedBlogs) : DEFAULT_BLOG_MAP_DATA;
            
            // 초기 모드 로드 (루틴 페이지 전용)
            const savedLinkMode = localStorage.getItem('currentLinkMode');
            if (savedLinkMode) {
                currentLinkMode = savedLinkMode;
            }
        }
        function initWatchlist() { let watchlist = JSON.parse(localStorage.getItem('myWatchlist')); if (!watchlist) localStorage.setItem('myWatchlist', JSON.stringify([{ s: "KRX:005930" }, { s: "NASDAQ:TSLA" }])); }
        function initFavoriteSymbols() { const saved = localStorage.getItem('favoriteSymbols'); favoriteSymbols = saved ? JSON.parse(saved) : DEFAULT_FAVORITE_SYMBOLS; renderFavoriteSymbols(); }
        
        function toggleEditMode() { 
            isEditMode = !isEditMode; 
            const btn = document.getElementById('edit-mode-btn'); 
            const knob = document.getElementById('edit-mode-knob'); 
            const linksContainer = document.getElementById('home-links-container');

            if(isEditMode) { 
                btn.classList.replace('bg-slate-300', 'bg-blue-600'); 
                knob.classList.replace('left-1', 'left-7'); 
                linksContainer.classList.add('editing'); 
            } else { 
                btn.classList.replace('bg-blue-600', 'bg-slate-300'); 
                knob.classList.replace('left-7', 'left-1'); 
                linksContainer.classList.remove('editing'); 
            } 
            renderHomeLinks(); 
        }

        function moveLink(category, index, direction) { 
            const linksData = currentLinkMode === 'blogs' ? blogMapData : quickLinks;
            const list = linksData[category]; 
            const newIndex = index + direction; 
            
            if (newIndex >= 0 && newIndex < list.length) { 
                [list[index], list[newIndex]] = [list[newIndex], list[index]]; 
                if (currentLinkMode === 'blogs') { saveBlogMap(); } else { saveLinks(); }
            } 
        }
        
        function deleteLink(category, index) { 
            const linksData = currentLinkMode === 'blogs' ? blogMapData : quickLinks;
            const linkName = linksData[category][index].name;
            openConfirmModal(`'${linkName}' 링크를 삭제하시겠습니까?`, () => {
                linksData[category].splice(index, 1); 
                if (currentLinkMode === 'blogs') { saveBlogMap(); } else { saveLinks(); }
            }); 
        }

        function openAddLinkModal(category) { 
            currentEditingCategory = category;
            
            // 모달 초기화
            document.getElementById('modal-link-name').value = '';
            document.getElementById('modal-link-url').value = 'https://';
            document.getElementById('modal-link-icon').value = 'fa-link';
            document.getElementById('modal-link-color').value = 'bg-slate-100 text-slate-700';

            // 모달 설정 (링크 추가 모드)
            const title = currentLinkMode === 'blogs' ? `'${category}'에 새 인사이트 링크 추가` : `'${category}'에 새 링크 추가`;
            const display = currentLinkMode === 'blogs' ? `[${category}] 주제에 추가` : `[${category}] 카테고리에 추가`;
            
            document.getElementById('add-edit-modal-title').textContent = title;
            document.getElementById('add-link-category-display').textContent = display;
            document.getElementById('add-category-input-group').classList.add('hidden');
            document.getElementById('add-link-input-group').classList.remove('hidden');
            
            // Mind Map은 아이콘/색상 불필요
            document.getElementById('icon-color-group').classList.toggle('hidden', currentLinkMode === 'blogs'); 
            
            document.getElementById('add-edit-modal-save-btn').onclick = saveNewLink;
            document.getElementById('add-edit-modal').classList.remove('hidden');
        }

        // 카테고리 추가 모달 열기 (투자/일상/인사이트 주제 모두 대응)
        function openAddCategoryModal(mode) {
            currentLinkMode = mode; // 현재 탭 모드 저장
            
            // 모달 초기화
            document.getElementById('modal-category-name').value = '';
            
            // 모달 설정 (카테고리 추가 모드)
            let titlePrefix = mode === 'investment' ? '투자 루틴' : mode === 'daily' ? '일상 루틴' : '인사이트 맵';
            document.getElementById('add-edit-modal-title').textContent = `${titlePrefix}에 새 카테고리/주제 추가`;
            document.getElementById('add-link-input-group').classList.add('hidden');
            document.getElementById('add-category-input-group').classList.remove('hidden');
            
            document.getElementById('add-edit-modal-save-btn').onclick = saveNewCategory;
            document.getElementById('add-edit-modal').classList.remove('hidden');
        }
        
        // 모달 닫기
        function closeAddEditModal() {
            document.getElementById('add-edit-modal').classList.add('hidden');
            // 입력 필드 초기화
            document.getElementById('modal-category-name').value = ''; 
            document.getElementById('modal-link-name').value = '';
            document.getElementById('modal-link-url').value = '';
        }

        // 새 링크 저장 (투자/일상/인사이트 모두 대응)
        function saveNewLink() {
            const name = document.getElementById('modal-link-name').value.trim();
            const url = document.getElementById('modal-link-url').value.trim();

            if (!name || !url || url === 'https://') { console.error('이름과 URL을 확인해주세요.'); return; } 

            if (currentLinkMode === 'blogs') {
                 // 인사이트 맵 링크 저장
                 if (blogMapData[currentEditingCategory]) {
                    blogMapData[currentEditingCategory].push({ name: name, url: url });
                    saveBlogMap();
                 }
            } else {
                // 투자/일상 링크 저장
                const icon = document.getElementById('modal-link-icon').value.trim() || 'fa-link';
                const color = document.getElementById('modal-link-color').value.trim() || 'bg-slate-100 text-slate-700';
                const newLink = { name, url, icon: `${icon}`, color }; 
            
                if (quickLinks[currentEditingCategory]) {
                    quickLinks[currentEditingCategory].push(newLink);
                    saveLinks();
                }
            }
            closeAddEditModal();
        }
        
        // 새 카테고리 저장 (최상위 카테고리/주제 추가 기능)
        function saveNewCategory() {
            const name = document.getElementById('modal-category-name').value.trim();
            if (!name) { console.error('카테고리 이름을 입력해주세요.'); return; }

            if (currentLinkMode === 'investment' || currentLinkMode === 'daily') {
                if (quickLinks[name]) { console.error('이미 존재하는 카테고리 이름입니다.'); return; }
                quickLinks[name] = []; // <-- Adds the new category key to quickLinks
                saveLinks();
            } else if (currentLinkMode === 'blogs') {
                if (blogMapData[name]) { console.error('이미 존재하는 주제 이름입니다.'); return; }
                blogMapData[name] = [];
                saveBlogMap(); 
            }

            closeAddEditModal();
        }


        function openFavoriteSymbolsModal() { document.getElementById('favorite-symbols-modal').classList.remove('hidden'); renderModalList(); }
        function closeFavoriteSymbolsModal() { document.getElementById('favorite-symbols-modal').classList.add('hidden'); }
        function addSymbolFromModal() { 
            const codeInput = document.getElementById('modal-new-code');
            const nameInput = document.getElementById('modal-new-name');
            const code = codeInput.value.trim();
            const name = nameInput.value.trim();
            
            if(!code || !name) { console.error('종목 코드와 종목명을 입력해주세요.'); return; } 
            
            favoriteSymbols.push({ code, name });
            localStorage.setItem('favoriteSymbols', JSON.stringify(favoriteSymbols));
            
            renderModalList();
            renderFavoriteSymbols();
            
            codeInput.value = '';
            nameInput.value = '';
            codeInput.focus();
        }
        function renderModalList() { 
            const list = document.getElementById('modal-favorite-list');
            list.innerHTML = '';
            favoriteSymbols.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-slate-50 dark:bg-slate-700 p-2 rounded";
                div.innerHTML = `
                    <span class="text-sm dark:text-white"><span class="font-bold text-slate-500 dark:text-slate-400 mr-2">${item.code}</span>${item.name}</span>
                    <button onclick="deleteFavoriteSymbol(${index})" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash"></i></button>
                `;
                list.appendChild(div);
            });
        }
        
        function deleteFavoriteSymbol(index) {
            const symbolName = favoriteSymbols[index].name;
            openConfirmModal(`자주 찾는 종목 목록에서 '${symbolName}'을(를) 삭제하시겠습니까?`, () => {
                favoriteSymbols.splice(index, 1);
                localStorage.setItem('favoriteSymbols', JSON.stringify(favoriteSymbols));
                renderModalList();
                renderFavoriteSymbols();
            });
        }
        
        function renderFavoriteSymbols() { 
            const container = document.getElementById('favorite-symbols-list');
            container.innerHTML = '';
            favoriteSymbols.forEach(item => {
                const btn = document.createElement('button');
                btn.className = "bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 dark:bg-slate-800 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-700 px-3 py-1.5 rounded-lg text-xs font-bold transition-all shadow-sm";
                btn.innerHTML = `<span class="text-slate-400 mr-1 text-[10px]">${item.code}</span>${item.name}`;
                btn.onclick = () => searchSymbol(item.code);
                container.appendChild(btn);
            });
        }
        
        function switchLinkMode(mode) { 
            if(currentLinkMode === mode) return; 
            currentLinkMode = mode; 
            localStorage.setItem('currentLinkMode', mode); 
            updateLinkModeUI(); 
            renderHomeLinks(); 
        }
        
        function updateLinkModeUI() { 
            document.getElementById('mode-investment')?.classList.toggle('active', currentLinkMode === 'investment'); 
            document.getElementById('mode-daily')?.classList.toggle('active', currentLinkMode === 'daily'); 
            document.getElementById('mode-blogs')?.classList.toggle('active', currentLinkMode === 'blogs');
        }

        function renderHomeLinks() {
            const container = document.getElementById('home-links-container');

            if (!container) return;
            container.innerHTML = ''; // Clear

            // Blog/Mind Map Rendering Logic
            if (currentLinkMode === 'blogs') {
                container.classList.remove('grid', 'grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3', 'gap-6'); // Remove grid for map
                container.classList.add('flex', 'flex-col', 'gap-8', 'p-4'); // Add stack layout

                let html = `<div class="bg-white dark:bg-slate-800 rounded-2xl p-8 shadow-inner border border-slate-200 dark:border-slate-700 min-h-[400px] mindmap-root">`;
                
                for (const [category, links] of Object.entries(blogMapData)) {
                    html += `
                        <div class="mindmap-branch group">
                             <div class="mindmap-line hidden md:block"></div>
                             <div class="mindmap-mobile-line block md:hidden"></div>
                             <div class="mindmap-node-main">
                                 ${category}
                                 ${isEditMode ? `<button onclick="deleteBlogCategory('${category}')" class="absolute -top-3 -right-3 w-6 h-6 flex items-center justify-center bg-red-500 rounded-full text-white text-xs opacity-80 hover:opacity-100 transition" title="주제 삭제"><i class="fa-solid fa-times"></i></button>` : ''}
                             </div>
                             <div class="mindmap-connector hidden md:block"></div>
                             <div class="mindmap-leaves-container">
                                 ${links.map((link, index) => `
                                     <div class="relative group">
                                         <a href="${link.url}" target="_blank" class="mindmap-leaf">
                                             <i class="fa-solid fa-link text-slate-400 text-xs"></i>
                                             <span>${link.name}</span>
                                         </a>
                                         ${isEditMode ? `<button onclick="deleteLink('${category}', ${index})" class="absolute -top-1 -right-1 w-5 h-5 flex items-center justify-center bg-red-400 rounded-full text-white text-[10px] opacity-0 group-hover:opacity-100 transition z-20" title="링크 삭제"><i class="fa-solid fa-minus"></i></button>` : ''}
                                     </div>
                                 `).join('')}
                                 ${isEditMode ? `<button onclick="openAddLinkModal('${category}')" class="mindmap-leaf border-dashed text-slate-400 hover:text-blue-500"><i class="fa-solid fa-plus"></i> 링크 추가</button>` : ''}
                             </div>
                        </div>
                    `;
                }
                html += `</div>`;
                html += `<div class="text-center text-xs text-slate-400 mt-2">* 편집 모드에서 삭제 및 추가 기능을 이용할 수 있습니다.</div>`;
                
                // --- ADD TOPIC CARD AT THE END OF THE MAP VIEW (IF EDIT MODE) ---
                if (isEditMode) {
                    html += `
                        <div class="mt-8 pt-4 border-t border-slate-200 dark:border-slate-700">
                            <button onclick="openAddCategoryModal(currentLinkMode)" class="w-full bg-indigo-50 dark:bg-indigo-900/50 hover:bg-indigo-100 dark:hover:bg-indigo-900 text-indigo-600 dark:text-indigo-300 py-3 border-2 border-dashed border-indigo-300 dark:border-indigo-600 rounded-xl text-lg font-bold transition-colors shadow-sm flex items-center justify-center gap-3">
                                <i class="fa-solid fa-plus-circle text-xl"></i> 새 인사이트 주제 추가
                            </button>
                        </div>
                    `;
                }
                // --- END ADD TOPIC CARD ---

                container.innerHTML = html;
                return;
            }

            // Standard Grid Rendering (Investment/Daily)
            container.classList.add('grid', 'grid-cols-1', 'md:grid-cols-2', 'lg:grid-cols-3', 'gap-6');
            container.classList.remove('flex', 'flex-col', 'gap-8', 'p-4');

            // --- 카테고리 필터링 로직 ---
            const allCategoryKeys = Object.keys(quickLinks);
            // Default categories are identified by specific substrings for automatic sorting
            const defaultInvestmentKeys = Object.keys(DEFAULT_QUICK_LINKS).filter(c => c.includes('Routine') || c.includes('IPO') || c.includes('Korea Market'));
            const defaultDailyKeys = Object.keys(DEFAULT_QUICK_LINKS).filter(c => c.includes('Daily Life') || (!c.includes('Routine') && !c.includes('IPO') && !c.includes('Korea Market') && c.includes('Daily Life')));

            let cats;

            if (currentLinkMode === 'investment') {
                // 투자: 기본 투자 카테고리 + 기본 데일리 카테고리가 아닌 모든 사용자 정의 카테고리
                cats = allCategoryKeys.filter(key => 
                    defaultInvestmentKeys.includes(key) || 
                    !defaultDailyKeys.includes(key) && !defaultInvestmentKeys.includes(key)
                );
            } else { // daily mode
                // 일상: 기본 일상 카테고리 + 기본 투자 카테고리가 아닌 모든 사용자 정의 카테고리
                cats = allCategoryKeys.filter(key => 
                    defaultDailyKeys.includes(key) || 
                    !defaultInvestmentKeys.includes(key) && !defaultDailyKeys.includes(key)
                );
            }
            // --- 카테고리 필터링 로직 끝 ---

            let html = '';
            for (const category of cats) { 
                const links = quickLinks[category] || []; 
                const linkIconClass = 'fa-solid'; 
                html += `<div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg border border-slate-100 dark:border-slate-700 flex flex-col h-full">
                            <h3 class="text-lg font-bold mb-5 flex items-center justify-between text-slate-800 dark:text-slate-200 border-b pb-3 border-slate-100 dark:border-slate-700">
                                <span>${category}</span>
                                ${isEditMode ? `<div class="flex gap-2">
                                    <button onclick="openAddLinkModal('${category}')" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200 transition-colors" title="링크 추가"><i class="fa-solid fa-plus"></i> 링크</button>
                                    <button onclick="deleteQuickLinkCategory('${category}')" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200 transition-colors" title="카테고리 삭제"><i class="fa-solid fa-trash"></i></button>
                                </div>` : ''}
                            </h3>
                            <div class="space-y-3 flex-1">
                                ${links.map((link, index) => `
                                    <div class="relative group">
                                        <a href="${link.url}" target="_blank" class="link-content link-card p-3 rounded-xl border border-slate-100 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 flex items-center gap-4 hover:bg-white dark:hover:bg-slate-600 ${isEditMode ? 'opacity-50 pointer-events-none' : ''}">
                                            <div class="w-10 h-10 rounded-lg flex items-center justify-center text-lg ${link.color} bg-opacity-30 shadow-sm">
                                                <i class="${linkIconClass} ${link.icon}"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="font-bold text-slate-700 dark:text-slate-200 text-base truncate">${link.name}</div>
                                                <div class="text-xs text-slate-500 dark:text-slate-400 mt-0.5 truncate">${new URL(link.url).hostname}</div>
                                            </div>
                                            ${!isEditMode ? `<i class="fa-solid fa-arrow-up-right-from-square text-slate-300 text-xs"></i>` : ''}
                                        </a>
                                        <div class="edit-controls absolute inset-y-0 right-2 flex items-center gap-1 ${isEditMode ? 'flex' : 'hidden'}">
                                            <button onclick="moveLink('${category}', ${index}, -1)" class="w-7 h-7 flex items-center justify-center bg-white border border-slate-200 rounded text-slate-500 hover:text-blue-600 hover:border-blue-400 shadow-sm" title="위로"><i class="fa-solid fa-arrow-up text-xs"></i></button>
                                            <button onclick="moveLink('${category}', ${index}, 1)" class="w-7 h-7 flex items-center justify-center bg-white border border-slate-200 rounded text-slate-500 hover:text-blue-600 hover:border-blue-400 shadow-sm" title="아래로"><i class="fa-solid fa-arrow-down text-xs"></i></button>
                                            <button onclick="deleteLink('${category}', ${index})" class="w-7 h-7 flex items-center justify-center bg-red-50 border border-red-200 rounded text-red-500 hover:bg-red-100 shadow-sm" title="삭제"><i class="fa-solid fa-trash text-xs"></i></button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>`; 
            } 
            
            // --- ADD CATEGORY CARD AT THE END OF THE GRID VIEW (IF EDIT MODE) ---
            if (isEditMode) {
                const titleText = currentLinkMode === 'daily' ? '새 일상 카테고리 추가' : '새 투자 카테고리 추가';
                html += `
                    <button onclick="openAddCategoryModal(currentLinkMode)" class="bg-slate-100 dark:bg-slate-700 rounded-2xl p-6 shadow-inner border-2 border-dashed border-slate-300 dark:border-slate-600 flex flex-col items-center justify-center h-full text-slate-500 dark:text-slate-400 hover:border-blue-500 hover:text-blue-500 transition-colors">
                        <i class="fa-solid fa-plus-circle text-3xl mb-2"></i>
                        <span class="text-lg font-bold">${titleText}</span>
                        <span class="text-sm">클릭하여 새로운 섹션을 만드세요.</span>
                    </button>
                `;
            }
            // --- END ADD CATEGORY CARD ---

            container.innerHTML = html; 
        }

        function deleteQuickLinkCategory(category) {
            openConfirmModal(`'${category}' 카테고리를 삭제하시겠습니까? (안에 있는 모든 링크가 삭제됩니다)`, () => {
                delete quickLinks[category];
                saveLinks();
            });
        }
        
        function deleteBlogCategory(category) {
            openConfirmModal(`'${category}' 주제를 삭제하시겠습니까? (안에 있는 모든 링크가 삭제됩니다)`, () => {
                delete blogMapData[category];
                saveBlogMap();
            });
        }

        function deleteBlogLink(category, index) {
            const linkName = blogMapData[category][index].name;
            openConfirmModal(`'${linkName}' 링크를 삭제하시겠습니까?`, () => {
                blogMapData[category].splice(index, 1);
                saveBlogMap();
            });
        }

        function switchPage(pageId) {
            // 1. 네비게이션 버튼 업데이트
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${pageId}`).classList.add('active');
            
            // 2. 모든 페이지 숨김
            document.getElementById('page-dashboard').classList.add('page-hidden');
            document.getElementById('page-routine').classList.add('page-hidden'); 
            document.getElementById('page-tools').classList.add('page-hidden');
            document.getElementById('page-tax').classList.add('page-hidden');
            
            // 3. 선택된 페이지 보임
            document.getElementById(`page-${pageId}`).classList.remove('page-hidden');
            
            const theme = getCurrentTheme();
            if(pageId === 'dashboard') { 
                // 위젯은 updateMarketStatus에서 로드됩니다.
                checkMarketStatus(); // 장운영 정보 업데이트 (시장 소스 결정 및 위젯 로드)
                // 장운영 정보 실시간 업데이트 시작
                if (marketStatusInterval === null) {
                    marketStatusInterval = setInterval(checkMarketStatus, 60000); // 1분마다 업데이트
                }
                renderFavoriteSymbols(); 
            }
            else {
                // 대시보드가 아니면 장운영 업데이트 인터벌 중지
                if (marketStatusInterval !== null) {
                    clearInterval(marketStatusInterval);
                    marketStatusInterval = null;
                }
            }
            
            if (pageId === 'routine') { 
                // 페이지 전환 시, 저장된 모드가 있다면 해당 모드로 초기화
                const savedMode = localStorage.getItem('currentLinkMode');
                if (savedMode) {
                    currentLinkMode = savedMode;
                }
                updateLinkModeUI();
                renderHomeLinks();
            }
            else if (pageId === 'tools') { 
                initCalculatorInputs(); 
            }
            else if (pageId === 'tax') { 
                // 탭 전환 시 자동 계산/렌더링
                renderFin();
                renderOther();
                updateTaxCalc(); 
            }
        }

        function getCurrentTheme() { 
            return document.documentElement.classList.contains('dark') ? 'dark' : 'light'; 
        }
        
        // TradingView Heatmap Implementation
        function loadHeatmapWidget(theme, marketSource) {
            const container = document.getElementById('heatmap-container');
            if(!container) return;
            
            if (window.innerWidth < 768) {
                 container.innerHTML = '';
                 return;
            }
            
            container.innerHTML = '<div class="tradingview-widget-container__widget"></div>';
            
            // [수정] 시장 소스에 관계없이 항상 S&P 500 (SPX500) Heatmap을 로드합니다. (사용자 요청 반영)
            const dataSource = "SPX500"; // Always use S&P 500
            
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-stock-heatmap.js';
            script.async = true;
            script.innerHTML = JSON.stringify({
                "exchanges": [],
                "dataSource": dataSource,
                "grouping": "sector",
                "blockSize": "market_cap_basic",
                "blockColor": "change",
                "locale": "kr",
                "symbolUrl": "",
                "colorTheme": theme,
                "hasTopBar": false,
                "isTransparent": true,
                "width": "100%",
                "height": "100%"
            });
            
            // 아이콘 색상 업데이트 (제목은 checkMarketStatus에서 통합 관리)
            document.getElementById('main-widget-icon').classList.toggle('text-red-500', marketSource === 'US');
            document.getElementById('main-widget-icon').classList.toggle('text-blue-500', marketSource === 'KRX');
            container.appendChild(script);
        }

        // TradingView Ticker Tape Implementation
        function loadTickerWidget(theme) {
            const container = document.getElementById('ticker-tape-container');
            if(!container) return;
            
            container.innerHTML = '<div class="tradingview-widget-container__widget"></div>';
            
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js';
            script.async = true;
            
            // [수정] 요청에 따라 불필요한 심볼 제거 (XLK, XLF, XLP, XLY, TSLA, AMZN)
            // [수정] 은 심볼을 현물(XAGUSD)로 변경하고, 속도를 "fast"로 설정
            script.innerHTML = JSON.stringify({
                "symbols": [
                    { "proName": "FOREXCOM:SPXUSD", "title": "S&P 500" },
                    { "proName": "NASDAQ:QQQ", "title": "나스닥 QQQ ETF" },
                    { "proName": "FX_IDC:USDKRW", "title": "원달러 환율" },
                    { "proName": "BINANCE:BTCUSDT", "title": "비트코인" },
                    { "proName": "CRYPTOCAP:BTC.D", "title": "비트코인 도미넌스" },
                    // [수정] 은 현물(XAGUSD)로 변경
                    { "proName": "OANDA:XAGUSD", "title": "은 현물" }, 
                    
                    { "proName": "NASDAQ:IBB", "title": "바이오텍 ETF" }, 
                    
                    { "proName": "NYSE:JPM", "title": "JP모건" },
                    { "proName": "NASDAQ:GOOGL", "title": "알파벳 (Google)" },
                    { "proName": "NYSE:V", "title": "비자" }
                ],
                "showSymbolLogo": true,
                "colorTheme": theme,
                "isTransparent": true,
                "displayMode": "adaptive", 
                "locale": "kr",
                "speed": "fast" // [수정] 이동 속도를 'fast'로 설정
            });
            container.appendChild(script);
        }

        // [NEW] KRX 시장 운영 상태 계산 함수
        function getKrxStatus(kstNow) {
            const day = kstNow.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
            const hours = kstNow.getHours();
            const minutes = kstNow.getMinutes();
            const totalMinutes = hours * 60 + minutes;

            // KRX Market Hours (Mon-Fri)
            const openTime = 9 * 60;       // 9:00 (540 min)
            const closeTime = 15 * 60 + 30; // 15:30 (930 min)
            const preMarketStart = 8 * 60 + 30; // 8:30 (510 min)
            const afterHoursStart = 15 * 60 + 40; // 15:40 (940 min)
            const afterHoursEnd = 18 * 60; // 18:00 (1080 min)
            
            if (day === 0 || day === 6) {
                return { text: "주말 휴장", color: "bg-slate-600 dark:bg-slate-800 text-white", reason: "주말 정기 휴장" };
            } else {
                if (totalMinutes >= openTime && totalMinutes <= closeTime) {
                    return { text: "정규장 운영 중", color: "bg-green-600 dark:bg-green-700 text-white", reason: "정상 거래 (9:00~15:30 KST)" };
                } else if (totalMinutes >= preMarketStart && totalMinutes < openTime) {
                    return { text: "장전 동시호가", color: "bg-cyan-600 dark:bg-cyan-700 text-white", reason: "시가 결정 중 (8:30~9:00 KST)" };
                } else if (totalMinutes > closeTime && totalMinutes < afterHoursStart) {
                    return { text: "종가/시간 외 준비", color: "bg-amber-500 dark:bg-amber-700 text-white", reason: "장 종료 및 정리 시간" };
                } else if (totalMinutes >= afterHoursStart && totalMinutes <= afterHoursEnd) {
                    return { text: "시간 외 거래", color: "bg-blue-600 dark:bg-blue-700 text-white", reason: "시간외 단일가 거래 (15:40~18:00 KST)" };
                } else {
                    return { text: "장 마감 (휴장)", color: "bg-red-600 dark:bg-red-700 text-white", reason: "정규/시간 외 거래 마감" };
                }
            }
        }

        // [NEW] US 시장 운영 상태 계산 함수
        function getUsStatus(kstNow) {
            const day = kstNow.getDay(); 
            const hours = kstNow.getHours();
            const minutes = kstNow.getMinutes();
            
            // US Market Hours in KST (simplified average)
            // Active Window (Approx. 22:30 KST to 07:00 KST)
            
            // Check for weekends (US Market Closed Sat/Sun KST)
            if (day === 6 || (day === 0 && hours < 22)) { // 토요일 전체, 일요일 22시 이전
                return { text: "주말 휴장", color: "bg-slate-600 dark:bg-slate-800 text-white", reason: "미국 시장 정기 휴장" };
            }
            
            // Simplified Active US Trading Hours (22:00 KST to 07:00 KST)
            const isUsTradingActive = (hours >= 22) || (hours >= 0 && hours < 7);
            
            if (isUsTradingActive) {
                // A simplified definition of regular trading hours based on KST ranges (DST assumed)
                const regularOpenTime = 22 * 60 + 30; // 22:30 KST
                const regularCloseTime = 5 * 60; // 05:00 KST
                const totalMinutes = hours * 60 + minutes;

                let isRegularHours = false;
                
                if (hours >= 22) { 
                    isRegularHours = totalMinutes >= regularOpenTime;
                } else if (hours >= 0 && hours < 7) { 
                    isRegularHours = totalMinutes < regularCloseTime;
                }
                
                if (isRegularHours) {
                    return { text: "정규장 운영 중", color: "bg-green-600 dark:bg-green-700 text-white", reason: "실시간 거래 (미국 시간대)" };
                } else {
                     return { text: "장전/장후 거래", color: "bg-blue-600 dark:bg-blue-700 text-white", reason: "개장 전후 거래 가능 시간" };
                }
            } else { 
                // Daytime KST (07:00 KST to 22:00 KST) -> US Market Closed
                return { text: "장 마감 (휴장)", color: "bg-red-600 dark:bg-red-700 text-white", reason: "미국 시장 정규/시간 외 거래 마감" };
            }
        }
        
        // [REVISED] 메인 시장 상태 컨트롤러 함수
        function checkMarketStatus() {
            const now = new Date();
            const kstOffset = 9 * 60; // KST is UTC+9
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const kstNow = new Date(utc + (kstOffset * 60000));
            
            const hours = kstNow.getHours();

            let status = { text: "상태 확인 중", color: "bg-slate-500 dark:bg-slate-700 text-white", reason: "" };
            let marketSource = '';

            // 1. 시장 소스 결정 (KST 기준)
            // KRX Focus: 08:00 KST (포함) ~ 19:00 KST (미포함)
            if (hours >= 8 && hours < 19) {
                marketSource = 'KRX';
                status = getKrxStatus(kstNow);
            } else {
                // US Focus: 19:00 KST (포함) ~ 08:00 KST (미포함)
                marketSource = 'US';
                status = getUsStatus(kstNow);
            }
            
            // 2. Heatmap 로드: 시장 소스가 변경되었거나, 초기 로드인 경우에만 Heatmap을 업데이트합니다.
            // Heatmap 자체는 S&P 500을 사용함을 명시하고, KRX 히트맵 로직은 제거합니다.
            if (currentMarketSource !== marketSource) {
                 const theme = getCurrentTheme();
                 // Heatmap은 항상 SPX500을 로드하지만, marketSource를 넘겨 아이콘/제목 업데이트의 기준으로 삼습니다.
                 loadHeatmapWidget(theme, marketSource); 
                 currentMarketSource = marketSource;
            } else {
                 // 시장 소스가 바뀌지 않았어도 테마나 다른 변경 사항을 위해 아이콘을 업데이트합니다.
                 document.getElementById('main-widget-icon').classList.toggle('text-red-500', marketSource === 'US');
                 document.getElementById('main-widget-icon').classList.toggle('text-blue-500', marketSource === 'KRX');
            }


            // 3. UI 업데이트
            const mainTitleEl = document.getElementById('main-widget-title');
            const badge = document.getElementById('market-status-badge');
            const reasonEl = document.getElementById('market-status-reason');
            const widgetUpdateTime = document.getElementById('widget-update-time');
            
            // 3.1. Main Title Update (요청 반영: 명칭을 'S&P 500 히트맵'으로 변경)
            mainTitleEl.textContent = `S&P 500 히트맵`; 
            
            // 3.2. Status Badge Update
            if (badge) {
                // [수정] 상태 배지에 시장 구분 정보 포함 (예: [KRX] 정규장 운영 중)
                const marketPrefix = marketSource === 'KRX' ? '[KRX]' : '[US]';
                badge.textContent = `${marketPrefix} ${status.text}`;
                badge.className = `market-status-badge ${status.color} transition-colors duration-200`;
            }

            // 3.3. Reason Update (Only show reason if not regular hours) - 요청 반영: 특별 사유만 표기
            if (reasonEl) {
                const isRegular = status.text.includes("정규장 운영 중");
                // 정규장 운영 중이 아닐 때만 사유를 표시
                reasonEl.textContent = !isRegular ? `(${status.reason})` : '';
                reasonEl.classList.toggle('hidden', isRegular);
            }
            
            // 3.4. Time Update
            if (widgetUpdateTime) {
                const dateString = kstNow.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false });
                widgetUpdateTime.textContent = `(업데이트: ${dateString} KST)`;
            }
        }


        function searchSymbolFromInput() { const input = document.getElementById('symbol-search-input').value.trim(); if(input) searchSymbol(input); }
        
        function searchSymbol(code) { 
            // 알파벳이 포함되어 있으면 해외 주식(티커)로 간주하고 네이버 해외증권 검색
            if (/[a-zA-Z]/.test(code)) {
                window.open(`https://finance.naver.com/world/sise.naver?symbol=${code}`, '_blank');
            } else {
                window.open(`https://finance.naver.com/item/main.naver?code=${code}`, '_blank');
            }
        }

        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            document.getElementById('current-time').textContent = timeString;
        }


        // === 계산기 함수들 ===

        function initCalculatorInputs() {
            // 초기화는 최초 1회만 수행
            if (!calculatorsInitialized) {
                // 평단가 계산기 초기화
                const avgCalcContainer = document.getElementById('average-calculator-inputs');
                if(avgCalcContainer) { 
                    avgCalcContainer.innerHTML = ''; 
                    addPurchaseRow(); addPurchaseRow(); addPurchaseRow(); addPurchaseRow(); 
                }
                // 환율 계산기 초기화
                populateTargetCurrencySelect(); 
                
                calculatorsInitialized = true;
            }
            // 모든 계산기 결과 업데이트
            calculateIPO(); 
            updateExchangeUI(); 
            switchDividendMode(currentDividendMode); 
            calculatePnL(); 
            // 현재 선택된 모드로 토글하여 UI 및 계산을 업데이트
            toggleTargetMode(document.querySelector('input[name="target-mode"]:checked')?.value || 'cap'); 
            calcAvg(); 
        }
        
        function calculateIPO() {
            const type = parseFloat(document.getElementById('ipo-type').value) || 0.5;
            const price = parseInt(document.getElementById('ipo-price').value) || 0;
            const qty = parseInt(document.getElementById('ipo-qty').value) || 10;
            const people = parseInt(document.getElementById('ipo-people').value) || 1;
            
            const requiredCash = (price * qty * people) * type;
            
            document.getElementById('ipo-rate-text').textContent = `(증거금률 ${type * 100}%)`;
            document.getElementById('ipo-result').textContent = formatCurrency(requiredCash, '');
        }
        
        function populateTargetCurrencySelect() {
            const select = document.getElementById('calc-target-currency-select');
            if(!select) return;
            select.innerHTML = '';
            // KRW를 제외한 모든 통화 추가 (KRW는 krw-label로 처리됨)
            for (const key in EXCHANGE_RATES) {
                if (key !== 'KRW') {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = `${key} (${EXCHANGE_RATES[key].name})`;
                    select.appendChild(option);
                }
            }
        }
        
        function updateExchangeUI() {
            const select = document.getElementById('calc-currency-select');
            const targetSelect = document.getElementById('calc-target-currency-select');
            const krwLabel = document.getElementById('krw-label');
            
            currentBaseCurrency = select.value;
            
            document.getElementById('foreign-unit').textContent = currentBaseCurrency;
            
            const inputForeign = document.getElementById('calc-input-foreign');
            const inputKrw = document.getElementById('calc-input-krw');
            
            // Base currency is KRW (two-way conversion)
            if (currentBaseCurrency === 'KRW') {
                krwLabel.classList.add('hidden');
                targetSelect.classList.remove('hidden');
                currentTargetCurrency = targetSelect.value;
                document.getElementById('krw-output-unit').textContent = currentTargetCurrency;
                inputForeign.placeholder = '원화 입력';
                inputKrw.placeholder = '외화 출력';
                inputKrw.readOnly = true;
                inputForeign.readOnly = false;
            } else {
                // Base currency is Foreign (convert to KRW)
                krwLabel.classList.remove('hidden');
                targetSelect.classList.add('hidden');
                currentTargetCurrency = 'KRW';
                document.getElementById('krw-output-unit').textContent = '원';
                inputForeign.placeholder = '외화 입력';
                inputKrw.placeholder = '원화 출력';
                inputKrw.readOnly = true;
                inputForeign.readOnly = false;
            }
            calculateExchange('foreign');
        }
        
        function calculateExchange(source) {
            const inputForeign = document.getElementById('calc-input-foreign');
            const inputKrw = document.getElementById('calc-input-krw');
            
            let rate = 1;
            let result = 0;
            
            if (currentBaseCurrency === 'KRW') {
                // KRW -> Foreign
                const foreignKey = currentTargetCurrency;
                rate = EXCHANGE_RATES[foreignKey]?.krw || 1;
                const krwAmount = parseFloat(inputForeign.value) || 0;
                
                result = krwAmount / rate;
                inputKrw.value = result.toFixed(2);
                
                const note = document.getElementById('exchange-rate-note');
                note.textContent = `* 1 ${foreignKey} 당 약 ${rate.toLocaleString()}원 기준 환율 적용 (실시간 환율 아님)`;

            } else {
                // Foreign -> KRW
                const foreignKey = currentBaseCurrency;
                rate = EXCHANGE_RATES[foreignKey]?.krw || 1;
                const foreignAmount = parseFloat(inputForeign.value) || 0;
                
                result = foreignAmount * rate;
                inputKrw.value = formatCurrency(result, '');
                
                const note = document.getElementById('exchange-rate-note');
                note.textContent = `* 1 ${foreignKey} 당 약 ${rate.toLocaleString()}원 기준 환율 적용 (실시간 환율 아님)`;
            }
        }
        
        function addPurchaseRow() { 
            const container = document.getElementById('average-calculator-inputs'); 
            if(!container) return; 
            const div = document.createElement('div'); 
            div.className = "flex gap-2 purchase-row mb-2"; 
            // `type="number"`와 함께 `input` 이벤트 사용
            div.innerHTML = `<input type="number" class="w-1/2 p-2 bg-slate-50 border rounded text-right qty text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-green-500 focus:ring-2 focus:ring-green-200" placeholder="수량" oninput="calcAvg()"><input type="number" class="w-1/2 p-2 bg-slate-50 border rounded text-right price text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:border-green-500 focus:ring-2 focus:ring-green-200" placeholder="가격" oninput="calcAvg()">`; 
            container.appendChild(div); 
        }

        function calcAvg() {
            const rows = document.querySelectorAll('#average-calculator-inputs .purchase-row');
            let totalQty = 0;
            let totalCost = 0;
            
            rows.forEach(row => {
                const qtyInput = row.querySelector('.qty');
                const priceInput = row.querySelector('.price');
                
                // safeParseNumber 사용
                const qty = safeParseNumber(qtyInput.value);
                const price = safeParseNumber(priceInput.value);
                
                totalQty += qty;
                totalCost += qty * price;
            });
            
            const avgPrice = totalQty > 0 ? totalCost / totalQty : 0;
            
            document.getElementById('average-price').textContent = formatCurrency(avgPrice, '');
        }

        function switchDividendMode(mode) {
            currentDividendMode = mode;
            document.getElementById('div-content-kor').classList.toggle('hidden', mode !== 'KOR');
            document.getElementById('div-content-us').classList.toggle('hidden', mode !== 'US');
            
            document.getElementById('tab-kor').classList.toggle('active-tab', mode === 'KOR');
            document.getElementById('tab-us').classList.toggle('active-tab', mode === 'US');
            
            calculateDividend();
        }
        
        function calculateDividend() {
            let shares = 0;
            let perShare = 0;
            let taxRate = 0;
            let unit = '';
            
            if (currentDividendMode === 'KOR') {
                shares = safeParseNumber(document.getElementById('div-shares-kor').value);
                perShare = safeParseNumber(document.getElementById('div-per-share-kor').value);
                taxRate = safeParseNumber(document.getElementById('div-tax-rate-kor').value);
                unit = '원';
            } else { // US
                shares = safeParseNumber(document.getElementById('div-shares-us').value);
                perShare = safeParseNumber(document.getElementById('div-per-share-us').value);
                taxRate = safeParseNumber(document.getElementById('div-tax-rate-us').value);
                unit = 'USD';
            }
            
            const gross = shares * perShare;
            const tax = gross * (taxRate / 100);
            const net = gross - tax;
            
            document.getElementById('div-gross').textContent = formatCurrency(gross, unit);
            
            if (unit === 'USD') {
                document.getElementById('div-net-result-value').textContent = net.toFixed(2);
                document.getElementById('div-net-result-unit').textContent = unit;
            } else {
                document.getElementById('div-net-result-value').textContent = formatCurrency(net, '');
                document.getElementById('div-net-result-unit').textContent = unit;
            }
        }
        
        function calculatePnL() {
            const buyCost = safeParseNumber(document.getElementById('pl-buy-cost').value);
            const sellRevenue = safeParseNumber(document.getElementById('pl-sell-revenue').value);
            const feeRate = safeParseNumber(document.getElementById('pl-fee-rate').value) / 100; // e.g., 0.3 -> 0.003
            
            // 매수/매도 시 발생한 수수료/세금 합산 (매수 비용과 매도 금액 모두에 적용된다고 가정)
            const feeTotal = (buyCost * feeRate) + (sellRevenue * feeRate);
            
            const grossProfit = sellRevenue - buyCost;
            const netProfit = grossProfit - feeTotal;
            
            let returnRate = 0;
            if (buyCost > 0) {
                returnRate = (netProfit / buyCost) * 100;
            }
            
            document.getElementById('pl-fee-total').textContent = formatCurrency(feeTotal);
            
            const plText = formatCurrency(netProfit, '');
            const plElement = document.getElementById('pl-profit-loss');
            plElement.textContent = plText;
            
            const rateText = returnRate.toFixed(2);
            const rateElement = document.getElementById('pl-return-rate');
            rateElement.textContent = rateText;

            // 색상 업데이트
            plElement.classList.toggle('text-red-600', netProfit < 0);
            plElement.classList.toggle('text-green-700', netProfit >= 0);
            plElement.classList.toggle('dark:text-red-300', netProfit < 0);
            plElement.classList.toggle('dark:text-green-300', netProfit >= 0);
            
            rateElement.classList.toggle('text-red-600', netProfit < 0);
            rateElement.classList.toggle('text-green-700', netProfit >= 0);
            rateElement.classList.toggle('dark:text-red-300', netProfit < 0);
            rateElement.classList.toggle('dark:text-green-300', netProfit >= 0);
        }

        // [수정] 목표 단가 계산기 토글 로직
        function toggleTargetMode(mode) {
            document.getElementById('mode-cap').checked = mode === 'cap';
            document.getElementById('mode-rate').checked = mode === 'rate';
            
            document.getElementById('target-input-current-cap-row').classList.toggle('hidden', mode !== 'cap');
            document.getElementById('target-cap-input-row').classList.toggle('hidden', mode !== 'cap');
            document.getElementById('target-return-rate-input-row').classList.toggle('hidden', mode !== 'rate');
            
            const currentPriceLabel = document.getElementById('current-price-label');
            const targetPriceLabel = document.getElementById('target-price-label');
            const targetRateInputLabel = document.getElementById('target-rate-input-label'); // NEW ID
            const targetRateRow = document.getElementById('target-rate-row'); // The auxiliary output row

            if (mode === 'cap') {
                // 시가총액 기반: 목표 시총 입력 -> 목표 단가 출력
                currentPriceLabel.textContent = '현재가';
                targetPriceLabel.textContent = '목표 단가:';
                targetRateRow.classList.remove('hidden'); // 시총/수익률 변화를 보조 출력으로 보여줌
                
                // 입력 필드 초기화/라벨 원복 (목표 수익률 %)
                targetRateInputLabel.textContent = '목표 수익률 (%)';
                document.getElementById('target-return-rate').placeholder = '예: 20';
            } else { 
                // 수익률 기반: 목표 매도가 입력 -> 목표 수익률 출력 (Reverse P&L)
                currentPriceLabel.textContent = '매수가';
                targetPriceLabel.textContent = '목표 수익률:'; // SWAP: Output is now Rate
                targetRateInputLabel.textContent = '목표 매도가'; // SWAP: Input is now Price
                targetRateRow.classList.add('hidden'); // 보조 출력 숨김 (메인 출력이 수익률이므로)
                
                // 입력 필드 플레이스홀더 변경
                document.getElementById('target-return-rate').placeholder = '예: 120000';
            }
            
            calculateTargetAnalysis();
        }
        
        // [수정] 목표 단가 계산기 계산 로직
        function calculateTargetAnalysis() {
            const currentPrice = safeParseNumber(document.getElementById('target-current-price').value);
            const shares = safeParseNumber(document.getElementById('target-shares').value);
            const mode = document.querySelector('input[name="target-mode"]:checked')?.value || 'cap';
            
            let mainOutputValue = 0; // 이 값은 targetPrice (cap 모드) 또는 rateChange (rate 모드)가 됨
            let targetPrice = currentPrice; // 평가 금액 계산을 위한 목표 가격
            let rateChange = 0; // 비율 변화
            
            if (mode === 'cap') {
                const currentCapTrillion = safeParseNumber(document.getElementById('target-current-cap').value);
                const targetCapTrillion = safeParseNumber(document.getElementById('target-cap').value);
                
                if (currentCapTrillion > 0) {
                    // 목표 주가 = 현재 주가 * (목표 시총 / 현재 시총)
                    targetPrice = currentPrice * (targetCapTrillion / currentCapTrillion);
                    rateChange = ((targetCapTrillion / currentCapTrillion) - 1) * 100;
                    mainOutputValue = targetPrice; // 출력은 목표 가격 (원)
                }
            } else { // mode === 'rate' -> Input Target Price, Output Required Return Rate (SWAP)
                // target-return-rate 입력 필드를 목표 매도가로 사용
                const targetSellingPrice = safeParseNumber(document.getElementById('target-return-rate').value); 
                
                if (currentPrice > 0) {
                    // 목표 수익률 = (목표 매도가 - 매수가) / 매수가 * 100
                    rateChange = ((targetSellingPrice - currentPrice) / currentPrice) * 100;
                    targetPrice = targetSellingPrice; // 목표 가격은 입력값으로 설정
                    mainOutputValue = rateChange; // 출력은 목표 수익률 (%)
                }
            }
            
            const initialValuation = currentPrice * shares;
            const targetValuation = targetPrice * shares;
            const targetProfit = targetValuation - initialValuation;
            
            const mainOutputEl = document.getElementById('target-price');
            
            // 메인 출력 업데이트 및 포맷팅
            if (mode === 'cap') {
                mainOutputEl.textContent = formatCurrency(mainOutputValue, ''); // 목표 단가 (원)
                document.getElementById('target-rate-row').classList.remove('hidden'); 
                document.getElementById('target-rate').textContent = `${rateChange.toFixed(2)}%`; // 시총/수익률 변화 (비율)
            } else { // mode === 'rate' (Reverse P&L)
                mainOutputEl.textContent = `${mainOutputValue.toFixed(2)}%`; // 목표 수익률 (비율)
                document.getElementById('target-rate-row').classList.add('hidden'); // 보조 비율 출력 숨김
            }

            document.getElementById('target-valuation').textContent = formatCurrency(targetValuation, '');
            
            const profitEl = document.getElementById('target-profit');
            profitEl.textContent = formatCurrency(targetProfit, '');
            
            // 색상 업데이트 (수익률 기반 모드에서 메인 출력(수익률)의 색상도 조정)
            const isProfit = targetProfit >= 0;

            // 예상 수익금 색상
            profitEl.classList.toggle('text-red-600', !isProfit);
            profitEl.classList.toggle('text-green-700', isProfit);
            profitEl.classList.toggle('dark:text-red-300', !isProfit);
            profitEl.classList.toggle('dark:text-green-300', isProfit);

            // 메인 출력 색상 (cap: 단가 -> indigo, rate: 수익률 -> green/red)
            if (mode === 'cap') {
                mainOutputEl.classList.add('text-indigo-700', 'dark:text-indigo-300');
                mainOutputEl.classList.remove('text-red-600', 'text-green-700', 'dark:text-red-300', 'dark:text-green-300');
            } else {
                mainOutputEl.classList.toggle('text-red-600', !isProfit);
                mainOutputEl.classList.toggle('text-green-700', isProfit);
                mainOutputEl.classList.toggle('dark:text-red-300', !isProfit);
                mainOutputEl.classList.toggle('dark:text-green-300', isProfit);
                mainOutputEl.classList.remove('text-indigo-700', 'dark:text-indigo-300');
            }
        }


        // === 금융소득 종합과세 로직 ===
        function addFinancial() {
            const typeSelect = document.getElementById('fin-type');
            const descInput = document.getElementById('fin-desc');
            const amountInput = document.getElementById('fin-amount');

            const amount = parseInt(amountInput.value) || 0;
            if(amount <= 0) { console.error('금액을 입력해주세요.'); return; } 

            const item = {
                id: Date.now(),
                type: typeSelect.value,
                desc: descInput.value.trim() || typeSelect.value,
                amount: amount
            };

            finData.push(item);
            renderFin();
            updateTaxCalc();
            localStorage.setItem('finData', JSON.stringify(finData)); // 데이터 저장

            descInput.value = '';
            amountInput.value = '';
            descInput.focus();
        }

        function removeFin(id) {
            finData = finData.filter(x => x.id !== id);
            renderFin();
            updateTaxCalc();
            localStorage.setItem('finData', JSON.stringify(finData)); // 데이터 저장
        }

        function resetFinancial() {
            openConfirmModal('금융소득 내역을 모두 삭제하시겠습니까?', () => {
                finData = [];
                renderFin();
                updateTaxCalc();
                localStorage.removeItem('finData'); // 데이터 삭제
            });
        }

        function renderFin() {
            const listEl = document.getElementById('fin-list-body');
            listEl.innerHTML = '';
            
            if(finData.length === 0) {
                listEl.innerHTML = `<tr id="fin-no-data"><td colspan="4" class="py-10 text-center text-slate-400"><i class="fa-solid fa-plus-circle mb-2 text-2xl opacity-20"></i><br>데이터를 추가해주세요</td></tr>`;
                return;
            }

            finData.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 dark:hover:bg-slate-700/50 group transition";
                tr.innerHTML = `
                    <td class="px-4 py-3"><span class="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded text-xs text-slate-600 dark:text-slate-300 font-bold">${item.type}</span></td>
                    <td class="px-4 py-3 text-slate-700 dark:text-slate-300">${item.desc}</td>
                    <td class="px-4 py-3 text-right font-bold text-blue-600 dark:text-blue-400">${item.amount.toLocaleString()}</td>
                    <td class="px-2 py-3 text-right">
                        <button onclick="removeFin(${item.id})" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-times"></i></button>
                    </td>
                `;
                listEl.appendChild(tr);
            });
        }

        function addOther() {
            const descInput = document.getElementById('other-desc');
            const revInput = document.getElementById('other-revenue');
            const expInput = document.getElementById('other-expense');

            const rev = parseInt(revInput.value) || 0;
            const exp = parseInt(expInput.value) || 0;
            
            if(rev <= 0) { console.error('총수입금액을 입력해주세요.'); return; } 

            const net = rev - exp;
            const item = {
                id: Date.now(),
                desc: descInput.value.trim() || '기타소득',
                rev: rev,
                exp: exp,
                net: net
            };

            otherData.push(item);
            renderOther();
            updateTaxCalc();
            localStorage.setItem('otherData', JSON.stringify(otherData)); // 데이터 저장

            descInput.value = '';
            revInput.value = '';
            expInput.value = '';
            descInput.focus();
        }

        function removeOther(id) {
            otherData = otherData.filter(x => x.id !== id);
            renderOther();
            updateTaxCalc();
            localStorage.setItem('otherData', JSON.stringify(otherData)); // 데이터 저장
        }

        function resetOther() {
            openConfirmModal('기타소득 내역을 모두 삭제하시겠습니까?', () => {
                otherData = [];
                renderOther();
                updateTaxCalc();
                localStorage.removeItem('otherData'); // 데이터 삭제
            });
        }

        function renderOther() {
            const listEl = document.getElementById('other-list-body');
            listEl.innerHTML = '';
            
            if(otherData.length === 0) {
                listEl.innerHTML = `<tr id="other-no-data"><td colspan="4" class="py-10 text-center text-slate-400"><i class="fa-solid fa-plus-circle mb-2 text-2xl opacity-20"></i><br>데이터를 추가해주세요</td></tr>`;
                return;
            }

            otherData.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 dark:hover:bg-slate-700/50 group transition";
                tr.innerHTML = `
                    <td class="px-4 py-3 font-medium text-slate-700 dark:text-slate-300">${item.desc}</td>
                    <td class="px-4 py-3 text-right text-xs text-slate-400"><div>+ ${item.rev.toLocaleString()}</div><div class="text-red-300 dark:text-red-400">- ${item.exp.toLocaleString()}</div></td>
                    <td class="px-4 py-3 text-right font-bold text-emerald-600 dark:text-emerald-400">${item.net.toLocaleString()}</td>
                    <td class="px-2 py-3 text-right">
                        <button onclick="removeOther(${item.id})" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-times"></i></button>
                    </td>
                `;
                listEl.appendChild(tr);
            });
        }
        
        // ** [REFINED] 누진세액 계산 함수 (종합소득세율표 기반) **
        function getIncomeTax(income) {
             // 과세표준에 따른 종합소득세 (지방세 10% 제외)
            if (income <= 0) return 0;
            // 1. 1,400만원 이하: 6% (누진공제 0)
            if (income <= 14000000) return income * 0.06;
            // 2. 5,000만원 이하: 15% (누진공제 126만원)
            if (income <= 50000000) return income * 0.15 - 1260000;
            // 3. 8,800만원 이하: 24% (누진공제 586만원)
            if (income <= 88000000) return income * 0.24 - 5860000;
            // 4. 1억 5천만원 이하: 35% (누진공제 1,544만원)
            if (income <= 150000000) return income * 0.35 - 15440000;
            // 5. 3억원 이하: 38% (누진공제 1,994만원)
            if (income <= 300000000) return income * 0.38 - 19940000;
            // 6. 5억원 이하: 40% (누진공제 2,594만원)
            if (income <= 500000000) return income * 0.40 - 25940000;
            // 7. 10억원 이하: 42% (누진공제 3,594만원)
            if (income <= 1000000000) return income * 0.42 - 35940000;
            // 8. 10억원 초과: 45% (누진공제 6,594만원)
            return income * 0.45 - 65940000;
        }

        function updateTaxCalc() {
            // 1. 합계 계산
            const finTotal = finData.reduce((sum, item) => sum + item.amount, 0);
            const otherTotal = otherData.reduce((sum, item) => sum + item.net, 0);
            
            // 2. 상단 요약 업데이트
            document.getElementById('summary-fin-total').textContent = finTotal.toLocaleString() + ' 원';
            document.getElementById('summary-other-total').textContent = otherTotal.toLocaleString() + ' 원';
            
            // 3. 종합과세 판단
            let grandTotal = 0;
            const badge = document.getElementById('badge-tax-type');
            const taxFlag = document.getElementById('tax-flag');
            const healthWarning = document.getElementById('health-warning'); 
            
            // 종합과세 대상 소득 (근로/사업소득 등 - 기타소득만 포함)
            const taxableBaseOther = Math.max(0, otherTotal); // 실제 종합소득은 기본공제 등이 있지만, 여기서는 간이 계산을 위해 기타소득 순액만 가정
            
            if (finTotal > TAX_THRESHOLD) {
                // 종합과세: 금융소득 전체 + 기타소득 합산
                // (금융소득 2천만원 + 초과분) + 기타소득
                grandTotal = finTotal + otherTotal;
                
                badge.className = "inline-block mt-4 px-3 py-1 bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-200 text-xs font-bold rounded-full animate-pulse";
                badge.innerHTML = `<i class="fa-solid fa-triangle-exclamation mr-1"></i>종합과세 대상 (2천만원 초과)`;
                taxFlag.classList.remove('hidden');
                healthWarning.classList.remove('hidden'); // Show warning
            } else {
                // 분리과세: 금융소득은 따로, 기타소득만 종합소득에 (여기선 사용자 이해를 돕기 위해 '총 번 돈' 개념으로 합산 표시)
                grandTotal = finTotal + otherTotal;
                
                if (finTotal > 0) {
                    badge.className = "inline-block mt-4 px-3 py-1 bg-green-100 dark:bg-green-900 text-green-600 dark:text-green-200 text-xs font-bold rounded-full";
                    badge.innerHTML = `<i class="fa-solid fa-check mr-1"></i>분리과세 종결 (2천만원 이하)`;
                } else {
                    badge.className = "inline-block mt-4 px-3 py-1 bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 text-xs font-bold rounded-full";
                    badge.innerText = "데이터 없음";
                }
                taxFlag.classList.add('hidden');
                healthWarning.classList.add('hidden'); // Hide warning
            }
            
            document.getElementById('summary-grand-total').textContent = grandTotal.toLocaleString() + ' 원';

            // 4. 하단 세금 계산기 업데이트
            updateTaxDetail(finTotal, otherTotal); // finIncome 대신 finTotal 사용
        }
        
        function updateTaxDetail(finIncome, otherIncome) {
            const limit = TAX_THRESHOLD; // 20000000
            const progressBar = document.getElementById('tax-progress-bar');
            const statusMsg = document.getElementById('tax-status-msg');
            
            // 게이지 바 업데이트 (최대 4000만원 기준 시각화)
            const maxGauge = 40000000;
            const ratio = Math.min(100, (finIncome / maxGauge) * 100); 

            if (finIncome === 0) {
                progressBar.style.width = '0%';
                progressBar.style.background = 'linear-gradient(90deg, #4ade80, #22c55e)';
                statusMsg.innerHTML = '금융소득 내역을 입력하면 계산됩니다.';
                statusMsg.className = 'text-center mt-3 font-bold text-sm text-slate-400';
            } else if (finIncome <= limit) {
                // 2천만원 이하: 안전
                progressBar.style.width = `${ratio}%`;
                progressBar.style.background = 'linear-gradient(90deg, #4ade80, #22c55e)'; // Green
                statusMsg.innerHTML = `<span class="text-green-600 dark:text-green-400"><i class="fa-solid fa-shield-halved"></i> 안전합니다! 분리과세(15.4%)로 종결됩니다.</span>`;
            } else {
                // 2천만원 초과: 위험 (경고 영역 포함)
                progressBar.style.width = `${ratio}%`;
                progressBar.style.background = 'linear-gradient(90deg, #f87171, #ef4444)'; // Red
                statusMsg.innerHTML = `<span class="text-red-500 dark:text-red-400"><i class="fa-solid fa-triangle-exclamation"></i> <strong>2,000만원 초과!</strong> 종합과세 대상입니다.</span>`;
            }

            // 세금 계산
            let taxStep1 = 0; // 2천만원 이하분에 대한 15.4% 분리과세액
            let taxStep2 = 0; // 초과분에 대한 누진세액 (종합소득세 비교과세)

            if (finIncome <= limit) {
                 // 2천만원 이하: 전액 15.4%
                 taxStep1 = finIncome * 0.154;
                 taxStep2 = 0;
            } else {
                 // 2천만원 초과
                 // 1. 2천만원까지는 15.4% 분리과세 (세금 종결)
                 taxStep1 = limit * 0.154;
                 
                 // 2. 초과분은 누진세율 적용 (비교과세 간이 계산)
                 const excessPart = finIncome - limit;
                 
                 // (기타소득 + 초과분) 세액
                 const totalIncomeForTax = otherIncome + excessPart;
                 const totalTaxBeforeLocal = getIncomeTax(totalIncomeForTax);
                 
                 // 기타소득(otherIncome)에 대한 세액
                 const baseTaxBeforeLocal = getIncomeTax(otherIncome);
                 
                 // 초과분에 대해서만 누진세율을 적용했을 때의 세금 (지방세 10% 포함)
                 const incomeTaxOnly = totalTaxBeforeLocal - baseTaxBeforeLocal; 
                 const calculatedTax = incomeTaxOnly * 1.1; // 지방세 10% 추가
                 
                 // 비교과세: 최소한 2천만원 초과분은 15.4%로 과세 (실제로는 복잡함, 간이화)
                 const minTax = excessPart * 0.154;
                 
                 // 누진세가 15.4%보다 적게 나오더라도 최소 15.4%를 적용 (비교과세의 간이 형태)
                 taxStep2 = Math.max(calculatedTax, minTax);
            }

            document.getElementById('tax-step-1-val').textContent = Math.floor(taxStep1).toLocaleString() + ' 원';
            document.getElementById('tax-step-2-val').textContent = Math.floor(taxStep2).toLocaleString() + ' 원';
            document.getElementById('tax-total-result').textContent = Math.floor(taxStep1 + taxStep2).toLocaleString() + ' 원';
        }

        // === 전체 초기화 ===
        function init() { 
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // 1. 테마 설정
            let isDark = savedTheme === 'dark' || (savedTheme === null && systemPrefersDark);
            if (isDark) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            updateThemeIcon(isDark);
            
            // 2. 링크 및 즐겨찾기 초기화
            initLinks(); 
            initWatchlist(); 
            initFavoriteSymbols(); 
            
            // 3. 시간 업데이트 시작
            setInterval(updateTime, 1000); 
            updateTime(); 
            
            // 4. 금융소득 내역 불러오기 (초기 로드)
            const savedFin = localStorage.getItem('finData');
            const savedOther = localStorage.getItem('otherData');
            finData = savedFin ? JSON.parse(savedFin) : [];
            otherData = savedOther ? JSON.parse(savedOther) : [];
            
            // 5. 초기 페이지 로드: 대시보드로 강제 시작
            document.getElementById('page-routine').classList.add('page-hidden');
            document.getElementById('page-tools').classList.add('page-hidden');
            document.getElementById('page-tax').classList.add('page-hidden');
            
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-dashboard').classList.add('active');
            
            // 6. 위젯 로드 (대시보드 내용) - 초기 시장 상태 결정 및 위젯 로드
            checkMarketStatus();
            loadTickerWidget(getCurrentTheme()); 
            
            // [NEW] 장운영 상태 1분 인터벌 설정 (checkMarketStatus가 시장 소스 결정 및 위젯 로드 역할도 수행)
            marketStatusInterval = setInterval(checkMarketStatus, 60000); 
            
            updateLinkModeUI();
        }
        
        init();
    </script>
</body>
</html>