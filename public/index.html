<!DOCTYPE html>
<html lang="ko" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Map Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        
        /* ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; } /* slate-400 */
        .dark ::-webkit-scrollbar-thumb { background: #475569; } /* slate-600 */
        
        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tab-btn { border-bottom: 3px solid transparent; color: #64748b; transition: all 0.2s; }
        .tab-btn.active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: 700; }
        .dark .tab-btn.active { border-bottom: 3px solid #60a5fa; color: #60a5fa; }

        /* ë² ìŠ¤íŠ¸ê¸€ ê°•ì¡° íš¨ê³¼ */
        .best-post-card { 
            background: linear-gradient(to right, #fee2e2, #fff); 
            border-left: 4px solid #ef4444; 
            transition: all 0.2s;
        }
        .dark .best-post-card { 
            background: linear-gradient(to right, #450a0a, #1e293b); 
            border-left: 4px solid #f87171; 
        }
        
        /* ì‹œì¥ ì‹¬ë„ í‘œì‹œë¥¼ ìœ„í•œ í´ë˜ìŠ¤ */
        .breadth-bar-container { height: 16px; background-color: #3b82f6; } 
        .breadth-bar-red { background-color: #ef4444; } 
        
        /* ìº”ë²„ìŠ¤ ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ë°˜ì‘í˜• ì„¤ì •) */
        #stock-chart-canvas {
            width: 100%;
            height: 150px;
            display: block;
        }

        /* ğŸ¥‡ğŸ¥ˆğŸ¥‰ ìˆœìœ„ ìŠ¤í‹°ì»¤ ì• ë‹ˆë©”ì´ì…˜ ë° ìƒ‰ìƒ ê°•í™” */
        .rank-pop {
            animation: rankPop 1.5s infinite;
            background: linear-gradient(135deg, #fef2f2, #ef4444);
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }
        @keyframes rankPop {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { 
                transform: scale(1.1); 
                box-shadow: 0 0 10px 3px rgba(239, 68, 68, 0.9);
            }
        }
        
        /* â­ 3D Tilt íš¨ê³¼ ë° ê·¸ë¦¼ì ê°•í™” */
        .treemap-card-3d {
            transition: transform 0.1s ease-out, box-shadow 0.1s ease-out; 
            transform-style: preserve-3d; 
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15); /* ê¸°ë³¸ ê·¸ë¦¼ì ê°•í™” */
        }
        .dark .treemap-card-3d {
             box-shadow: 0 6px 15px rgba(255, 255, 255, 0.08);
        }
        
        /* 5. ì„¹í„°ë³„ ê²½ê³„ì„  ìƒ‰ìƒ í´ë˜ìŠ¤ */
        .border-sector-red { border-color: #ef4444; }
        .border-sector-blue { border-color: #3b82f6; }
        .border-sector-green { border-color: #10b981; }
        .border-sector-purple { border-color: #8b5cf6; }
        .border-sector-amber { border-color: #f59e0b; }
        .border-sector-orange { border-color: #f97316; }
        .border-sector-indigo { border-color: #6366f1; }
        .border-sector-lime { border-color: #84cc16; }
        .border-sector-cyan { border-color: #06b6d4; }
        .border-sector-pink { border-color: #ec4899; }
        .border-sector-teal { border-color: #14b8a6; }
        
        /* ìƒìŠ¹/í•˜ë½ì— ë”°ë¥¸ íŠ¸ë ˆë§µ ì¹´ë“œ ë°°ê²½ ê°•ì¡° (ë¯¸ì„¸í•œ ê·¸ë¼ë””ì–¸íŠ¸) */
        .bg-gradient-positive { background: linear-gradient(135deg, #fef2f2 5%, #fff 50%); }
        .bg-gradient-negative { background: linear-gradient(135deg, #eff6ff 5%, #fff 50%); }
        .dark .bg-gradient-positive { background: linear-gradient(135deg, #450a0a 5%, #1e293b 50%); }
        .dark .bg-gradient-negative { background: linear-gradient(135deg, #1e3a8a 5%, #1e293b 50%); }
        
        /* Proportional Layoutì˜ ìŠ¤í¬ë¡¤ ì²˜ë¦¬ */
        .proportional-basket-stocks {
            max-height: none; /* ìµœëŒ€ ë†’ì´ ì œí•œ ì œê±° */
            overflow-y: visible; /* ìŠ¤í¬ë¡¤ë°” ì œê±° */
        }
        
    </style>
</head>
<body class="bg-slate-50 text-slate-800 transition-colors duration-200 dark:bg-slate-900 dark:text-slate-100">

    <!-- ìƒë‹¨ í—¤ë” -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50 dark:bg-slate-800 dark:border-slate-700">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-chart-line text-blue-600 text-xl dark:text-blue-400"></i>
                <h1 class="font-bold text-xl tracking-tight">Market Dashboard</h1>
                <span id="status-badge" class="flex items-center gap-1 text-xs font-bold bg-red-500 text-white px-2 py-0.5 rounded-full shadow-md animate-pulse">
                    <i class="fa-solid fa-circle text-[6px]"></i> LIVE
                </span>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ -->
                <button onclick="manualRefresh()" id="btn-refresh" 
                        class="p-2 text-slate-500 hover:text-blue-600 dark:text-slate-400 dark:hover:text-blue-400 transition-colors"
                        title="ìˆ˜ë™ìœ¼ë¡œ ì‹œì„¸ ê°±ì‹ ">
                    <i class="fa-solid fa-arrows-rotate"></i>
                </button>
                <button onclick="toggleDarkMode()" class="p-2"><i id="theme-icon" class="fa-solid fa-moon"></i></button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6 space-y-8">
        
        <!-- 1. ì£¼ìš” ì§€í‘œ ì¹´ë“œ ì„¹ì…˜: ê·¸ë¦¼ìì™€ í˜¸ë²„ íš¨ê³¼ ê°•í™” -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
            <!-- ì§€í‘œ ì¹´ë“œë“¤ì€ JSë¡œ ë¡œë“œë©ë‹ˆë‹¤. -->
            <div id="indices-container" class="contents"></div>
        </div>

        <!-- 2. 2ë‹¨ ë ˆì´ì•„ì›ƒ: Market Map (ì¢Œ) vs Detail Panel (ìš°) -->
        <!-- ëª¨ë°”ì¼: ìƒì„¸ ì •ë³´(Detail Panel)ë¥¼ ë¨¼ì € í‘œì‹œ (order-1) -->
        <!-- ë°ìŠ¤í¬í†±: ì‹œì¥ ì§€ë„(Market Map)ë¥¼ ë¨¼ì € í‘œì‹œ (lg:order-1) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- ì˜¤ë¥¸ìª½: ìƒì„¸ ì •ë³´ ë° ë„êµ¬ íŒ¨ë„ (1/3 ì°¨ì§€) -->
            <div class="lg:col-span-1 space-y-6 order-1 lg:order-2">
                
                <!-- 1. ì¢…ëª© ìƒì„¸ ì •ë³´ (ê²€ìƒ‰ + íƒ­) -->
                <div class="bg-white rounded-2xl border border-slate-200 shadow-xl overflow-hidden dark:bg-slate-800 dark:border-slate-700">
                    
                    <!-- ê²€ìƒ‰ ë° ê°€ê²© í—¤ë” -->
                    <div class="p-5 pb-3 border-b border-slate-100 dark:border-slate-700">
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="symbol-input" value="005930" placeholder="ì¢…ëª©ì½”ë“œ (ì˜ˆ: 005930)"
                                class="bg-slate-50 border border-slate-200 text-sm rounded-xl block w-full p-2.5 dark:bg-slate-700 dark:border-slate-600 dark:text-white" 
                                onkeypress="if(event.key==='Enter') fetchAllData()">
                            <button onclick="fetchAllData()" class="bg-blue-600 text-white rounded-xl px-4 py-2 text-sm font-bold whitespace-nowrap hover:bg-blue-700 transition-colors">ì¡°íšŒ</button>
                        </div>
                        
                        <!-- ê°€ê²© ë° ì¦ê²¨ì°¾ê¸° -->
                        <div class="flex justify-between items-start">
                            <div>
                                <!-- ì¢…ëª©ëª… í‘œì‹œ -->
                                <h3 id="main-name" class="text-2xl font-extrabold mb-1 dark:text-white leading-snug">Loading Name...</h3> 
                                <div class="flex items-center gap-2 mb-1">
                                    <h2 class="text-4xl font-extrabold" id="main-price">-</h2>
                                    <button onclick="toggleFavorite()" id="btn-favorite" class="text-slate-300 hover:text-yellow-400 transition-colors text-3xl" title="ê´€ì‹¬ ì¢…ëª© ì¶”ê°€/ì‚­ì œ">
                                        <i class="fa-solid fa-star"></i>
                                    </button>
                                </div>
                                <div class="flex items-end gap-2">
                                    <div class="text-lg font-bold" id="main-change">-</div>
                                    <div class="text-sm text-slate-400 mb-1" id="main-symbol">Loading...</div>
                                </div>
                                
                                <!-- ì‹œì´ ë° ìˆœìœ„ ì •ë³´ (ê°œì„ ëœ ë ˆì´ì•„ì›ƒ) -->
                                <div id="stock-meta-info" class="mt-3 bg-slate-50 dark:bg-slate-700/50 p-2 rounded-lg text-xs">
                                    <!-- JSì— ì˜í•´ ì±„ì›Œì§ (ì‹œì´, ìˆœìœ„ ì •ë³´) -->
                                </div>
                            </div>
                            
                            <!-- ë§í¬ ë²„íŠ¼ ê·¸ë£¹ (ì„¸ë¡œ ë°°ì—´) -->
                            <div class="flex flex-col gap-2 pt-1">
                                <a id="link-naver" href="#" target="_blank" class="px-3 py-2 bg-[#03C75A] text-white rounded-xl text-xs font-bold text-center hover:bg-green-600 transition-colors">ë„¤ì´ë²„ ì¦ê¶Œ</a>
                                <a id="link-dart" href="#" target="_blank" class="px-3 py-2 bg-indigo-600 text-white rounded-xl text-xs font-bold text-center hover:bg-indigo-700 transition-colors">DART ê³µì‹œ ê²€ìƒ‰</a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-5 pt-0">
                        <!-- ìº”ë“¤ì°¨íŠ¸ ìº”ë²„ìŠ¤ -->
                        <div class="relative mb-5 p-3 rounded-xl bg-slate-50 dark:bg-slate-700/50 shadow-inner mt-4">
                            <canvas id="stock-chart-canvas"></canvas>
                            <div id="chart-loading" class="absolute inset-0 flex items-center justify-center text-slate-400 text-sm bg-slate-50/80 dark:bg-slate-700/80 rounded-xl">
                                ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                            </div>
                        </div>

                        <!-- íƒ­ ë©”ë‰´ (ë‰´ìŠ¤/ì»¤ë®¤ë‹ˆí‹°) -->
                        <div class="flex border-b border-slate-200 dark:border-slate-700 mb-4">
                            <button onclick="switchTab('news')" id="tab-news" class="tab-btn active flex-1 py-3 text-sm font-medium">
                                <i class="fa-regular fa-newspaper mr-1"></i> ë‰´ìŠ¤/ê³µì‹œ
                            </button>
                            <button onclick="switchTab('community')" id="tab-community" class="tab-btn flex-1 py-3 text-sm font-medium">
                                <i class="fa-solid fa-fire mr-1 text-red-500"></i> í† ë¡ ë°© (BEST)
                            </button>
                        </div>
                    </div>

                    <!-- íƒ­ ì½˜í…ì¸  ì˜ì—­ -->
                    <div class="px-5 pb-5 min-h-[300px] max-h-[500px] overflow-y-auto">
                        
                        <!-- 1. ë‰´ìŠ¤ íƒ­ -->
                        <div id="content-news" class="space-y-3">
                            <div class="text-center text-slate-400 py-10">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                        </div>

                        <!-- 2. ì»¤ë®¤ë‹ˆí‹° íƒ­ (BEST ê¸°ëŠ¥) -->
                        <div id="content-community" class="hidden space-y-4">
                            <!-- ì‹¤ì‹œê°„ ë² ìŠ¤íŠ¸ ì„¹ì…˜ -->
                            <div class="mb-4">
                                <h4 class="text-sm font-bold text-red-500 mb-2 flex items-center">
                                    <i class="fa-solid fa-crown mr-2"></i> ì‹¤ì‹œê°„ ì¸ê¸°ê¸€ (Top 3)
                                </h4>
                                <div id="best-community-list" class="space-y-2">
                                    <!-- ë² ìŠ¤íŠ¸ê¸€ 5ê°œ ë“¤ì–´ê°ˆ ê³³ -->
                                </div>
                            </div>
                            <hr class="border-slate-100 dark:border-slate-700 my-4">
                            <!-- ìµœì‹ ê¸€ ì„¹ì…˜ -->
                            <h4 class="text-xs font-bold text-slate-500 mb-2">â±ï¸ ìµœì‹ ê¸€</h4>
                            <div id="latest-community-list" class="space-y-2">
                                <!-- ìµœì‹ ê¸€ ë¦¬ìŠ¤íŠ¸ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. ë‚˜ì˜ ê´€ì‹¬ ì¢…ëª© ìœ„ì ¯: ê²½ê³„ì„ ê³¼ ë°°ê²½ìƒ‰ ê°•ì¡° -->
                <div class="bg-white rounded-2xl border-2 border-yellow-300 dark:border-yellow-700 shadow-lg dark:bg-slate-800 overflow-hidden">
                    <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-yellow-50 dark:bg-yellow-900/50">
                        <h3 class="font-bold text-slate-800 dark:text-slate-200 flex items-center gap-2">
                            <i class="fa-solid fa-star text-yellow-500"></i> ë‚˜ì˜ ê´€ì‹¬ ì¢…ëª©
                        </h3>
                    </div>
                    <!-- ì˜¤ë¥˜ í•´ê²°ì„ ìœ„í•´ ID ì¶”ê°€ -->
                    <div id="watchlist-container" class="divide-y divide-slate-100 dark:divide-slate-700 max-h-[300px] overflow-y-auto">
                        <div class="p-4 text-center text-xs text-slate-400">â˜… ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¢…ëª©ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</div>
                    </div>
                </div>

                <!-- 2. í™˜ìœ¨ ê³„ì‚°ê¸° ìœ„ì ¯: ê²½ê³„ì„ ê³¼ ë°°ê²½ìƒ‰ ê°•ì¡° -->
                <div class="bg-white p-5 rounded-2xl border-2 border-blue-300 dark:border-blue-700 shadow-lg dark:bg-slate-800">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2 dark:text-slate-200">
                        <i class="fa-solid fa-calculator text-blue-500"></i> í™˜ìœ¨ ê³„ì‚°ê¸°
                    </h3>
                    
                    <!-- í†µí™” ì„ íƒ ë“œë¡­ë‹¤ìš´ ë° ë™ì  ì…ë ¥/ì¶œë ¥ í•„ë“œ - EUR, JPY ìœ ì§€ -->
                    <div class="space-y-4">
                        <!-- ì™¸í™” ì…ë ¥ í•„ë“œ -->
                        <div class="flex items-center gap-2">
                            <select id="calc-currency-select" onchange="updateCurrencyRate(); calculateExchange()"
                                    class="w-24 p-2.5 bg-slate-50 border border-slate-300 rounded-xl text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white font-bold cursor-pointer">
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="JPY">JPY</option>
                            </select>
                            <input type="number" id="calc-input-foreign" placeholder="100" oninput="calculateExchange()"
                                class="flex-1 p-3 bg-slate-50 border border-slate-300 rounded-xl text-right font-mono text-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        </div>
                        <!-- KRW ì¶œë ¥ í•„ë“œ -->
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-bold text-slate-600 dark:text-slate-400 w-24 text-center">KRW (ì›)</span>
                            <input type="text" id="calc-input-krw" readonly 
                                class="flex-1 p-3 bg-blue-50 border border-blue-200 rounded-xl text-right font-mono font-extrabold text-lg text-blue-800 dark:bg-blue-900/30 dark:border-blue-700 dark:text-blue-300" value="-">
                        </div>
                        <!-- í˜„ì¬ í™˜ìœ¨ í‘œì‹œ -->
                        <div class="text-right text-xs text-slate-500 dark:text-slate-400 pt-1 border-t border-slate-100 dark:border-slate-700">
                            í˜„ì¬ í™˜ìœ¨: <span id="current-rate" class="font-bold">-</span>ì›/<span id="current-currency-unit">USD</span>
                        </div>
                    </div>

                </div>

            </div>

            <!-- ì™¼ìª½: ì‹œì¥ ì§€ë„ (Market Map, 2/3 ì°¨ì§€) -->
            <div class="lg:col-span-2 space-y-6 order-2 lg:order-1">
                
                <!-- Market Map ì»¨íŠ¸ë¡¤ íŒ¨ë„: í•„í„°, ì •ë ¬, ì‹¬ë„ í‘œì‹œ í†µí•© -->
                <div class="bg-white p-4 rounded-xl shadow-lg border border-slate-200 dark:bg-slate-800 dark:border-slate-700 space-y-4">
                    <h2 class="text-xl font-bold flex items-center gap-2 text-slate-700 dark:text-slate-300">
                        <i class="fa-solid fa-earth-americas text-blue-600"></i> ì‹œì¥ ì§€ë„ ë¶„ì„ (Market Map)
                    </h2>
                    
                    <!-- í•„í„° ë° ì •ë ¬ -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        
                        <!-- ì‹œì¥ í•„í„° ë²„íŠ¼ ê·¸ë£¹ -->
                        <div class="flex gap-2 text-sm">
                            <button id="filter-all" onclick="renderMarketMap('ALL', currentSortBy)" class="px-3 py-1.5 rounded-xl text-xs font-medium border border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">ì „ì²´ëª¨ë“œ</button>
                            <button id="filter-kospi_top_60" onclick="renderMarketMap('KOSPI_TOP_60', currentSortBy)" class="px-3 py-1.5 rounded-xl text-xs font-medium border border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">KOSPI Top 50</button>
                            <button id="filter-kosdaq_top_60" onclick="renderMarketMap('KOSDAQ_TOP_60', currentSortBy)" class="px-3 py-1.5 rounded-xl text-xs font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors">KOSDAQ Top 60</button>
                        </div>
                        
                        <!-- ë³´ê¸° ë°©ë²• ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
                        <div class="flex items-center gap-2">
                            <label for="sort-by-select" class="text-sm font-medium text-slate-500 dark:text-slate-400 whitespace-nowrap">ë³´ê¸°:</label>
                            <select id="sort-by-select" onchange="renderMarketMap(currentFilterMode, this.value)"
                                    class="p-2 text-sm bg-slate-50 border border-slate-300 rounded-xl dark:bg-slate-700 dark:border-slate-600 cursor-pointer focus:ring-blue-500 focus:border-blue-500">
                                <option value="cap">ì‹œê°€ì´ì•¡ ì§€ë„</option>
                                <option value="sector_list">ì—…ì¢…ë³„ ëª©ë¡</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- ì‹œì¥ ì‹¬ë„ (Market Breadth) Indicator -->
                    <div id="market-breadth-indicator" class="pt-2 border-t border-slate-100 dark:border-slate-700">
                        <div class="flex justify-between items-center text-xs font-medium mb-1 text-slate-500 dark:text-slate-400">
                            <span class="flex items-center gap-1 text-blue-500"><i class="fa-solid fa-chart-line"></i> í•˜ë½/ìœ ì§€ ì¢…ëª© ìˆ˜</span>
                            <span class="text-xs font-bold text-slate-700 dark:text-slate-300">ì‹œì¥ ì‹¬ë„ í˜„í™© (ìƒìŠ¹ vs í•˜ë½)</span>
                            <span class="flex items-center gap-1 text-red-500"><i class="fa-solid fa-chart-line"></i> ìƒìŠ¹ ì¢…ëª© ìˆ˜</span>
                        </div>
                        <div class="breadth-bar-container rounded-lg overflow-hidden relative shadow-inner">
                            <div id="breadth-up-bar" class="h-full breadth-bar-red transition-all duration-500" style="width: 50%;"></div>
                            <div class="absolute inset-y-0 left-1/2 w-px bg-slate-400 dark:bg-slate-500 opacity-50"></div>
                        </div>
                        <div class="flex justify-between text-xs mt-1 text-slate-600 dark:text-slate-400 font-bold">
                            <span id="breadth-down-count" class="text-blue-500">-</span>
                            <span id="breadth-up-count" class="text-red-500">-</span>
                        </div>
                    </div>
                </div>

                <!-- ì„¹í„°ë³„ ì¢…ëª© ê·¸ë£¹ ì»¨í…Œì´ë„ˆ -->
                <div id="market-map-container" class="space-y-6">
                    <div class="text-center py-10 text-slate-400">ì‹œì´ ìˆœìœ¼ë¡œ ì¢…ëª©ë“¤ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // === ì„¤ì • ===
        // ì£¼ìš” ì§€í‘œ 6ê°œë§Œ í‘œì‹œ (EUR/JPY ì œì™¸)
        const INDICES = [
            { id: '^KS11', name: 'KOSPI', link: 'https://finance.naver.com/sise/sise_index.nhn?code=KOSPI' },
            { id: '^KQ11', name: 'KOSDAQ', link: 'https://finance.naver.com/sise/sise_index.nhn?code=KOSDAQ' },
            { id: 'NQ=F', name: 'NASDAQ ì„ ë¬¼', link: 'https://kr.investing.com/indices/nq-100-futures' }, 
            { id: 'KRW=X', name: 'USD/KRW', link: 'https://finance.naver.com/marketindex/exchangeDetail.naver?marketindexCd=FX_USDKRW' },
            { id: 'BTC-KRW', name: 'Bitcoin', link: 'https://kr.investing.com/crypto/bitcoin/btc-krw' },
            { id: 'XAG=X', name: 'Silver', link: 'https://kr.investing.com/commodities/silver' } 
        ];

        let currentRates = {
            USD: { rate: 1350.00, link: 'https://finance.naver.com/marketindex/exchangeDetail.naver?marketindexCd=FX_USDKRW', unit: 1 },
            EUR: { rate: 1450.00, link: 'https://finance.naver.com/marketindex/exchangeDetail.naver?marketindexCd=FX_EURKRW', unit: 1 },
            JPY: { rate: 9.50, link: 'https://finance.naver.com/marketindex/exchangeDetail.naver?marketindexCd=FX_JPYKRW', unit: 100 } 
        };
        let selectedCurrency = 'USD'; 
        
        let currentFilterMode = 'KOSDAQ_TOP_60'; 
        let currentSortBy = 'cap'; 

        // Market Mapì— í‘œì‹œí•  ì¢…ëª© ëª©ë¡ (ì‹œê°€ì´ì•¡ ë° ì„¹í„° ì •ë³´ í¬í•¨)
        const ALL_MARKET_MAP_STOCKS = {
            // --- KOSPI (Cap Total Sorting) ---
            'ë°˜ë„ì²´ ëŒ€í˜•ì£¼/IDM': [ 
                { code: '005930', name: 'ì‚¼ì„±ì „ì', change: 3.14, price: 108400, market: 'KOSPI', cap: 6416888, rank: 1 },
                { code: '000660', name: 'SKí•˜ì´ë‹‰ìŠ¤', change: 0.37, price: 544000, market: 'KOSPI', cap: 3960333, rank: 2 },
                { code: '005935', name: 'ì‚¼ì„±ì „ììš°', change: 1.39, price: 80100, market: 'KOSPI', cap: 653596, rank: 5 },
            ],
            '2ì°¨ì „ì§€ ì…€/í•µì‹¬ì†Œì¬(KOSPI)': [ 
                { code: '373220', name: 'LGì—ë„ˆì§€ì†”ë£¨ì…˜', change: 3.90, price: 426000, market: 'KOSPI', cap: 996840, rank: 3 },
                { code: '006400', name: 'ì‚¼ì„±SDI', change: 1.65, price: 307500, market: 'KOSPI', cap: 247800, rank: 28 },
                { code: '051910', name: 'LGí™”í•™', change: 1.46, price: 381500, market: 'KOSPI', cap: 269310, rank: 24 },
                { code: '008650', name: 'í¬ìŠ¤ì½”í“¨ì²˜ì— ', change: 0.73, price: 206000, market: 'KOSPI', cap: 183229, rank: 39 },
                { code: '096770', name: 'SKì´ë…¸ë² ì´ì…˜', change: 1.78, price: 114600, market: 'KOSPI', cap: 193734, rank: 36 },
            ],
            'ì œì•½/ë°”ì´ì˜¤ ëŒ€í˜•': [ 
                { code: '207940', name: 'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤', change: -2.32, price: 1641000, market: 'KOSPI', cap: 759634, rank: 4 },
                { code: '068270', name: 'ì…€íŠ¸ë¦¬ì˜¨', change: 0.38, price: 183300, market: 'KOSPI', cap: 423351, rank: 12 },
            ],
            'ì™„ì„±ì°¨ ë° ëŒ€í˜•ë¶€í’ˆ': [ 
                { code: '005380', name: 'í˜„ëŒ€ì°¨', change: 11.11, price: 315000, market: 'KOSPI', cap: 644987, rank: 6 },
                { code: '000270', name: 'ê¸°ì•„', change: 2.74, price: 123600, market: 'KOSPI', cap: 482550, rank: 9 },
                { code: '012330', name: 'í˜„ëŒ€ëª¨ë¹„ìŠ¤', change: 4.32, price: 362500, market: 'KOSPI', cap: 328906, rank: 19 },
            ],
            'ì¡°ì„ /ë°©ì‚°/ì¤‘ê³µì—…': [ 
                { code: '034020', name: 'ë‘ì‚°ì—ë„ˆë¹Œë¦¬í‹°', change: 1.52, price: 80400, market: 'KOSPI', cap: 515011, rank: 7 },
                { code: '329180', name: 'HDí˜„ëŒ€ì¤‘ê³µì—…', change: 1.33, price: 534000, market: 'KOSPI', cap: 474048, rank: 10 },
                { code: '000830', name: 'ì‚¼ì„±ë¬¼ì‚°', change: 1.46, price: 244000, market: 'KOSPI', cap: 414743, rank: 13 },
                { code: '036620', name: 'í•œí™”ì˜¤ì…˜', change: 1.88, price: 108500, market: 'KOSPI', cap: 332459, rank: 18 },
                { code: '329180', name: 'HDí•œêµ­ì¡°ì„ í•´ì–‘', change: 3.10, price: 432000, market: 'KOSPI', cap: 305740, rank: 21 },
                { code: '010140', name: 'ì‚¼ì„±ì¤‘ê³µì—…', change: 3.25, price: 25450, market: 'KOSPI', cap: 223960, rank: 30 },
            ],
            'ì€í–‰/ì¢…í•©ê¸ˆìœµ': [ 
                { code: '105560', name: 'KBê¸ˆìœµ', change: 1.48, price: 130700, market: 'KOSPI', cap: 498571, rank: 8 },
                { code: '055550', name: 'ì‹ í•œì§€ì£¼', change: 1.91, price: 80200, market: 'KOSPI', cap: 389367, rank: 16 },
                { code: '032830', name: 'ì‚¼ì„±ìƒëª…', change: 0.76, price: 158200, market: 'KOSPI', cap: 316400, rank: 20 },
                { code: '086790', name: 'í•˜ë‚˜ê¸ˆìœµì§€ì£¼', change: 0.74, price: 95200, market: 'KOSPI', cap: 264966, rank: 25 },
                { code: '000810', name: 'ì‚¼ì„±í™”ì¬', change: 5.03, price: 522000, market: 'KOSPI', cap: 240178, rank: 29 },
                { code: '316140', name: 'ìš°ë¦¬ê¸ˆìœµì§€ì£¼', change: 0.88, price: 28500, market: 'KOSPI', cap: 209212, rank: 31 },
                { code: '138040', name: 'ë©”ë¦¬ì¸ ê¸ˆìœµì§€ì£¼', change: 1.37, price: 111000, market: 'KOSPI', cap: 194496, rank: 34 },
                { code: '024110', name: 'ê¸°ì—…ì€í–‰', change: -0.24, price: 21050, market: 'KOSPI', cap: 167858, rank: 41 },
                { code: '058350', name: 'ì‚¼ì„±ì—í”¼ìŠ¤í™€ë”©ìŠ¤', change: -7.54, price: 515000, market: 'KOSPI', cap: 128148, rank: 50 },
            ],
            'ì§€ì£¼ì‚¬/ITì„œë¹„ìŠ¤/ê¸°íƒ€ëŒ€í˜•': [ 
                { code: '402340', name: 'SKìŠ¤í€˜ì–´', change: -3.36, price: 302000, market: 'KOSPI', cap: 400273, rank: 14 },
                { code: '034730', name: 'SK', change: -0.75, price: 264000, market: 'KOSPI', cap: 191407, rank: 37 },
                { code: '267250', name: 'HDí˜„ëŒ€', change: 0.48, price: 208500, market: 'KOSPI', cap: 164701, rank: 42 },
                { code: '000150', name: 'ë‘ì‚°', change: 4.39, price: 928000, market: 'KOSPI', cap: 150279, rank: 45 },
                { code: '005940', name: 'ì‚¼ì„±ì—ìŠ¤ë””ì—ìŠ¤', change: -0.85, price: 176000, market: 'KOSPI', cap: 136185, rank: 46 },
                { code: '003550', name: 'LG', change: 5.03, price: 85600, market: 'KOSPI', cap: 132014, rank: 49 },
            ],
            'IT í”Œë«í¼/í†µì‹ ': [ 
                { code: '035420', name: 'NAVER', change: 1.01, price: 249500, market: 'KOSPI', cap: 391347, rank: 15 },
                { code: '035720', name: 'ì¹´ì¹´ì˜¤', change: 2.16, price: 61500, market: 'KOSPI', cap: 272066, rank: 23 },
                { code: '030200', name: 'KT', change: 0.00, price: 53100, market: 'KOSPI', cap: 133824, rank: 48 },
            ],
            'ì² ê°•/ê¸ˆì†/í•´ìš´': [ 
                { code: '004700', name: 'ê³ ë ¤ì•„ì—°', change: 4.70, price: 1359000, market: 'KOSPI', cap: 262875, rank: 26 },
                { code: '005490', name: 'POSCOí™€ë”©ìŠ¤', change: 1.47, price: 311000, market: 'KOSPI', cap: 251701, rank: 27 },
                { code: '011200', name: 'HMM', change: 2.24, price: 20550, market: 'KOSPI', cap: 193835, rank: 35 },
                { code: '086280', name: 'í˜„ëŒ€ê¸€ë¡œë¹„ìŠ¤', change: 1.59, price: 179300, market: 'KOSPI', cap: 134475, rank: 47 },
            ],
            'ì „ë ¥ê¸°ê¸°/ë³€ì••ê¸°': [ 
                { code: '012450', name: 'í•œí™”ì—ì–´ë¡œìŠ¤í˜ì´ìŠ¤', change: 4.68, price: 895000, market: 'KOSPI', cap: 461492, rank: 11 },
                { code: '178920', name: 'HDí˜„ëŒ€ì¼ë ‰íŠ¸ë¦­', change: 4.26, price: 832000, market: 'KOSPI', cap: 299912, rank: 22 },
                { code: '298040', name: 'íš¨ì„±ì¤‘ê³µì—…', change: 8.87, price: 2012000, market: 'KOSPI', cap: 187610, rank: 38 },
                { code: '064350', name: 'í˜„ëŒ€ë¡œí…œ', change: 3.29, price: 182000, market: 'KOSPI', cap: 198639, rank: 32 },
                { code: '010120', name: 'LS ELECTRIC', change: 5.86, price: 515000, market: 'KOSPI', cap: 154500, rank: 44 },
            ],
            'ì†Œë¹„ì¬/ì „ìë¶€í’ˆ': [ 
                { code: '015760', name: 'í•œêµ­ì „ë ¥', change: 3.16, price: 52200, market: 'KOSPI', cap: 335105, rank: 17 },
                { code: '009150', name: 'ì‚¼ì„±ì „ê¸°', change: -0.75, price: 263000, market: 'KOSPI', cap: 196444, rank: 33 },
                { code: '033780', name: 'KT&G', change: -0.21, price: 143000, market: 'KOSPI', cap: 168707, rank: 40 },
                { code: '066570', name: 'LGì „ì', change: 5.17, price: 99700, market: 'KOSPI', cap: 162398, rank: 43 },
            ],
            
            // --- KOSDAQ (Cap Total Sorting) ---
            '2ì°¨ì „ì§€ ì–‘ê·¹ì¬/í•µì‹¬ì†Œì¬(KOSDAQ)': [ 
                { code: '247540', name: 'ì—ì½”í”„ë¡œë¹„ì— ', change: 1.14, price: 159700, market: 'KOSDAQ', cap: 156189, rank: 2 },
                { code: '086520', name: 'ì—ì½”í”„ë¡œ', change: 5.90, price: 96900, market: 'KOSDAQ', cap: 131567, rank: 3 },
                { code: '348390', name: 'ì—”ì¼', change: -2.23, price: 70000, market: 'KOSDAQ', cap: 15237, rank: 50 },
                { code: '004700', name: 'ì‹ ì„±ë¸íƒ€í…Œí¬', change: 5.16, price: 63200, market: 'KOSDAQ', cap: 17370, rank: 43 },
                { code: '347470', name: 'ì„œì§„ì‹œìŠ¤í…œ', change: 2.41, price: 25500, market: 'KOSDAQ', cap: 14352, rank: 57 },
            ],
            'ì œì•½/ë°”ì´ì˜¤ ì„±ì¥': [ 
                { code: '196170', name: 'ì•Œí…Œì˜¤ì  ', change: -12.04, price: 456500, market: 'KOSDAQ', cap: 244254, rank: 1 },
                { code: '298380', name: 'ì—ì´ë¹„ì—˜ë°”ì´ì˜¤', change: -5.17, price: 190600, market: 'KOSDAQ', cap: 105069, rank: 4 },
                { code: '141080', name: 'ë¦¬ê°€ì¼ë°”ì´ì˜¤', change: -5.41, price: 185500, market: 'KOSDAQ', cap: 67912, rank: 6 },
                { code: '310960', name: 'ì½”ì˜¤ë¡±í‹°ìŠˆì§„', change: -2.56, price: 80000, market: 'KOSDAQ', cap: 66577, rank: 7 },
                { code: '199800', name: 'í©íŠ¸ë¡ ', change: 1.60, price: 285000, market: 'KOSDAQ', cap: 66454, rank: 8 },
                { code: '088520', name: 'HLB', change: 1.66, price: 49100, market: 'KOSDAQ', cap: 64730, rank: 9 },
                { code: '000250', name: 'ì‚¼ì²œë‹¹ì œì•½', change: -3.36, price: 216000, market: 'KOSDAQ', cap: 50668, rank: 10 },
                { code: '348390', name: 'ë³´ë¡œë…¸ì´', change: 2.59, price: 238000, market: 'KOSDAQ', cap: 43776, rank: 12 },
                { code: '347470', name: 'ë””ì•¤ë””íŒŒë§ˆí…', change: -0.72, price: 95900, market: 'KOSDAQ', cap: 41645, rank: 14 },
                { code: '214370', name: 'ì¼€ì–´ì  ', change: -1.09, price: 72900, market: 'KOSDAQ', cap: 39158, rank: 16 },
                { code: '453360', name: 'ì—ì„ë“œë°”ì´ì˜¤', change: 30.00, price: 57200, market: 'KOSDAQ', cap: 36697, rank: 17 },
                { code: '068760', name: 'ì…€íŠ¸ë¦¬ì˜¨ì œì•½', change: -0.16, price: 62000, market: 'KOSDAQ', cap: 27083, rank: 22 },
                { code: '140410', name: 'ë©”ì§€ì˜¨', change: 2.17, price: 84800, market: 'KOSDAQ', cap: 25749, rank: 23 },
                { code: '237690', name: 'ì—ìŠ¤í‹°íŒœ', change: 0.08, price: 118000, market: 'KOSDAQ', cap: 24428, rank: 27 },
                { code: '226330', name: 'ì˜¬ë¦­ìŠ¤', change: -2.13, price: 119600, market: 'KOSDAQ', cap: 24057, rank: 29 },
                { code: '079580', name: 'ì˜¤ìŠ¤ì½”í…', change: -7.18, price: 56900, market: 'KOSDAQ', cap: 21769, rank: 33 },
                { code: '344830', name: 'ì˜¤ë¦„í…Œë¼í“¨í‹±', change: 0.61, price: 82200, market: 'KOSDAQ', cap: 17392, rank: 42 },
                { code: '446270', name: 'íë¦¬ì˜¥ìŠ¤ë°”ì´ì˜¤ì‹œìŠ¤í…œì¦ˆ', change: 1.33, price: 91700, market: 'KOSDAQ', cap: 15668, rank: 48 },
                { code: '298380', name: 'HKì´ë…¸ì—”', change: -1.90, price: 51600, market: 'KOSDAQ', cap: 14618, rank: 54 },
                { code: '141080', name: 'ë„¤ì´ì²˜ì…€', change: 0.45, price: 22350, market: 'KOSDAQ', cap: 14401, rank: 56 },
                { code: '32550', name: 'ì ¬ë°±ìŠ¤', change: 4.16, price: 32550, market: 'KOSDAQ', cap: 13798, rank: 60 },
            ],
            'ë°˜ë„ì²´ ì†Œë¶€ì¥/ì¥ë¹„': [ 
                { code: '058470', name: 'ë¦¬ë…¸ê³µì—…', change: 0.46, price: 65400, market: 'KOSDAQ', cap: 49843, rank: 11 },
                { code: '039030', name: 'ì´ì˜¤í…Œí¬ë‹‰ìŠ¤', change: 2.52, price: 285000, market: 'KOSDAQ', cap: 35111, rank: 19 },
                { code: '240810', name: 'ì›ìµIPS', change: 1.31, price: 61800, market: 'KOSDAQ', cap: 30334, rank: 20 },
                { code: '403870', name: 'HPSP', change: -0.82, price: 30300, market: 'KOSDAQ', cap: 25300, rank: 25 },
                { code: '095340', name: 'ISC', change: -0.73, price: 109500, market: 'KOSDAQ', cap: 23211, rank: 31 },
                { code: '036930', name: 'ì†”ë¸Œë ˆì¸', change: -0.73, price: 271500, market: 'KOSDAQ', cap: 21119, rank: 35 },
                { code: '005690', name: 'ë™ì§„ì„ë¯¸ì¼', change: 0.27, price: 36850, market: 'KOSDAQ', cap: 18946, rank: 36 },
                { code: '057080', name: 'ìœ ì§„í…Œí¬', change: 0.26, price: 77000, market: 'KOSDAQ', cap: 17645, rank: 40 },
                { code: '089030', name: 'í…Œí¬ìœ™', change: 3.41, price: 47050, market: 'KOSDAQ', cap: 17434, rank: 41 },
                { code: '064760', name: 'í‹°ì”¨ì¼€ì´', change: 1.80, price: 147000, market: 'KOSDAQ', cap: 17162, rank: 44 },
                { code: '170920', name: 'í•˜ë‚˜ë§ˆì´í¬ë¡ ', change: 3.69, price: 25300, market: 'KOSDAQ', cap: 16794, rank: 46 },
                { code: '344830', name: 'íŒŒí¬ì‹œìŠ¤í…œìŠ¤', change: 0.67, price: 225000, market: 'KOSDAQ', cap: 15742, rank: 47 },
                { code: '47600', name: 'íƒœì„±', change: 1.60, price: 47600, market: 'KOSDAQ', cap: 14518, rank: 55 },
                { code: '29250', name: 'ì£¼ì„±ì—”ì§€ë‹ˆì–´ë§', change: -0.85, price: 29250, market: 'KOSDAQ', cap: 13826, rank: 59 },
            ],
            'ì˜ë£Œê¸°ê¸°/í—¬ìŠ¤ì¼€ì–´': [ 
                { code: '214450', name: 'íŒŒë§ˆë¦¬ì„œì¹˜', change: -2.31, price: 401500, market: 'KOSDAQ', cap: 41714, rank: 13 },
                { code: '214150', name: 'í´ë˜ì‹œìŠ¤', change: 0.36, price: 55300, market: 'KOSDAQ', cap: 36225, rank: 18 },
                { code: '223000', name: 'íœ´ì ¤', change: 0.90, price: 223000, market: 'KOSDAQ', cap: 27438, rank: 21 },
                { code: '298380', name: 'ì—˜ì•¤ì”¨ë°”ì´ì˜¤', change: 5.04, price: 68800, market: 'KOSDAQ', cap: 16938, rank: 45 },
                { code: '098460', name: 'ê³ ì˜', change: -3.92, price: 26950, market: 'KOSDAQ', cap: 18502, rank: 37 },
                { code: '247540', name: 'ì”¨ì–´ìŠ¤í…Œí¬ë†€ë¡œì§€', change: -3.11, price: 118400, market: 'KOSDAQ', cap: 14996, rank: 52 },
            ],
            'ê²Œì„/ì—”í„°í…Œì¸ë¨¼íŠ¸': [ 
                { code: '263750', name: 'í„ì–´ë¹„ìŠ¤', change: -0.13, price: 38650, market: 'KOSDAQ', cap: 24832, rank: 26 },
                { code: '357340', name: 'JYP Ent.', change: 1.03, price: 68400, market: 'KOSDAQ', cap: 24304, rank: 28 },
                { code: '041190', name: 'ì—ìŠ¤ì— ', change: 0.58, price: 104400, market: 'KOSDAQ', cap: 23902, rank: 30 },
                { code: '196170', name: 'ì¹´ì¹´ì˜¤ê²Œì„ì¦ˆ', change: 0.18, price: 16710, market: 'KOSDAQ', cap: 15003, rank: 51 },
            ],
            'ë¡œë´‡/ìë™í™”': [ 
                { code: '277810', name: 'ë ˆì¸ë³´ìš°ë¡œë³´í‹±ìŠ¤', change: -7.20, price: 438500, market: 'KOSDAQ', cap: 85068, rank: 5 },
                { code: '108320', name: 'ë¡œë³´í‹°ì¦ˆ', change: -1.74, price: 283000, market: 'KOSDAQ', cap: 41233, rank: 15 },
                { code: '451960', name: 'í•˜ì´ì  ì•Œì•¤ì— ', change: -2.45, price: 59700, market: 'KOSDAQ', cap: 18440, rank: 39 },
                { code: '086520', name: 'ì—ìŠ¤í”¼ì§€', change: 2.78, price: 66600, market: 'KOSDAQ', cap: 14770, rank: 53 },
                { code: '44700', name: 'ì‚¼í˜„', change: 7.71, price: 44700, market: 'KOSDAQ', cap: 14173, rank: 58 },
            ],
            'IT ë¶€í’ˆ/ê¸°íƒ€ì†Œë¹„ì¬': [ 
                { code: '291880', name: 'ì‹¤ë¦¬ì½˜íˆ¬', change: -1.88, price: 41850, market: 'KOSDAQ', cap: 25600, rank: 24 },
                { code: '007390', name: 'ì›ìµí™€ë”©ìŠ¤', change: 2.16, price: 28350, market: 'KOSDAQ', cap: 21897, rank: 32 },
                { code: '222800', name: 'ì‹¬í…', change: 7.48, price: 57500, market: 'KOSDAQ', cap: 21246, rank: 34 },
                { code: '224020', name: 'LSë§ˆë¦°ì†”ë£¨ì…˜', change: 4.73, price: 29900, market: 'KOSDAQ', cap: 15619, rank: 49 },
            ],
        };


        let currentSymbol = '005930';
        
        let sectorPerformance = {}; // ì„¹í„°ë³„ í‰ê·  ë“±ë½ë¥  ì €ì¥ìš©

        // === ìœ í‹¸ë¦¬í‹° ===
        function formatNum(n) { return new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 2 }).format(n); }
        function getColor(v) { return v > 0 ? 'text-red-500' : (v < 0 ? 'text-blue-500' : 'text-slate-500'); }
        function getCardGradient(v) {
            if (v > 0) return 'bg-gradient-positive';
            if (v < 0) return 'bg-gradient-negative';
            return 'bg-white dark:bg-slate-800';
        }

        // ì‹œê°€ì´ì•¡ í¬ë§·íŒ… í•¨ìˆ˜
        function formatCap(capValue) {
            const trillionValue = capValue / 10000;
            const formattedTrillion = trillionValue.toFixed(2); 
            return `${formatNum(formattedTrillion)}ì¡° ì›`;
        }

        // ì‹œì´/ìˆœìœ„ ì •ë³´ ê²€ìƒ‰ í•¨ìˆ˜
        function getStockDetailsBySymbol(symbol) {
            for (const sector in ALL_MARKET_MAP_STOCKS) {
                const found = ALL_MARKET_MAP_STOCKS[sector].find(s => s.code === symbol);
                if (found) {
                    return {
                        cap: formatCap(found.cap),
                        rank: found.rank > 0 ? `${found.rank}ìœ„` : 'N/A' 
                    };
                }
            }
            return { cap: 'N/A', rank: 'N/A' };
        }
        
        // ì„¹í„°ë³„ ê²½ê³„ì„  ìƒ‰ìƒ í´ë˜ìŠ¤ ë§¤í•‘ í•¨ìˆ˜
        function getSectorBorderColor(sectorName) {
            if (sectorName.includes('ë°˜ë„ì²´')) return 'border-sector-red';
            if (sectorName.includes('2ì°¨ì „ì§€')) return 'border-sector-blue';
            if (sectorName.includes('ì™„ì„±ì°¨')) return 'border-sector-green';
            if (sectorName.includes('AI') || sectorName.includes('í”Œë«í¼') || sectorName.includes('IT í”Œë«í¼')) return 'border-sector-red';
            if (sectorName.includes('ì œì•½') || sectorName.includes('ë°”ì´ì˜¤') || sectorName.includes('ì˜ë£Œê¸°ê¸°')) return 'border-sector-purple';
            if (sectorName.includes('ì€í–‰') || sectorName.includes('ì¢…í•©ê¸ˆìœµ')) return 'border-sector-amber';
            if (sectorName.includes('ì¡°ì„ ') || sectorName.includes('ë°©ì‚°') || sectorName.includes('ì¤‘ê³µì—…')) return 'border-sector-orange';
            if (sectorName.includes('ì§€ì£¼ì‚¬') || sectorName.includes('ITì„œë¹„ìŠ¤')) return 'border-sector-indigo';
            if (sectorName.includes('ì² ê°•') || sectorName.includes('ê¸ˆì†') || sectorName.includes('í•´ìš´')) return 'border-sector-lime';
            if (sectorName.includes('ì „ë ¥ê¸°ê¸°') || sectorName.includes('ë³€ì••ê¸°')) return 'border-sector-cyan';
            if (sectorName.includes('ë¡œë´‡') || sectorName.includes('ìë™í™”')) return 'border-sector-pink';
            if (sectorName.includes('ì†Œë¹„ì¬') || sectorName.includes('ì „ìë¶€í’ˆ')) return 'border-sector-teal';
            if (sectorName.includes('ê²Œì„') || sectorName.includes('ì—”í„°í…Œì¸ë¨¼íŠ¸')) return 'border-red-400';
            return 'border-slate-500';
        }

        // ì„¹í„° ê°•ë„ ì‹œê°í™” ë§‰ëŒ€ HTML ìƒì„± (ëª©ë¡ ë³´ê¸°ìš©)
        function getRelativeStrengthBarHtml(strength) {
            const maxDelta = 2.0; 
            const barWidthPercent = Math.min(Math.abs(strength) / maxDelta, 1.0) * 50; 
            const isStronger = strength > 0.1; 
            const isWeaker = strength < -0.1;
            
            let barHtml;
            let labelText;

            if (isStronger) {
                labelText = `+${strength.toFixed(2)}% ê°•ì„¸`;
                barHtml = `<div class="absolute left-1/2 h-full bg-red-500 transition-all duration-300 ease-in-out" style="width: ${barWidthPercent}%;"></div>`;
            } else if (isWeaker) {
                labelText = `${strength.toFixed(2)}% ì•½ì„¸`;
                barHtml = `<div class="absolute right-1/2 h-full bg-blue-500 transition-all duration-300 ease-in-out" style="width: ${barWidthPercent}%;"></div>`;
            } else {
                labelText = 'ì¤‘ë¦½';
                barHtml = `<div class="absolute left-1/2 transform -translate-x-1/2 w-px h-full bg-slate-400 dark:bg-slate-500"></div>`; 
            }
            
            return `
                <div class="relative w-full h-3 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden shadow-inner" title="ì„¹í„° í‰ê·  ëŒ€ë¹„ ${labelText}">
                    <div class="absolute left-1/2 top-0 bottom-0 w-px bg-slate-300 dark:bg-slate-600"></div>
                    ${barHtml}
                </div>
            `;
        }
        
        // Stock Card HTML ìƒì„± í—¬í¼ (Proportional Viewìš©)
        function generateStockCardHtml(stock, sectorName) {
            const colorClass = getColor(stock.change);
            const bgColorClass = getCardGradient(stock.change);
            const changeSign = stock.change > 0 ? 'â–²' : 'â–¼';
            const sectorBorderClass = getSectorBorderColor(sectorName);
            const marketBadge = stock.market === 'KOSDAQ' ? '<span class="text-[10px] text-blue-400 ml-1"> (Q)</span>' : '';
            
            const isTop3 = stock.rank <= 3; 
            const rankBadgeClass = isTop3 ? 'bg-red-600' : (stock.rank <= 10 ? 'bg-orange-500' : 'bg-slate-400 dark:bg-slate-600');
            const rankAnimationClass = isTop3 ? 'rank-pop' : '';
            const rankIcon = stock.rank === 1 ? 'ğŸ¥‡' : (stock.rank === 2 ? 'ğŸ¥ˆ' : (stock.rank === 3 ? 'ğŸ¥‰' : ''));
            const rankDisplay = `
                <div class="absolute top-0 right-0 m-1 z-10">
                    <span class="text-[10px] text-white font-black px-1.5 py-0.5 rounded-full ${rankBadgeClass} ${rankAnimationClass} leading-none shadow-md" title="ì‹œì´ ìˆœìœ„: ${stock.rank}ìœ„">
                        ${rankIcon || stock.rank}
                    </span>
                </div>
            `;
            
            // ì„¹í„° ëŒ€ë¹„ ê°•ë„ (Simpler badge for proportional view)
            const currentSectorPerf = sectorPerformance[sectorName] || 0; 
            const relativeStrength = stock.change - currentSectorPerf;
            let strengthBadge = '';
            if (relativeStrength > 0.5) {
                strengthBadge = `<span class="ml-1 text-[8px] font-bold text-green-500" title="ì„¹í„° ëŒ€ë¹„ ê°•ì„¸"><i class="fa-solid fa-up-long"></i></span>`;
            } else if (relativeStrength < -0.5) {
                strengthBadge = `<span class="ml-1 text-[8px] font-bold text-indigo-500" title="ì„¹í„° ëŒ€ë¹„ ì•½ì„¸"><i class="fa-solid fa-down-long"></i></span>`;
            }
            
            // Proportional Viewì—ì„œëŠ” ê°œë³„ ì¹´ë“œì˜ í¬ê¸°ëŠ” ì‘ê²Œ í†µì¼í•˜ì—¬ 'ë°”êµ¬ë‹ˆ' í¬ê¸°ë¥¼ ê°•ì¡°
            const nameSize = 'text-xs font-medium';
            const priceSize = 'text-base';
            const heightClass = 'h-[70px]'; 

            return `
                <div onclick="document.getElementById('symbol-input').value='${stock.code}'; fetchAllData()" 
                    onmousemove="handleTilt(event, this)"
                    onmouseout="resetTilt(this)"
                    data-code="${stock.code}"
                    data-sector="${sectorName}"
                    class="relative ${heightClass} p-2 rounded-lg treemap-card-3d border ${sectorBorderClass} border-opacity-70 cursor-pointer ${bgColorClass} hover:ring-2 hover:ring-offset-1 hover:ring-blue-400 dark:border-slate-700 flex flex-col justify-between overflow-hidden">
                    
                    <!-- Rank Badge -->
                    ${rankDisplay}

                    <!-- Top Line: Name and Sector -->
                    <div class="flex flex-col">
                        <div class="${nameSize} text-slate-900 dark:text-slate-100 leading-tight truncate">
                            ${stock.name}${marketBadge}
                        </div>
                        <div class="text-[9px] text-slate-500 dark:text-slate-400 leading-none truncate">
                            ${sectorName.replace(/KOSPI|KOSDAQ|\(.*\)/g, '').trim()}
                        </div>
                    </div>

                    <!-- Price & Change -->
                    <div class="flex justify-between items-end mt-1">
                        <div class="font-bold ${priceSize} dark:text-white leading-none">
                            ${formatNum(stock.price)}
                        </div>
                        <div class="text-[11px] font-bold ${colorClass} flex items-center">
                            ${changeSign} ${formatNum(stock.change)}%
                            ${strengthBadge} 
                        </div>
                    </div>
                </div>
            `;
        }

        // === ë‹¤í¬ëª¨ë“œ ë¡œì§ ===
        function initDarkMode() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                updateThemeIcon(true);
            } else {
                document.documentElement.classList.remove('dark');
                updateThemeIcon(false);
            }
        }
        function toggleDarkMode() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
                updateThemeIcon(false);
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
                updateThemeIcon(true);
            }
        }
        function updateThemeIcon(isDark) {
            const icon = document.getElementById('theme-icon');
            icon.className = isDark ? "fa-solid fa-sun text-yellow-400 text-lg" : "fa-solid fa-moon text-slate-600 text-lg";
        }


        // === í™˜ìœ¨ ê³„ì‚°ê¸° ë¡œì§ ===
        function calculateExchange() {
            const foreignInput = document.getElementById('calc-input-foreign').value;
            const krwOutput = document.getElementById('calc-input-krw');
            
            const rateInfo = currentRates[selectedCurrency];
            const currentRate = rateInfo ? rateInfo.rate : 0;
            const unit = rateInfo ? rateInfo.unit : 1;

            if (currentRate > 0 && foreignInput) {
                const amount = parseFloat(foreignInput);
                const calculatedKrw = amount * (currentRate / unit); 
                krwOutput.value = formatNum(calculatedKrw);
            } else {
                krwOutput.value = "-";
            }
        }

        function updateCurrencyRate() {
            const selectElement = document.getElementById('calc-currency-select');
            selectedCurrency = selectElement.value;

            const rateInfo = currentRates[selectedCurrency];
            const rateDisplay = document.getElementById('current-rate');
            const unitDisplay = document.getElementById('current-currency-unit');
            
            if (rateInfo) {
                rateDisplay.textContent = formatNum(rateInfo.rate);
                unitDisplay.textContent = selectedCurrency;
                if (rateInfo.unit > 1) {
                    unitDisplay.textContent += ` (${rateInfo.unit}ë‹¨ìœ„)`;
                }
            } else {
                rateDisplay.textContent = "-";
                unitDisplay.textContent = selectedCurrency;
            }

            calculateExchange();
        }
        
        // === ê´€ì‹¬ ì¢…ëª© ì¦ê²¨ì°¾ê¸° ë¡œì§ ===
        function getFavorites() {
            const favs = localStorage.getItem('stockFavorites');
            return favs ? JSON.parse(favs) : ['005930', '005380', '196170']; 
        }

        function toggleFavorite() {
            let favs = getFavorites();
            const btn = document.getElementById('btn-favorite');
            
            if (favs.includes(currentSymbol)) {
                favs = favs.filter(s => s !== currentSymbol); // ì‚­ì œ
                btn.className = "text-slate-300 hover:text-yellow-400 transition-colors text-3xl";
            } else {
                favs.push(currentSymbol); // ì¶”ê°€
                btn.className = "text-yellow-400 hover:text-yellow-500 transition-colors text-3xl drop-shadow-sm";
            }
            
            localStorage.setItem('stockFavorites', JSON.stringify(favs));
            fetchWatchlistData();
        }

        function updateFavoriteBtnState() {
            const favs = getFavorites();
            const btn = document.getElementById('btn-favorite');
            if (favs.includes(currentSymbol)) {
                btn.className = "text-yellow-400 hover:text-yellow-500 transition-colors text-3xl drop-shadow-sm";
            } else {
                btn.className = "text-slate-300 hover:text-yellow-400 transition-colors text-3xl";
            }
        }

        async function fetchWatchlistData() {
            const favs = getFavorites();
            const container = document.getElementById('watchlist-container');
            
            if (!container) return; 

            if (favs.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-xs text-slate-400">â˜… ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¢…ëª©ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</div>';
                return;
            }

            container.innerHTML = ''; 

            const promises = favs.map(symbol => Promise.resolve(getMockData(symbol)));
            const results = await Promise.all(promises);

            results.forEach(data => {
                const item = document.createElement('div');
                item.className = "p-3 flex justify-between items-center cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors";
                item.onclick = () => {
                    document.getElementById('symbol-input').value = data.symbol;
                    fetchAllData();
                };

                const changeSign = data.change > 0 ? '+' : '';
                const colorClass = getColor(data.change);
                
                item.innerHTML = `
                    <div>
                        <div class="font-bold text-sm text-slate-700 dark:text-slate-200">${data.name} <span class="text-xs text-slate-400 ml-1">(${data.symbol})</span></div>
                        <div class="text-xs text-slate-400">ì‹œì´: ${getStockDetailsBySymbol(data.symbol).cap}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-lg dark:text-white">${formatNum(data.price)}</div>
                        <div class="text-xs ${colorClass} font-bold">
                            ${changeSign}${formatNum(data.change_percent.toFixed(2))}%
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }


        // === ë©”ì¸ íƒ­ ì „í™˜ (ë‰´ìŠ¤/ì»¤ë®¤ë‹ˆí‹°) ===
        function switchTab(tab) {
            document.getElementById('content-news').classList.toggle('hidden', tab !== 'news');
            document.getElementById('content-community').classList.toggle('hidden', tab !== 'community');
            document.getElementById('tab-news').classList.toggle('active', tab === 'news');
            document.getElementById('tab-community').classList.toggle('active', tab === 'community');
            
            if(tab === 'community') fetchCommunity();
        }

        // === ë°ì´í„° ë¡œì§ ===
        async function fetchAllData() {
            const sym = document.getElementById('symbol-input').value;
            currentSymbol = sym;
            
            updateFavoriteBtnState(); 
            
            const data = getMockData(sym);
            renderMain(data);

            if(document.getElementById('tab-community').classList.contains('active')) fetchCommunity();
            
            fetchMarketData(); 
        }
        
        // ì£¼ê°€ ì°¨íŠ¸ ì‹œë®¬ë ˆì´ì…˜ í•¨ìˆ˜ -> ìº”ë“¤ì°¨íŠ¸ ë¡œì§
        function drawStockChart(price, change) {
            const canvas = document.getElementById('stock-chart-canvas');
            const loading = document.getElementById('chart-loading');
            
            if (!canvas) return;

            // ë°˜ì‘í˜• ì²˜ë¦¬ë¥¼ ìœ„í•´ ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ ë¶€ëª¨ ìš”ì†Œì— ë§ì¶° ì¬ì„¤ì •
            const containerWidth = canvas.parentElement.clientWidth;
            canvas.width = containerWidth;
            canvas.height = 150; 

            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            loading.classList.remove('hidden');

            // ì°¨íŠ¸ ë¡œì§ì— í•„ìš”í•œ ìƒìˆ˜ ì •ì˜
            const dataPoints = 12;
            const fixedRandoms = [0.3, 0.7, 0.5, 0.2, 0.8, 0.4, 0.6, 0.9, 0.1, 0.55, 0.45, 1.0]; 
            const basePrice = price / (1 + change / 100); 
            const dailyRange = Math.abs(change) * 1.5; 

            // ìº”ë²„ìŠ¤ ê·¸ë¦¬ê¸° ì½”ë“œëŠ” ë¹„ë™ê¸° ì²˜ë¦¬
            setTimeout(() => {
                loading.classList.add('hidden');

                const OHLCData = [];
                
                let minVal = basePrice * 0.98; 
                let maxVal = basePrice * 1.02;

                let lastClose = basePrice;
                
                // 1. OHLC ë°ì´í„° ê³„ì‚°
                for (let i = 0; i < dataPoints; i++) {
                    const r1 = fixedRandoms[i] * 0.005; 
                    const r2 = fixedRandoms[i] * 0.5 + 0.5; 
                    const r3 = fixedRandoms[(i + 1) % dataPoints]; 
                    const r4 = fixedRandoms[(i + 2) % dataPoints]; 

                    const open = lastClose * (1 + (0.5 - r1)); 
                    
                    const variance = dailyRange * r2; 
                    const highLowDiff = open * (variance / 100);
                    
                    const high = open + highLowDiff * r3;
                    const low = open - highLowDiff * (1 - r3);
                    
                    let close;
                    if (i === dataPoints - 1) {
                         close = price; 
                    } else {
                        close = open + (r4 - 0.5) * highLowDiff;
                    }

                    const candleHigh = Math.max(open, close, high);
                    const candleLow = Math.min(open, close, low);

                    OHLCData.push({ open, high: candleHigh, low: candleLow, close });

                    minVal = Math.min(minVal, candleLow);
                    maxVal = Math.max(maxVal, candleHigh);
                    lastClose = close;
                }
                
                // 2. ì°¨íŠ¸ ê·¸ë¦¬ê¸° ì„¤ì •
                const width = canvas.width;
                const height = canvas.height;
                const padding = 10;
                const chartHeight = height - padding * 2;
                const chartWidth = width - padding * 2;
                const priceRange = maxVal - minVal;
                const barWidth = chartWidth / dataPoints * 0.6;
                const gap = chartWidth / dataPoints * 0.4;
                
                const getY = (value) => height - padding - ((value - minVal) / priceRange) * chartHeight;

                // 3. ìº”ë“¤ ê·¸ë¦¬ê¸°
                for (let i = 0; i < dataPoints; i++) {
                    const data = OHLCData[i];
                    const x = padding + i * (barWidth + gap) + gap / 2;
                    
                    const openY = getY(data.open);
                    const closeY = getY(data.close);
                    const highY = getY(data.high);
                    const lowY = getY(data.low);

                    const isRising = data.close > data.open;
                    const bodyTop = isRising ? closeY : openY;
                    const bodyBottom = isRising ? openY : closeY;
                    const bodyHeight = Math.max(1, bodyBottom - bodyTop); 

                    ctx.fillStyle = isRising ? '#ef4444' : '#3b82f6'; 
                    ctx.strokeStyle = isRising ? '#ef4444' : '#3b82f6';

                    ctx.beginPath();
                    ctx.moveTo(x + barWidth / 2, highY);
                    ctx.lineTo(x + barWidth / 2, lowY);
                    ctx.stroke();

                    ctx.fillRect(x, bodyTop, barWidth, bodyHeight);
                }
                
                // 4. í˜„ì¬ê°€ ê¸°ì¤€ì„  ê·¸ë¦¬ê¸°
                ctx.beginPath();
                ctx.strokeStyle = change > 0 ? '#ef4444' : (change < 0 ? '#3b82f6' : '#94a3b8');
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 2]); 

                const currentY = getY(price);
                ctx.moveTo(padding, currentY);
                ctx.lineTo(width - padding, currentY);
                ctx.stroke();
                ctx.closePath();
                ctx.setLineDash([]); 

            }, 200); 
        }

        // 3D Tilt íš¨ê³¼ ê´€ë ¨ JavaScript í•¨ìˆ˜
        const TILT_MAX_ROTATE = 5; // íšŒì „ ê°ë„ ê°ì†Œ (ëœ ê³¼í•˜ê²Œ)
        const TILT_PERSPECTIVE = 800;
        const BASE_SHADOW_LIGHT = '0 6px 15px rgba(0, 0, 0, 0.15)';
        const BASE_SHADOW_DARK = '0 6px 15px rgba(255, 255, 255, 0.08)';


        function handleTilt(event, element) {
            if (currentSortBy === 'sector_list') return; 

            const rect = element.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            const mouseX = event.clientX - centerX;
            const mouseY = event.clientY - centerY;

            const tiltX = (mouseY / rect.height) * (TILT_MAX_ROTATE * 2); 
            const tiltY = (mouseX / rect.width) * (TILT_MAX_ROTATE * 2);  
            
            const rotateX = Math.min(Math.max(-TILT_MAX_ROTATE, tiltX), TILT_MAX_ROTATE) * -1;
            const rotateY = Math.min(Math.max(-TILT_MAX_ROTATE, tiltY), TILT_MAX_ROTATE);
            
            const isDark = document.documentElement.classList.contains('dark');
            const shadowColor = isDark ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.3)';
            
            // ë“±ë½ë¥ ì— ë”°ë¥¸ ë°œê´‘ íš¨ê³¼ ì¶”ê°€
            // ì„¹í„° ì •ë³´ëŠ” data-sector ì†ì„±ì—ì„œ ì°¾ê¸°
            const sectorName = element.dataset.sector;
            const stockCode = element.dataset.code;
            let stockData = null;
            if (sectorName) {
                stockData = ALL_MARKET_MAP_STOCKS[sectorName]?.find(s => s.code === stockCode);
            }

            let glow = '';
            if (stockData) {
                if (stockData.change > 2) glow = `0 0 10px 0 #ef4444`; // ê°•í•œ ìƒìŠ¹
                else if (stockData.change > 0) glow = `0 0 5px 0 #fca5a5`; // ì•½í•œ ìƒìŠ¹
                else if (stockData.change < -2) glow = `0 0 10px 0 #3b82f6`; // ê°•í•œ í•˜ë½
                else if (stockData.change < 0) glow = `0 0 5px 0 #93c5fd`; // ì•½í•œ í•˜ë½
            }

            element.style.transform = `perspective(${TILT_PERSPECTIVE}px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
            element.style.boxShadow = `${(tiltY/4).toFixed(1)}px ${(tiltX/4).toFixed(1)}px 30px ${shadowColor}${glow ? `, ${glow}` : ''}`;
        }

        function resetTilt(element) {
            if (currentSortBy === 'sector_list') return; 

            const isDark = document.documentElement.classList.contains('dark');
            element.style.transform = `perspective(${TILT_PERSPECTIVE}px) rotateX(0deg) rotateY(0deg)`;
            element.style.boxShadow = isDark ? BASE_SHADOW_DARK : BASE_SHADOW_LIGHT; 
        }

        // Market Map í•„í„°ë§ ë° ë Œë”ë§
        function renderMarketMap(filterMode, sortBy) {
            
            currentFilterMode = filterMode;
            currentSortBy = sortBy;

            const buttons = ['all', 'kospi_top_60', 'kosdaq_top_60'];
            buttons.forEach(id => {
                const btn = document.getElementById(`filter-${id}`);
                const isActive = id.toUpperCase() === filterMode;
                if (btn) {
                    btn.className = isActive
                        ? 'px-3 py-1.5 rounded-xl text-xs font-bold bg-blue-600 text-white hover:bg-blue-700 transition-colors shadow-md'
                        : 'px-3 py-1.5 rounded-xl text-xs font-medium border border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors';
                }
            });
            
            const sortBySelect = document.getElementById('sort-by-select');
            if(sortBySelect) sortBySelect.value = sortBy;

            // 3. ì¢…ëª© í•„í„°ë§ ë° ë­í¬ í™•ì •
            let totalCapBySector = {};
            
            const filterMarket = filterMode === 'KOSPI_TOP_60' ? 'KOSPI' : (filterMode === 'KOSDAQ_TOP_60' ? 'KOSDAQ' : null);
            const maxStocks = filterMarket === 'KOSPI' ? 50 : (filterMarket === 'KOSDAQ' ? 60 : 110); 
            
            let allStocks = [];
            for (const stocks of Object.values(ALL_MARKET_MAP_STOCKS)) {
                allStocks.push(...stocks);
            }
            
            let marketStocks = allStocks;
            if (filterMarket) {
                marketStocks = allStocks.filter(s => s.market === filterMarket);
            }
            
            marketStocks.sort((a, b) => b.cap - a.cap); 
            
            marketStocks.forEach((stock, index) => { 
                stock.rank = index + 1; 
            });

            let stocksToRender = marketStocks; 
            const totalMarketCap = stocksToRender.reduce((sum, s) => sum + s.cap, 0);

            let finalStocksBySector = {};
            
            stocksToRender.forEach((stock) => { 
                const sectorName = Object.keys(ALL_MARKET_MAP_STOCKS).find(key => 
                    ALL_MARKET_MAP_STOCKS[key].some(s => s.code === stock.code && s.market === stock.market)
                ) || 'ê¸°íƒ€';

                if (!finalStocksBySector[sectorName]) {
                    finalStocksBySector[sectorName] = [];
                    totalCapBySector[sectorName] = 0;
                }
                
                finalStocksBySector[sectorName].push(stock);
                totalCapBySector[sectorName] += stock.cap;
            });
            
            // ì„¹í„°ë³„ í‰ê·  ë“±ë½ë¥  ê³„ì‚° ë° ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            sectorPerformance = {};
            Object.keys(finalStocksBySector).forEach(sectorName => {
                const stocks = finalStocksBySector[sectorName];
                if (stocks.length > 0) {
                    const totalChange = stocks.reduce((sum, s) => sum + s.change, 0);
                    sectorPerformance[sectorName] = totalChange / stocks.length;
                } else {
                    sectorPerformance[sectorName] = 0;
                }
            });
            
            // Market Breadth ê³„ì‚° ë° ì—…ë°ì´íŠ¸
            const totalCount = stocksToRender.length;
            const upCount = stocksToRender.filter(s => s.change > 0).length;
            const downCount = stocksToRender.filter(s => s.change < 0).length;
            const neutralCount = totalCount - upCount - downCount;
            const upPercent = totalCount > 0 ? (upCount / totalCount) * 100 : 0;
            const downPercent = totalCount > 0 ? (downCount / totalCount) * 100 : 0;
            // FIX: neutralPercent is not defined ì˜¤ë¥˜ ìˆ˜ì •.
            const neutralPercent = totalCount > 0 ? (neutralCount / totalCount) * 100 : 0;


            document.getElementById('breadth-up-count').textContent = `${upCount}ê°œ (${upPercent.toFixed(1)}%)`;
            document.getElementById('breadth-down-count').textContent = `${downCount + neutralCount}ê°œ (${(downPercent + neutralPercent).toFixed(1)}%)`;
            
            const upBar = document.getElementById('breadth-up-bar');
            upBar.style.width = `${upPercent}%`;
            upBar.classList.toggle('breadth-bar-red', upPercent > 50); // 50%ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìƒ‰ìƒ ë³€ê²½
            upBar.classList.toggle('bg-blue-500', upPercent <= 50);
            
            // 4. ëª¨ë“  ì¢…ëª©ì„ ìˆœì„œëŒ€ë¡œ ë Œë”ë§
            const container = document.getElementById('market-map-container');
            let globalStockCount = stocksToRender.length;

            if (stocksToRender.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-slate-400">ì„ íƒëœ ëª¨ë“œ(${filterMode})ì— í•´ë‹¹í•˜ëŠ” ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }
            
            let stockCountMessage = filterMarket ? `${filterMarket} Top ${maxStocks} ì¤‘ ${globalStockCount}ê°œ í‘œì‹œë¨` : `ì´ ${globalStockCount}ê°œ í‘œì‹œë¨`;
            
            const isCapSort = currentSortBy === 'cap';

            let mapContentHtml = `
                <div class="text-sm text-slate-500 dark:text-slate-400 mb-4 font-semibold">${isCapSort ? 'ì‹œê°€ì´ì•¡ ì§€ë„ ë³´ê¸° (ë°”êµ¬ë‹ˆë³„ ë¹„ì¤‘)' : 'ì—…ì¢…ë³„ ëª©ë¡ ë³´ê¸°'} (${stockCountMessage})</div>
            `;

            if (sortBy === 'sector_list') {
                // --- SECTOR LIST VIEW (ì—…ì¢…ë³„ ëª©ë¡ ë³´ê¸° - ê¸°ì¡´ ë¡œì§ ìœ ì§€) ---
                mapContentHtml += `<div class="bg-white p-4 rounded-2xl shadow-xl border border-slate-200 dark:bg-slate-800 dark:border-slate-700 space-y-6">`;
                
                const sortedSectors = Object.keys(finalStocksBySector).sort((a, b) => {
                    return totalCapBySector[b] - totalCapBySector[a]; 
                });

                sortedSectors.forEach(sectorName => {
                    const stocks = finalStocksBySector[sectorName];
                    if (stocks.length > 0) {
                        stocks.sort((a, b) => b.cap - a.cap); 
                        
                        const sectorBorderClass = getSectorBorderColor(sectorName);
                        const avgChange = sectorPerformance[sectorName];
                        const avgChangeColorClass = getColor(avgChange);
                        const avgChangeSign = avgChange > 0 ? '+' : '';

                        mapContentHtml += `
                            <div class="border-l-4 ${sectorBorderClass} pl-4 p-3 bg-slate-50/50 dark:bg-slate-700/30 rounded-lg shadow-sm">
                                <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200 mb-2 flex justify-between items-center">
                                    <span>
                                        <i class="fa-solid fa-layer-group mr-1 text-slate-500"></i> ${sectorName} 
                                        <span class="text-sm text-slate-500">(${stocks.length}ê°œ)</span>
                                    </span>
                                    <span class="text-xs font-bold ${avgChangeColorClass} bg-white dark:bg-slate-800 px-3 py-1 rounded-full border border-slate-200 dark:border-slate-700">
                                        í‰ê· : ${avgChangeSign}${formatNum(avgChange.toFixed(2))}%
                                    </span>
                                </h3>
                                
                                <div class="flex text-xs font-bold text-slate-500 dark:text-slate-400 border-b border-slate-200 dark:border-slate-700 pb-1 mt-3">
                                    <div class="w-[30%] pl-8">ì¢…ëª©ëª…</div>
                                    <div class="w-[20%] text-right">í˜„ì¬ê°€</div>
                                    <div class="w-[15%] text-center">ë“±ë½ë¥ </div>
                                    <div class="w-[25%] text-center">ì„¹í„° ê°•ë„</div>
                                    <div class="w-[10%] text-right">ì‹œì´</div>
                                </div>
                                
                                <div class="space-y-1 mt-1">
                        `;

                        stocks.forEach(stock => {
                            const colorClass = getColor(stock.change);
                            const changeSign = stock.change > 0 ? '+' : '';
                            const formattedCap = formatCap(stock.cap);
                            
                            const relativeStrength = stock.change - avgChange;
                            const relativeStrengthBarHtml = getRelativeStrengthBarHtml(relativeStrength);

                            const rank = stock.rank;
                            let rankIcon = rank <= 3 ? (rank === 1 ? 'ğŸ¥‡' : (rank === 2 ? 'ğŸ¥ˆ' : 'ğŸ¥‰')) : '';
                            let rankTitle = `ì‹œì´ ìˆœìœ„: ${rank}ìœ„`;

                            mapContentHtml += `
                                <div onclick="document.getElementById('symbol-input').value='${stock.code}'; fetchAllData()" 
                                     class="flex items-center p-2 bg-white hover:bg-slate-100 dark:bg-slate-800 dark:hover:bg-slate-700 rounded-xl cursor-pointer transition-shadow border border-slate-200 dark:border-slate-700 hover:shadow-md">

                                    <!-- 1. Name & Code (30%) + Rank -->
                                    <div class="w-[30%] font-medium text-sm text-slate-800 dark:text-slate-100 truncate flex items-center">
                                        <!-- Rank Badge (Updated) -->
                                        <span class="text-sm mr-2" title="${rankTitle}">${rankIcon || rank}</span>
                                        ${stock.name} 
                                        <span class="text-xs font-normal text-slate-400 ml-1">(${stock.code})</span>
                                    </div>

                                    <!-- 2. Price (20%) -->
                                    <div class="w-[20%] text-right font-bold text-base dark:text-white">
                                        ${formatNum(stock.price)}
                                    </div>

                                    <!-- 3. Change % (15%) - Highlighted -->
                                    <div class="w-[15%] text-center text-xs ml-2">
                                        <span class="font-bold ${colorClass} bg-red-500/10 dark:bg-red-900/30 px-2.5 py-1 rounded-full whitespace-nowrap">
                                            ${changeSign}${formatNum(stock.change)}%
                                        </span>
                                    </div>
                                    
                                    <!-- 4. Sector Strength Bar (25%) - New Visual -->
                                    <div class="w-[25%] text-center px-4">
                                        ${relativeStrengthBarHtml}
                                    </div>


                                    <!-- 5. Cap (10%) - Simplified -->
                                    <div class="w-[10%] text-right text-xs text-slate-500 dark:text-slate-400">
                                        ${formattedCap.replace('ì¡° ì›', 'ì¡°')}
                                    </div>
                                </div>
                            `;
                        });

                        mapContentHtml += `
                                </div>
                            </div>
                        `;
                    }
                });

                mapContentHtml += `</div>`;
            } else {
                // --- PROPORTIONAL BASKET VIEW (ì‹œê°€ì´ì•¡ ì§€ë„) ---
                const TOP_N_SECTORS = 4;
                let proportionalHtml = '';
                let remainingStocks = [];

                const sortedSectors = Object.keys(finalStocksBySector).sort((a, b) => totalCapBySector[b] - totalCapBySector[a]);
                const topSectors = sortedSectors.slice(0, TOP_N_SECTORS);
                const remainingSectors = sortedSectors.slice(TOP_N_SECTORS);
                
                // 1. Proportional Baskets Wrapper
                // min-h-[600px]ë¡œ ë†’ì´ í™•ì¥ ë° flex-wrapì„ ì‚¬ìš©í•˜ì—¬ ìœ ì—°í•˜ê²Œ ì²˜ë¦¬
                proportionalHtml += `<div class="flex flex-col lg:flex-row lg:flex-wrap w-full h-auto min-h-[600px] rounded-2xl overflow-hidden shadow-xl border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-800">`;

                // 2. Render Top N Proportional Baskets (ê° ë°”êµ¬ë‹ˆì˜ ë„ˆë¹„ë¥¼ 25%ë¡œ ê³ ì •í•˜ê³ , overflowë¥¼ ë§‰ìŒ)
                topSectors.forEach(sectorName => {
                    const sectorCap = totalCapBySector[sectorName];
                    const totalCapOfTopSectors = topSectors.reduce((sum, name) => sum + totalCapBySector[name], 0);
                    const hoverTitle = `ì‹œì´ ë¹„ì¤‘: ${(sectorCap/totalMarketCap * 100).toFixed(1)}% (Top ì„¹í„° ì¤‘: ${(sectorCap/totalCapOfTopSectors * 100).toFixed(1)}%)`;

                    const stocks = finalStocksBySector[sectorName];
                    const sectorBorderClass = getSectorBorderColor(sectorName);
                    const avgChange = sectorPerformance[sectorName];
                    const bgColorClass = getCardGradient(avgChange);
                    
                    // ìˆ˜ì •: widthStyleì„ ì œê±°í•˜ê³  lg:w-1/4, w-fullì„ ì‚¬ìš©
                    proportionalHtml += `
                        <!-- Proportional Basket for ${sectorName} -->
                        <div title="${hoverTitle}"
                            class="w-full lg:w-1/4 flex-shrink-0 p-3 border-b lg:border-r lg:border-b-0 border-slate-300 dark:border-slate-700 ${bgColorClass} min-h-[120px] lg:h-full">
                            
                            <!-- Sector Header -->
                            <div class="text-sm lg:text-base font-extrabold text-slate-800 dark:text-slate-200 mb-2 border-l-4 ${sectorBorderClass} pl-2 flex justify-between items-center">
                                <span>${sectorName} (${stocks.length})</span>
                                <span class="text-xs font-bold ${getColor(avgChange)}">${avgChange > 0 ? 'â–²' : 'â–¼'}${avgChange.toFixed(2)}%</span>
                            </div>

                            <!-- Individual Stocks Grid: Fixed 2-column on mobile, 3-column on desktop (inside the proportional space) -->
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-2 xl:grid-cols-3 gap-2 proportional-basket-stocks">
                    `;

                    // Render stocks inside this sector basket (sorted by rank/cap)
                    stocks.sort((a, b) => b.cap - a.cap); 
                    stocks.forEach(stock => {
                        const stockHtml = generateStockCardHtml(stock, sectorName);
                        proportionalHtml += `<div>${stockHtml}</div>`; 
                    });
                    
                    proportionalHtml += `
                            </div>
                        </div>
                    `;
                });

                // 3. Group remaining stocks into an "Others" basket
                if (remainingSectors.length > 0) {
                    remainingSectors.forEach(sectorName => {
                        remainingStocks.push(...finalStocksBySector[sectorName]);
                    });

                    const remainingCap = remainingSectors.reduce((sum, name) => sum + totalCapBySector[name], 0);
                    const avgChange = remainingStocks.length > 0 ? (remainingStocks.reduce((sum, s) => sum + s.change, 0) / remainingStocks.length) : 0;
                    const bgColorClass = getCardGradient(avgChange);
                    
                    const totalRemainingCap = totalMarketCap - topSectors.reduce((sum, name) => sum + totalCapBySector[name], 0);
                    const hoverTitle = `ì‹œì´ ë¹„ì¤‘: ${(remainingCap/totalMarketCap * 100).toFixed(1)}%`;
                    
                    // ìˆ˜ì •: ë‚˜ë¨¸ì§€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€í•˜ë„ë¡ lg:w-full ë˜ëŠ” lg:flex-grow ì‚¬ìš©
                    proportionalHtml += `
                        <!-- Others Basket -->
                        <div title="${hoverTitle}"
                            class="w-full lg:flex-grow p-3 ${bgColorClass} min-h-[120px] lg:h-full">
                            
                            <div class="text-sm lg:text-base font-extrabold text-slate-800 dark:text-slate-200 mb-2 border-l-4 border-slate-500 pl-2 flex justify-between items-center">
                                <span>ê¸°íƒ€ ${remainingSectors.length}ê°œ ì„¹í„° (${remainingStocks.length}ê°œ ì¢…ëª©)</span>
                                <span class="text-xs font-bold ${getColor(avgChange)}">${avgChange > 0 ? 'â–²' : 'â–¼'}${avgChange.toFixed(2)}%</span>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-3 xl:grid-cols-4 gap-2 proportional-basket-stocks">
                    `;
                    
                    remainingStocks.sort((a, b) => b.cap - a.cap); 
                    remainingStocks.forEach(stock => {
                        const sectorNameForStock = Object.keys(ALL_MARKET_MAP_STOCKS).find(key => 
                            ALL_MARKET_MAP_STOCKS[key].some(s => s.code === stock.code && s.market === stock.market)
                        ) || 'ê¸°íƒ€';
                        const stockHtml = generateStockCardHtml(stock, sectorNameForStock);
                        proportionalHtml += `<div>${stockHtml}</div>`;
                    });
                    
                    proportionalHtml += `
                            </div>
                        </div>
                    `;
                }

                proportionalHtml += `</div>`; 
                mapContentHtml += proportionalHtml;
            }

            container.innerHTML = mapContentHtml;
        }


        // Mock ì»¤ë®¤ë‹ˆí‹° ë°ì´í„° ìƒì„± í•¨ìˆ˜ (ë¡œì§ ìœ ì§€)
        function getMockCommunityData(symbol, name) {
            const isUp = getMockData(symbol).change > 0;
            const randomSeed = 5; 
            
            const bestTitles = [
                `${name} í­ë“± ì‹ í˜¸! ê¸°ê´€ ë§¤ìˆ˜ í¬ì°©. (V.3)`,
                `[HOT] ${name} vs ê²½ìŸì‚¬, í•˜ë°˜ê¸° ì „ë§ ì‹¬ì¸µ ë¶„ì„ ë¦¬í¬íŠ¸`,
                `ì¥ê¸° ê´€ì ì—ì„œ ë³´ë©´ ì§€ê¸ˆì€ ì ˆí˜¸ì˜ ${isUp ? 'ë§¤ìˆ˜' : 'ê´€ë§'} ê¸°íšŒ (W.5)`,
            ];

            const latestTitles = [
                `í˜„ì¬ê°€ ${isUp ? 'ìƒìŠ¹' : 'í•˜ë½'} ì¶”ì´ ë¶„ì„ ìš”ì²­ë“œë¦½ë‹ˆë‹¤.`,
                `${name} ì™œ ê°‘ìê¸° ${isUp ? 'ì˜¤ë¥´ëŠ”' : 'ë¹ ì§€ëŠ”'} ê±¸ê¹Œìš”?`,
                `ì´ë²ˆ ë¶„ê¸° ì‹¤ì  ë°œí‘œ ì˜ˆìƒì¹˜ ë° ì „ë§ ê³µìœ  ë¶€íƒë“œë ¤ìš”.`,
            ];
            
            const baseViews = 2000;
            const baseLikes = 400;

            return {
                // ë² ìŠ¤íŠ¸ê¸€ 3ê°œë§Œ í‘œì‹œí•˜ë„ë¡ ì¡°ì •
                best: bestTitles.slice(0, 3).map((title, i) => ({
                    title: title,
                    link: '#',
                    views: formatNum(Math.floor(baseViews + (randomSeed % 100) * (i + 1) * 5)),
                    likes: formatNum(Math.floor(baseLikes + (randomSeed % 50) * (i + 1) * 3)),
                    date: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
                })),
                latest: latestTitles.map((title, i) => ({
                    title: title,
                    link: '#',
                    views: formatNum(Math.floor(100 + (randomSeed % 20) * (i + 1))),
                    likes: formatNum(Math.floor(10 + (randomSeed % 5) * (i + 1))),
                    date: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
                }))
            };
        }


        async function fetchCommunity() {
            const bestList = document.getElementById('best-community-list');
            const latestList = document.getElementById('latest-community-list');
            
            const mainStockData = getMockData(currentSymbol);
            
            if(isNaN(currentSymbol)) {
                bestList.innerHTML = '<div class="text-center text-xs text-slate-400">ì§€ì›í•˜ì§€ ì•ŠëŠ” ì¢…ëª©ì…ë‹ˆë‹¤.</div>';
                latestList.innerHTML = '';
                return;
            }

            bestList.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-spinner fa-spin text-red-500"></i></div>';
            latestList.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-spinner fa-spin text-slate-500"></i></div>';
            
            const data = getMockCommunityData(currentSymbol, mainStockData.name);

            // ë² ìŠ¤íŠ¸ê¸€ ë Œë”ë§
            if(data.best && data.best.length > 0) {
                bestList.innerHTML = data.best.map((p, index) => `
                    <a href="${p.link}" target="_blank" class="block p-3 best-post-card rounded-xl hover:shadow-lg transition-all mb-2">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-xl font-black text-red-500 mr-2">${index + 1}</span>
                            <span class="font-bold text-sm text-slate-800 dark:text-white truncate flex-1 pr-2">
                                ${p.title}
                            </span>
                        </div>
                        <div class="flex gap-3 text-xs font-bold text-slate-600 dark:text-slate-400 pl-8">
                            <span><i class="fa-regular fa-eye mr-1"></i>${p.views}</span>
                            <span class="text-red-500"><i class="fa-regular fa-thumbs-up mr-1"></i>${p.likes}</span>
                            <span class="text-slate-400 font-normal ml-auto">${p.date.split(' ')[1] || p.date}</span>
                        </div>
                    </a>
                `).join('');
            } else {
                bestList.innerHTML = '<div class="text-center py-2 text-xs text-slate-400">ì¸ê¸°ê¸€ì„ ì§‘ê³„ ì¤‘ì…ë‹ˆë‹¤.</div>';
            }

            // ìµœì‹ ê¸€ ë Œë”ë§
            if(data.latest && data.latest.length > 0) {
                latestList.innerHTML = data.latest.map(p => `
                    <a href="${p.link}" target="_blank" class="block p-3 bg-slate-50 rounded-xl hover:bg-slate-100 border border-slate-200 dark:bg-slate-700 dark:border-slate-600">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-sm text-slate-700 dark:text-slate-200 truncate flex-1 pr-2">${p.title}</span>
                        </div>
                        <div class="flex gap-3 text-xs text-slate-400">
                            <span>ì¡°íšŒ ${p.views}</span>
                            <span>ê³µê° ${p.likes}</span>
                            <span class="ml-auto">${p.date.split(' ')[1] || p.date}</span>
                        </div>
                    </a>
                `).join('');
            } else {
                latestList.innerHTML = '<div class="text-center py-2 text-xs text-slate-400">ìµœì‹ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }
        
        async function fetchMarketData() {
            const refreshIcon = document.getElementById('btn-refresh').querySelector('i');
            refreshIcon.classList.remove('fa-spin');
            refreshIcon.classList.remove('text-blue-600');
            refreshIcon.classList.add('text-slate-500');


            // 1. ì£¼ìš” ì§€í‘œ ê°±ì‹ 
            INDICES.forEach(async (index) => {
                const data = getMockData(index.id);
                
                const currencyCode = index.id.split('=')[0];
                if (currentRates[currencyCode]) {
                    currentRates[currencyCode].rate = data.price;
                    if (index.id === 'KRW=X') { 
                        updateCurrencyRate();
                    }
                }
                updateIndexUI(index.id, data); 

                if (currentRates['EUR']) currentRates['EUR'].rate = getMockData('EUR=X').price;
                if (currentRates['JPY']) currentRates['JPY'].rate = getMockData('JPY=X').price;
            });
            
            // 2. ê´€ì‹¬ ì¢…ëª© ë°ì´í„° ê°±ì‹ 
            fetchWatchlistData();
            
            // 3. ë§ˆì¼“ë§µ ê°±ì‹  (ì„ íƒëœ ëª¨ë“œë¡œ)
            renderMarketMap(currentFilterMode, currentSortBy);


            if(document.getElementById('tab-community').classList.contains('active')) fetchCommunity();
        }

        // === ë Œë”ë§ í—¬í¼ ===
        function updateIndexUI(id, data) {
            const priceElem = document.getElementById(`idx-p-${id}`);
            const linkElem = priceElem ? priceElem.closest('a') : null;
            
            // í˜¸ë²„ ì‹œ ìƒ‰ìƒì„ ìœ„í•œ í´ë˜ìŠ¤ ì •ì˜
            const hoverColor = data.change > 0 ? 'hover:bg-red-500/20' : (data.change < 0 ? 'hover:bg-blue-500/20' : 'hover:bg-slate-500/20');
            
            if(linkElem) {
                linkElem.className = `bg-white p-3 rounded-xl border border-slate-200 dark:bg-slate-800 dark:border-slate-700 block transition-all duration-200 shadow-md hover:shadow-lg hover:ring-2 hover:ring-offset-2 hover:ring-blue-400 ${hoverColor}`;
            }

            if(priceElem) {
                let displayPrice = data.price;
                
                if(id === 'JPY=X' && currentRates['JPY']) {
                    displayPrice = data.price / currentRates['JPY'].unit;
                }

                priceElem.textContent = formatNum(displayPrice);
                
                const changeElem = linkElem ? linkElem.querySelector('.index-change') : null;
                if(changeElem) {
                    const changeSign = data.change > 0 ? '+' : '';
                    changeElem.textContent = `${changeSign}${formatNum(data.change)} (${changeSign}${formatNum(data.change_percent.toFixed(2))}%)`;
                    changeElem.className = `text-xs font-bold flex items-center mt-1 index-change ${getColor(data.change)}`;
                }
                
                priceElem.className = `font-black text-xl dark:text-white ${getColor(data.change)}`;
            }
        }

        // ë‹¹ì¼ ì£¼ìš” ê³µì‹œ Mock ë°ì´í„° ìƒì„± í•¨ìˆ˜ (ëœë¤ì„± ì œê±°)
        function getMajorDisclosure(data) {
            const isSignificant = Math.abs(data.change_percent) >= 1.5; 
            const isPositive = data.change_percent > 0;
            const seed = 5; 
            
            let badgeClass, badgeText, title, time;

            if (isSignificant) {
                if (isPositive) {
                    badgeClass = "bg-red-500 border-red-700 text-white border-red-500";
                    badgeText = "í˜¸ì¬ (HOT)";
                    if (seed % 3 === 0) {
                        title = `[ê³µì‹œ] ${data.name}, ì‚¬ìƒ ìµœëŒ€ ê·œëª¨ ${data.change_percent.toFixed(0)}% ë¬´ìƒì¦ì ê²°ì •`;
                    } else if (seed % 3 === 1) {
                        title = `[ê³µì‹œ] 1000ì–µ ê·œëª¨ ì‹ ê·œ ì‹œì„¤ íˆ¬ì ë°œí‘œ, ë¯¸ë˜ ì„±ì¥ ë™ë ¥ í™•ë³´`;
                    } else {
                        title = `[ê³µì‹œ] ì°½ì‚¬ ì´ë˜ ìµœëŒ€ì¹˜ ${data.change_percent.toFixed(1)}% ì˜ì—…ì´ìµ ì ì • ë°œí‘œ (ê¹œì§ ì‹¤ì )`;
                    }
                } else {
                    badgeClass = "bg-blue-500 border-blue-700 text-white border-blue-500";
                    badgeText = "ì•…ì¬ (DANGER)";
                    if (seed % 3 === 0) {
                        title = `[ê³µì‹œ] ì „í™˜ì‚¬ì±„(CB) 500ì–µ ê·œëª¨ ë°œí–‰ ê²°ì •... ì£¼ì‹ í¬ì„ ìš°ë ¤`;
                    } else if (seed % 3 === 1) {
                        title = `[ê³µì‹œ] ëŒ€í‘œì´ì‚¬ íš¡ë ¹ ë°°ì„ì„¤ ì¡°íšŒ ê³µì‹œ ìš”êµ¬ (í™•ì¸ ì¤‘)`;
                    } else {
                        title = `[ê³µì‹œ] 3ë¶„ê¸° ì ì • ì‹¤ì , ì‹œì¥ ì»¨ì„¼ì„œìŠ¤ ëŒ€ë¹„ 30% ë¯¸ë‹¬ ì˜ˆìƒ`;
                    }
                }
            } else {
                badgeClass = "bg-slate-500 border-slate-700 text-white border-slate-500";
                badgeText = "ì£¼ìš” ê³µì‹œ";
                if (seed % 2 === 0) {
                    title = `[ê³µì‹œ] ${data.name}, ì •ê¸° ì£¼ì£¼ì´íšŒ ì†Œì§‘ ê²°ì˜`;
                } else {
                    title = `[ê³µì‹œ] ìµœëŒ€ì£¼ì£¼ ì£¼ì‹ë‹´ë³´ëŒ€ì¶œ ë¹„ìœ¨ ë³€ê²½ ì‹ ê³  (ë‹¨ìˆœ ê³µì‹œ)`;
                }
            }
            
            time = "14:30";

            return { badgeClass, badgeText, title, time };
        }
        
        function renderMain(data) {
            currentSymbol = data.symbol;

            document.getElementById('main-name').textContent = data.name; 
            document.getElementById('main-symbol').textContent = data.symbol;
            document.getElementById('main-price').textContent = formatNum(data.price);
            document.getElementById('main-price').className = `text-4xl font-extrabold dark:text-white ${getColor(data.change)}`;
            document.getElementById('main-change').textContent = `${data.change>0?'+':''}${formatNum(data.change)} (${formatNum(data.change_percent)}%)`;
            document.getElementById('main-change').className = `text-2xl font-bold mb-1 ${getColor(data.change)}`;
            
            document.getElementById('link-naver').href = !isNaN(data.symbol) ? `https://finance.naver.com/item/main.naver?code=${data.symbol}` : `https://finance.yahoo.com/quote/${data.symbol}`;

            const stockName = ALL_MARKET_MAP_STOCKS['ë°˜ë„ì²´ ëŒ€í˜•ì£¼/IDM'].find(s => s.code === currentSymbol)?.name || '';
            const dartQuery = `${stockName} ${currentSymbol}`;
            document.getElementById('link-dart').href = `https://dart.fss.or.kr/dsac001/mainK.do?textCrpNm=${dartQuery}&autoSearch=true`;

            const stockDetails = getStockDetailsBySymbol(currentSymbol);

            // ì‹œì´ ë° ìˆœìœ„ ì •ë³´ ì‚½ì… (ë” ì§ê´€ì ì¸ ì•„ì´ì½˜ ì‚¬ìš©)
            document.getElementById('stock-meta-info').innerHTML = `
                <div class="flex flex-col gap-2">
                    <div class="flex items-center gap-1 text-slate-700 dark:text-slate-300">
                        <i class="fa-solid fa-money-bill-wave text-green-500 w-4"></i>
                        <span class="font-medium">ì‹œê°€ì´ì•¡:</span>
                        <span class="font-bold text-slate-900 dark:text-white">${stockDetails.cap}</span>
                    </div>
                    <div class="flex items-center gap-1 text-slate-700 dark:text-slate-300">
                        <i class="fa-solid fa-ranking-star text-amber-500 w-4"></i>
                        <span class="font-medium">ì‹œì¥ ìˆœìœ„:</span>
                        <span class="font-bold text-slate-900 dark:text-white">${stockDetails.rank}</span>
                    </div>
                </div>
            `;
            
            drawStockChart(data.price, data.change_percent);

            updateFavoriteBtnState(); 

            const newsBox = document.getElementById('content-news');
            
            // 1. ì£¼ìš” ê³µì‹œ Mock ìƒì„±
            const majorDisclosure = getMajorDisclosure(data);
            const majorDisclosureHTML = `
                <a href="https://dart.fss.or.kr/" target="_blank" class="block p-4 rounded-xl shadow-lg border-2 border-dashed ${majorDisclosure.badgeClass.replace('bg-', 'border-').trim()} hover:shadow-xl transition-all"
                   title="ì‹¤ì œ ê³µì‹œê°€ ì•„ë‹™ë‹ˆë‹¤. DARTì—ì„œ í™•ì¸í•˜ì„¸ìš”.">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-xs font-extrabold ${majorDisclosure.badgeClass} px-2 py-0.5 rounded-full shadow-inner">
                            ${majorDisclosure.badgeText}
                        </span>
                        <span class="text-xs text-slate-500 dark:text-slate-400 font-normal ml-auto">${majorDisclosure.time}</span>
                    </div>
                    <div class="font-extrabold text-lg text-slate-900 dark:text-white leading-snug">
                        ${majorDisclosure.title}
                    </div>
                </a>
            `;

            // 2. ì¼ë°˜ Mock News Data ìƒì„± ë° ë“±ë½ë¥  ë°˜ì˜
            const newsData = [
                { title: `[ëª¨ì˜ë‰´ìŠ¤] ${data.name}ì˜ ${formatNum(data.price)}ì› ${data.change > 0 ? 'ëŒíŒŒ ì„ë°•!' : 'í•˜ë½ ì••ë ¥ ê²½ê³ '}`, publisher: 'ëª¨ì˜ê²½ì œ', link: '#' },
                { title: `[ëª¨ì˜ë‰´ìŠ¤] ${data.name} ${data.change > 0 ? 'ì™¸êµ­ì¸ ìˆœë§¤ìˆ˜ ì§€ì†' : 'ì°¨ìµ ì‹¤í˜„ ì¶œíšŒ'} ë¶„ì„`, publisher: 'ëª¨ì˜ë‰´ìŠ¤24', link: '#' },
                { title: `[ëª¨ì˜ë‰´ìŠ¤] ${data.name} ê´€ë ¨ ${data.change > 0 ? 'í˜¸ì¬ì„±' : 'ë¦¬ìŠ¤í¬'} ë³´ê³ ì„œ ë°œí‘œ`, publisher: 'ê°€ìƒíˆ¬ìì¼ë³´', link: '#' },
            ];

            let regularNewsHTML = '';
            if(newsData.length) {
                regularNewsHTML = newsData.map(n => `
                    <a href="${n.link}" target="_blank" class="block p-3 bg-slate-50 rounded-xl hover:bg-slate-100 border border-slate-200 dark:bg-slate-700 dark:border-slate-600 transition-colors shadow-sm">
                        <div class="font-bold text-sm text-slate-800 dark:text-white truncate">${n.title}</div>
                        <div class="text-xs text-slate-400 mt-1">${n.publisher}</div>
                    </a>
                `).join('');
            }

            newsBox.innerHTML = majorDisclosureHTML + regularNewsHTML;
            if (newsBox.innerHTML === '') {
                newsBox.innerHTML = '<div class="text-center py-4 text-xs text-slate-400">ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }

        // Mock Data ìƒì„± í—¬í¼ í•¨ìˆ˜
        function getMockData(symbol, name = '') {
            let basePrice = 1000; 
            let fixedChangePercent = 0; 
            let stock = null;
            
            if (symbol === '^KS11') { basePrice = 2700; fixedChangePercent = 0.5; }
            else if (symbol === '^KQ11') { basePrice = 880; fixedChangePercent = 1.2; }
            else if (symbol === 'NQ=F') { basePrice = 18500; fixedChangePercent = -0.8; }
            else if (symbol === 'KRW=X') { basePrice = 1350; fixedChangePercent = -0.1; }
            else if (symbol === 'BTC-KRW') { basePrice = 95000000; fixedChangePercent = 3.5; }
            else if (symbol === 'XAG=X') { basePrice = 24.50; fixedChangePercent = 0.7; }
            else if(symbol === 'EUR=X') { basePrice = 1450; fixedChangePercent = 0.0; } 
            else if(symbol === 'JPY=X') { basePrice = 950; fixedChangePercent = -0.5; } 

            for (const sector in ALL_MARKET_MAP_STOCKS) {
                const found = ALL_MARKET_MAP_STOCKS[sector].find(s => s.code === symbol);
                if (found) {
                    stock = found;
                    fixedChangePercent = stock.change; 
                    basePrice = stock.price / (1 + fixedChangePercent / 100); 
                    break;
                }
                // Mock ë°ì´í„°ì—ì„œ ì°¾ì§€ ëª»í•˜ë©´ ê¸°ë³¸ê°’ ìœ ì§€
            }

            let price = stock ? stock.price : (basePrice * (1 + fixedChangePercent / 100));
            let change = price - basePrice;
            let stockName = stock ? stock.name : (name || symbol);
            
            if (fixedChangePercent === 0) {
                 change = 0;
                 price = basePrice;
            }


            return {
                symbol: symbol,
                name: stockName,
                price: price,
                change: change,
                change_percent: fixedChangePercent,
                news: [],
                dart_url: null,
                is_mock: true
            };
        }
        function mockStock(sym) { return getMockData(sym); }

        // ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ê¸°ëŠ¥
        function manualRefresh() {
            const refreshButton = document.getElementById('btn-refresh');
            const refreshIcon = refreshButton.querySelector('i');

            refreshButton.disabled = true;
            refreshIcon.className = 'fa-solid fa-spinner fa-spin text-blue-600';
            refreshIcon.classList.remove('text-slate-500');

            fetchMarketData();

            setTimeout(() => {
                refreshButton.disabled = false;
                refreshIcon.className = 'fa-solid fa-arrows-rotate';
                refreshIcon.classList.remove('fa-spin');
                refreshIcon.classList.remove('text-blue-600');
                refreshIcon.classList.add('text-slate-500');
            }, 1000); 
        }
        
        // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•˜ì—¬ ìº”ë²„ìŠ¤ í¬ê¸° ì¬ì„¤ì •
        window.addEventListener('resize', () => {
             // í˜„ì¬ ì„ íƒëœ ì‹¬ë³¼ì˜ ë°ì´í„°ë¡œ ì°¨íŠ¸ë§Œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            if (currentSymbol) {
                const data = getMockData(currentSymbol);
                drawStockChart(data.price, data.change_percent);
            }
            // ë§ˆì¼“ë§µ ë Œë”ë§ì„ ë‹¤ì‹œ ì‹¤í–‰í•˜ì—¬ ë ˆì´ì•„ì›ƒ ì¡°ì •
            renderMarketMap(currentFilterMode, currentSortBy);
        });


        // === ì´ˆê¸°í™” ===
        function init() {
            initDarkMode();
            
            // 1. ì§€í‘œ ì¹´ë“œ ìƒì„±
            const idxBox = document.getElementById('indices-container');
            idxBox.innerHTML = INDICES.map(i => `
                <a href="${i.link}" target="_blank" class="bg-white p-3 rounded-xl border border-slate-200 dark:bg-slate-800 dark:border-slate-700 block transition-all duration-200 shadow-md hover:shadow-lg hover:ring-2 hover:ring-offset-2 hover:ring-blue-400" title="${i.name} ìƒì„¸ ë³´ê¸°">
                    <div class="text-xs text-slate-500 mb-1 dark:text-slate-400">${i.name}</div>
                    <div class="font-black text-xl dark:text-white" id="idx-p-${i.id}">-</div>
                    <div class="text-xs font-bold mt-1 index-change" id="change-${i.id}">-</div>
                </a>
            `).join('');

            // 2. ë§ˆì¼“ ë§µ ë Œë”ë§ (ì´ˆê¸°: KOSDAQ Top 60, ì‹œì´ ìˆœ)
            renderMarketMap(currentFilterMode, currentSortBy); 

            // ì´ˆê¸° ë¡œë“œ (ì‚¼ì„±ì „ì)
            fetchAllData(); 
        }
        
        init();
    </script>
</body>
</html>