<!DOCTYPE html>
<html lang="ko" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Dashboard Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        /* 탭 스타일 */
        .tab-btn { border-bottom: 2px solid transparent; color: #64748b; transition: all 0.2s; }
        .tab-btn.active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 700; }
        .dark .tab-btn.active { border-bottom: 2px solid #60a5fa; color: #60a5fa; }
        
        /* 베스트글 강조 효과 */
        .best-post-card { background: linear-gradient(to right, #fef2f2, #fff); border-left: 3px solid #ef4444; }
        .dark .best-post-card { background: linear-gradient(to right, #450a0a, #1e293b); border-left: 3px solid #f87171; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 transition-colors duration-200 dark:bg-slate-900 dark:text-slate-100">

    <!-- 상단 헤더 -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50 dark:bg-slate-800 dark:border-slate-700">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-chart-line text-blue-600 text-xl dark:text-blue-400"></i>
                <h1 class="font-bold text-xl tracking-tight">Market Dashboard</h1>
                <span class="flex items-center gap-1 text-xs font-medium bg-red-100 text-red-600 px-2 py-0.5 rounded-full animate-pulse dark:bg-red-900 dark:text-red-200">LIVE</span>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleDarkMode()" class="p-2"><i id="theme-icon" class="fa-solid fa-moon"></i></button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
        
        <!-- 1. 지표 카드 -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3" id="indices-container">
            <!-- JS 로드 -->
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 왼쪽: 메인 패널 (2/3) -->
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden dark:bg-slate-800 dark:border-slate-700">
                    
                    <!-- 검색 및 가격 -->
                    <div class="p-6 pb-0">
                        <div class="flex gap-2 mb-6">
                            <input type="text" id="symbol-input" value="005930" class="bg-slate-50 border border-slate-200 text-sm rounded-lg block w-full p-2.5 dark:bg-slate-700 dark:border-slate-600" onkeypress="if(event.key==='Enter') fetchAllData()">
                            <button onclick="fetchAllData()" class="bg-blue-600 text-white rounded-lg px-5 py-2.5 text-sm">조회</button>
                        </div>
                        
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h2 class="text-3xl font-bold" id="main-price">-</h2>
                                <div class="flex items-end gap-2">
                                    <div class="text-lg font-medium" id="main-change">-</div>
                                    <div class="text-sm text-slate-400 mb-1" id="main-symbol">Loading...</div>
                                </div>
                            </div>
                            <div class="flex flex-col gap-2">
                                <a id="link-naver" href="#" target="_blank" class="px-4 py-2 bg-[#03C75A] text-white rounded-lg text-xs font-bold text-center">네이버 증권</a>
                            </div>
                        </div>

                        <!-- 탭 메뉴 -->
                        <div class="flex border-b border-slate-200 dark:border-slate-700">
                            <button onclick="switchTab('news')" id="tab-news" class="tab-btn active flex-1 py-3 text-sm font-medium">
                                <i class="fa-regular fa-newspaper mr-1"></i> 주요 뉴스
                            </button>
                            <button onclick="switchTab('community')" id="tab-community" class="tab-btn flex-1 py-3 text-sm font-medium">
                                <i class="fa-solid fa-fire mr-1 text-red-500"></i> 토론방 (BEST)
                            </button>
                        </div>
                    </div>

                    <!-- 탭 콘텐츠 영역 -->
                    <div class="p-6 min-h-[300px]">
                        <!-- 1. 뉴스 탭 -->
                        <div id="content-news" class="space-y-3">
                            <div class="text-center text-slate-400 py-10">데이터 로딩 중...</div>
                        </div>

                        <!-- 2. 커뮤니티 탭 -->
                        <div id="content-community" class="hidden space-y-4">
                            <!-- [NEW] 실시간 베스트 섹션 (강조됨) -->
                            <div class="mb-6">
                                <h4 class="text-sm font-bold text-red-500 mb-3 flex items-center">
                                    <i class="fa-solid fa-crown mr-2"></i> 실시간 인기글 (Top 5)
                                </h4>
                                <div id="best-community-list" class="space-y-2">
                                    <!-- 베스트글 5개 들어갈 곳 -->
                                </div>
                            </div>

                            <hr class="border-slate-100 dark:border-slate-700 my-4">

                            <!-- 일반 최신글 섹션 -->
                            <h4 class="text-xs font-bold text-slate-500 mb-2">⏱️ 실시간 최신순</h4>
                            <div id="latest-community-list" class="space-y-2">
                                <!-- 최신글 리스트 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 오른쪽: 순위 (1/3) -->
            <div class="space-y-6">
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm dark:bg-slate-800 dark:border-slate-700 h-[500px] flex flex-col">
                    <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-700/50">
                        <h3 class="font-bold text-slate-800 dark:text-slate-200 text-sm"><i class="fa-solid fa-trophy text-yellow-500 mr-1"></i> 시가총액 순위</h3>
                    </div>
                    <div id="ranking-container" class="overflow-y-auto flex-1 p-2 space-y-1">
                        <!-- 랭킹 리스트 -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // === 설정 ===
        const INDICES = [
            { id: '^KS11', name: 'KOSPI' }, { id: '^KQ11', name: 'KOSDAQ' },
            { id: 'NQ=F', name: 'NASDAQ' }, { id: 'KRW=X', name: 'USD/KRW' }
        ];
        const TOP_STOCKS = [
            { code: '005930', name: '삼성전자' }, { code: '000660', name: 'SK하이닉스' },
            { code: '373220', name: 'LG에너지' }, { code: '207940', name: '삼바' },
            { code: '005380', name: '현대차' }, { code: '247540', name: '에코프로비엠' }
        ];
        let currentSymbol = '005930';

        // === 유틸리티 ===
        function formatNum(n) { return new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 2 }).format(n); }
        function getColor(v) { return v > 0 ? 'text-red-500' : (v < 0 ? 'text-blue-500' : 'text-slate-500'); }

        // === 탭 전환 ===
        function switchTab(tab) {
            document.getElementById('content-news').classList.toggle('hidden', tab !== 'news');
            document.getElementById('content-community').classList.toggle('hidden', tab !== 'community');
            document.getElementById('tab-news').classList.toggle('active', tab === 'news');
            document.getElementById('tab-community').classList.toggle('active', tab === 'community');
            
            if(tab === 'community') fetchCommunity();
        }

        // === 데이터 로직 ===
        async function fetchAllData() {
            const sym = document.getElementById('symbol-input').value;
            currentSymbol = sym;
            
            try {
                const res = await fetch(`/api/info?symbol=${sym}`);
                const data = await res.json();
                renderMain(data);
            } catch { renderMain(mockStock(sym)); }

            if(document.getElementById('tab-community').classList.contains('active')) fetchCommunity();
        }

        async function fetchCommunity() {
            const bestList = document.getElementById('best-community-list');
            const latestList = document.getElementById('latest-community-list');
            
            if(isNaN(currentSymbol)) {
                bestList.innerHTML = '<div class="text-center text-xs text-slate-400">지원하지 않는 종목입니다.</div>';
                latestList.innerHTML = '';
                return;
            }

            bestList.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-spinner fa-spin text-red-500"></i></div>';
            latestList.innerHTML = '';
            
            try {
                const res = await fetch(`/api/community?code=${currentSymbol}`);
                const data = await res.json();
                
                // 베스트글 렌더링
                if(data.best && data.best.length > 0) {
                    bestList.innerHTML = data.best.map(p => `
                        <a href="${p.link}" target="_blank" class="block p-3 best-post-card rounded-r-lg hover:shadow-sm transition-all mb-2">
                            <div class="flex justify-between items-start mb-1">
                                <span class="font-bold text-sm text-slate-800 dark:text-white truncate flex-1 pr-2">
                                    <span class="text-red-500 mr-1 text-xs">BEST</span>${p.title}
                                </span>
                            </div>
                            <div class="flex gap-3 text-xs font-bold text-slate-600 dark:text-slate-400">
                                <span><i class="fa-regular fa-eye mr-1"></i>${p.views}</span>
                                <span class="text-red-500"><i class="fa-regular fa-thumbs-up mr-1"></i>${p.likes}</span>
                                <span class="text-slate-400 font-normal ml-auto">${p.date.split(' ')[1] || p.date}</span>
                            </div>
                        </a>
                    `).join('');
                } else {
                    bestList.innerHTML = '<div class="text-center py-2 text-xs text-slate-400">인기글을 집계 중입니다.</div>';
                }

                // 최신글 렌더링
                if(data.latest && data.latest.length > 0) {
                    latestList.innerHTML = data.latest.map(p => `
                        <a href="${p.link}" target="_blank" class="block p-3 bg-slate-50 rounded-lg hover:bg-slate-100 border border-slate-100 dark:bg-slate-700 dark:border-slate-600">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-sm text-slate-700 dark:text-slate-200 truncate flex-1 pr-2">${p.title}</span>
                            </div>
                            <div class="flex gap-3 text-xs text-slate-400">
                                <span>조회 ${p.views}</span>
                                <span>공감 ${p.likes}</span>
                                <span class="ml-auto">${p.date.split(' ')[1] || p.date}</span>
                            </div>
                        </a>
                    `).join('');
                }

            } catch {
                bestList.innerHTML = '<div class="text-center text-xs text-slate-400">로딩 실패</div>';
            }
        }

        // === 렌더링 헬퍼 ===
        function renderMain(data) {
            document.getElementById('main-symbol').textContent = data.symbol;
            document.getElementById('main-price').textContent = formatNum(data.price);
            document.getElementById('main-price').className = `text-3xl font-bold dark:text-white ${getColor(data.change)}`;
            document.getElementById('main-change').textContent = `${data.change>0?'+':''}${formatNum(data.change)} (${formatNum(data.change_percent)}%)`;
            document.getElementById('main-change').className = `text-lg font-medium mb-1 ${getColor(data.change)}`;
            document.getElementById('link-naver').href = !isNaN(data.symbol) ? `https://finance.naver.com/item/main.naver?code=${data.symbol}` : `https://finance.yahoo.com/quote/${data.symbol}`;

            const newsBox = document.getElementById('content-news');
            if(data.news && data.news.length) {
                newsBox.innerHTML = data.news.map(n => `
                    <a href="${n.link}" target="_blank" class="block p-3 bg-slate-50 rounded-lg hover:bg-slate-100 border border-slate-100 dark:bg-slate-700 dark:border-slate-600">
                        <div class="font-bold text-sm text-slate-800 dark:text-white truncate">${n.title}</div>
                        <div class="text-xs text-slate-400 mt-1">${n.publisher}</div>
                    </a>
                `).join('');
            } else {
                newsBox.innerHTML = '<div class="text-center py-4 text-xs text-slate-400">뉴스가 없습니다.</div>';
            }
        }

        function mockStock(sym) { return { symbol: sym, price: 50000, change: 1000, change_percent: 2.0, news: [] }; }

        // === 초기화 ===
        function init() {
            if(localStorage.theme === 'dark') document.documentElement.classList.add('dark');
            window.toggleDarkMode = () => {
                document.documentElement.classList.toggle('dark');
                localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            };

            const idxBox = document.getElementById('indices-container');
            idxBox.innerHTML = INDICES.map(i => `
                <div class="bg-white p-3 rounded-xl border border-slate-200 dark:bg-slate-800 dark:border-slate-700">
                    <div class="text-xs text-slate-500 mb-1">${i.name}</div>
                    <div class="font-bold text-sm dark:text-white" id="idx-p-${i.id}">-</div>
                </div>
            `).join('');

            const rankBox = document.getElementById('ranking-container');
            rankBox.innerHTML = TOP_STOCKS.map((s, i) => `
                <div onclick="document.getElementById('symbol-input').value='${s.code}'; fetchAllData()" class="flex justify-between items-center p-2 hover:bg-slate-50 cursor-pointer rounded dark:hover:bg-slate-700">
                    <div class="flex items-center gap-2">
                        <span class="w-5 h-5 flex items-center justify-center ${i<3?'bg-yellow-400 text-white':'bg-slate-100 text-slate-500'} rounded text-xs font-bold">${i+1}</span>
                        <span class="text-xs font-bold text-slate-700 dark:text-slate-200">${s.name}</span>
                    </div>
                    <div class="text-xs font-bold" id="rank-p-${s.code}">-</div>
                </div>
            `).join('');

            const updateMini = async (s, idPrefix) => {
                try {
                    const res = await fetch(`/api/info?symbol=${s}`);
                    const d = await res.json();
                    const el = document.getElementById(`${idPrefix}-${s}`);
                    if(el) {
                        el.textContent = formatNum(d.price);
                        el.className = `text-xs font-bold ${getColor(d.change)}`;
                    }
                } catch {}
            };
            INDICES.forEach(i => updateMini(i.id, 'idx-p'));
            TOP_STOCKS.forEach(s => updateMini(s.code, 'rank-p'));

            fetchAllData(); 
        }
        
        init();
    </script>
</body>
</html>