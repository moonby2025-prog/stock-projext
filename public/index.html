<!DOCTYPE html>
<html lang="ko" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Map Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        /* 메인 탭 스타일 */
        .tab-btn { border-bottom: 2px solid transparent; color: #64748b; transition: all 0.2s; }
        .tab-btn.active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: 700; }
        .dark .tab-btn.active { border-bottom: 2px solid #60a5fa; color: #60a5fa; }

        /* 베스트글 강조 효과 */
        .best-post-card { background: linear-gradient(to right, #fef2f2, #fff); border-left: 3px solid #ef4444; }
        .dark .best-post-card { background: linear-gradient(to right, #450a0a, #1e293b); border-left: 3px solid #f87171; }
        
        /* 마켓맵 카드 스타일 - Treemap 시뮬레이션용이 아닌, 일반 카드 스타일 유지 */
        .market-card { min-height: 120px; transition: all 0.15s; }

        /* 순위 스티커 애니메이션 */
        .rank-pop {
            animation: rankPop 1.5s infinite;
        }
        @keyframes rankPop {
            0%, 100% { transform: scale(1); box-shadow: none; }
            50% { 
                transform: scale(1.08); 
                box-shadow: 0 0 10px rgba(239, 68, 68, 0.8); /* 붉은색 그림자 */
            }
        }
        /* 시장 심도 표시를 위한 클래스 */
        .breadth-bar-container { height: 12px; background-color: #3b82f6; } /* Tailwind blue-500 */
        .breadth-bar-red { background-color: #ef4444; } /* Tailwind red-500 */

        /* 캔버스 기본 스타일 (반응형 설정) */
        #stock-chart-canvas {
            width: 100%;
            height: 150px;
            display: block;
        }

        /* ✅ 주요 공시 강조 스타일 */
        .major-disclosure-card {
            border: 2px solid;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            background: linear-gradient(to right, #fef2f2, #fff);
        }
        .dark .major-disclosure-card {
            background: linear-gradient(to right, #450a0a, #1e293b);
        }

        /* ✅ 3D Tilt 효과 및 그림자 강화 */
        .treemap-card-3d {
            transition: transform 0.1s ease-out, box-shadow 0.1s ease-out; /* 부드러운 전환 효과 */
            transform-style: preserve-3d; /* 3D 변형을 위한 설정 */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* 기본 그림자 강화 */
        }
        .dark .treemap-card-3d {
             box-shadow: 0 4px 12px rgba(255, 255, 255, 0.05);
        }

        /* 5. ✅ 섹터별 경계선 색상 클래스 */
        .border-sector-red { border-color: #ef4444; }
        .border-sector-blue { border-color: #3b82f6; }
        .border-sector-green { border-color: #10b981; }
        .border-sector-purple { border-color: #8b5cf6; }
        .border-sector-amber { border-color: #f59e0b; }
        .border-sector-orange { border-color: #f97316; }
        .border-sector-indigo { border-color: #6366f1; }
        .border-sector-lime { border-color: #84cc16; }
        .border-sector-cyan { border-color: #06b6d4; }
        .border-sector-pink { border-color: #ec4899; }
        .border-sector-teal { border-color: #14b8a6; }
        
    </style>
</head>
<body class="bg-slate-50 text-slate-800 transition-colors duration-200 dark:bg-slate-900 dark:text-slate-100">

    <!-- 상단 헤더 -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50 dark:bg-slate-800 dark:border-slate-700">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-chart-line text-blue-600 text-xl dark:text-blue-400"></i>
                <h1 class="font-bold text-xl tracking-tight">Market Dashboard</h1>
                <span id="status-badge" class="flex items-center gap-1 text-xs font-medium bg-red-100 text-red-600 px-2 py-0.5 rounded-full animate-pulse dark:bg-red-900 dark:text-red-200">LIVE</span>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- ✅ 수동 새로고침 버튼 추가 -->
                <button onclick="manualRefresh()" id="btn-refresh" 
                        class="p-2 text-slate-500 hover:text-blue-600 dark:text-slate-400 dark:hover:text-blue-400 transition-colors"
                        title="수동으로 시세 갱신">
                    <i class="fa-solid fa-arrows-rotate"></i>
                </button>
                <button onclick="toggleDarkMode()" class="p-2"><i id="theme-icon" class="fa-solid fa-moon"></i></button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
        
        <!-- 1. 주요 지표 카드 섹션: 6개만 표시되도록 INDICES 상수를 수정했습니다. -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3" id="indices-container">
            <!-- 지표 카드들은 JS로 로드됩니다. -->
        </div>

        <!-- 2. 2단 레이아웃: Market Map (좌) vs Detail Panel (우) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- 왼쪽: 시장 지도 (Market Map, 2/3 차지) -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Market Map 필터 버튼 -->
                <div class="flex justify-between items-center text-slate-700 dark:text-slate-300">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <i class="fa-solid fa-globe text-green-500"></i> 시장 지도 (Market Map)
                    </h2>
                    <div class="flex gap-2 text-sm">
                        <button id="filter-all" onclick="renderMarketMap('ALL')" class="px-3 py-1 rounded-full text-xs font-medium border border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700">전체모드</button>
                        <button id="filter-kospi_top_60" onclick="renderMarketMap('KOSPI_TOP_60')" class="px-3 py-1 rounded-full text-xs font-medium border border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700">KOSPI Top 60</button>
                        <button id="filter-kosdaq_top_60" onclick="renderMarketMap('KOSDAQ_TOP_60')" class="px-3 py-1 rounded-full text-xs font-medium bg-blue-600 text-white hover:bg-blue-700">KOSDAQ Top 60</button>
                    </div>
                </div>
                
                <!-- 시장 심도 (Market Breadth) Indicator -->
                <div id="market-breadth-indicator" class="bg-white p-3 rounded-xl shadow-sm border border-slate-200 dark:bg-slate-800 dark:border-slate-700">
                    <div class="flex justify-between items-center text-sm font-medium mb-2 text-slate-700 dark:text-slate-300">
                        <span class="flex items-center gap-1 text-blue-500"><i class="fa-solid fa-arrow-down"></i> 하락 종목 수: <span id="breadth-down-count">-</span></span>
                        <span class="text-xs text-slate-500">시장 심도</span>
                        <span class="flex items-center gap-1 text-red-500"><i class="fa-solid fa-arrow-up"></i> 상승 종목 수: <span id="breadth-up-count">-</span></span>
                    </div>
                    <div class="breadth-bar-container rounded-full overflow-hidden">
                        <div id="breadth-up-bar" class="h-full breadth-bar-red" style="width: 50%;"></div>
                    </div>
                </div>


                <!-- 섹터별 종목 그룹 컨테이너 -->
                <div id="market-map-container" class="space-y-6">
                    <div class="text-center py-10 text-slate-400">시총 순으로 종목들을 불러오는 중...</div>
                </div>
            </div>

            <!-- 오른쪽: 상세 정보 및 도구 패널 (1/3 차지) -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- 1. 종목 상세 정보 (검색 + 탭) -->
                <div class="bg-white rounded-2xl border border-slate-200 shadow-xl overflow-hidden dark:bg-slate-800 dark:border-slate-700">
                    
                    <!-- 검색 및 가격 헤더 -->
                    <div class="flex gap-2 mb-6 p-5 pb-0">
                        <input type="text" id="symbol-input" value="005930" placeholder="종목코드 (예: 005930)"
                               class="bg-slate-50 border border-slate-200 text-sm rounded-lg block w-full p-2.5 dark:bg-slate-700 dark:border-slate-600 dark:text-white" 
                               onkeypress="if(event.key==='Enter') fetchAllData()">
                        <button onclick="fetchAllData()" class="bg-blue-600 text-white rounded-lg px-4 py-2 text-sm whitespace-nowrap">조회</button>
                    </div>
                    
                    <div class="p-5 pt-0">
                        <!-- 가격 및 즐겨찾기 -->
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <!-- ✅ 종목명 표시 -->
                                <h3 id="main-name" class="text-xl font-bold mb-1 dark:text-white">Loading Name...</h3> 
                                <div class="flex items-center gap-2 mb-1">
                                    <h2 class="text-3xl font-bold" id="main-price">-</h2>
                                    <button onclick="toggleFavorite()" id="btn-favorite" class="text-slate-300 hover:text-yellow-400 transition-colors text-2xl" title="관심 종목 추가/삭제">
                                        <i class="fa-solid fa-star"></i>
                                    </button>
                                </div>
                                <div class="flex items-end gap-2">
                                    <div class="text-lg font-medium" id="main-change">-</div>
                                    <div class="text-sm text-slate-400 mb-1" id="main-symbol">Loading...</div>
                                </div>
                                <!-- 시총 및 순위 정보가 삽입될 영역 -->
                                <div id="stock-meta-info" class="mt-3">
                                    <!-- JS에 의해 채워짐 (시총, 순위 정보) -->
                                </div>
                            </div>
                            <!-- 링크 버튼 -->
                            <!-- ✅ DART 공시 링크 추가 및 레이아웃 정리 -->
                            <div class="flex flex-col gap-2">
                                <a id="link-naver" href="#" target="_blank" class="px-3 py-2 bg-[#03C75A] text-white rounded-lg text-xs font-bold text-center">네이버 증권</a>
                                <a id="link-dart" href="#" target="_blank" class="px-3 py-2 bg-indigo-600 text-white rounded-lg text-xs font-bold text-center hover:bg-indigo-700">DART 공시 검색</a>
                            </div>
                        </div>

                        <!-- 캔들차트 캔버스 -->
                        <div class="relative mb-5 p-3 rounded-xl bg-slate-50 dark:bg-slate-700/50">
                            <canvas id="stock-chart-canvas"></canvas>
                            <div id="chart-loading" class="absolute inset-0 flex items-center justify-center text-slate-400 text-sm bg-slate-50/80 dark:bg-slate-700/80">
                                차트 데이터를 불러오는 중...
                            </div>
                        </div>


                        <!-- 탭 메뉴 (뉴스/커뮤니티) -->
                        <div class="flex border-b border-slate-200 dark:border-slate-700">
                            <button onclick="switchTab('news')" id="tab-news" class="tab-btn active flex-1 py-3 text-sm font-medium">
                                <i class="fa-regular fa-newspaper mr-1"></i> 뉴스
                            </button>
                            <button onclick="switchTab('community')" id="tab-community" class="tab-btn flex-1 py-3 text-sm font-medium">
                                <i class="fa-solid fa-fire mr-1 text-red-500"></i> 토론방 (BEST)
                            </button>
                        </div>
                    </div>

                    <!-- 탭 콘텐츠 영역 -->
                    <div class="p-5 min-h-[250px] max-h-[500px] overflow-y-auto">
                        
                        <!-- 1. 뉴스 탭 -->
                        <div id="content-news" class="space-y-3">
                            <div class="text-center text-slate-400 py-10">데이터 로딩 중...</div>
                        </div>

                        <!-- 2. 커뮤니티 탭 (BEST 기능) -->
                        <div id="content-community" class="hidden space-y-4">
                            <!-- 실시간 베스트 섹션 -->
                            <div class="mb-4">
                                <h4 class="text-sm font-bold text-red-500 mb-2 flex items-center">
                                    <i class="fa-solid fa-crown mr-2"></i> 실시간 인기글 (Top 5)
                                </h4>
                                <div id="best-community-list" class="space-y-2">
                                    <!-- 베스트글 5개 들어갈 곳 -->
                                </div>
                            </div>
                            <hr class="border-slate-100 dark:border-slate-700 my-4">
                            <!-- 최신글 섹션 -->
                            <h4 class="text-xs font-bold text-slate-500 mb-2">⏱️ 최신글</h4>
                            <div id="latest-community-list" class="space-y-2">
                                <!-- 최신글 리스트 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. 나의 관심 종목 위젯 -->
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm dark:bg-slate-800 dark:border-slate-700 overflow-hidden">
                    <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-700/50">
                        <h3 class="font-bold text-slate-800 dark:text-slate-200 flex items-center gap-2">
                            <i class="fa-solid fa-star text-yellow-400"></i> 나의 관심 종목
                        </h3>
                    </div>
                    <!-- 오류 해결을 위해 ID 추가 -->
                    <div id="watchlist-container" class="divide-y divide-slate-100 dark:divide-slate-700 max-h-[300px] overflow-y-auto">
                        <div class="p-4 text-center text-xs text-slate-400">★ 버튼을 눌러 종목을 추가해보세요.</div>
                    </div>
                </div>

                <!-- 2. 환율 계산기 위젯 -->
                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm dark:bg-slate-800 dark:border-slate-700">
                    <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2 dark:text-slate-200">
                        <i class="fa-solid fa-calculator text-blue-500"></i> 환율 계산기
                    </h3>
                    
                    <!-- 통화 선택 드롭다운 및 동적 입력/출력 필드 - EUR, JPY 유지 -->
                    <div class="space-y-3">
                        <!-- 외화 입력 필드 -->
                        <div class="flex items-center gap-2">
                            <select id="calc-currency-select" onchange="updateCurrencyRate(); calculateExchange()"
                                    class="w-20 p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white font-bold">
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="JPY">JPY</option>
                            </select>
                            <input type="number" id="calc-input-foreign" placeholder="100" oninput="calculateExchange()"
                                class="flex-1 p-2 bg-slate-50 border border-slate-200 rounded-lg text-right font-mono focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        </div>
                        <!-- KRW 출력 필드 -->
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-slate-500 w-20 text-center">KRW (원)</span>
                            <input type="text" id="calc-input-krw" readonly 
                                class="flex-1 p-2 bg-slate-100 border border-slate-200 rounded-lg text-right font-mono font-bold text-slate-700 dark:bg-slate-600 dark:border-slate-500 dark:text-slate-200" value="-">
                        </div>
                        <!-- 현재 환율 표시 -->
                        <div class="text-right text-xs text-slate-400">
                            환율: <span id="current-rate">-</span>원/<span id="current-currency-unit">USD</span>
                        </div>
                    </div>

                </div>

                <!-- 3. 주요 사이트 링크 위젯 -->
                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm dark:bg-slate-800 dark:border-slate-700">
                    <h3 class="font-bold text-slate-800 mb-3 flex items-center gap-2 dark:text-slate-200">
                        <i class="fa-solid fa-link text-green-500"></i> 주요 사이트
                    </h3>
                    <div class="grid grid-cols-2 gap-2">
                        <a href="https://finance.naver.com/" target="_blank" class="block p-2 text-center text-xs bg-slate-50 hover:bg-slate-100 rounded-lg transition-colors border border-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-200 dark:hover:bg-slate-600">
                            네이버 금융
                        </a>
                        <a href="https://kr.investing.com/" target="_blank" class="block p-2 text-center text-xs bg-slate-50 hover:bg-slate-100 rounded-lg transition-colors border border-slate-100 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-200 dark:hover:bg-slate-600">
                            인베스팅닷컴
                        </a>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        // === 설정 ===
        // ✅ [반영] 주요 지표 6개만 표시 (EUR/JPY 제외)
        const INDICES = [
            { id: '^KS11', name: 'KOSPI', link: 'https://finance.naver.com/sise/sise_index.nhn?code=KOSPI' },
            { id: '^KQ11', name: 'KOSDAQ', link: 'https://finance.naver.com/sise/sise_index.nhn?code=KOSDAQ' },
            { id: 'NQ=F', name: 'NASDAQ 선물', link: 'https://kr.investing.com/indices/nq-100-futures' }, 
            { id: 'KRW=X', name: 'USD/KRW', link: 'https://finance.naver.com/marketindex/exchangeDetail.naver?marketindexCd=FX_USDKRW' },
            { id: 'BTC-KRW', name: 'Bitcoin', link: 'https://kr.investing.com/crypto/bitcoin/btc-krw' },
            { id: 'XAG=X', name: 'Silver (XAG/USD 현물)', link: 'https://kr.investing.com/commodities/silver' } 
        ];

        // 환율 계산기 로직 유지를 위해 EUR/JPY 데이터는 Mock으로 유지
        let currentRates = {
            USD: { rate: 1350.00, link: 'https://finance.naver.com/marketindex/exchangeDetail.naver?marketindexCd=FX_USDKRW', unit: 1 },
            EUR: { rate: 1450.00, link: 'https://finance.naver.com/marketindex/exchangeDetail.naver?marketindexCd=FX_EURKRW', unit: 1 },
            JPY: { rate: 9.50, link: 'https://finance.naver.com/marketindex/exchangeDetail.naver?marketindexCd=FX_JPYKRW', unit: 100 } // 100엔당
        };
        let selectedCurrency = 'USD'; // 기본 선택 통화

        // Mock Data 생성 헬퍼 함수
        function createMockStocks(count, market, baseCap, codePrefix, sectorKey) {
            return Array(count).fill(0).map((_, i) => ({
                code: `${market.substring(0, 1)}MOCK${codePrefix}${i < 9 ? `0${i + 1}` : `${i + 1}`}`, 
                name: `${sectorKey.replace(/KOSDAQ |KOSPI |\s*\(.*\)\s*/g, '').replace(/\//g, '·')} M${i + 1}`,
                // Mock Stock은 이제 고정된 등락률을 가집니다.
                change: (i % 2 === 0 ? 1.0 : -0.5) * (1 + (i % 5) * 0.2), // 고정 등락률 (약간의 변동은 유지)
                price: Math.floor(Math.random() * 30000) + 10000,
                market: market,
                cap: baseCap - i * (Math.random() * 50) - 1, 
                rank: 0 
            }));
        }

        // Market Map에 표시할 종목 목록 (시가총액 및 섹터 정보 포함)
        const ALL_MARKET_MAP_STOCKS = {
            // --- KOSPI Top Tier (Core) ---
            '반도체(메모리/파운드리)': [ 
                { code: '005930', name: '삼성전자', change: -1.3, price: 38000, market: 'KOSPI', cap: 450000, rank: 0 },
                { code: '000660', name: 'SK하이닉스', change: 2.15, price: 950000, market: 'KOSPI', cap: 100000, rank: 0 },
            ],
            '2차전지 셀/모듈': [
                { code: '373220', name: 'LG에너지솔루션', change: 0.41, price: 245000, market: 'KOSPI', cap: 35000, rank: 0 },
                { code: '006400', name: '삼성SDI', change: 0.5, price: 400000, market: 'KOSPI', cap: 28000, rank: 0 },
                { code: '003283', name: 'LG화학', change: 0.1, price: 650000, market: 'KOSPI', cap: 15000, rank: 0 },
            ],
            '완성차': [
                { code: '005380', name: '현대차', change: 1.2, price: 200000, market: 'KOSPI', cap: 40000, rank: 0 },
                { code: '000270', name: '기아', change: 0.9, price: 85000, market: 'KOSPI', cap: 25000, rank: 0 },
            ],
            'AI/플랫폼': [ 
                { code: '035420', name: 'NAVER', change: -1.0, price: 180000, market: 'KOSPI', cap: 35000, rank: 0 },
                { code: '036570', name: '엔씨소프트', change: 2.97, price: 52000, market: 'KOSPI', cap: 15000, rank: 0 },
            ],
            '제약/바이오(대형)': [ 
                { code: '068270', name: '셀트리온', change: -1.8, price: 82000, market: 'KOSPI', cap: 20000, rank: 0 },
                { code: '000100', name: '유한양행', change: 0.3, price: 60000, market: 'KOSPI', cap: 9000, rank: 0 },
            ],
            '은행/지주': [
                { code: '105560', name: 'KB금융', change: 0.5, price: 70000, market: 'KOSPI', cap: 18000, rank: 0 },
                { code: '055550', name: '신한지주', change: 0.3, price: 40000, market: 'KOSPI', cap: 15000, rank: 0 },
            ],
            '증권/보험': [ 
                { code: '000010', name: '하나금융지주', change: 1.0, price: 50000, market: 'KOSPI', cap: 12000, rank: 0 },
                { code: '032110', name: 'S-Oil', change: -1.0, price: 65000, market: 'KOSPI', cap: 10000, rank: 0 }, 
            ],

            // --- KOSDAQ Top Tier (Core) ---
            '2차전지 양극재/소재': [ 
                { code: '003670', name: '포스코퓨처엠', change: 0.8, price: 350000, market: 'KOSDAQ', cap: 9000, rank: 0 },
                { code: '247540', name: '에코프로비엠', change: 1.92, price: 265000, market: 'KOSDAQ', cap: 25000, rank: 0 },
                { code: '086520', name: '에코프로', change: 1.27, price: 94100, market: 'KOSDAQ', cap: 18000, rank: 0 },
                { code: '210000', name: '엘앤에프', change: -1.5, price: 150000, market: 'KOSDAQ', cap: 8500, rank: 0 },
                { code: '032830', name: '코스모신소재', change: 2.0, price: 55000, market: 'KOSDAQ', cap: 7500, rank: 0 },
            ],
            '제약/바이오(성장)': [
                { code: '196170', name: '알테오젠', change: 3.6, price: 345000, market: 'KOSDAQ', cap: 10000, rank: 0 },
                { code: '091990', name: '셀트리온헬스케어', change: 1.2, price: 70000, market: 'KOSDAQ', cap: 12000, rank: 0 },
            ],
            '의료기기/헬스케어': [
                { code: '950130', name: '휴젤', change: 2.46, price: 125000, market: 'KOSDAQ', cap: 8000, rank: 0 },
                { code: '084990', name: '헬릭스미스', change: -0.5, price: 5000, market: 'KOSDAQ', cap: 2000, rank: 0 },
            ],
            '반도체 소부장/장비': [ 
                { code: '086790', name: '하나마이크론', change: -0.5, price: 25000, market: 'KOSDAQ', cap: 5000, rank: 0 },
            ],
            
            // --- KOSPI 세분화된 기타 소비재 (40개 Mock) ---
            'KOSPI 식음료/프랜차이즈': createMockStocks(15, 'KOSPI', 5000, 'P1X', '식음료/프랜차이즈'),
            'KOSPI 유통/백화점': createMockStocks(15, 'KOSPI', 3500, 'P2X', '유통/백화점'),
            'KOSPI 화학/소재': createMockStocks(10, 'KOSPI', 2000, 'P3X', '화학/소재'),

            // --- KOSDAQ 세분화된 기타 성장주 (40개 Mock) ---
            'KOSDAQ 게임/엔터': createMockStocks(15, 'KOSDAQ', 10000, 'Q1X', '게임/엔터'),
            'KOSDAQ 인터넷/컨텐츠': createMockStocks(15, 'KOSDAQ', 8000, 'Q2X', '인터넷/컨텐츠'),
            'KOSDAQ 로봇/자동화': createMockStocks(10, 'KOSDAQ', 6000, 'Q3X', '로봇/자동화'),
        };


        let currentSymbol = '005930';
        

        // === 유틸리티 ===
        function formatNum(n) { return new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 2 }).format(n); }
        function getColor(v) { return v > 0 ? 'text-red-500' : (v < 0 ? 'text-blue-500' : 'text-slate-500'); }
        function getColorBg(v) { return v > 0 ? 'bg-red-500/10' : (v < 0 ? 'bg-blue-500/10' : 'bg-slate-500/10'); }

        // 시가총액 포맷팅 함수 (억 원 -> 조 원)
        function formatCap(capValue) {
            // capValue는 억 원 단위의 숫자
            
            // 조 단위 (10000억 이상, 즉 1조 원 이상)
            if (capValue >= 10000) {
                // 소수점 둘째 자리까지 표시
                return `${(capValue / 10000).toFixed(2)}조 원`;
            }
            // 억 단위 (1억 이상 ~ 9999억 이하)
            if (capValue > 0) {
                // 자연수로 표현 (formatNum이 콤마를 추가함)
                return `${formatNum(Math.floor(capValue))}억 원`; 
            }
            return 'N/A';
        }

        // 시총/순위 정보 검색 함수
        function getStockDetailsBySymbol(symbol) {
            for (const sector in ALL_MARKET_MAP_STOCKS) {
                // Find the stock object within the sector's array
                const found = ALL_MARKET_MAP_STOCKS[sector].find(s => s.code === symbol);
                if (found) {
                    return {
                        cap: formatCap(found.cap),
                        // 순위는 1~60위까지 표시되므로 0보다 클 때만 표시
                        rank: found.rank > 0 ? `${found.rank}위` : 'N/A' 
                    };
                }
            }
            return { cap: 'N/A', rank: 'N/A' };
        }


        // === 다크모드 로직 ===
        function initDarkMode() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                updateThemeIcon(true);
            } else {
                document.documentElement.classList.remove('dark');
                updateThemeIcon(false);
            }
        }
        function toggleDarkMode() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
                updateThemeIcon(false);
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
                updateThemeIcon(true);
            }
        }
        function updateThemeIcon(isDark) {
            const icon = document.getElementById('theme-icon');
            icon.className = isDark ? "fa-solid fa-sun text-yellow-400 text-lg" : "fa-solid fa-moon text-slate-600 text-lg";
        }


        // === 환율 계산기 로직 ===
        // 통화 종류를 반영하여 계산
        function calculateExchange() {
            const foreignInput = document.getElementById('calc-input-foreign').value;
            const krwOutput = document.getElementById('calc-input-krw');
            
            const rateInfo = currentRates[selectedCurrency];
            const currentRate = rateInfo ? rateInfo.rate : 0;
            const unit = rateInfo ? rateInfo.unit : 1;

            if (currentRate > 0 && foreignInput) {
                const amount = parseFloat(foreignInput);
                // 100엔당 표기일 경우, 1엔당 가격으로 변환하여 계산
                const calculatedKrw = amount * (currentRate / unit); 
                krwOutput.value = formatNum(calculatedKrw);
            } else {
                krwOutput.value = "-";
            }
        }

        // 선택된 통화에 따라 환율 정보를 업데이트하고 계산을 트리거
        function updateCurrencyRate() {
            const selectElement = document.getElementById('calc-currency-select');
            selectedCurrency = selectElement.value;

            const rateInfo = currentRates[selectedCurrency];
            const rateDisplay = document.getElementById('current-rate');
            const unitDisplay = document.getElementById('current-currency-unit');
            
            if (rateInfo) {
                rateDisplay.textContent = formatNum(rateInfo.rate);
                unitDisplay.textContent = selectedCurrency;
                // 100엔당 표기일 경우, UI에 (100엔) 표시 추가
                if (rateInfo.unit > 1) {
                    unitDisplay.textContent += ` (${rateInfo.unit}단위)`;
                }
            } else {
                rateDisplay.textContent = "-";
                unitDisplay.textContent = selectedCurrency;
            }

            // 환율 정보가 바뀌었으므로 계산 재실행
            calculateExchange();
        }
        
        // === 관심 종목 즐겨찾기 로직 ===
        function getFavorites() {
            const favs = localStorage.getItem('stockFavorites');
            return favs ? JSON.parse(favs) : ['005930', 'TSLA']; // 기본값
        }

        function toggleFavorite() {
            let favs = getFavorites();
            const btn = document.getElementById('btn-favorite');
            
            if (favs.includes(currentSymbol)) {
                favs = favs.filter(s => s !== currentSymbol); // 삭제
                btn.className = "text-slate-300 hover:text-yellow-400 transition-colors text-2xl";
            } else {
                favs.push(currentSymbol); // 추가
                btn.className = "text-yellow-400 hover:text-yellow-500 transition-colors text-2xl drop-shadow-sm";
            }
            
            localStorage.setItem('stockFavorites', JSON.stringify(favs));
            fetchWatchlistData();
        }

        function updateFavoriteBtnState() {
            const favs = getFavorites();
            const btn = document.getElementById('btn-favorite');
            if (favs.includes(currentSymbol)) {
                btn.className = "text-yellow-400 hover:text-yellow-500 transition-colors text-2xl drop-shadow-sm";
            } else {
                btn.className = "text-slate-300 hover:text-yellow-400 transition-colors text-2xl";
            }
        }

        async function fetchWatchlistData() {
            const favs = getFavorites();
            const container = document.getElementById('watchlist-container');
            
            if (!container) return; // 요소가 없으면 함수 종료 (오류 방지)

            if (favs.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-xs text-slate-400">★ 버튼을 눌러 종목을 추가해보세요.</div>';
                return;
            }

            container.innerHTML = ''; 

            // ✅ Mock 데이터 강제 사용: API 호출 실패 가정
            const promises = favs.map(symbol => Promise.resolve(getMockData(symbol)));
            const results = await Promise.all(promises);

            results.forEach(data => {
                const item = document.createElement('div');
                item.className = "p-3 flex justify-between items-center cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors";
                item.onclick = () => {
                    document.getElementById('symbol-input').value = data.symbol;
                    fetchAllData();
                };

                const changeSign = data.change > 0 ? '+' : '';
                const colorClass = getColor(data.change);
                
                item.innerHTML = `
                    <div>
                        <div class="font-bold text-sm text-slate-700 dark:text-slate-200">${data.symbol}</div>
                        <div class="text-xs text-slate-400">클릭하여 상세 보기</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-sm dark:text-white">${formatNum(data.price)}</div>
                        <div class="text-xs ${colorClass}">
                            ${changeSign}${formatNum(data.change_percent.toFixed(2))}%
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }


        // === 메인 탭 전환 (뉴스/커뮤니티) ===
        function switchTab(tab) {
            document.getElementById('content-news').classList.toggle('hidden', tab !== 'news');
            document.getElementById('content-community').classList.toggle('hidden', tab !== 'community');
            document.getElementById('tab-news').classList.toggle('active', tab === 'news');
            document.getElementById('tab-community').classList.toggle('active', tab === 'community');
            
            if(tab === 'community') fetchCommunity();
        }

        // === 데이터 로직 ===
        async function fetchAllData() {
            const sym = document.getElementById('symbol-input').value;
            currentSymbol = sym;
            
            updateFavoriteBtnState(); 
            
            // ✅ Mock 데이터 강제 사용: API 호출 실패 가정
            const data = getMockData(sym);
            renderMain(data);

            if(document.getElementById('tab-community').classList.contains('active')) fetchCommunity();
            
            // 갱신 함수 호출 (자동 갱신은 setInterval에 의해 이루어짐)
            fetchMarketData(); 
        }
        
        // 주가 차트 시뮬레이션 함수 -> 캔들차트 로직
        function drawStockChart(price, change) {
            const canvas = document.getElementById('stock-chart-canvas');
            const loading = document.getElementById('chart-loading');
            
            if (!canvas) return;

            // 캔버스 크기 조정
            const containerWidth = canvas.parentElement.clientWidth;
            canvas.width = containerWidth;
            canvas.height = 150; // 고정 높이

            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            loading.classList.remove('hidden');

            const width = canvas.width;
            const height = canvas.height;
            const dataPoints = 12; // 12개의 캔들 (예: 12시간 또는 12일)
            
            // 200ms 딜레이 후 차트 로딩
            setTimeout(() => {
                loading.classList.add('hidden');

                // 1. Mock OHLC 데이터 생성 (현재 가격과 등락률 기반)
                const OHLCData = [];
                // basePrice를 현재 price와 change를 역산해서 계산하여 고정된 차트 모양 유지
                const basePrice = price / (1 + change / 100); 
                const dailyRange = Math.abs(change) * 1.5; 
                
                let minVal = basePrice * 0.98; // 전체 가격 범위 추정치
                let maxVal = basePrice * 1.02;

                let lastClose = basePrice;
                // 난수 대신 고정된 패턴을 사용하여 차트가 변하지 않도록 합니다.
                const fixedRandoms = [0.3, 0.7, 0.5, 0.2, 0.8, 0.4, 0.6, 0.9, 0.1, 0.55, 0.45, 1.0]; 

                for (let i = 0; i < dataPoints; i++) {
                    const r1 = fixedRandoms[i] * 0.005; // open variation factor
                    const r2 = fixedRandoms[i] * 0.5 + 0.5; // variance factor
                    const r3 = fixedRandoms[(i + 1) % dataPoints]; // high/low factor
                    const r4 = fixedRandoms[(i + 2) % dataPoints]; // close factor

                    // 다음 시가 (Open)는 이전 종가(Close) 근처에서 시작
                    const open = lastClose * (1 + (0.5 - r1)); // 고정된 작은 변동 
                    
                    // 변동폭 설정
                    const variance = dailyRange * r2; 
                    const highLowDiff = open * (variance / 100);
                    
                    const high = open + highLowDiff * r3;
                    const low = open - highLowDiff * (1 - r3);
                    
                    // 종가(Close)는 고정된 패턴으로 수렴하거나 현재 가격으로 고정
                    let close;
                    if (i === dataPoints - 1) {
                         close = price; // 마지막 캔들의 종가는 현재 가격
                    } else {
                        close = open + (r4 - 0.5) * highLowDiff;
                    }

                    // OHLC 순서 보정
                    const candleHigh = Math.max(open, close, high);
                    const candleLow = Math.min(open, close, low);

                    OHLCData.push({ open, high: candleHigh, low: candleLow, close });

                    minVal = Math.min(minVal, candleLow);
                    maxVal = Math.max(maxVal, candleHigh);
                    lastClose = close;
                }

                // 2. 스케일링 설정
                const padding = 10;
                const chartHeight = height - padding * 2;
                const chartWidth = width - padding * 2;
                const priceRange = maxVal - minVal;
                const barWidth = chartWidth / dataPoints * 0.6;
                const gap = chartWidth / dataPoints * 0.4;
                
                const getY = (value) => height - padding - ((value - minVal) / priceRange) * chartHeight;

                // 3. 캔들 그리기
                for (let i = 0; i < dataPoints; i++) {
                    const data = OHLCData[i];
                    const x = padding + i * (barWidth + gap) + gap / 2;
                    
                    const openY = getY(data.open);
                    const closeY = getY(data.close);
                    const highY = getY(data.high);
                    const lowY = getY(data.low);

                    const isRising = data.close > data.open;
                    const bodyTop = isRising ? closeY : openY;
                    const bodyBottom = isRising ? openY : closeY;
                    const bodyHeight = Math.max(1, bodyBottom - bodyTop); // 최소 높이 1px

                    ctx.fillStyle = isRising ? '#ef4444' : '#3b82f6'; // 빨강(상승) 또는 파랑(하락)
                    ctx.strokeStyle = isRising ? '#ef4444' : '#3b82f6';

                    // 꼬리(심지) 그리기
                    ctx.beginPath();
                    ctx.moveTo(x + barWidth / 2, highY);
                    ctx.lineTo(x + barWidth / 2, lowY);
                    ctx.stroke();

                    // 몸통 그리기
                    ctx.fillRect(x, bodyTop, barWidth, bodyHeight);
                }
                
                // 마지막 가격 기준선 (현재 가격) 그리기
                ctx.beginPath();
                ctx.strokeStyle = change > 0 ? '#ef4444' : (change < 0 ? '#3b82f6' : '#94a3b8');
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 2]); // 점선

                const currentY = getY(price);
                ctx.moveTo(padding, currentY);
                ctx.lineTo(width - padding, currentY);
                ctx.stroke();
                ctx.closePath();
                ctx.setLineDash([]); 

            }, 200); // 로딩 시뮬레이션
        }
        // 캔들차트 시뮬레이션 함수 끝


        // ✅ [추가] 3D Tilt 효과 관련 JavaScript 함수
        const TILT_MAX_ROTATE = 10;
        const TILT_PERSPECTIVE = 800;
        const BASE_SHADOW_LIGHT = '0 4px 12px rgba(0, 0, 0, 0.1)';
        const BASE_SHADOW_DARK = '0 4px 12px rgba(255, 255, 255, 0.05)';

        function handleTilt(event, element) {
            const rect = element.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            // 마우스 위치 (element 중앙 기준)
            const mouseX = event.clientX - centerX;
            const mouseY = event.clientY - centerY;

            // Normalize mouse position to [-1, 1] range relative to element size
            const tiltX = (mouseY / rect.height) * (TILT_MAX_ROTATE * 2); 
            const tiltY = (mouseX / rect.width) * (TILT_MAX_ROTATE * 2);  
            
            // 최종 회전 각도 (마우스가 중앙에서 멀어질수록 커짐)
            // X축 회전 (수직 기울임)은 Y 좌표 변화에 따라, Y축 회전 (수평 기울임)은 X 좌표 변화에 따라 적용
            const rotateX = Math.min(Math.max(-TILT_MAX_ROTATE, tiltX), TILT_MAX_ROTATE) * -1;
            const rotateY = Math.min(Math.max(-TILT_MAX_ROTATE, tiltY), TILT_MAX_ROTATE);
            
            // 동적 그림자 적용 (마우스 위치에 따라 그림자 위치 및 크기 변경)
            const shadowOpacity = 0.2 + (Math.abs(rotateX) + Math.abs(rotateY)) / TILT_MAX_ROTATE * 0.05; // 기울임에 따라 그림자 진하게
            const isDark = document.documentElement.classList.contains('dark');
            const shadowColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.2)';
            
            element.style.transform = `perspective(${TILT_PERSPECTIVE}px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
            element.style.boxShadow = `${(tiltY/4).toFixed(1)}px ${(tiltX/4).toFixed(1)}px 30px ${shadowColor}`; 
        }

        function resetTilt(element) {
            const isDark = document.documentElement.classList.contains('dark');
            element.style.transform = `perspective(${TILT_PERSPECTIVE}px) rotateX(0deg) rotateY(0deg)`;
            element.style.boxShadow = isDark ? BASE_SHADOW_DARK : BASE_SHADOW_LIGHT; 
        }

        // Market Map 필터링 및 렌더링
        function renderMarketMap(filterMode = 'KOSDAQ_TOP_60') {
            // 1. 버튼 활성화/비활성화
            const buttons = ['all', 'kospi_top_60', 'kosdaq_top_60'];
            buttons.forEach(id => {
                const btn = document.getElementById(`filter-${id}`);
                const isActive = id.toUpperCase() === filterMode;
                if (btn) {
                    btn.className = isActive
                        ? 'px-3 py-1 rounded-full text-xs font-medium bg-blue-600 text-white hover:bg-blue-700'
                        : 'px-3 py-1 rounded-full text-xs font-medium border border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700';
                }
            });

            // 2. 종목 필터링 및 정렬
            let totalCapBySector = {};
            
            const filterMarket = filterMode === 'KOSPI_TOP_60' ? 'KOSPI' : (filterMode === 'KOSDAQ_TOP_60' ? 'KOSDAQ' : null);
            const maxStocks = filterMode === 'ALL' ? 120 : 60;

            let allStocks = [];
            for (const stocks of Object.values(ALL_MARKET_MAP_STOCKS)) {
                allStocks.push(...stocks);
            }
            
            let marketStocks = allStocks;
            if (filterMarket) {
                marketStocks = allStocks.filter(s => s.market === filterMarket);
            }
            
            // 시가총액 순으로 정렬하여 순위를 확정
            marketStocks.sort((a, b) => b.cap - a.cap);
            let topMarketStocks = marketStocks.slice(0, maxStocks);

            let finalStocksBySector = {};
            
            topMarketStocks.forEach((stock, index) => { 
                const currentRank = index + 1;
                // 종목이 속한 원래 섹터 찾기 (섹터 색상 구분을 위해 필요)
                const sectorName = Object.keys(ALL_MARKET_MAP_STOCKS).find(key => 
                    ALL_MARKET_MAP_STOCKS[key].some(s => s.code === stock.code && s.market === stock.market)
                ) || '기타';

                if (!finalStocksBySector[sectorName]) {
                    finalStocksBySector[sectorName] = [];
                    totalCapBySector[sectorName] = 0;
                }
                
                stock.rank = currentRank; 
                finalStocksBySector[sectorName].push(stock);
                totalCapBySector[sectorName] += stock.cap;
            });
            
            // 섹터별 평균 등락률 계산 (상대 강도 배지를 위해 필요)
            let sectorPerformance = {};
            Object.keys(finalStocksBySector).forEach(sectorName => {
                const stocks = finalStocksBySector[sectorName];
                if (stocks.length > 0) {
                    const totalChange = stocks.reduce((sum, s) => sum + s.change, 0);
                    sectorPerformance[sectorName] = totalChange / stocks.length;
                } else {
                    sectorPerformance[sectorName] = 0;
                }
            });
            
            // Market Breadth 계산 및 업데이트
            const totalCount = topMarketStocks.length;
            const upCount = topMarketStocks.filter(s => s.change > 0).length;
            const downCount = topMarketStocks.filter(s => s.change < 0).length;
            const upPercent = totalCount > 0 ? (upCount / totalCount) * 100 : 0;
            const downPercent = totalCount > 0 ? (downCount / totalCount) * 100 : 0;

            document.getElementById('breadth-up-count').textContent = `${upCount}개 (${upPercent.toFixed(1)}%)`;
            document.getElementById('breadth-down-count').textContent = `${downCount}개 (${downPercent.toFixed(1)}%)`;
            
            const upBar = document.getElementById('breadth-up-bar');
            upBar.style.width = `${upPercent}%`;
            upBar.classList.toggle('breadth-bar-red', upPercent > downPercent);
            upBar.classList.toggle('bg-blue-500', upPercent <= downPercent);
            
            // 3. 모든 종목을 시총 순으로 통합 배치하고 섹터는 테두리 색상으로만 구분
            const container = document.getElementById('market-map-container');
            let globalStockCount = topMarketStocks.length;

            if (topMarketStocks.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-slate-400">선택된 모드(${filterMode})에 해당하는 종목이 없습니다.</div>`;
                return;
            }
            
            let stockCountMessage = filterMarket ? `${filterMarket} Top ${maxStocks} 중 ${globalStockCount}개 표시됨` : `총 ${globalStockCount}개 표시됨`;

            let mapContentHtml = `
                <div class="text-sm text-slate-500 dark:text-slate-400 mb-4">시가총액 순으로 통합 배치 (${stockCountMessage})</div>
                <div class="bg-white p-4 rounded-xl shadow-xl border border-slate-200 dark:bg-slate-800 dark:border-slate-700">
                    <div class="grid grid-cols-12 auto-rows-min gap-2">
            `;

            // Treemap Layout 결정 로직 (순위에 따라 크기 지정)
            function getStockLayout(rank) {
                if (rank <= 3) return { span: 'col-span-6 row-span-2', nameSize: 'text-xl', priceSize: 'text-4xl' }; // 초대형주 (가장 크게)
                if (rank <= 6) return { span: 'col-span-4 row-span-2', nameSize: 'text-lg', priceSize: 'text-3xl' }; // 대형주
                if (rank <= 10) return { span: 'col-span-3 row-span-1', nameSize: 'text-md', priceSize: 'text-2xl' }; // 중대형주
                if (rank <= 20) return { span: 'col-span-3 row-span-1', nameSize: 'text-sm', priceSize: 'text-xl' }; // 중형주
                if (rank <= 40) return { span: 'col-span-2 row-span-1', nameSize: 'text-xs', priceSize: 'text-lg' }; // 소형주
                // 120개 종목을 모두 표시하기 위해 가장 작은 크기 설정
                return { span: 'col-span-2 row-span-1', nameSize: 'text-xs', priceSize: 'text-base' }; // 기타
            }

            // 섹터별 경계선 색상 클래스 매핑 함수 (유지)
            function getSectorBorderColor(sectorName) {
                if (sectorName.includes('반도체')) return 'border-sector-red';
                if (sectorName.includes('2차전지')) return 'border-sector-blue';
                if (sectorName.includes('완성차')) return 'border-sector-green';
                if (sectorName.includes('AI') || sectorName.includes('플랫폼')) return 'border-sector-red';
                if (sectorName.includes('제약') || sectorName.includes('바이오') || sectorName.includes('의료기기')) return 'border-sector-purple';
                if (sectorName.includes('은행') || sectorName.includes('증권') || sectorName.includes('보험')) return 'border-sector-amber';
                if (sectorName.includes('식음료')) return 'border-sector-orange';
                if (sectorName.includes('유통') || sectorName.includes('백화점')) return 'border-sector-indigo';
                if (sectorName.includes('화학') || sectorName.includes('소재')) return 'border-sector-lime';
                if (sectorName.includes('게임') || sectorName.includes('엔터')) return 'border-sector-cyan';
                if (sectorName.includes('컨텐츠')) return 'border-sector-pink';
                if (sectorName.includes('로봇') || sectorName.includes('자동화')) return 'border-sector-teal';
                return 'border-slate-500';
            }
            
            // 4. 모든 종목을 순서대로 렌더링
            topMarketStocks.forEach(stock => {
                // 해당 종목의 섹터 이름 찾기 (테두리 색상 결정을 위해)
                const sectorName = Object.keys(ALL_MARKET_MAP_STOCKS).find(key => 
                    ALL_MARKET_MAP_STOCKS[key].some(s => s.code === stock.code && s.market === stock.market)
                ) || '기타';

                // ✅ [추가 로직] 섹터 이름 표시 로직
                let displaySectorName = sectorName;
                if (stock.rank > 20) { // 작은 카드일 경우 섹터명 축약
                    // 시장 구분자나 괄호 내용 제거 및 슬래시/점 대체
                    displaySectorName = sectorName.replace(/KOSPI|KOSDAQ|\(.*\)/g, '').trim().replace(/·/g, '/');
                    // 아주 작은 카드일 경우 더 짧게 자름
                    if (stock.rank > 40 && displaySectorName.length > 5) {
                         displaySectorName = displaySectorName.substring(0, 5) + '...';
                    }
                }
                
                // ✅ 시가총액 표시 로직
                const formattedCap = formatCap(stock.cap);

                const layout = getStockLayout(stock.rank); // 개별 종목 크기 결정
                const colorClass = getColor(stock.change);
                const bgColorClass = getColorBg(stock.change);
                const changeSign = stock.change > 0 ? '▲' : '▼';
                
                const sectorBorderClass = getSectorBorderColor(sectorName);
                
                const marketBadge = stock.market === 'KOSDAQ' ? '<span class="text-[10px] text-blue-400 ml-1"> (Q)</span>' : '';
                
                // 순위 배지
                const isTop3 = stock.rank <= 3;
                const rankBadgeClass = isTop3 ? 'bg-red-500' : 'bg-orange-500';
                const rankAnimationClass = isTop3 ? 'rank-pop' : '';
                const rankDisplay = `<span class="text-[10px] text-white font-bold px-2 py-0.5 rounded-full ${rankBadgeClass} ${rankAnimationClass}">${stock.rank}위</span>`;
                
                // 상대 강도 배지 (섹터 평균을 찾기 위해 다시 계산)
                const currentSectorPerf = sectorPerformance[sectorName] || 0;
                const relativeStrength = stock.change - currentSectorPerf;
                let strengthBadge = '';
                if (relativeStrength > 0.5) {
                    strengthBadge = `<span class="ml-1 text-[10px] font-bold text-white bg-green-500 px-1 py-0.5 rounded-full" title="섹터 평균 대비 +${relativeStrength.toFixed(2)}% 강세">강세</span>`;
                } else if (relativeStrength < -0.5) {
                    strengthBadge = `<span class="ml-1 text-[10px] font-bold text-white bg-indigo-500 px-1 py-0.5 rounded-full" title="섹터 평균 대비 ${relativeStrength.toFixed(2)}% 약세">약세</span>`;
                } else {
                    strengthBadge = `<span class="ml-1 text-[10px] font-medium text-slate-400" title="섹터 평균과 유사">중립</span>`;
                }

                mapContentHtml += `
                    <div onclick="document.getElementById('symbol-input').value='${stock.code}'; fetchAllData()" 
                         onmousemove="handleTilt(event, this)"
                         onmouseout="resetTilt(this)"
                         class="${layout.span} p-2 rounded-lg treemap-card-3d border-2 ${sectorBorderClass} cursor-pointer ${bgColorClass} hover:ring-2 hover:ring-blue-400 dark:border-slate-700 flex flex-col justify-between">
                        
                        <!-- Top Line: Name and Rank -->
                        <div class="flex justify-between items-start mb-0.5">
                            <div class="font-bold ${layout.nameSize} text-slate-800 dark:text-slate-100 leading-tight">
                                ${stock.name}${marketBadge}
                            </div>
                            ${rankDisplay}
                        </div>
                        
                        <!-- ✅ 섹터 이름 -->
                        <div class="text-[10px] text-slate-500 dark:text-slate-400 leading-none mb-1">
                            ${displaySectorName}
                        </div>

                        <!-- Price -->
                        <div class="font-extrabold ${layout.priceSize} dark:text-white leading-none mt-1">
                            ${formatNum(stock.price)}
                        </div>
                        
                        <!-- Change and Strength -->
                        <div class="text-xs ${colorClass} mt-1 flex items-center justify-between">
                            <div>${changeSign} ${formatNum(stock.change)}%</div>
                            ${strengthBadge} 
                        </div>
                        
                        <!-- Details: Code & Market Cap -->
                        <div class="text-[10px] text-slate-500 dark:text-slate-400 mt-1 flex justify-between">
                            <span>${stock.code}</span>
                            <!-- ✅ 시가총액 (억 원/조 원, 조단위는 소수점 둘째자리) -->
                            <span class="font-medium text-slate-600 dark:text-slate-300 whitespace-nowrap">${formattedCap}</span> 
                        </div>
                    </div>
                `;
            });

            mapContentHtml += `</div></div>`;
            container.innerHTML = mapContentHtml;
        }


        // ✅ 새로운 Mock 커뮤니티 데이터 생성 함수 (로직 유지)
        function getMockCommunityData(symbol, name) {
            const isUp = getMockData(symbol).change > 0;
            const randomSeed = 100; // 고정된 값
            
            const bestTitles = [
                `${name} 폭등 신호! 기관 매수 포착. (V.3)`,
                `[HOT] ${name} vs 경쟁사, 하반기 전망 심층 분석 리포트`,
                `장기 관점에서 보면 지금은 절호의 ${isUp ? '매수' : '관망'} 기회 (W.5)`,
            ];

            const latestTitles = [
                `현재가 ${isUp ? '상승' : '하락'} 추이 분석 요청드립니다.`,
                `${name} 왜 갑자기 ${isUp ? '오르는' : '빠지는'} 걸까요?`,
                `이번 분기 실적 발표 예상치 및 전망 공유 부탁드려요.`,
            ];
            
            // 조회수/공감수 시뮬레이션
            const baseViews = 2000;
            const baseLikes = 400;

            return {
                best: bestTitles.map((title, i) => ({
                    title: title,
                    link: '#',
                    views: formatNum(Math.floor(baseViews + (randomSeed % 100) * (i + 1) * 5)),
                    likes: formatNum(Math.floor(baseLikes + (randomSeed % 50) * (i + 1) * 3)),
                    date: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
                })),
                latest: latestTitles.map((title, i) => ({
                    title: title,
                    link: '#',
                    views: formatNum(Math.floor(100 + (randomSeed % 20) * (i + 1))),
                    likes: formatNum(Math.floor(10 + (randomSeed % 5) * (i + 1))),
                    date: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })
                }))
            };
        }


        async function fetchCommunity() {
            const bestList = document.getElementById('best-community-list');
            const latestList = document.getElementById('latest-community-list');
            
            // 현재 메인 종목 데이터를 가져와 이름(name)을 확보
            const mainStockData = getMockData(currentSymbol);
            
            if(isNaN(currentSymbol)) {
                bestList.innerHTML = '<div class="text-center text-xs text-slate-400">지원하지 않는 종목입니다.</div>';
                latestList.innerHTML = '';
                return;
            }

            bestList.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-spinner fa-spin text-red-500"></i></div>';
            latestList.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-spinner fa-spin text-slate-500"></i></div>';
            
            // ✅ Mock 데이터 생성 함수 호출
            const data = getMockCommunityData(currentSymbol, mainStockData.name);

            // 베스트글 렌더링
            if(data.best && data.best.length > 0) {
                bestList.innerHTML = data.best.map(p => `
                    <a href="${p.link}" target="_blank" class="block p-3 best-post-card rounded-r-lg hover:shadow-sm transition-all mb-2">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-bold text-sm text-slate-800 dark:text-white truncate flex-1 pr-2">
                                <span class="text-red-500 mr-1 text-xs">BEST</span>${p.title}
                            </span>
                        </div>
                        <div class="flex gap-3 text-xs font-bold text-slate-600 dark:text-slate-400">
                            <span><i class="fa-regular fa-eye mr-1"></i>${p.views}</span>
                            <span class="text-red-500"><i class="fa-regular fa-thumbs-up mr-1"></i>${p.likes}</span>
                            <span class="text-slate-400 font-normal ml-auto">${p.date.split(' ')[1] || p.date}</span>
                        </div>
                    </a>
                `).join('');
            } else {
                bestList.innerHTML = '<div class="text-center py-2 text-xs text-slate-400">인기글을 집계 중입니다.</div>';
            }

            // 최신글 렌더링
            if(data.latest && data.latest.length > 0) {
                latestList.innerHTML = data.latest.map(p => `
                    <a href="${p.link}" target="_blank" class="block p-3 bg-slate-50 rounded-lg hover:bg-slate-100 border border-slate-100 dark:bg-slate-700 dark:border-slate-600">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-sm text-slate-700 dark:text-slate-200 truncate flex-1 pr-2">${p.title}</span>
                        </div>
                        <div class="flex gap-3 text-xs text-slate-400">
                            <span>조회 ${p.views}</span>
                            <span>공감 ${p.likes}</span>
                            <span class="ml-auto">${p.date.split(' ')[1] || p.date}</span>
                        </div>
                    </a>
                `).join('');
            } else {
                latestList.innerHTML = '<div class="text-center py-2 text-xs text-slate-400">최신글이 없습니다.</div>';
            }
        }
        
        async function fetchMarketData() {
            // 새로고침 아이콘에 스피너가 표시되고 있을 경우, 완료 후 제거합니다.
            const refreshIcon = document.getElementById('btn-refresh').querySelector('i');
            refreshIcon.classList.remove('fa-spin');
            refreshIcon.classList.remove('text-blue-600');
            refreshIcon.classList.add('text-slate-500');


            // 1. 주요 지표 갱신
            INDICES.forEach(async (index) => {
                // ✅ Mock 데이터 강제 사용
                const data = getMockData(index.id);
                
                // 환율 데이터가 들어오면 currentRates 객체를 업데이트
                const currencyCode = index.id.split('=')[0];
                if (currentRates[currencyCode]) {
                    // KRW=X만 INDICES에 있으므로, 이 지표가 업데이트 될 때만 calculateExchange를 호출
                    // KRW=X Mock 데이터가 고정값으로 설정되었으므로, currentRates도 고정됨
                    currentRates[currencyCode].rate = data.price;
                    if (index.id === 'KRW=X') { 
                        updateCurrencyRate();
                    }
                }
                updateIndexUI(index.id, data); 

                // Mock Rate 사용 시 currentRates 업데이트 (고정값 사용)
                if (currentRates['EUR']) currentRates['EUR'].rate = getMockData('EUR=X').price;
                if (currentRates['JPY']) currentRates['JPY'].rate = getMockData('JPY=X').price;
            });
            
            // 2. 관심 종목 데이터 갱신
            fetchWatchlistData();

            // 3. 커뮤니티 데이터 갱신 (수동 새로고침 시 즉시 반영되도록)
            if(document.getElementById('tab-community').classList.contains('active')) fetchCommunity();
        }

        // === 렌더링 헬퍼 ===
        function updateIndexUI(id, data) {
            const priceElem = document.getElementById(`idx-p-${id}`);
            const linkElem = priceElem ? priceElem.closest('a') : null;
            if(priceElem) {
                // JPY의 경우 100엔당 가격이 들어오므로 1엔당 가격으로 환산하여 표시 (현재 INDICES에 JPY는 없으나, 혹시 모를 로직 유지를 위해)
                let displayPrice = data.price;
                
                if(id === 'JPY=X' && currentRates['JPY']) {
                    displayPrice = data.price / currentRates['JPY'].unit;
                }

                priceElem.textContent = formatNum(displayPrice);
                
                // Change element inside the link tag
                const changeElem = linkElem ? linkElem.querySelector('.index-change') : null;
                if(changeElem) {
                    const changeSign = data.change > 0 ? '+' : '';
                    changeElem.textContent = `${changeSign}${formatNum(data.change)} (${changeSign}${formatNum(data.change_percent.toFixed(2))}%)`;
                    changeElem.className = `text-xs font-medium flex items-center mt-1 index-change ${getColor(data.change)}`;
                }
                
                priceElem.className = `font-bold text-sm ${getColor(data.change)}`;
            }
        }

        // ✅ [수정] 당일 주요 공시 Mock 데이터 생성 함수 (랜덤성 제거)
        function getMajorDisclosure(data) {
            // 등락률은 getMockData에서 고정된 값으로 가져옴
            const isSignificant = Math.abs(data.change_percent) >= 1.5; 
            const isPositive = data.change_percent > 0;
            const seed = 5; // 고정된 시드값 사용 (랜덤성 제거)
            
            let badgeClass, badgeText, title, time;

            if (isSignificant) {
                // 등락폭이 클 경우 시세 방향에 맞춰 긍정/부정 공시 생성
                if (isPositive) {
                    badgeClass = "bg-red-500 border-red-700 text-red-700 dark:text-red-300 dark:border-red-500";
                    badgeText = "호재 (HOT)";
                    if (seed % 3 === 0) {
                        title = `[공시] ${data.name}, 사상 최대 규모 ${data.change_percent.toFixed(0)}% 무상증자 결정 (매우 긍정적)`;
                    } else if (seed % 3 === 1) {
                        title = `[공시] 1000억 규모 신규 시설 투자 발표, 미래 성장 동력 확보`;
                    } else {
                        title = `[공시] 창사 이래 최대치 ${data.change_percent.toFixed(1)}% 영업이익 잠정 발표 (깜짝 실적)`;
                    }
                } else {
                    badgeClass = "bg-blue-500 border-blue-700 text-blue-700 dark:text-blue-300 dark:border-blue-500";
                    badgeText = "악재 (DANGER)";
                    if (seed % 3 === 0) {
                        title = `[공시] 전환사채(CB) 500억 규모 발행 결정... 주식 희석 우려`;
                    } else if (seed % 3 === 1) {
                        title = `[공시] 대표이사 횡령 배임설 조회 공시 요구 (확인 중)`;
                    } else {
                        title = `[공시] 3분기 잠정 실적, 시장 컨센서스 대비 30% 미달 예상`;
                    }
                }
            } else {
                // 등락폭이 작을 경우 중립적인 공시 생성
                badgeClass = "bg-slate-500 border-slate-700 text-slate-700 dark:text-slate-300 dark:border-slate-500";
                badgeText = "주요 공시";
                if (seed % 2 === 0) {
                    title = `[공시] ${data.name}, 정기 주주총회 소집 결의`;
                } else {
                    title = `[공시] 최대주주 주식담보대출 비율 변경 신고 (단순 공시)`;
                }
            }
            
            // 시간도 고정된 시각으로 처리 (14:30)
            time = "14:30";

            return { badgeClass, badgeText, title, time };
        }
        
        function renderMain(data) {
            currentSymbol = data.symbol;
            // ✅ [수정] 종목명 표시 (이전 오류 해결)
            document.getElementById('main-name').textContent = data.name; 
            document.getElementById('main-symbol').textContent = data.symbol;
            document.getElementById('main-price').textContent = formatNum(data.price);
            document.getElementById('main-price').className = `text-3xl font-bold dark:text-white ${getColor(data.change)}`;
            document.getElementById('main-change').textContent = `${data.change>0?'+':''}${formatNum(data.change)} (${formatNum(data.change_percent)}%)`;
            document.getElementById('main-change').className = `text-lg font-medium mb-1 ${getColor(data.change)}`;
            
            // 네이버 증권 링크 업데이트
            document.getElementById('link-naver').href = !isNaN(data.symbol) ? `https://finance.naver.com/item/main.naver?code=${data.symbol}` : `https://finance.yahoo.com/quote/${data.symbol}`;

            // ✅ DART 공시 검색 링크 업데이트 (종목코드 기반 검색)
            const stockName = ALL_MARKET_MAP_STOCKS['반도체(메모리/파운드리)'].find(s => s.code === currentSymbol)?.name || '';
            const dartQuery = `${stockName} ${currentSymbol}`;
            document.getElementById('link-dart').href = `https://dart.fss.or.kr/dsac001/mainK.do?textCrpNm=${dartQuery}&autoSearch=true`;

            // 시총 및 순위 정보 가져오기
            const stockDetails = getStockDetailsBySymbol(currentSymbol);

            // 시총 및 순위 정보 삽입
            document.getElementById('stock-meta-info').innerHTML = `
                <div class="flex gap-4 text-sm text-slate-500 dark:text-slate-400">
                    <div class="flex items-center gap-1">
                        <i class="fa-solid fa-coins text-yellow-500 text-xs"></i>
                        <span>시총: ${stockDetails.cap}</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <i class="fa-solid fa-trophy text-amber-500 text-xs"></i>
                        <span>순위: ${stockDetails.rank}</span>
                    </div>
                </div>
            `;
            
            // 주가 차트 다시 그리기 (캔들차트)
            drawStockChart(data.price, data.change_percent);

            updateFavoriteBtnState(); // 메인 종목 바뀔 때 즐겨찾기 별표 상태도 업데이트

            const newsBox = document.getElementById('content-news');
            
            // 1. ✅ [추가] 주요 공시 Mock 생성
            const majorDisclosure = getMajorDisclosure(data);
            const majorDisclosureHTML = `
                <a href="https://dart.fss.or.kr/" target="_blank" class="block p-4 rounded-lg major-disclosure-card border-2 ${majorDisclosure.badgeClass}"
                   title="실제 공시가 아닙니다. DART에서 확인하세요.">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-xs font-extrabold text-white px-2 py-0.5 rounded-full ${majorDisclosure.badgeClass.replace(/border-.*|text-.*/g, '').trim()}">
                            ${majorDisclosure.badgeText}
                        </span>
                        <span class="text-xs text-slate-400 font-normal ml-auto">${majorDisclosure.time}</span>
                    </div>
                    <div class="font-extrabold text-lg text-slate-900 dark:text-white leading-snug">
                        ${majorDisclosure.title}
                    </div>
                </a>
            `;

            // 2. 일반 Mock News Data 생성 및 등락률 반영
            const newsData = [
                { title: `[모의뉴스] ${data.name}의 ${formatNum(data.price)}원 ${data.change > 0 ? '돌파 임박!' : '하락 압력 경고'} (고정된 뉴스)`, publisher: '모의경제', link: '#' },
                { title: `[모의뉴스] ${data.name} ${data.change > 0 ? '외국인 순매수 지속' : '차익 실현 출회'} 분석 (고정된 뉴스)`, publisher: '모의뉴스24', link: '#' },
                { title: `[모의뉴스] ${data.name} 관련 ${data.change > 0 ? '호재성' : '리스크'} 보고서 발표 (고정된 뉴스)`, publisher: '가상투자일보', link: '#' },
            ];

            let regularNewsHTML = '';
            if(newsData.length) {
                regularNewsHTML = newsData.map(n => `
                    <a href="${n.link}" target="_blank" class="block p-3 bg-slate-50 rounded-lg hover:bg-slate-100 border border-slate-100 dark:bg-slate-700 dark:border-slate-600">
                        <div class="font-bold text-sm text-slate-800 dark:text-white truncate">${n.title}</div>
                        <div class="text-xs text-slate-400 mt-1">${n.publisher}</div>
                    </a>
                `).join('');
            }

            // 3. 주요 공시 + 일반 뉴스 합쳐서 렌더링
            newsBox.innerHTML = majorDisclosureHTML + regularNewsHTML;
            if (newsBox.innerHTML === '') {
                newsBox.innerHTML = '<div class="text-center py-4 text-xs text-slate-400">뉴스가 없습니다.</div>';
            }
        }

        // === [수정] Mock Data 생성 헬퍼 함수: 고정된 '어제 종가' 데이터를 반환합니다. ===
        function getMockData(symbol, name = '') {
            let basePrice = 1000; // 기준 가격 (어제 종가)
            let fixedChangePercent = 0; // 어제 대비 등락률 (고정값)
            const fixedChangeFactor = 1.0; // 랜덤 대신 사용할 고정 변동 요소

            // 1. 주요 지표에 대한 고정값 설정
            if (symbol === '^KS11') { basePrice = 2700; fixedChangePercent = 0.5; }
            else if (symbol === '^KQ11') { basePrice = 880; fixedChangePercent = 1.2; }
            else if (symbol === 'NQ=F') { basePrice = 18500; fixedChangePercent = -0.8; }
            else if (symbol === 'KRW=X') { basePrice = 1350; fixedChangePercent = -0.1; }
            else if (symbol === 'BTC-KRW') { basePrice = 95000000; fixedChangePercent = 3.5; }
            else if (symbol === 'XAG=X') { basePrice = 24.50; fixedChangePercent = 0.7; }
            // 환율 Mock Data 제공 (계산기 로직 유지를 위함)
            else if(symbol === 'EUR=X') { basePrice = 1450; fixedChangePercent = 0.0; } 
            else if(symbol === 'JPY=X') { basePrice = 950; fixedChangePercent = -0.5; } // 100엔당

            // 2. 시장 지도 종목의 경우 ALL_MARKET_MAP_STOCKS의 고정된 price와 change를 사용
            let stock = null;
            for (const sector in ALL_MARKET_MAP_STOCKS) {
                const found = ALL_MARKET_MAP_STOCKS[sector].find(s => s.code === symbol);
                if (found) {
                    stock = found;
                    // Mock Stock List에 있는 등락률을 고정값으로 사용하고, price를 오늘 가격으로 간주
                    fixedChangePercent = stock.change; 
                    // basePrice는 (오늘 가격) / (1 + 등락률) 로 역산하여 어제 종가처럼 보이게 함
                    basePrice = stock.price / (1 + fixedChangePercent / 100); 
                    break;
                }
                // Mock Stock이 없는 경우에도 기본값을 사용하도록 함
            }

            // 고정된 오늘 가격 계산
            const price = stock ? stock.price : (basePrice * (1 + fixedChangePercent / 100));
            const change = price - basePrice;
            
            // 종목 이름은 Mock Stocks에서 가져와서 Mock Data에 포함합니다.
            let stockName = stock ? stock.name : (name || symbol);

            return {
                symbol: symbol,
                name: stockName,
                price: price,
                change: change,
                change_percent: fixedChangePercent,
                news: [],
                dart_url: null,
                is_mock: true
            };
        }
        function mockStock(sym) { return getMockData(sym); }

        // === 수동 새로고침 기능 ===
        function manualRefresh() {
            const refreshButton = document.getElementById('btn-refresh');
            const refreshIcon = refreshButton.querySelector('i');

            // 버튼 비활성화 및 스피너 시작
            refreshButton.disabled = true;
            refreshIcon.className = 'fa-solid fa-spinner fa-spin text-blue-600';
            refreshIcon.classList.remove('text-slate-500');

            // 데이터 갱신 시작 (고정된 데이터가 다시 로드됨)
            fetchMarketData();

            // 1초 후 스피너 멈춤 및 버튼 재활성화 
            setTimeout(() => {
                refreshButton.disabled = false;
                refreshIcon.className = 'fa-solid fa-arrows-rotate';
                refreshIcon.classList.remove('fa-spin');
                refreshIcon.classList.remove('text-blue-600');
                refreshIcon.classList.add('text-slate-500');
            }, 1000); 
        }

        // === 초기화 ===
        function init() {
            initDarkMode();
            
            // 1. 지표 카드 생성
            const idxBox = document.getElementById('indices-container');
            idxBox.innerHTML = INDICES.map(i => `
                <a href="${i.link}" target="_blank" class="card-hover bg-white p-3 rounded-xl border border-slate-200 dark:bg-slate-800 dark:border-slate-700 block">
                    <div class="text-xs text-slate-500 mb-1 dark:text-slate-400">${i.name}</div>
                    <div class="font-bold text-sm dark:text-white" id="idx-p-${i.id}">-</div>
                    <div class="text-xs font-medium mt-1 index-change" id="change-${i.id}">-</div>
                </a>
            `).join('');

            // 2. 마켓 맵 렌더링 (초기: KOSDAQ Top 60)
            renderMarketMap('KOSDAQ_TOP_60');

            // 초기 로드
            fetchAllData(); 
            
            // ✅ [제거] 자동 갱신 기능을 제거합니다. (3분 자동 갱신 제거)
            // setInterval(fetchMarketData, 180000); 
        }
        
        init();
    </script>
</body>
</html>