<!DOCTYPE html>
<html lang="ko" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Map Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        
        /* ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; } /* slate-400 */
        .dark ::-webkit-scrollbar-thumb { background: #475569; } /* slate-600 */
        
        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tab-btn { border-bottom: 3px solid transparent; color: #64748b; transition: all 0.2s; }
        .tab-btn.active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: 700; }
        .dark .tab-btn.active { border-bottom: 3px solid #60a5fa; color: #60a5fa; }

        /* ë² ìŠ¤íŠ¸ê¸€ ê°•ì¡° íš¨ê³¼ (ê¸°ëŠ¥ ì‚­ì œë¡œ ë¶ˆí•„ìš”í•˜ì§€ë§Œ ìŠ¤íƒ€ì¼ ìœ ì§€) */
        .best-post-card { 
            background: linear-gradient(to right, #fee2e2, #fff); 
            border-left: 4px solid #ef4444; 
            transition: all 0.2s;
        }
        .dark .best-post-card { 
            background: linear-gradient(to right, #450a0a, #1e293b); 
            border-left: 4px solid #f87171; 
        }
        
        /* ì‹œì¥ ì‹¬ë„ í‘œì‹œë¥¼ ìœ„í•œ í´ë˜ìŠ¤ */
        .breadth-bar-container { height: 16px; background-color: #3b82f6; } 
        .breadth-bar-red { background-color: #ef4444; } 
        
        /* ìº”ë²„ìŠ¤ ê¸°ë³¸ ìŠ¤íƒ€ì¼ (ë°˜ì‘í˜• ì„¤ì •) */
        #stock-chart-canvas {
            width: 100%;
            height: 150px;
            display: block;
        }

        /* ğŸ¥‡ğŸ¥ˆğŸ¥‰ ìˆœìœ„ ìŠ¤í‹°ì»¤ ì• ë‹ˆë©”ì´ì…˜ ë° ìƒ‰ìƒ ê°•í™” */
        .rank-pop {
            animation: rankPop 1.5s infinite;
            background: linear-gradient(135deg, #fef2f2, #ef4444);
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
        }
        @keyframes rankPop {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { 
                transform: scale(1.1); 
                box-shadow: 0 0 10px 3px rgba(239, 68, 68, 0.9);
            }
        }
        
        /* â­ 3D Tilt íš¨ê³¼ ë° ê·¸ë¦¼ì ê°•í™” */
        .treemap-card-3d {
            transition: transform 0.1s ease-out, box-shadow 0.1s ease-out; 
            transform-style: preserve-3d; 
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15); /* ê¸°ë³¸ ê·¸ë¦¼ì ê°•í™” */
            /* ì¹´ë“œê°€ ë™ì ìœ¼ë¡œ í¬ê¸° ì¡°ì ˆë˜ë¯€ë¡œ h-fullì„ ì“°ì§€ ì•Šê³  ë‚´ë¶€ ì»¨í…ì¸ ë¡œ ë†’ì´ ì¡°ì ˆ */
            height: 100%; 
        }
        .dark .treemap-card-3d {
             box-shadow: 0 6px 15px rgba(255, 255, 255, 0.08);
        }
        
        /* 5. ì„¹í„°ë³„ ê²½ê³„ì„  ìƒ‰ìƒ í´ë˜ìŠ¤ */
        .border-sector-red { border-color: #ef4444; }
        .border-sector-blue { border-color: #3b82f6; }
        .border-sector-green { border-color: #10b981; }
        .border-sector-purple { border-color: #8b5cf6; }
        .border-sector-amber { border-color: #f59e0b; }
        .border-sector-orange { border-color: #f97316; }
        .border-sector-indigo { border-color: #6366f1; }
        .border-sector-lime { border-color: #84cc16; }
        .border-sector-cyan { border-color: #06b6d4; }
        .border-sector-pink { border-color: #ec4899; }
        .border-sector-teal { border-color: #14b8a6; }
        .border-sector-violet { border-color: #7c3aed; } /* New color for new sectors */
        .border-sector-fuchsia { border-color: #d946ef; } /* New color for new sectors */
        
        /* ìƒìŠ¹/í•˜ë½ì— ë”°ë¥¸ íŠ¸ë ˆë§µ ì¹´ë“œ ë°°ê²½ ê°•ì¡° (ë¯¸ì„¸í•œ ê·¸ë¼ë°ì´ì…˜) */
        .bg-gradient-positive { background: linear-gradient(135deg, #fef2f2 5%, #fff 50%); }
        .bg-gradient-negative { background: linear-gradient(135deg, #eff6ff 5%, #fff 50%); }
        .dark .bg-gradient-positive { background: linear-gradient(135deg, #450a0a 5%, #1e293b 50%); }
        .dark .bg-gradient-negative { background: linear-gradient(135deg, #1e3a8a 5%, #1e293b 50%); }
        
        /* Proportional Layoutì˜ ìŠ¤í¬ë¡¤ ì²˜ë¦¬ */
        .proportional-basket-stocks {
            /* max-height: none; ì œê±° */
            /* overflow-y: visible; ì œê±° */
        }
        
        /* Dynamic Treemap Style */
        /* âœ… ìˆ˜ì •: íŠ¸ë ˆë§µ ë°”êµ¬ë‹ˆì˜ ìµœì†Œ ë†’ì´ë¥¼ ìœ ì§€í•˜ê³ , ë‚´ë¶€ ì¹´ë“œê°€ ê· ì¼í•œ í¬ê¸°ë¥¼ ê°–ë„ë¡ flex-growë¥¼ ì œê±° */
        .treemap-basket {
            min-height: 120px; 
            transition: all 0.3s ease-out; 
            /* height: 100%; ì‚­ì œ: ë‚´ë¶€ ì½˜í…ì¸ ì— ë”°ë¼ ë†’ì´ê°€ ìœ ë™ì ìœ¼ë¡œ ê²°ì •ë˜ì–´ì•¼ í•¨ */
        }

        /* ğŸ’¡ ìˆ˜ì •: ì¢…ëª© ì¹´ë“œ ê°€ë…ì„± í–¥ìƒì„ ìœ„í•œ ìŠ¤íƒ€ì¼ (Treemap View) */
        .stock-card-content {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
        }
        .stock-card-price {
            font-size: 1.5rem; /* 2xl */
            font-weight: 800; /* extabold */
        }
        .stock-card-change {
            font-size: 0.8rem; /* sm */
            font-weight: 700; /* bold */
        }
        .stock-card-cap {
            font-size: 0.65rem; /* text-xsë³´ë‹¤ ì‘ê²Œ */
            color: #94a3b8; /* slate-400 */
        }
        
    </style>
</head>
<body class="bg-slate-50 text-slate-800 transition-colors duration-200 dark:bg-slate-900 dark:text-slate-100">

    <!-- ìƒë‹¨ í—¤ë” -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50 dark:bg-slate-800 dark:border-slate-700">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-chart-line text-blue-600 text-xl dark:text-blue-400"></i>
                <h1 class="font-bold text-xl tracking-tight">Market Dashboard</h1>
                <!-- ìƒíƒœ ë°°ì§€ ì—…ë°ì´íŠ¸: ëª¨ì˜ ì‹œì„¸ + ê²€ìƒ‰ ê¸°ë°˜ ë‰´ìŠ¤ ì œê³µ -->
                <span id="status-badge" class="flex items-center gap-1 text-xs font-bold bg-amber-500 text-white px-2 py-0.5 rounded-full shadow-md">
                    <i class="fa-solid fa-circle text-[6px]"></i> SIMULATED (Grounded News)
                </span>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ -->
                <button onclick="manualRefresh()" id="btn-refresh" 
                        class="p-2 text-slate-500 hover:text-blue-600 dark:text-slate-400 dark:hover:text-blue-400 transition-colors"
                        title="ìˆ˜ë™ìœ¼ë¡œ ì‹œì„¸ ê°±ì‹ ">
                    <i class="fa-solid fa-arrows-rotate"></i>
                </button>
                <button onclick="toggleDarkMode()" class="p-2"><i id="theme-icon" class="fa-solid fa-moon"></i></button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6 space-y-8">
        
        <!-- 1. ì£¼ìš” ì§€í‘œ ì¹´ë“œ ì„¹ì…˜: ê·¸ë¦¼ìì™€ í˜¸ë²„ íš¨ê³¼ ê°•í™” -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
            <!-- ì§€í‘œ ì¹´ë“œë“¤ì€ JSë¡œ ë¡œë“œë©ë‹ˆë‹¤. -->
            <div id="indices-container" class="contents"></div>
        </div>

        <!-- 2. 2ë‹¨ ë ˆì´ì•„ì›ƒ: Market Map (ì¢Œ) vs Detail Panel (ìš°) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- ì˜¤ë¥¸ìª½: ìƒì„¸ ì •ë³´ ë° ë„êµ¬ íŒ¨ë„ (1/3 ì°¨ì§€) -->
            <div class="lg:col-span-1 space-y-6 order-1 lg:order-2">
                
                <!-- 1. ì¢…ëª© ìƒì„¸ ì •ë³´ (ê²€ìƒ‰ + íƒ­) -->
                <div class="bg-white rounded-2xl border border-slate-200 shadow-xl overflow-hidden dark:bg-slate-800 dark:border-slate-700">
                    
                    <!-- ê²€ìƒ‰ ë° ê°€ê²© í—¤ë” -->
                    <div class="p-5 pb-3 border-b border-slate-100 dark:border-slate-700">
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="symbol-input" value="005930" placeholder="ì¢…ëª©ì½”ë“œ (ì˜ˆ: 005930)"
                                class="bg-slate-50 border border-slate-200 text-sm rounded-xl block w-full p-2.5 dark:bg-slate-700 dark:border-slate-600 dark:text-white" 
                                onkeypress="if(event.key==='Enter') fetchAllData()">
                            <button onclick="fetchAllData()" class="bg-blue-600 text-white rounded-xl px-4 py-2 text-sm font-bold whitespace-nowrap hover:bg-blue-700 transition-colors">ì¡°íšŒ</button>
                        </div>

                        <!-- ğŸ’¡ ìˆ˜ì •: API Key ì…ë ¥ í•„ë“œ ë³µì› ë° ì•ˆë‚´ UI ë³€ê²½ -->
                        <div id="api-key-info" class="mb-4 p-4 rounded-xl border border-red-400 bg-red-50 dark:bg-red-900/20 shadow-md">
                            <p class="text-xs text-red-700 dark:text-red-300 font-extrabold flex items-center gap-2 mb-1">
                                <i class="fa-solid fa-key text-base"></i> Gemini API í‚¤ ì…ë ¥ (ë‰´ìŠ¤ ê²€ìƒ‰ í™œì„±í™”)
                            </p>
                            <input type="password" id="gemini-api-key-input" placeholder="ì—¬ê¸°ì— Gemini API Keyë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."
                                class="w-full mt-2 p-2 bg-white border border-red-300 text-sm rounded-lg block dark:bg-slate-700 dark:border-red-500 dark:text-white"
                                onchange="saveApiKey()">
                            <p class="text-[11px] text-slate-600 dark:text-slate-400 leading-tight mt-1">
                                API í‚¤ëŠ” **1ì‹œê°„ ë™ì•ˆë§Œ** ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ë©°, Google Search ê¸°ë°˜ì˜ ì‹¤ì‹œê°„ ë‰´ìŠ¤ ê²€ìƒ‰ ë° ìš”ì•½ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                        </div>
                        
                        <!-- ê°€ê²© ë° ì¦ê²¨ì°¾ê¸° -->
                        <div class="flex justify-between items-start">
                            <div>
                                <!-- ì¢…ëª©ëª… í‘œì‹œ -->
                                <h3 id="main-name" class="text-2xl font-extrabold mb-1 dark:text-white leading-snug">Loading Name...</h3> 
                                <div class="flex items-center gap-2 mb-1">
                                    <h2 class="text-4xl font-extrabold" id="main-price">-</h2>
                                    <button onclick="toggleFavorite()" id="btn-favorite" class="text-slate-300 hover:text-yellow-400 transition-colors text-3xl" title="ê´€ì‹¬ ì¢…ëª© ì¶”ê°€/ì‚­ì œ">
                                        <i class="fa-solid fa-star"></i>
                                    </button>
                                </div>
                                <div class="flex items-end gap-2">
                                    <div class="text-lg font-bold" id="main-change">-</div>
                                    <div class="text-sm text-slate-400 mb-1" id="main-symbol">Loading...</div>
                                
                                </div>
                                
                                <!-- ì‹œì´ ë° ìˆœìœ„ ì •ë³´ (ê°œì„ ëœ ë ˆì´ì•„ì›ƒ) -->
                                <div id="stock-meta-info" class="mt-3 bg-slate-50 dark:bg-slate-700/50 p-2 rounded-lg text-xs">
                                    <!-- JSì— ì˜í•´ ì±„ì›Œì§ (ì‹œì´, ìˆœìœ„ ì •ë³´) -->
                                </div>
                            </div>
                            
                            <!-- ë§í¬ ë²„íŠ¼ ê·¸ë£¹ (ì„¸ë¡œ ë°°ì—´) -->
                            <div class="flex flex-col gap-2 pt-1">
                                <a id="link-naver" href="#" target="_blank" class="px-3 py-2 bg-[#03C75A] text-white rounded-xl text-xs font-bold text-center hover:bg-green-600 transition-colors">ë„¤ì´ë²„ ì¦ê¶Œ</a>
                                <!-- DART ë§í¬ í…ìŠ¤íŠ¸ë¥¼ "DART ê³µì‹œ ê²€ìƒ‰ (ì½”ë“œ)"ë¡œ ë³€ê²½í•˜ê³ , URL ì¿¼ë¦¬ë¥¼ ì¢…ëª©ì½”ë“œë¡œ ë³€ê²½í•©ë‹ˆë‹¤. -->
                                <a id="link-dart" href="#" target="_blank" class="px-3 py-2 bg-indigo-600 text-white rounded-xl text-xs font-bold text-center hover:bg-indigo-700 transition-colors">DART ê³µì‹œ ê²€ìƒ‰ (ì½”ë“œ)</a>
                                <a id="link-kind" href="https://kind.krx.co.kr/main.do?method=loadInitPage&scrnmode=1" target="_blank" class="px-3 py-2 bg-purple-600 text-white rounded-xl text-xs font-bold text-center hover:bg-purple-700 transition-colors">KIND ê³µì‹œ ê²€ìƒ‰</a>
                                <!-- SEIBRO ë²„íŠ¼ ì¶”ê°€ -->
                                <a id="link-seibro" href="https://seibro.or.kr/websquare/control.jsp?w2xPath=/IPORTAL/user/index.xml" target="_blank" class="px-3 py-2 bg-sky-600 text-white rounded-xl text-xs font-bold text-center hover:bg-sky-700 transition-colors">SEIBRO ê²€ìƒ‰</a>
                            </div>
                        </div>
                        <!-- ë°ì´í„° ì†ŒìŠ¤ ì£¼ì˜ ë¬¸êµ¬ ì¶”ê°€ -->
                        <p class="text-xs text-red-500/80 mt-4 pt-2 border-t border-slate-100 dark:border-slate-700">
                             âš ï¸ **ì£¼ì˜:** ìƒê¸° ì£¼ê°€ ì‹œì„¸ëŠ” ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„°ì´ë©°, ì‹¤ì œ íˆ¬ìì— ì‚¬ìš©ë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‰´ìŠ¤ëŠ” ì›¹ ê²€ìƒ‰ ê²°ê³¼ì— ê·¼ê±°í•©ë‹ˆë‹¤.
                        </p>
                    </div>
                    
                    <div class="p-5 pt-0">
                        <!-- ìº”ë“¤ì°¨íŠ¸ ìº”ë²„ìŠ¤ -->
                        <div class="relative mb-5 p-3 rounded-xl bg-slate-50 dark:bg-slate-700/50 shadow-inner mt-4">
                            <canvas id="stock-chart-canvas"></canvas>
                            <div id="chart-loading" class="absolute inset-0 flex items-center justify-center text-slate-400 text-sm bg-slate-50/80 dark:bg-slate-700/80 rounded-xl">
                                ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                            </div>
                        </div>

                        <!-- ğŸ’¡ ìˆ˜ì •: íƒ­ ë©”ë‰´ì—ì„œ 'í† ë¡ ë°©' íƒ­ ì œê±° ë° 'ë‰´ìŠ¤' íƒ­ ê³ ì • í™œì„±í™” -->
                        <div class="flex border-b border-slate-200 dark:border-slate-700 mb-4">
                            <button onclick="switchTab('news')" id="tab-news" 
                                    class="tab-btn active w-full py-3 text-sm font-medium border-b-2 border-blue-600 dark:border-blue-400"
                                    style="border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: 700;">
                                <i class="fa-regular fa-newspaper mr-1"></i> ë‰´ìŠ¤/ê³µì‹œ (ê²€ìƒ‰ ê¸°ë°˜)
                            </button>
                        </div>
                    </div>

                    <!-- íƒ­ ì½˜í…ì¸  ì˜ì—­ -->
                    <div class="px-5 pb-5 min-h-[300px] max-h-[500px] overflow-y-auto">
                        
                        <!-- 1. ë‰´ìŠ¤ íƒ­ -->
                        <div id="content-news" class="space-y-3">
                            <div class="text-center text-slate-400 py-10">ì‹¤ì œ ì›¹ ê¸°ë°˜ ë‰´ìŠ¤ë¥¼ ê²€ìƒ‰ ì¤‘...</div>
                        </div>

                        <!-- ğŸ’¡ ìˆ˜ì •: ì»¤ë®¤ë‹ˆí‹° íƒ­ (BEST ê¸°ëŠ¥) ì½˜í…ì¸  ì˜ì—­ ì‚­ì œ -->
                        
                    </div>
                </div>

                <!-- 4. ë‚˜ì˜ ê´€ì‹¬ ì¢…ëª© ìœ„ì ¯: ê²½ê³„ì„ ê³¼ ë°°ê²½ìƒ‰ ê°•ì¡° -->
                <div class="bg-white rounded-2xl border-2 border-yellow-300 dark:border-yellow-700 shadow-lg dark:bg-slate-800 overflow-hidden">
                    <div class="p-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-yellow-50 dark:bg-yellow-900/50">
                        <h3 class="font-bold text-slate-800 dark:text-slate-200 flex items-center gap-2">
                            <i class="fa-solid fa-star text-yellow-500"></i> ë‚˜ì˜ ê´€ì‹¬ ì¢…ëª©
                        </h3>
                    </div>
                    <!-- ì˜¤ë¥˜ í•´ê²°ì„ ìœ„í•´ ID ì¶”ê°€ -->
                    <div id="watchlist-container" class="divide-y divide-slate-100 dark:divide-slate-700 max-h-[300px] overflow-y-auto">
                        <div class="p-4 text-center text-xs text-slate-400">â˜… ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¢…ëª©ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</div>
                    </div>
                </div>

                <!-- 2. í™˜ìœ¨ ê³„ì‚°ê¸° ìœ„ì ¯: ê²½ê³„ì„ ê³¼ ë°°ê²½ìƒ‰ ê°•ì¡° -->
                <div class="bg-white p-5 rounded-2xl border-2 border-blue-300 dark:border-blue-700 shadow-lg dark:bg-slate-800">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2 dark:text-slate-200">
                        <i class="fa-solid fa-calculator text-blue-500"></i> í™˜ìœ¨ ê³„ì‚°ê¸°
                    </h3 >
                    
                    <!-- í†µí™” ì„ íƒ ë“œë¡­ë‹¤ìš´ ë° ë™ì  ì…ë ¥/ì¶œë ¥ í•„ë“œ - EUR, JPY ìœ ì§€ -->
                    <div class="space-y-4">
                        <!-- ì™¸í™” ì…ë ¥ í•„ë“œ -->
                        <div class="flex items-center gap-2">
                            <select id="calc-currency-select" onchange="updateCurrencyRate(); calculateExchange()"
                                    class="w-24 p-2.5 bg-slate-50 border border-slate-300 rounded-xl text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white font-bold cursor-pointer">
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="JPY">JPY</option>
                            </select>
                            <input type="number" id="calc-input-foreign" placeholder="100" oninput="calculateExchange()"
                                class="flex-1 p-3 bg-slate-50 border border-slate-300 rounded-xl text-right font-mono text-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        </div>
                        <!-- KRW ì¶œë ¥ í•„ë“œ -->
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-bold text-slate-600 dark:text-slate-400 w-24 text-center">KRW (ì›)</span>
                            <input type="text" id="calc-input-krw" readonly 
                                class="flex-1 p-3 bg-blue-50 border border-blue-200 rounded-xl text-right font-mono font-extrabold text-lg text-blue-800 dark:bg-blue-900/30 dark:border-blue-700 dark:text-blue-300" value="-">
                        </div>
                        <!-- í˜„ì¬ í™˜ìœ¨ í‘œì‹œ -->
                        <div class="text-right text-xs text-slate-500 dark:text-slate-400 pt-1 border-t border-slate-100 dark:border-slate-700">
                            í˜„ì¬ í™˜ìœ¨: <span id="current-rate" class="font-bold">-</span>ì›/<span id="current-currency-unit">USD</span>
                        </div>
                    </div>

                </div>

                <!-- 3. ì¢…ëª© í‰ë‹¨ê°€ ê³„ì‚°ê¸° ìœ„ì ¯ (ìˆ˜ì •: ëª…ì¹­ ë³€ê²½ ë° ë™ì  í–‰ ì§€ì›) -->
                <div class="bg-white p-5 rounded-2xl border-2 border-green-300 dark:border-green-700 shadow-lg dark:bg-slate-800">
                    <!-- ğŸ’¡ ìˆ˜ì •: ìœ„ì ¯ ì œëª© ë³€ê²½ -->
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2 dark:text-slate-200">
                        <i class="fa-solid fa-calculator text-green-500"></i> ì¢…ëª© í‰ê·  ê±°ë˜ ë‹¨ê°€ ê³„ì‚°ê¸°
                    </h3 >
                    
                    <div id="average-calculator-inputs" class="space-y-3">
                        <!-- ë™ì ìœ¼ë¡œ ê±°ë˜ í–‰ì´ ì±„ì›Œì§‘ë‹ˆë‹¤ (initAverageCalculatorì—ì„œ ì´ˆê¸°í™”) -->
                    </div>

                    <!-- ğŸ’¡ ìˆ˜ì •: ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½ -->
                    <button onclick="addPurchaseRow()" class="mt-3 w-full flex items-center justify-center p-2 text-sm font-bold text-green-600 bg-green-50 hover:bg-green-100 rounded-lg border border-green-200 transition-colors dark:bg-green-900/20 dark:hover:bg-green-900/40 dark:text-green-300">
                        <i class="fa-solid fa-plus mr-2"></i> ê±°ë˜ ê¸°ë¡ ì¶”ê°€
                    </button>
                    
                    <!-- ğŸ’¡ ìˆ˜ì •: ê²°ê³¼ ë¼ë²¨ ë³€ê²½ -->
                    <div class="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-bold text-slate-600 dark:text-slate-400">ì´ ê±°ë˜ ê¸ˆì•¡:</span>
                            <span id="total-cost" class="font-mono font-bold text-lg text-slate-800 dark:text-white">-</span>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-sm font-bold text-slate-600 dark:text-slate-400">ì´ ìˆ˜ëŸ‰/ì”ê³ :</span>
                            <span id="total-qty" class="font-mono font-bold text-lg text-slate-800 dark:text-white">-</span>
                        </div>
                        
                        <div class="flex justify-between items-center mt-3 p-3 rounded-lg bg-green-50 border border-green-200 dark:bg-green-900/30 dark:border-green-700">
                            <span class="text-base font-extrabold text-green-800 dark:text-green-300">í‰ê·  ê±°ë˜ ë‹¨ê°€:</span>
                            <span id="average-price" class="font-mono text-xl font-extrabold text-green-800 dark:text-green-300">-</span>
                        </div>
                    </div>
                </div>

            </div>

            <!-- ì™¼ìª½: ì‹œì¥ ì§€ë„ (Market Map, 2/3 ì°¨ì§€) -->
            <div class="lg:col-span-2 space-y-6 order-2 lg:order-1">
                
                <!-- Market Map ì»¨íŠ¸ë¡¤ íŒ¨ë„: í•„í„°, ì •ë ¬, ì‹¬ë„ í‘œì‹œ í†µí•© -->
                <div class="bg-white p-4 rounded-xl shadow-lg border border-slate-200 dark:bg-slate-800 dark:border-slate-700 space-y-4">
                    <h2 class="text-xl font-bold flex items-center gap-2 text-slate-700 dark:text-slate-300">
                        <i class="fa-solid fa-earth-americas text-blue-600"></i> ì‹œì¥ ì§€ë„ ë¶„ì„ (Market Map)
                    </h3 >
                    
                    <!-- í•„í„° ë° ì •ë ¬ -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        
                        <!-- ì‹œì¥ í•„í„° ë²„íŠ¼ ê·¸ë£¹ -->
                        <div class="flex gap-2 text-sm">
                            <button id="filter-all" onclick="renderMarketMap('ALL', currentSortBy)" class="px-3 py-1.5 rounded-xl text-xs font-medium border border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">ì „ì²´ëª¨ë“œ</button>
                            <button id="filter-kospi_top_60" onclick="renderMarketMap('KOSPI_TOP_60', currentSortBy)" class="px-3 py-1.5 rounded-xl text-xs font-medium border border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors">KOSPI Top 50</button>
                            <button id="filter-kosdaq_top_60" onclick="renderMarketMap('KOSDAQ_TOP_60', currentSortBy)" class="px-3 py-1.5 rounded-xl text-xs font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors">KOSDAQ Top 60</button>
                        </div>
                        
                        <!-- ë³´ê¸° ë°©ë²• ì„ íƒ ë“œë¡­ë‹¤ìš´ -->
                        <div class="flex items-center gap-2">
                            <label for="sort-by-select" class="text-sm font-medium text-slate-500 dark:text-slate-400 whitespace-nowrap">ë³´ê¸°:</label>
                            <select id="sort-by-select" onchange="renderMarketMap(currentFilterMode, this.value)"
                                    class="p-2 text-sm bg-slate-50 border border-slate-300 rounded-xl dark:bg-slate-700 dark:border-slate-600 cursor-pointer focus:ring-blue-500 focus:border-blue-500">
                                <option value="cap">ì‹œê°€ì´ì•¡ ì§€ë„</option>
                                <option value="sector_list">ì—…ì¢…ë³„ ëª©ë¡</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- ì‹œì¥ ì‹¬ë„ (Market Breadth) Indicator -->
                    <div id="market-breadth-indicator" class="pt-2 border-t border-slate-100 dark:border-slate-700">
                        <div class="flex justify-between items-center text-xs font-medium mb-1 text-slate-500 dark:text-slate-400">
                            <span class="flex items-center gap-1 text-blue-500"><i class="fa-solid fa-chart-line"></i> í•˜ë½/ìœ ì§€ ì¢…ëª© ìˆ˜</span>
                            <span class="text-xs font-bold text-slate-700 dark:text-slate-300">ì‹œì¥ ì‹¬ë„ í˜„í™© (ìƒìŠ¹ vs í•˜ë½)</span>
                            <span class="flex items-center gap-1 text-red-500"><i class="fa-solid fa-chart-line"></i> ìƒìŠ¹ ì¢…ëª© ìˆ˜</span>
                        </div>
                        <div class="breadth-bar-container rounded-lg overflow-hidden relative shadow-inner">
                            <div id="breadth-up-bar" class="h-full breadth-bar-red transition-all duration-500" style="width: 50%;"></div>
                            <div class="absolute inset-y-0 left-1/2 w-px bg-slate-400 dark:bg-slate-500 opacity-50"></div>
                        </div>
                        <div class="flex justify-between text-xs mt-1 text-slate-600 dark:text-slate-400 font-bold">
                            <span id="breadth-down-count" class="text-blue-500">-</span>
                            <span id="breadth-up-count" class="text-red-500">-</span>
                        </div>
                    </div>
                </div>

                <!-- ì„¹í„°ë³„ ì¢…ëª© ê·¸ë£¹ ì»¨í…Œì´ë„ˆ -->
                <div id="market-map-container" class="space-y-6">
                    <div class="text-center py-10 text-slate-400">ì‹œì´ ìˆœìœ¼ë¡œ ì¢…ëª©ë“¤ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // === ì„¤ì • ===
        // ì£¼ìš” ì§€í‘œ 6ê°œë§Œ í‘œì‹œ (EUR/JPY ì œì™¸)
        const INDICES = [
            { id: '^KS11', name: 'KOSPI', link: 'https://finance.naver.com/sise/sise_index.nhn?code=KOSPI' },
            { id: '^KQ11', name: 'KOSDAQ', link: 'https://finance.naver.com/sise/sise_index.nhn?code=KOSDAQ' },
            { id: 'NQ=F', name: 'NASDAQ ì„ ë¬¼', link: 'https://kr.investing.com/indices/nq-100-futures' }, 
            { id: 'KRW=X', name: 'USD/KRW', link: 'https://finance.naver.com/marketindex/exchangeDetail.naver?marketindexCd=FX_USDKRW' },
            { id: 'BTC-KRW', name: 'Bitcoin', link: 'https://kr.investing.com/crypto/bitcoin/btc-krw' },
            // Silver ë§í¬ë¥¼ í˜„ë¬¼ ì‹œì„¸ (XAG/USD) í˜ì´ì§€ë¡œ ìˆ˜ì •
            { id: 'XAG=X', name: 'Silver', link: 'https://kr.investing.com/currencies/xag-usd' } 
        ];

        let currentRates = {
            USD: { rate: 1350.00, link: 'https://finance.naver.com/marketindex/exchangeDetail.naver?marketindexCd=FX_USDKRW', unit: 1 },
            EUR: { rate: 1450.00, link: 'https://finance.naver.com/marketindex/exchangeDetail.naver?marketindexCd=FX_EURKRW', unit: 1 },
            JPY: { rate: 9.50, link: 'https://finance.naver.com/marketindex/exchangeDetail.naver?marketindexCd=FX_JPYKRW', unit: 100 } 
        };
        let selectedCurrency = 'USD'; 
        
        let currentFilterMode = 'KOSDAQ_TOP_60'; 
        let currentSortBy = 'cap'; 

        // Market Mapì— í‘œì‹œí•  ì¢…ëª© ëª©ë¡ (ì‹œê°€ì´ì•¡ ë° ì„¹í„° ì •ë³´ í¬í•¨)
        const ALL_MARKET_MAP_STOCKS = {
            // --- KOSPI (Cap Total Sorting) ---
            'ë°˜ë„ì²´ ëŒ€í˜•ì£¼/IDM': [ 
                { code: '005930', name: 'ì‚¼ì„±ì „ì', change: 3.14, price: 108400, market: 'KOSPI', cap: 6416888, rank: 1 },
                { code: '000660', name: 'SKí•˜ì´ë‹‰ìŠ¤', change: 0.37, price: 544000, market: 'KOSPI', cap: 3960333, rank: 2 },
                { code: '005935', name: 'ì‚¼ì„±ì „ììš°', change: 1.39, price: 80100, market: 'KOSPI', cap: 653596, rank: 5 },
            ],
            '2ì°¨ì „ì§€ ì…€/í•µì‹¬ì†Œì¬(KOSPI)': [ 
                { code: '373220', name: 'LGì—ë„ˆì§€ì†”ë£¨ì…˜', change: 3.90, price: 426000, market: 'KOSPI', cap: 996840, rank: 3 },
                { code: '006400', name: 'ì‚¼ì„±SDI', change: 1.65, price: 307500, market: 'KOSPI', cap: 247800, rank: 28 },
                { code: '051910', name: 'LGí™”í•™', change: 1.46, price: 381500, market: 'KOSPI', cap: 269310, rank: 24 },
                { code: '008650', name: 'í¬ìŠ¤ì½”í“¨ì²˜ì— ', change: 0.73, price: 206000, market: 'KOSPI', cap: 183229, rank: 39 },
                { code: '096770', name: 'SKì´ë…¸ë² ì´ì…˜', change: 1.78, price: 114600, market: 'KOSPI', cap: 193734, rank: 36 },
            ],
            'ì œì•½/ë°”ì´ì˜¤ ëŒ€í˜•': [ 
                { code: '207940', name: 'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤', change: -2.32, price: 1641000, market: 'KOSPI', cap: 759634, rank: 4 },
                { code: '068270', name: 'ì…€íŠ¸ë¦¬ì˜¨', change: 0.38, price: 183300, market: 'KOSPI', cap: 423351, rank: 12 },
            ],
            'ì™„ì„±ì°¨ ë° ëŒ€í˜•ë¶€í’ˆ': [ 
                { code: '005380', name: 'í˜„ëŒ€ì°¨', change: 11.11, price: 315000, market: 'KOSPI', cap: 644987, rank: 6 },
                { code: '000270', name: 'ê¸°ì•„', change: 2.74, price: 123600, market: 'KOSPI', cap: 482550, rank: 9 },
                { code: '012330', name: 'í˜„ëŒ€ëª¨ë¹„ìŠ¤', change: 4.32, price: 362500, market: 'KOSPI', cap: 328906, rank: 19 },
            ],
            'ì¡°ì„ /ë°©ì‚°/ì¤‘ê³µì—…': [ 
                { code: '034020', name: 'ë‘ì‚°ì—ë„ˆë¹Œë¦¬í‹°', change: 1.52, price: 80400, market: 'KOSPI', cap: 515011, rank: 7 },
                { code: '329180', name: 'HDí˜„ëŒ€ì¤‘ê³µì—…', change: 1.33, price: 534000, market: 'KOSPI', cap: 474048, rank: 10 },
                { code: '000830', name: 'ì‚¼ì„±ë¬¼ì‚°', change: 1.46, price: 244000, market: 'KOSPI', cap: 414743, rank: 13 },
                { code: '036620', name: 'í•œí™”ì˜¤ì…˜', change: 1.88, price: 108500, market: 'KOSPI', cap: 332459, rank: 18 },
                { code: '329180', name: 'HDí•œêµ­ì¡°ì„ í•´ì–‘', change: 3.10, price: 432000, market: 'KOSPI', cap: 305740, rank: 21 },
                { code: '010140', name: 'ì‚¼ì„±ì¤‘ê³µì—…', change: 3.25, price: 25450, market: 'KOSPI', cap: 223960, rank: 30 },
            ],
            'ì€í–‰/ì¢…í•©ê¸ˆìœµ': [ 
                { code: '105560', name: 'KBê¸ˆìœµ', change: 1.48, price: 130700, market: 'KOSPI', cap: 498571, rank: 8 },
                { code: '055550', name: 'ì‹ í•œì§€ì£¼', change: 1.91, price: 80200, market: 'KOSPI', cap: 389367, rank: 16 },
                { code: '032830', name: 'ì‚¼ì„±ìƒëª…', change: 0.76, price: 158200, market: 'KOSPI', cap: 316400, rank: 20 },
                { code: '086790', name: 'í•˜ë‚˜ê¸ˆìœµì§€ì£¼', change: 0.74, price: 95200, market: 'KOSPI', cap: 264966, rank: 25 },
                { code: '000810', name: 'ì‚¼ì„±í™”ì¬', change: 5.03, price: 522000, market: 'KOSPI', cap: 240178, rank: 29 },
                { code: '316140', name: 'ìš°ë¦¬ê¸ˆìœµì§€ì£¼', change: 0.88, price: 28500, market: 'KOSPI', cap: 209212, rank: 31 },
                { code: '138040', name: 'ë©”ë¦¬ì¸ ê¸ˆìœµì§€ì£¼', change: 1.37, price: 111000, market: 'KOSPI', cap: 194496, rank: 34 },
                { code: '024110', name: 'ê¸°ì—…ì€í–‰', change: -0.24, price: 21050, market: 'KOSPI', cap: 167858, rank: 41 },
                { code: '058350', name: 'ì‚¼ì„±ì—í”¼ìŠ¤í™€ë”©ìŠ¤', change: -7.54, price: 515000, market: 'KOSPI', cap: 128148, rank: 50 },
            ],
            'ì§€ì£¼ì‚¬/ITì„œë¹„ìŠ¤/ê¸°íƒ€ëŒ€í˜•': [ 
                { code: '402340', name: 'SKìŠ¤í€˜ì–´', change: -3.36, price: 302000, market: 'KOSPI', cap: 400273, rank: 14 },
                { code: '034730', name: 'SK', change: -0.75, price: 264000, market: 'KOSPI', cap: 191407, rank: 37 },
                { code: '267250', name: 'HDí˜„ëŒ€', change: 0.48, price: 208500, market: 'KOSPI', cap: 164701, rank: 42 },
                { code: '000150', name: 'ë‘ì‚°', change: 4.39, price: 928000, market: 'KOSPI', cap: 150279, rank: 45 },
                { code: '005940', name: 'ì‚¼ì„±ì—ìŠ¤ë””ì—ìŠ¤', change: -0.85, price: 176000, market: 'KOSPI', cap: 136185, rank: 46 },
                { code: '003550', name: 'LG', change: 5.03, price: 85600, market: 'KOSPI', cap: 132014, rank: 49 },
            ],
            'IT í”Œë«í¼/í†µì‹ ': [ 
                { code: '035420', name: 'NAVER', change: 1.01, price: 249500, market: 'KOSPI', cap: 391347, rank: 15 },
                { code: '035720', name: 'ì¹´ì¹´ì˜¤', change: 2.16, price: 61500, market: 'KOSPI', cap: 272066, rank: 23 },
                { code: '030200', name: 'KT', change: 0.00, price: 53100, market: 'KOSPI', cap: 133824, rank: 48 },
            ],
            'ì² ê°•/ê¸ˆì†/í•´ìš´': [ 
                { code: '004700', name: 'ê³ ë ¤ì•„ì—°', change: 4.70, price: 1359000, market: 'KOSPI', cap: 262875, rank: 26 },
                { code: '005490', name: 'POSCOí™€ë”©ìŠ¤', change: 1.47, price: 311000, market: 'KOSPI', cap: 251701, rank: 27 },
                { code: '011200', name: 'HMM', change: 2.24, price: 20550, market: 'KOSPI', cap: 193835, rank: 35 },
                { code: '086280', name: 'í˜„ëŒ€ê¸€ë¡œë¹„ìŠ¤', change: 1.59, price: 179300, market: 'KOSPI', cap: 134475, rank: 47 },
            ],
            'ì „ë ¥ê¸°ê¸°/ë³€ì••ê¸°': [ 
                { code: '012450', name: 'í•œí™”ì—ì–´ë¡œìŠ¤í˜ì´ìŠ¤', change: 4.68, price: 895000, market: 'KOSPI', cap: 461492, rank: 11 },
                { code: '178920', name: 'HDí˜„ëŒ€ì¼ë ‰íŠ¸ë¦­', change: 4.26, price: 832000, market: 'KOSPI', cap: 299912, rank: 22 },
                { code: '298040', name: 'íš¨ì„±ì¤‘ê³µì—…', change: 8.87, price: 2012000, market: 'KOSPI', cap: 187610, rank: 38 },
                { code: '064350', name: 'í˜„ëŒ€ë¡œí…œ', change: 3.29, price: 182000, market: 'KOSPI', cap: 198639, rank: 32 },
                { code: '010120', name: 'LS ELECTRIC', change: 5.86, price: 515000, market: 'KOSPI', cap: 154500, rank: 44 },
            ],
            'ì†Œë¹„ì¬/ì „ìë¶€í’ˆ': [ 
                { code: '015760', name: 'í•œêµ­ì „ë ¥', change: 3.16, price: 52200, market: 'KOSPI', cap: 335105, rank: 17 },
                { code: '009150', name: 'ì‚¼ì„±ì „ê¸°', change: -0.75, price: 263000, market: 'KOSPI', cap: 196444, rank: 33 },
                { code: '033780', name: 'KT&G', change: -0.21, price: 143000, market: 'KOSPI', cap: 168707, rank: 40 },
                { code: '066570', name: 'LGì „ì', change: 5.17, price: 99700, market: 'KOSPI', cap: 162398, rank: 43 },
            ],
            
            // --- KOSDAQ (Cap Total Sorting) ---
            '2ì°¨ì „ì§€ ì–‘ê·¹ì¬/í•µì‹¬ì†Œì¬(KOSDAQ)': [ 
                { code: '247540', name: 'ì—ì½”í”„ë¡œë¹„ì— ', change: 1.14, price: 159700, market: 'KOSDAQ', cap: 156189, rank: 2 },
                { code: '086520', name: 'ì—ì½”í”„ë¡œ', change: 5.90, price: 96900, market: 'KOSDAQ', cap: 131567, rank: 3 },
                { code: '348390', name: 'ì—”ì¼', change: -2.23, price: 70000, market: 'KOSDAQ', cap: 15237, rank: 50 },
                { code: '004700', name: 'ì‹ ì„±ë¸íƒ€í…Œí¬', change: 5.16, price: 63200, market: 'KOSDAQ', cap: 17370, rank: 43 },
                { code: '347470', name: 'ì„œì§„ì‹œìŠ¤í…œ', change: 2.41, price: 25500, market: 'KOSDAQ', cap: 14352, rank: 57 },
            ],
            'ë°”ì´ì˜¤/í—¬ìŠ¤ì¼€ì–´ ì„±ì¥': [ 
                { code: '196170', name: 'ì•Œí…Œì˜¤ì  ', change: -12.04, price: 456500, market: 'KOSDAQ', cap: 244254, rank: 1 },
                { code: '298380', name: 'ì—ì´ë¹„ì—˜ë°”ì´ì˜¤', change: -5.17, price: 190600, market: 'KOSDAQ', cap: 105069, rank: 4 },
                { code: '141080', name: 'ë¦¬ê°€ì¼ë°”ì´ì˜¤', change: -5.41, price: 185500, market: 'KOSDAQ', cap: 67912, rank: 6 },
                { code: '310960', name: 'ì½”ì˜¤ë¡±í‹°ìŠˆì§„', change: -2.56, price: 80000, market: 'KOSDAQ', cap: 66577, rank: 7 },
                { code: '199800', name: 'í©íŠ¸ë¡ ', change: 1.60, price: 285000, market: 'KOSDAQ', cap: 66454, rank: 8 },
                { code: '088520', name: 'HLB', change: 1.66, price: 49100, market: 'KOSDAQ', cap: 64730, rank: 9 },
                { code: '455910', name: 'íë¦¬ì˜¥ìŠ¤ë°”ì´ì˜¤ì‹œìŠ¤í…œì¦ˆ', change: -3.50, price: 23000, market: 'KOSDAQ', cap: 14500, rank: 55 }, // ì‹œì´ 60ìœ„ ë‚´ ì¢…ëª© ì¶”ê°€
            ],
            'ë¯¸ìš©/í”¼ë¶€ ì˜ë£Œê¸°ê¸°/ì—ìŠ¤í…Œí‹±': [
                { code: '214450', name: 'íŒŒë§ˆë¦¬ì„œì¹˜', change: -2.31, price: 401500, market: 'KOSDAQ', cap: 41714, rank: 13 },
                { code: '214150', name: 'í´ë˜ì‹œìŠ¤', change: 0.36, price: 55300, market: 'KOSDAQ', cap: 36225, rank: 18 },
                { code: '223000', name: 'íœ´ì ¤', change: 0.90, price: 223000, market: 'KOSDAQ', cap: 27438, rank: 21 },
                { code: '298380', name: 'ì—˜ì•¤ì”¨ë°”ì´ì˜¤', change: 5.04, price: 68800, market: 'KOSDAQ', cap: 16938, rank: 45 },
            ],
            'ë¡œë´‡/ìë™í™”': [ 
                { code: '277810', name: 'ë ˆì¸ë³´ìš°ë¡œë³´í‹±ìŠ¤', change: -7.20, price: 438500, market: 'KOSDAQ', cap: 85068, rank: 5 },
                { code: '108320', name: 'ë¡œë³´í‹°ì¦ˆ', change: -1.74, price: 283000, market: 'KOSDAQ', cap: 41233, rank: 15 },
                { code: '451960', name: 'í•˜ì´ì  ì•Œì•¤ì— ', change: -2.45, price: 59700, market: 'KOSDAQ', cap: 18440, rank: 39 },
                { code: '086520', name: 'ì—ìŠ¤í”¼ì§€', change: 2.78, price: 66600, market: 'KOSDAQ', cap: 14770, rank: 53 },
                { code: '44700', name: 'ì‚¼í˜„', change: 7.71, price: 44700, market: 'KOSDAQ', cap: 14173, rank: 58 },
            ],
            'ë°˜ë„ì²´ ì†Œë¶€ì¥/ì¥ë¹„': [ 
                { code: '058470', name: 'ë¦¬ë…¸ê³µì—…', change: 0.46, price: 65400, market: 'KOSDAQ', cap: 49843, rank: 11 },
                { code: '039030', name: 'ì´ì˜¤í…Œí¬ë‹‰ìŠ¤', change: 2.52, price: 285000, market: 'KOSDAQ', cap: 35111, rank: 19 },
                { code: '240810', name: 'ì›ìµIPS', change: 1.31, price: 61800, market: 'KOSDAQ', cap: 30334, rank: 20 },
                { code: '403870', name: 'HPSP', change: -0.82, price: 30300, market: 'KOSDAQ', cap: 25300, rank: 25 },
                { code: '095340', name: 'ISC', change: -0.73, price: 109500, market: 'KOSDAQ', cap: 23211, rank: 31 },
                { code: '036930', name: 'ì†”ë¸Œë ˆì¸', change: -0.73, price: 271500, market: 'KOSDAQ', cap: 21119, rank: 35 },
            ],
            'ì²¨ë‹¨ IT ë¶€í’ˆ/ì¥ë¹„': [ 
                { code: '057080', name: 'ìœ ì§„í…Œí¬', change: 0.26, price: 77000, market: 'KOSDAQ', cap: 17645, rank: 40 },
                { code: '089030', name: 'í…Œí¬ìœ™', change: 3.41, price: 47050, market: 'KOSDAQ', cap: 17434, rank: 41 },
                { code: '064760', name: 'í‹°ì”¨ì¼€ì´', change: 1.80, price: 147000, market: 'KOSDAQ', cap: 17162, rank: 44 },
                { code: '170920', name: 'í•˜ë‚˜ë§ˆì´í¬ë¡ ', change: 3.69, price: 25300, market: 'KOSDAQ', cap: 16794, rank: 46 },
                { code: '344830', name: 'íŒŒí¬ì‹œìŠ¤í…œìŠ¤', change: 0.67, price: 225000, market: 'KOSDAQ', cap: 15742, rank: 47 },
                { code: '005690', name: 'ë™ì§„ì„ë¯¸ì¼', change: 0.27, price: 36850, market: 'KOSDAQ', cap: 18946, rank: 36 },
                { code: '224020', name: 'LSë§ˆë¦°ì†”ë£¨ì…˜', change: 4.73, price: 29900, market: 'KOSDAQ', cap: 15619, rank: 49 },
            ],
            'ê²Œì„/ì—”í„°í…Œì¸ë¨¼íŠ¸/ì½˜í…ì¸ ': [ 
                { code: '263750', name: 'í„ì–´ë¹„ìŠ¤', change: -0.13, price: 38650, market: 'KOSDAQ', cap: 24832, rank: 26 },
                { code: '357340', name: 'JYP Ent.', change: 1.03, price: 68400, market: 'KOSDAQ', cap: 24304, rank: 28 },
                { code: '041190', name: 'ì—ìŠ¤ì— ', change: 0.58, price: 104400, market: 'KOSDAQ', cap: 23902, rank: 30 },
                { code: '293490', name: 'ì¹´ì¹´ì˜¤ê²Œì„ì¦ˆ', change: 0.18, price: 16710, market: 'KOSDAQ', cap: 15003, rank: 51 }, 
            ],
            // ì‹œì´ 60ìœ„ ì»¤ë²„ë¦¬ì§€ë¥¼ ìœ„í•œ ì¶”ê°€ ëª©ì—… ì¢…ëª© (Placeholder)
            'KOSDAQ ê¸°íƒ€ ì„±ì¥ì£¼': [
                { code: '900001', name: 'ì„±ì¥ì£¼_A1', change: 0.1, price: 15000, market: 'KOSDAQ', cap: 14000, rank: 52 },
                { code: '900002', name: 'ì„±ì¥ì£¼_A2', change: -0.5, price: 14500, market: 'KOSDAQ', cap: 13500, rank: 54 },
                { code: '900003', name: 'ì„±ì¥ì£¼_A3', change: 1.2, price: 14000, market: 'KOSDAQ', cap: 13000, rank: 56 },
                { code: '900004', name: 'ì„±ì¥ì£¼_A4', change: 2.1, price: 13500, market: 'KOSDAQ', cap: 12500, rank: 59 },
                { code: '900005', name: 'ì„±ì¥ì£¼_A5', change: -3.0, price: 13000, market: 'KOSDAQ', cap: 12000, rank: 60 },
                { code: '900006', name: 'ì„±ì¥ì£¼_A6', change: 0.8, price: 12500, market: 'KOSDAQ', cap: 11500, rank: 61 },
                { code: '900007', name: 'ì„±ì¥ì£¼_A7', change: 1.5, price: 12000, market: 'KOSDAQ', cap: 11000, rank: 62 },
                { code: '900008', name: 'ì„±ì¥ì£¼_A8', change: 0.2, price: 11500, market: 'KOSDAQ', cap: 10500, rank: 63 },
                { code: '900009', name: 'ì„±ì¥ì£¼_A9', change: 0.4, price: 11000, market: 'KOSDAQ', cap: 10000, rank: 64 },
                { code: '900010', name: 'ì„±ì¥ì£¼_A10', change: -1.0, price: 10500, market: 'KOSDAQ', cap: 9500, rank: 65 },
                { code: '900011', name: 'ì„±ì¥ì£¼_A11', change: 0.6, price: 10000, market: 'KOSDAQ', cap: 9000, rank: 66 },
                { code: '900012', name: 'ì„±ì¥ì£¼_A12', change: 1.1, price: 9500, market: 'KOSDAQ', cap: 8500, rank: 67 },
                { code: '900013', name: 'ì„±ì¥ì£¼_A13', change: 0.0, price: 9000, market: 'KOSDAQ', cap: 8000, rank: 68 },
                { code: '900014', name: 'ì„±ì¥ì£¼_A14', change: -0.3, price: 8500, market: 'KOSDAQ', cap: 7500, rank: 69 },
                { code: '900015', name: 'ì„±ì¥ì£¼_A15', change: 0.7, price: 8000, market: 'KOSDAQ', cap: 7000, rank: 70 },
                { code: '900016', name: 'ì„±ì¥ì£¼_A16', change: 1.3, price: 7500, market: 'KOSDAQ', cap: 6500, rank: 71 },
                { code: '900017', name: 'ì„±ì¥ì£¼_A17', change: -0.8, price: 7000, market: 'KOSDAQ', cap: 6000, rank: 72 },
                { code: '900018', name: 'ì„±ì¥ì£¼_A18', change: 1.6, price: 6500, market: 'KOSDAQ', cap: 5500, rank: 73 },
                { code: '900019', name: 'ì„±ì¥ì£¼_A19', change: 0.9, price: 6000, market: 'KOSDAQ', cap: 5000, rank: 74 },
                { code: '900020', name: 'ì„±ì¥ì£¼_A20', change: -2.0, price: 5500, market: 'KOSDAQ', cap: 4500, rank: 75 },
                { code: '900021', name: 'ì„±ì¥ì£¼_A21', change: 0.5, price: 5000, market: 'KOSDAQ', cap: 4000, rank: 76 },
                { code: '900022', name: 'ì„±ì¥ì£¼_A22', change: 2.5, price: 4500, market: 'KOSDAQ', cap: 3500, rank: 77 },
                { code: '900023', name: 'ì„±ì¥ì£¼_A23', change: 1.9, price: 4000, market: 'KOSDAQ', cap: 3000, rank: 78 },
            ]
        };

        // ğŸ’¡ ì¶”ê°€: ëª¨ë“  ì¢…ëª©ì„ ì½”ë“œë¡œ ë¹ ë¥´ê²Œ ì°¾ê¸° ìœ„í•œ í‰íƒ„í™” ë§µ
        let FLAT_STOCK_MAP = {}; 
        
        let currentSymbol = '005930';
        
        let sectorPerformance = {}; // ì„¹í„°ë³„ í‰ê·  ë“±ë½ë¥  ì €ì¥ìš©
        
        // ğŸ’¡ ìˆ˜ì •: API Key ì €ì¥ì†Œ ë° ë¡œë“œ í•¨ìˆ˜ - ì‹œê°„ ì œí•œ(60ë¶„) ì¶”ê°€
        function loadApiKey() {
            // í‚¤ì™€ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ í¬í•¨í•˜ëŠ” JSON ë°ì´í„°ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
            const storedData = localStorage.getItem('geminiApiKeyData');
            const HOUR_IN_MS = 60 * 60 * 1000; // 1ì‹œê°„ (60ë¶„)

            if (storedData) {
                try {
                    const data = JSON.parse(storedData);
                    const currentTime = Date.now();
                    
                    // ë§Œë£Œ ì‹œê°„ ì²´í¬ (1ì‹œê°„ ì´ˆê³¼ ì‹œ)
                    if (currentTime - data.timestamp > HOUR_IN_MS) {
                        localStorage.removeItem('geminiApiKeyData');
                        const apiKeyInput = document.getElementById('gemini-api-key-input');
                        if (apiKeyInput) apiKeyInput.value = ''; // ë§Œë£Œ ì‹œ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                        return '';
                    }
                    
                    // ìœ íš¨í•˜ë©´ í‚¤ ë°˜í™˜
                    return data.key;
                } catch (e) {
                    // ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜ ë°œìƒ ì‹œ ì´ˆê¸°í™”
                    localStorage.removeItem('geminiApiKeyData');
                    return '';
                }
            }
            return '';
        }

        function saveApiKey() {
            const apiKeyInput = document.getElementById('gemini-api-key-input');
            const key = apiKeyInput.value.trim();
            
            if (key) {
                const data = {
                    key: key,
                    timestamp: Date.now() // í˜„ì¬ ì‹œê°„ì„ ì €ì¥í•˜ì—¬ 1ì‹œê°„ íƒ€ì´ë¨¸ ì‹œì‘
                };
                // ìƒˆë¡œìš´ í‚¤ë¡œ ì €ì¥í•˜ê±°ë‚˜, ìœ íš¨í•œ í‚¤ë¥¼ ë®ì–´ì”ë‹ˆë‹¤ (ê°±ì‹  ê¸°ëŠ¥).
                localStorage.setItem('geminiApiKeyData', JSON.stringify(data));
            } else {
                localStorage.removeItem('geminiApiKeyData');
            }
            
            // í‚¤ë¥¼ ì €ì¥í•œ í›„ ìë™ìœ¼ë¡œ ë‰´ìŠ¤ ê²€ìƒ‰ì„ ë‹¤ì‹œ ì‹œë„
            fetchAllData(); 
        }
        
        function initApiKeyInput() {
            const apiKeyInput = document.getElementById('gemini-api-key-input');
            if(apiKeyInput) apiKeyInput.value = loadApiKey(); // ë¡œë“œ ì‹œ ë§Œë£Œ ì²´í¬ê¹Œì§€ ì™„ë£Œë¨
        }

        // ğŸ’¡ ì¶”ê°€: ëª¨ë“  ì„¹í„°ë³„ ë°ì´í„°ë¥¼ í•˜ë‚˜ì˜ ë§µìœ¼ë¡œ í‰íƒ„í™”
        function flattenStocks() {
            FLAT_STOCK_MAP = {};
            for (const sector in ALL_MARKET_MAP_STOCKS) {
                for (const stock of ALL_MARKET_MAP_STOCKS[sector]) {
                    // ì¤‘ë³µëœ ì½”ë“œê°€ ìˆì„ ê²½ìš°, ë­í¬ê°€ ë” ë†’ì€ (ìˆ«ìê°€ ë‚®ì€) ê²ƒì„ ìœ ì§€
                    if (!FLAT_STOCK_MAP[stock.code] || stock.rank < FLAT_STOCK_MAP[stock.code].rank) {
                        FLAT_STOCK_MAP[stock.code] = { ...stock, sector: sector };
                    }
                }
            }
        }


        // === ìœ í‹¸ë¦¬í‹° ===
        function formatNum(n) { return new Intl.NumberFormat('ko-KR', { maximumFractionDigits: 2 }).format(n); }
        function getColor(v) { return v > 0 ? 'text-red-500' : (v < 0 ? 'text-blue-500' : 'text-slate-500'); }
        function getCardGradient(v) {
            if (v > 0) return 'bg-gradient-positive';
            if (v < 0) return 'bg-gradient-negative';
            return 'bg-white dark:bg-slate-800';
        }

        // ì‹œê°€ì´ì•¡ í¬ë§·íŒ… í•¨ìˆ˜ (ë‹¨ìœ„ë¥¼ ì–µ, ì¡° ì›ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ í‘œì‹œ)
        function formatCap(capValue) {
            if (capValue >= 10000) {
                const trillionValue = capValue / 10000;
                // ì†Œìˆ˜ì  2ìë¦¬ê¹Œì§€ í‘œì‹œí•˜ë˜, 0ì€ ì œê±°
                let formattedTrillion = trillionValue.toFixed(2);
                formattedTrillion = formattedTrillion.endsWith('.00') ? formattedTrillion.slice(0, -3) : (formattedTrillion.endsWith('0') ? formattedTrillion.slice(0, -1) : formattedTrillion);
                return `${formatNum(formattedTrillion)}ì¡° ì›`;
            } else if (capValue > 0) {
                // 10000 ë¯¸ë§Œ (1ì¡° ë¯¸ë§Œ)ì¼ ê²½ìš° ì–µ ì›ìœ¼ë¡œ í‘œì‹œ
                return `${formatNum(capValue)}ì–µ ì›`;
            }
            return 'N/A';
        }

        // ì‹œì´/ìˆœìœ„ ì •ë³´ ê²€ìƒ‰ í•¨ìˆ˜ (FLAT_STOCK_MAP ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •)
        function getStockDetailsBySymbol(symbol) {
            const found = FLAT_STOCK_MAP[symbol];

            if (found) {
                return {
                    cap: formatCap(found.cap),
                    rawCap: found.cap, // ì›ë³¸ ì–µ ë‹¨ìœ„ ì‹œì´ ê°’ ë°˜í™˜
                    rank: found.rank > 0 ? `${found.rank}ìœ„` : 'N/A' 
                };
            }
            return { cap: 'N/A', rawCap: 0, rank: 'N/A' };
        }
        
        // ì„¹í„°ë³„ ê²½ê³„ì„  ìƒ‰ìƒ í´ë˜ìŠ¤ ë§¤í•‘ í•¨ìˆ˜ (ì„¸ë¶„í™”ëœ ì„¹í„°ì— ìƒˆ ìƒ‰ìƒ ì¶”ê°€)
        function getSectorBorderColor(sectorName) {
            if (sectorName.includes('ë°˜ë„ì²´')) return 'border-sector-red';
            if (sectorName.includes('2ì°¨ì „ì§€')) return 'border-sector-blue';
            if (sectorName.includes('ì™„ì„±ì°¨')) return 'border-sector-green';
            if (sectorName.includes('IT í”Œë«í¼')) return 'border-sector-red';
            
            // ì„¸ë¶„í™”ëœ ë°”ì´ì˜¤/ì˜ë£Œê¸°ê¸°
            if (sectorName.includes('ë°”ì´ì˜¤') || sectorName.includes('í—¬ìŠ¤ì¼€ì–´')) return 'border-sector-purple'; // Darker purple
            if (sectorName.includes('ë¯¸ìš©')) return 'border-sector-fuchsia'; // Fuchsia for aesthetics
            
            if (sectorName.includes('ì€í–‰') || sectorName.includes('ì¢…í•©ê¸ˆìœµ')) return 'border-sector-amber';
            if (sectorName.includes('ì¡°ì„ ') || sectorName.includes('ë°©ì‚°') || sectorName.includes('ì¤‘ê³µì—…')) return 'border-sector-orange';
            if (sectorName.includes('ì§€ì£¼ì‚¬') || sectorName.includes('ITì„œë¹„ìŠ¤')) return 'border-sector-indigo';
            if (sectorName.includes('ì² ê°•') || sectorName.includes('ê¸ˆì†') || sectorName.includes('í•´ìš´')) return 'border-sector-lime';
            if (sectorName.includes('ì „ë ¥ê¸°ê¸°') || sectorName.includes('ë³€ì••ê¸°')) return 'border-sector-cyan';
            if (sectorName.includes('ë¡œë´‡') || sectorName.includes('ìë™í™”')) return 'border-sector-pink';
            
            // ì„¸ë¶„í™”ëœ IT/ì½˜í…ì¸ 
            if (sectorName.includes('ì²¨ë‹¨ IT')) return 'border-sector-teal';
            if (sectorName.includes('ê²Œì„') || sectorName.includes('ì—”í„°í…Œì¸ë¨¼íŠ¸') || sectorName.includes('ì½˜í…ì¸ ')) return 'border-sector-violet';
            
            return 'border-slate-500'; // ê¸°íƒ€
        }

        // ì„¹í„° ê°•ë„ ì‹œê°í™” ë§‰ëŒ€ HTML ìƒì„± (ëª©ë¡ ë³´ê¸°ìš©)
        function getRelativeStrengthBarHtml(strength) {
            const maxDelta = 2.0; 
            const barWidthPercent = Math.min(Math.abs(strength) / maxDelta, 1.0) * 50; 
            const isStronger = strength > 0.1; 
            const isWeaker = strength < -0.1;
            
            let barHtml;
            let labelText;

            if (isStronger) {
                labelText = `+${strength.toFixed(2)}% ê°•ì„¸`;
                barHtml = `<div class="absolute left-1/2 h-full bg-red-500 transition-all duration-300 ease-in-out" style="width: ${barWidthPercent}%;"></div>`;
            } else if (isWeaker) {
                labelText = `${strength.toFixed(2)}% ì•½ì„¸`;
                barHtml = `<div class="absolute right-1/2 h-full bg-blue-500 transition-all duration-300 ease-in-out" style="width: ${barWidthPercent}%;"></div>`;
            } else {
                labelText = 'ì¤‘ë¦½';
                barHtml = `<div class="absolute left-1/2 transform -translate-x-1/2 w-px h-full bg-slate-400 dark:bg-slate-500"></div>`; 
            }
            
            return `
                <div class="relative w-full h-3 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden shadow-inner" title="ì„¹í„° í‰ê·  ëŒ€ë¹„ ${labelText}">
                    <div class="absolute left-1/2 top-0 bottom-0 w-px bg-slate-300 dark:bg-slate-600"></div>
                    ${barHtml}
                </div>
            `;
        }
        
        // Stock Card HTML ìƒì„± í—¬í¼ (Proportional Viewìš©)
        function generateStockCardHtml(stock, sectorName) {
            const colorClass = getColor(stock.change);
            const bgColorClass = getCardGradient(stock.change);
            const changeSign = stock.change > 0 ? 'â–²' : 'â–¼';
            const sectorBorderClass = getSectorBorderColor(sectorName);
            // ì¢…ëª©ì˜ market ì†ì„±ì„ ì‚¬ìš©í•˜ì—¬ (Q) ë°°ì§€ í‘œì‹œ
            const marketBadge = stock.market === 'KOSDAQ' ? '<span class="text-[10px] text-blue-400 ml-1"> (Q)</span>' : '';
            
            const isTop3 = stock.rank <= 3; 
            const rankBadgeClass = isTop3 ? 'bg-red-600' : (stock.rank <= 10 ? 'bg-orange-500' : 'bg-slate-400 dark:bg-slate-600');
            const rankAnimationClass = isTop3 ? 'rank-pop' : '';
            const rankIcon = stock.rank === 1 ? 'ğŸ¥‡' : (stock.rank === 2 ? 'ğŸ¥ˆ' : (stock.rank === 3 ? 'ğŸ¥‰' : ''));
            const rankDisplay = `
                <div class="absolute top-0 right-0 m-1 z-10">
                    <span class="text-[10px] text-white font-black px-1.5 py-0.5 rounded-full ${rankBadgeClass} ${rankAnimationClass} leading-none shadow-md" title="ì‹œì´ ìˆœìœ„: ${stock.rank}ìœ„">
                        ${rankIcon || stock.rank}
                    </span>
                </div>
            `;
            
            // ì„¹í„° ëŒ€ë¹„ ê°•ë„ (Simpler badge for proportional view)
            const currentSectorPerf = sectorPerformance[sectorName] || 0; 
            const relativeStrength = stock.change - currentSectorPerf;
            let strengthBadge = '';
            if (relativeStrength > 0.5) {
                strengthBadge = `<span class="ml-1 text-[8px] font-bold text-green-500" title="ì„¹í„° ëŒ€ë¹„ ê°•ì„¸"><i class="fa-solid fa-up-long"></i></span>`;
            } else if (relativeStrength < -0.5) {
                strengthBadge = `<span class="ml-1 text-[8px] font-bold text-indigo-500" title="ì„¹í„° ëŒ€ë¹„ ì•½ì„¸"><i class="fa-solid fa-down-long"></i></span>`;
            }
            
            // ğŸ’¡ ìˆ˜ì •: ì‹œê°€ì´ì•¡ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (Treemap Cardìš©)
            const stockDetails = getStockDetailsBySymbol(stock.code);
            const capDisplay = stockDetails.cap;

            // ğŸ’¡ ìˆ˜ì •: í´ë˜ìŠ¤ëª…ì„ ì‚¬ìš©í•˜ì—¬ ê°€ë…ì„±ì„ ë†’ì…ë‹ˆë‹¤.
            return `
                <div onclick="document.getElementById('symbol-input').value='${stock.code}'; fetchAllData()" 
                    onmousemove="handleTilt(event, this)"
                    onmouseout="resetTilt(this)"
                    data-code="${stock.code}"
                    data-sector="${sectorName}"
                    class="relative h-full p-2 rounded-lg treemap-card-3d border ${sectorBorderClass} border-opacity-70 cursor-pointer ${bgColorClass} hover:ring-2 hover:ring-offset-1 hover:ring-blue-400 dark:border-slate-700 overflow-hidden">
                    
                    <!-- Rank Badge -->
                    ${rankDisplay}

                    <div class="stock-card-content">
                        <!-- Top Line: Name and Market Badge -->
                        <div class="flex flex-col">
                            <div class="text-sm font-semibold text-slate-900 dark:text-slate-100 leading-tight truncate">
                                ${stock.name}${marketBadge}
                            </div>
                            <div class="text-[9px] text-slate-500 dark:text-slate-400 leading-none truncate">
                                ${sectorName.replace(/KOSPI|KOSDAQ|\(.*\)/g, '').trim()}
                            </div>
                        </div>

                        <!-- Price & Change (ê°•ì¡°) -->
                        <div class="mt-1">
                            <div class="font-bold stock-card-price ${colorClass} leading-none">
                                ${formatNum(stock.price)}
                            </div>
                            <div class="text-[10px] stock-card-cap text-slate-500 dark:text-slate-400 mt-1">
                                ì‹œì´: ${capDisplay}
                            </div>
                            <div class="stock-card-change ${colorClass} flex items-center mt-0.5">
                                ${changeSign} ${formatNum(stock.change.toFixed(2))}%
                                ${strengthBadge} 
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // === ë‹¤í¬ëª¨ë“œ ë¡œì§ ===
        function initDarkMode() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                updateThemeIcon(true);
            } else {
                document.documentElement.classList.remove('dark');
                updateThemeIcon(false);
            }
        }
        function toggleDarkMode() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
                updateThemeIcon(false);
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
                updateThemeIcon(true);
            }
        }
        function updateThemeIcon(isDark) {
            const icon = document.getElementById('theme-icon');
            icon.className = isDark ? "fa-solid fa-sun text-yellow-400 text-lg" : "fa-solid fa-moon text-slate-600 text-lg";
        }


        // === í™˜ìœ¨ ê³„ì‚°ê¸° ë¡œì§ ===
        function calculateExchange() {
            const foreignInput = document.getElementById('calc-input-foreign').value;
            const krwOutput = document.getElementById('calc-input-krw');
            
            const rateInfo = currentRates[selectedCurrency];
            const currentRate = rateInfo ? rateInfo.rate : 0;
            const unit = rateInfo ? rateInfo.unit : 1;

            if (currentRate > 0 && foreignInput) {
                const amount = parseFloat(foreignInput);
                const calculatedKrw = amount * (currentRate / unit); 
                krwOutput.value = formatNum(calculatedKrw);
            } else {
                krwOutput.value = "-";
            }
        }

        function updateCurrencyRate() {
            const selectElement = document.getElementById('calc-currency-select');
            selectedCurrency = selectElement.value;

            const rateInfo = currentRates[selectedCurrency];
            const rateDisplay = document.getElementById('current-rate');
            const unitDisplay = document.getElementById('current-currency-unit');
            
            if (rateInfo) {
                rateDisplay.textContent = formatNum(rateInfo.rate);
                unitDisplay.textContent = selectedCurrency;
                if (rateInfo.unit > 1) {
                    unitDisplay.textContent += ` (${rateInfo.unit}ë‹¨ìœ„)`;
                }
            } else {
                rateDisplay.textContent = "-";
                unitDisplay.textContent = selectedCurrency;
            }

            calculateExchange();
        }

        // === ì¢…ëª© í‰ë‹¨ê°€ ê³„ì‚°ê¸° ë¡œì§ (ë™ì  í–‰ ì§€ì›) ===
        function initAverageCalculator() {
            const container = document.getElementById('average-calculator-inputs');
            container.innerHTML = ''; // ê¸°ì¡´ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            
            // ì´ˆê¸° 2ê°œì˜ ì…ë ¥ í–‰ ì¶”ê°€ (ê¸°ë³¸ ê°’ ì„¤ì •)
            addPurchaseRow(10, 50000);
            addPurchaseRow(20, 40000);

            calculateAveragePrice();
        }

        function addPurchaseRow(defaultQty = null, defaultPrice = null) {
            const container = document.getElementById('average-calculator-inputs');
            const rowCount = container.children.length + 1;
            
            const newRow = document.createElement('div');
            newRow.className = "flex gap-2 items-center purchase-row";
            newRow.dataset.index = rowCount; // ì¸ë±ìŠ¤ ì €ì¥

            const qtyVal = defaultQty !== null ? defaultQty : '';
            const priceVal = defaultPrice !== null ? defaultPrice : '';

            newRow.innerHTML = `
                <!-- ğŸ’¡ ìˆ˜ì •: ë¼ë²¨ì„ 'ê±°ë˜'ë¡œ ë³€ê²½ -->
                <span class="w-1/6 text-xs text-slate-500 dark:text-slate-400 font-medium whitespace-nowrap row-label">${rowCount}ì°¨ ê±°ë˜</span>
                <input type="number" placeholder="ìˆ˜ëŸ‰" value="${qtyVal}" min="0" oninput="calculateAveragePrice(); updateRowLabels()" 
                    class="w-1/3 p-2 bg-slate-50 border border-slate-300 rounded-lg text-sm text-right dark:bg-slate-700 dark:border-slate-600 stock-qty">
                <input type="number" placeholder="ê°€ê²©" value="${priceVal}" min="0" oninput="calculateAveragePrice(); updateRowLabels()" 
                    class="w-1/2 p-2 bg-slate-50 border border-slate-300 rounded-lg text-sm text-right dark:bg-slate-700 dark:border-slate-600 stock-price">
                ${rowCount > 1 ? `<button onclick="removePurchaseRow(this)" class="p-2 text-red-500 hover:text-red-700 transition-colors" title="ì‚­ì œ"><i class="fa-solid fa-trash-can text-sm"></i></button>` : ''}
            `;
            
            container.appendChild(newRow);
            calculateAveragePrice();
            updateRowLabels(); // ë¼ë²¨ì„ ì—…ë°ì´íŠ¸í•˜ì—¬ ìˆœì„œê°€ ë§ë„ë¡ í•¨
        }
        
        function removePurchaseRow(buttonElement) {
            const row = buttonElement.closest('.purchase-row');
            if (row) {
                row.remove();
                calculateAveragePrice();
                updateRowLabels(); 
            }
        }

        function updateRowLabels() {
            const container = document.getElementById('average-calculator-inputs');
            const rows = container.querySelectorAll('.purchase-row');
            
            rows.forEach((row, index) => {
                const label = row.querySelector('.row-label');
                const deleteBtn = row.querySelector('button[title="ì‚­ì œ"]');
                const rowNum = index + 1;
                
                if (label) {
                    // ğŸ’¡ ìˆ˜ì •: ë¼ë²¨ì„ 'ê±°ë˜'ë¡œ ë³€ê²½
                    label.textContent = `${rowNum}ì°¨ ê±°ë˜`;
                }

                // 1ì°¨ ê±°ë˜ í–‰ì€ ì‚­ì œ ë²„íŠ¼ì„ ìˆ¨ê¹€
                if (rowNum === 1 && deleteBtn) {
                    deleteBtn.style.display = 'none';
                } else if (rowNum > 1 && !deleteBtn) {
                    // 1ì°¨ ê±°ë˜ í–‰ì´ ì•„ë‹Œë° ë²„íŠ¼ì´ ì—†ë‹¤ë©´ ì¶”ê°€ (addPurchaseRowì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë˜ì§€ë§Œ ì•ˆì „ì¥ì¹˜)
                    const deleteButtonHtml = `<button onclick="removePurchaseRow(this)" class="p-2 text-red-500 hover:text-red-700 transition-colors" title="ì‚­ì œ"><i class="fa-solid fa-trash-can text-sm"></i></button>`;
                    const inputs = row.querySelectorAll('.stock-price');
                    if (inputs.length > 0) {
                        inputs[inputs.length - 1].insertAdjacentHTML('afterend', deleteButtonHtml);
                    }
                } else if (rowNum > 1 && deleteBtn) {
                    deleteBtn.style.display = 'block';
                }
            });
        }

        function calculateAveragePrice() {
            let totalCost = 0;
            let totalQuantity = 0;
            const rows = document.querySelectorAll('#average-calculator-inputs .purchase-row');

            rows.forEach(row => {
                const quantityInput = row.querySelector('.stock-qty');
                const priceInput = row.querySelector('.stock-price');

                if (quantityInput && priceInput) {
                    const quantity = parseFloat(quantityInput.value) || 0;
                    const price = parseFloat(priceInput.value) || 0;

                    if (quantity >= 0 && price >= 0) {
                        totalQuantity += quantity;
                        totalCost += quantity * price;
                    }
                }
            });

            const averagePrice = totalQuantity > 0 ? totalCost / totalQuantity : 0;

            // ğŸ’¡ ìˆ˜ì •: ê²°ê³¼ ë¼ë²¨ ë³€ê²½ 
            document.getElementById('total-cost').textContent = `${formatNum(totalCost)} ì›`;
            document.getElementById('total-qty').textContent = `${formatNum(totalQuantity)} ì£¼`;
            
            const avgPriceElement = document.getElementById('average-price');
            if (averagePrice > 0) {
                avgPriceElement.textContent = formatNum(averagePrice.toFixed(2));
            } else {
                avgPriceElement.textContent = '-';
            }
        }
        
        // === ê´€ì‹¬ ì¢…ëª© ì¦ê²¨ì°¾ê¸° ë¡œì§ (Local Storage ìœ ì§€) ===
        function getFavorites() {
            const favs = localStorage.getItem('stockFavorites');
            return favs ? JSON.parse(favs) : ['005930', '005380', '196170']; 
        }

        function toggleFavorite() {
            let favs = getFavorites();
            const btn = document.getElementById('btn-favorite');
            
            if (favs.includes(currentSymbol)) {
                favs = favs.filter(s => s !== currentSymbol); // ì‚­ì œ
                btn.className = "text-slate-300 hover:text-yellow-400 transition-colors text-3xl";
            } else {
                favs.push(currentSymbol); // ì¶”ê°€
                btn.className = "text-yellow-400 hover:text-yellow-500 transition-colors text-3xl drop-shadow-sm";
            }
            
            localStorage.setItem('stockFavorites', JSON.stringify(favs));
            fetchWatchlistData();
        }

        function updateFavoriteBtnState() {
            const favs = getFavorites();
            const btn = document.getElementById('btn-favorite');
            if (favs.includes(currentSymbol)) {
                btn.className = "text-yellow-400 hover:text-yellow-500 transition-colors text-3xl drop-shadow-sm";
            } else {
                btn.className = "text-slate-300 hover:text-yellow-400 transition-colors text-3xl";
            }
        }

        async function fetchWatchlistData() {
            const favs = getFavorites();
            const container = document.getElementById('watchlist-container');
            
            if (!container) return; 

            if (favs.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-xs text-slate-400">â˜… ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¢…ëª©ì„ ì¶”ê°€í•´ë³´ì„¸ìš”.</div>';
                return;
            }

            container.innerHTML = ''; 

            // FLAT_STOCK_MAPì—ì„œ ë°ì´í„° ë¡œë“œ (ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„° ì¼ê´€ì„± ìœ ì§€)
            const results = favs.map(symbol => getSimulatedStockData(symbol));
            
            results.forEach(data => {
                // ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš° ê±´ë„ˆëœë‹ˆë‹¤.
                if (!data || data.is_mock === true) return; 
                
                const item = document.createElement('div');
                item.className = "p-3 flex justify-between items-center cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors";
                item.onclick = () => {
                    document.getElementById('symbol-input').value = data.symbol;
                    fetchAllData();
                };

                const changeSign = data.change_percent > 0 ? '+' : '';
                const colorClass = getColor(data.change_percent);
                
                item.innerHTML = `
                    <div>
                        <div class="font-bold text-sm text-slate-700 dark:text-slate-200">${data.name} <span class="text-xs text-slate-400 ml-1">(${data.symbol})</span></div>
                        <div class="text-xs text-slate-400">ì‹œì´: ${getStockDetailsBySymbol(data.symbol).cap}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-lg dark:text-white">${formatNum(data.price)}</div>
                        <div class="text-xs ${colorClass} font-bold">
                            ${changeSign}${formatNum(data.change_percent.toFixed(2))}%
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });
        }


        // === ë©”ì¸ íƒ­ ì „í™˜ (ë‰´ìŠ¤) ===
        function switchTab(tab) {
            // ì»¤ë®¤ë‹ˆí‹° íƒ­ì´ ì‚­ì œë˜ì—ˆìœ¼ë¯€ë¡œ, ì˜¤ì§ ë‰´ìŠ¤ íƒ­ë§Œ ì²˜ë¦¬
            if(tab === 'news') {
                fetchGroundedNews(currentSymbol, document.getElementById('main-name').textContent);
            }
        }
        
        // ğŸ’¡ ìˆ˜ì •: í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ Gemini API ì§ì ‘ í˜¸ì¶œ ë¡œì§ (JSON Schema í¬í•¨)
        async function fetchGroundedNews(symbol, name) {
            const newsBox = document.getElementById('content-news');
            const apiKey = loadApiKey();
            const maxRetries = 3;
            const model = "gemini-2.5-flash-preview-09-2025";
            
            // 1. API í‚¤ ìœ íš¨ì„± ê²€ì‚¬
            if (!apiKey) {
                newsBox.innerHTML = `
                    <div class="text-center py-10 p-5 rounded-xl border-2 border-red-300 bg-red-50 dark:bg-red-900/20 text-red-500/80">
                        <i class="fa-solid fa-triangle-exclamation mr-2 text-xl"></i> 
                        <strong>Gemini API Keyê°€ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</strong>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mt-2">API í‚¤ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì‹œë©´ ë‰´ìŠ¤ ê²€ìƒ‰ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }

            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            newsBox.innerHTML = `
                <div class="text-center py-10 text-slate-400">
                    <i class="fa-solid fa-magnifying-glass text-blue-500 mr-2 text-xl fa-bounce"></i> 
                    <p class="mt-2 text-sm">ì‹¤ì‹œê°„ ì›¹ ê²€ìƒ‰ì„ í†µí•´ ${name} ê´€ë ¨ ë‰´ìŠ¤ë¥¼ ë¶„ì„ ì¤‘...</p>
                </div>
            `;
            
            const systemPrompt = `Act as a senior financial analyst and news curator for a South Korean stock market dashboard. Your task is to find the most relevant, up-to-date news and disclosures about the company "${name}" (Stock Code: ${symbol}). Based on the search results, output a clean JSON array with 5-6 articles. The response MUST be a single JSON array structure that ONLY contains the following properties for each object, and nothing else.
            1. title: The title of the article (Korean).
            2. summary: A concise, 2-3 sentence summary of the article's core finding or impact (Korean).
            3. source: The original source of the news (e.g., 'Google Search', 'Yonhap News', 'DART Disclosure'). If the search result is a corporate filing, set the source to 'ì£¼ìš” ê³µì‹œ (DART)' if it's a DART/KRX filing. Otherwise, use the actual news source name.
            `;
            
            const userQuery = `Find the latest 5-6 news articles or corporate disclosures about the South Korean stock, ${name} (Code: ${symbol}). Prioritize articles from major Korean or global news agencies.`;

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], 
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "title": { "type": "STRING", "description": "The headline of the article in Korean." },
                                "summary": { "type": "STRING", "description": "A 2-3 sentence summary of the news in Korean." },
                                "source": { "type": "STRING", "description": "The name of the source (e.g., Yonhap News, DART)." }
                            },
                            required: ["title", "summary", "source"]
                        }
                    }
                }
            };
            
            let result;
            let success = false;
            let lastError = null;
            let attempt = 0;

            while (!success && attempt < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    result = await response.json();
                    
                    if (response.ok && result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        
                        const jsonText = result.candidates[0].content.parts[0].text.trim();
                        // ëª¨ë¸ì´ ê°€ë” ```json ... ``` ìœ¼ë¡œ ê°ì‹¸ì„œ ë³´ë‚´ë¯€ë¡œ, JSON ë°°ì—´ ë¶€ë¶„ë§Œ ì¶”ì¶œ
                        const jsonMatch = jsonText.match(/\[.*\]/s); 

                        if (jsonMatch) {
                            // ëª¨ë¸ì´ ìƒì„±í•œ JSON ë°°ì—´ í…ìŠ¤íŠ¸ë¥¼ íŒŒì‹±
                            const data = JSON.parse(jsonMatch[0]); 
                            if (Array.isArray(data) && data.length > 0) {
                                success = true;
                                renderNewsContent(newsBox, data, name);
                                break; 
                            }
                        }
                        lastError = "Model output was not a valid, non-empty JSON array.";

                    } else if (result.error) {
                        // Rate Limit ë˜ëŠ” API ì˜¤ë¥˜ ì²˜ë¦¬
                        lastError = result.error.message || `API Error: ${result.error.code}`;
                        if (lastError.includes("API key not valid")) {
                            lastError = "API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.";
                            break; 
                        }
                        if (lastError.includes("quota")) {
                            lastError = "í• ë‹¹ëŸ‰ ì´ˆê³¼. API í‚¤ì˜ ì‚¬ìš©ëŸ‰ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
                            break;
                        }
                    } else {
                        lastError = "Response structure invalid or empty content.";
                    }

                } catch (error) {
                    lastError = error.message;
                }
                
                attempt++;
                if (!success && attempt < maxRetries) {
                    // console.log(`Retry attempt ${attempt} in ${Math.pow(2, attempt) * 1000}ms...`);
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000)); 
                }
            }
            
            // ìµœì¢… ì‹¤íŒ¨ ì²˜ë¦¬
            if (!success) {
                newsBox.innerHTML = `
                    <div class="text-center py-10 p-5 rounded-xl border-2 border-red-300 bg-red-50 dark:bg-red-900/20 text-red-500/80">
                        <i class="fa-solid fa-triangle-exclamation mr-2 text-xl"></i> 
                        <strong>ë‰´ìŠ¤ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</strong>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mt-2">${lastError || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}</p>
                        <p class="text-xs text-slate-400 mt-2">API í‚¤ì™€ í• ë‹¹ëŸ‰ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>
                    </div>
                `;
            }
        }

        // ğŸ’¡ ìˆ˜ì •: ë‰´ìŠ¤ ë Œë”ë§ í•¨ìˆ˜ ë¶„ë¦¬ (Sourceì— 'Gemini' ëª…ì‹œ)
        function renderNewsContent(newsBox, data, name) {
            let majorDisclosureHTML = '';
            let regularNewsHTML = '';

            data.forEach((item) => {
                const isDisclosure = item.source && (item.source.includes('DART') || item.source.includes('ê³µì‹œ'));
                const title = item.title.includes(name) ? item.title : `[${name}] ${item.title}`;
                const searchLink = `https://www.google.com/search?q=${encodeURIComponent(`${item.title} ${name}`)}`;

                const html = `
                    <a href="${searchLink}" target="_blank" 
                       class="block p-3 ${isDisclosure ? 'rounded-xl shadow-lg border-2 border-dashed border-red-400/50 bg-red-50/50 dark:bg-red-900/10' : 'bg-slate-50 rounded-xl border border-slate-200 dark:bg-slate-700 dark:border-slate-600'} 
                       hover:shadow-xl transition-all"
                       title="${item.summary} - ì¶œì²˜: ${item.source}">
                        
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs font-extrabold ${isDisclosure ? 'bg-red-500 text-white px-2 py-0.5 rounded-full' : 'text-slate-500 dark:text-slate-400'} shadow-inner">
                                ${isDisclosure ? 'ì£¼ìš” ê³µì‹œ (DART)' : 'ê²€ìƒ‰ ë‰´ìŠ¤ (Gemini)'}
                            </span>
                            <span class="text-xs text-slate-500 dark:text-slate-400 font-normal ml-auto">${item.source}</span>
                        </div>
                        <div class="font-bold ${isDisclosure ? 'text-lg text-red-700 dark:text-red-300' : 'text-sm text-slate-800 dark:text-white'} leading-snug">
                            ${title}
                        </div>
                        <div class="text-xs mt-1 text-slate-600 dark:text-slate-400 line-clamp-2">${item.summary}</div>
                    </a>
                `;

                if (isDisclosure && majorDisclosureHTML === '') {
                    majorDisclosureHTML = html; 
                } else if (!isDisclosure) {
                    regularNewsHTML += html;
                }
            });

            newsBox.innerHTML = majorDisclosureHTML + regularNewsHTML;
            if (newsBox.innerHTML === '') {
                newsBox.innerHTML = '<div class="text-center py-10 text-slate-400">ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        // === ë°ì´í„° ë¡œì§ ===
        async function fetchAllData() {
            const sym = document.getElementById('symbol-input').value;
            currentSymbol = sym;
            
            updateFavoriteBtnState(); 
            
            const data = getSimulatedStockData(sym);
            renderMain(data);

            // ë‰´ìŠ¤ íƒ­ë§Œ ë‚¨ì•„ìˆìœ¼ë¯€ë¡œ ë¬´ì¡°ê±´ ë‰´ìŠ¤ ê²€ìƒ‰ ì‹¤í–‰
            fetchGroundedNews(currentSymbol, data.name);
            
            fetchMarketData(); 
        }

        // ğŸ’¡ ìˆ˜ì •: renderMain í•¨ìˆ˜ ì¶”ê°€ (ì£¼ìš” ì¢…ëª© ì •ë³´ ì—…ë°ì´íŠ¸)
        function renderMain(data) {
            const colorClass = getColor(data.change_percent);
            const changeSign = data.change_percent > 0 ? 'â–²' : (data.change_percent < 0 ? 'â–¼' : '');
            
            document.getElementById('main-name').textContent = data.name;
            document.getElementById('main-symbol').textContent = data.symbol;
            document.getElementById('main-price').textContent = formatNum(data.price);
            document.getElementById('main-price').className = `text-4xl font-extrabold ${colorClass}`;
            
            // ê¸ˆì•¡ ë³€í™”ì™€ í¼ì„¼íŠ¸ ë³€í™”ë¥¼ ë¬¶ì–´ì„œ í‘œì‹œ
            document.getElementById('main-change').innerHTML = `
                ${changeSign} ${formatNum(Math.abs(data.change))} 
                <span class="text-2xl font-bold">(${data.change_percent > 0 ? '+' : ''}${formatNum(data.change_percent.toFixed(2))}%)</span>
            `;
            document.getElementById('main-change').className = `text-lg font-bold ${colorClass}`;

            const details = getStockDetailsBySymbol(data.symbol);
            document.getElementById('stock-meta-info').innerHTML = `
                <p class="text-sm text-slate-700 dark:text-slate-300">
                    <i class="fa-solid fa-money-bill-wave text-green-500 mr-1"></i> 
                    <strong>ì‹œê°€ì´ì•¡:</strong> <span class="font-mono font-bold">${details.cap}</span>
                </p>
                <p class="text-sm text-slate-700 dark:text-slate-300 mt-1">
                    <i class="fa-solid fa-trophy text-yellow-500 mr-1"></i> 
                    <strong>ì‹œì¥ ìˆœìœ„:</strong> <span class="font-mono font-bold">${details.rank}</span>
                </p>
            `;
            
            // ë§í¬ ì—…ë°ì´íŠ¸ (DARTëŠ” ì¢…ëª©ì½”ë“œë¥¼ ì¿¼ë¦¬ë¡œ ì‚¬ìš©)
            document.getElementById('link-naver').href = `https://finance.naver.com/item/main.naver?code=${data.symbol}`;
            document.getElementById('link-dart').href = `https://dart.fss.or.kr/dsac001/main.do?selectDate=20250101&textCrpName=${data.symbol}`;
            
            drawStockChart(data.price, data.change_percent);
        }

        function fetchMarketData() {
            // ì§€í‘œ ë°ì´í„° ì‹œë®¬ë ˆì´ì…˜ ë° ì—…ë°ì´íŠ¸
            INDICES.forEach(i => {
                const data = getSimulatedStockData(i.id);
                const priceElement = document.getElementById(`idx-p-${i.id}`);
                const changeElement = document.getElementById(`change-${i.id}`);

                if (priceElement && changeElement) {
                    const colorClass = getColor(data.change_percent);
                    const changeSign = data.change_percent > 0 ? '+' : '';

                    priceElement.textContent = formatNum(data.price);
                    changeElement.innerHTML = `${changeSign}${formatNum(data.change_percent.toFixed(2))}%`;
                    changeElement.className = `text-xs font-bold mt-1 index-change ${colorClass}`;
                }
            });

             // í™˜ìœ¨ ì‹œì„¸ ì—…ë°ì´íŠ¸ (USD, EUR, JPY)
            updateCurrencyRate();
            
            // ë§ˆì¼“ë§µê³¼ ê´€ì‹¬ì¢…ëª© ë°ì´í„°ëŠ” fetchAllDataì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë˜ê±°ë‚˜ ì´í›„ í˜¸ì¶œë¨
            renderMarketMap(currentFilterMode, currentSortBy);
            fetchWatchlistData();
        }
        
        // ì£¼ê°€ ì°¨íŠ¸ ì‹œë®¬ë ˆì´ì…˜ í•¨ìˆ˜ -> ìº”ë“¤ì°¨íŠ¸ ë¡œì§ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        function drawStockChart(price, change) {
            const canvas = document.getElementById('stock-chart-canvas');
            const loading = document.getElementById('chart-loading');
            
            if (!canvas) return;

            // ë°˜ì‘í˜• ì²˜ë¦¬ë¥¼ ìœ„í•´ ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ ë¶€ëª¨ ìš”ì†Œì— ë§ì¶° ì¬ì„¤ì •
            const containerWidth = canvas.parentElement.clientWidth;
            canvas.width = containerWidth;
            canvas.height = 150; 

            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            loading.classList.remove('hidden');

            // ì°¨íŠ¸ ë¡œì§ì— í•„ìš”í•œ ìƒìˆ˜ ì •ì˜
            const dataPoints = 12;
            const fixedRandoms = [0.3, 0.7, 0.5, 0.2, 0.8, 0.4, 0.6, 0.9, 0.1, 0.55, 0.45, 1.0]; 
            const basePrice = price / (1 + change / 100); 
            const dailyRange = Math.abs(change) * 1.5; 

            // ìº”ë²„ìŠ¤ ê·¸ë¦¬ê¸° ì½”ë“œëŠ” ë¹„ë™ê¸° ì²˜ë¦¬
            setTimeout(() => {
                loading.classList.add('hidden');

                const OHLCData = [];
                
                let minVal = basePrice * 0.98; 
                let maxVal = basePrice * 1.02;

                let lastClose = basePrice;
                
                // 1. OHLC ë°ì´í„° ê³„ì‚°
                for (let i = 0; i < dataPoints; i++) {
                    const r1 = fixedRandoms[i] * 0.005; 
                    const r2 = fixedRandoms[i] * 0.5 + 0.5; 
                    const r3 = fixedRandoms[(i + 1) % dataPoints]; 
                    const r4 = fixedRandoms[(i + 2) % dataPoints]; 

                    const open = lastClose * (1 + (0.5 - r1)); 
                    
                    const variance = dailyRange * r2; 
                    const highLowDiff = open * (variance / 100);
                    
                    const high = open + highLowDiff * r3;
                    const low = open - highLowDiff * (1 - r3);
                    
                    let close;
                    if (i === dataPoints - 1) {
                         close = price; 
                    } else {
                        close = open + (r4 - 0.5) * highLowDiff;
                    }

                    const candleHigh = Math.max(open, close, high);
                    const candleLow = Math.min(open, close, low);

                    OHLCData.push({ open, high: candleHigh, low: candleLow, close });

                    minVal = Math.min(minVal, candleLow);
                    maxVal = Math.max(maxVal, candleHigh);
                    lastClose = close;
                }
                
                // 2. ì°¨íŠ¸ ê·¸ë¦¬ê¸° ì„¤ì •
                const width = canvas.width;
                const height = canvas.height;
                const padding = 10;
                const chartHeight = height - padding * 2;
                const chartWidth = width - padding * 2;
                const priceRange = maxVal - minVal;
                const barWidth = chartWidth / dataPoints * 0.6;
                const gap = chartWidth / dataPoints * 0.4;
                
                const getY = (value) => height - padding - ((value - minVal) / priceRange) * chartHeight;

                // 3. ìº”ë“¤ ê·¸ë¦¬ê¸°
                for (let i = 0; i < dataPoints; i++) {
                    const data = OHLCData[i];
                    const x = padding + i * (barWidth + gap) + gap / 2;
                    
                    const openY = getY(data.open);
                    const closeY = getY(data.close);
                    const highY = getY(data.high);
                    const lowY = getY(data.low);

                    const isRising = data.close > data.open;
                    const bodyTop = isRising ? closeY : openY;
                    const bodyBottom = isRising ? openY : closeY;
                    const bodyHeight = Math.max(1, bodyBottom - bodyTop); 

                    ctx.fillStyle = isRising ? '#ef4444' : '#3b82f6'; 
                    ctx.strokeStyle = isRising ? '#ef4444' : '#3b82f6';

                    ctx.beginPath();
                    ctx.moveTo(x + barWidth / 2, highY);
                    ctx.lineTo(x + barWidth / 2, lowY);
                    ctx.stroke();

                    ctx.fillRect(x, bodyTop, barWidth, bodyHeight);
                }
                
                // 4. í˜„ì¬ê°€ ê¸°ì¤€ì„  ê·¸ë¦¬ê¸°
                ctx.beginPath();
                ctx.strokeStyle = change > 0 ? '#ef4444' : (change < 0 ? '#3b82f6' : '#94a3b8');
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 2]); 

                const currentY = getY(price);
                ctx.moveTo(padding, currentY);
                ctx.lineTo(width - padding, currentY);
                ctx.stroke();
                ctx.closePath();
                ctx.setLineDash([]); 

            }, 200); 
        }

        // 3D Tilt íš¨ê³¼ ê´€ë ¨ JavaScript í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        const TILT_MAX_ROTATE = 5; 
        const TILT_PERSPECTIVE = 800;
        const BASE_SHADOW_LIGHT = '0 6px 15px rgba(0, 0, 0, 0.15)';
        const BASE_SHADOW_DARK = '0 6px 15px rgba(255, 255, 255, 0.08)';


        function handleTilt(event, element) {
            if (currentSortBy === 'sector_list') return; 

            const rect = element.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            const mouseX = event.clientX - centerX;
            const mouseY = event.clientY - centerY;

            const tiltX = (mouseY / rect.height) * (TILT_MAX_ROTATE * 2); 
            const tiltY = (mouseX / rect.width) * (TILT_MAX_ROTATE * 2);  
            
            const rotateX = Math.min(Math.max(-TILT_MAX_ROTATE, tiltX), TILT_MAX_ROTATE) * -1;
            const rotateY = Math.min(Math.max(-TILT_MAX_ROTATE, tiltY), TILT_MAX_ROTATE);
            
            const isDark = document.documentElement.classList.contains('dark');
            const shadowColor = isDark ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.3)';
            
            // ë“±ë½ë¥ ì— ë”°ë¥¸ ë°œê´‘ íš¨ê³¼ ì¶”ê°€
            // FLAT_STOCK_MAPì„ ì‚¬ìš©í•˜ì—¬ ë°ì´í„° ì¡°íšŒ ë‹¨ìˆœí™”
            const stockCode = element.dataset.code;
            const stockData = FLAT_STOCK_MAP[stockCode];
            
            let glow = '';
            if (stockData) {
                if (stockData.change > 2) glow = `0 0 10px 0 #ef4444`; // ê°•í•œ ìƒìŠ¹
                else if (stockData.change > 0) glow = `0 0 5px 0 #fca5a5`; // ì•½í•œ ìƒìŠ¹
                else if (stockData.change < -2) glow = `0 0 10px 0 #3b82f6`; // ê°•í•œ í•˜ë½
                else if (stockData.change < 0) glow = `0 0 5px 0 #93c5fd`; // ì•½í•œ í•˜ë½
            }

            element.style.transform = `perspective(${TILT_PERSPECTIVE}px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
            element.style.boxShadow = `${(tiltY/4).toFixed(1)}px ${(tiltX/4).toFixed(1)}px 30px ${shadowColor}${glow ? `, ${glow}` : ''}`;
        }

        function resetTilt(element) {
            if (currentSortBy === 'sector_list') return; 

            const isDark = document.documentElement.classList.contains('dark');
            element.style.transform = `perspective(${TILT_PERSPECTIVE}px) rotateX(0deg) rotateY(0deg)`;
            element.style.boxShadow = isDark ? BASE_SHADOW_DARK : BASE_SHADOW_LIGHT; 
        }

        // ì‹œì¥ ì ìœ ìœ¨ì— ë”°ë¥¸ ê·¸ë¦¬ë“œ ì»¬ëŸ¼ ìŠ¤íŒ¬ ê³„ì‚° (Cap Viewì—ì„œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
        function getColSpanForMarketShare(marketShare) {
             const sharePercent = marketShare * 100;
            if (sharePercent >= 50) return 12; 
            if (sharePercent >= 35) return 8;  
            if (sharePercent >= 25) return 6; 
            if (sharePercent >= 15) return 5; 
            if (sharePercent >= 10) return 4; 
            if (sharePercent >= 5) return 3;   
            return 2;                          
        }


        // Market Map í•„í„°ë§ ë° ë Œë”ë§ (í•µì‹¬ ìˆ˜ì •)
        function renderMarketMap(filterMode, sortBy) {
            
            currentFilterMode = filterMode;
            currentSortBy = sortBy;

            const buttons = ['all', 'kospi_top_60', 'kosdaq_top_60'];
            buttons.forEach(id => {
                const btn = document.getElementById(`filter-${id}`);
                const isActive = id.toUpperCase() === filterMode;
                if (btn) {
                    btn.className = isActive
                        ? 'px-3 py-1.5 rounded-xl text-xs font-bold bg-blue-600 text-white hover:bg-blue-700 transition-colors shadow-md'
                        : 'px-3 py-1.5 rounded-xl text-xs font-medium border border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors';
                }
            });
            
            const sortBySelect = document.getElementById('sort-by-select');
            if(sortBySelect) sortBySelect.value = sortBy;

            // 3. ì¢…ëª© í•„í„°ë§ ë° ë­í¬ í™•ì •
            let totalCapBySector = {};
            
            // KOSPI Top 50, KOSDAQ Top 60ì„ ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§
            const filterMarket = filterMode === 'KOSPI_TOP_60' ? 'KOSPI' : (filterMode === 'KOSDAQ_TOP_60' ? 'KOSDAQ' : null);
            const maxStocks = filterMarket === 'KOSPI' ? 50 : (filterMarket === 'KOSDAQ' ? 78 : 110); 
            
            let allStocks = Object.values(FLAT_STOCK_MAP); // Flat Map ì‚¬ìš©
            
            let marketStocks = allStocks;
            if (filterMarket) {
                marketStocks = allStocks.filter(s => s.market === filterMarket);
            }
            
            // ì‹œê°€ì´ì•¡(cap) ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•˜ê³  rankë¥¼ ì¬í• ë‹¹
            marketStocks.sort((a, b) => b.cap - a.cap); 
            
            marketStocks.forEach((stock, index) => { 
                stock.rank = index + 1; 
            });

            // ìƒìœ„ maxStocks ê°œìˆ˜ë§Œí¼ë§Œ í‘œì‹œ
            let stocksToRender = marketStocks.slice(0, maxStocks); 
            const totalMarketCap = stocksToRender.reduce((sum, s) => sum + s.cap, 0);
            
            let finalStocksBySector = {};
            
            stocksToRender.forEach((stock) => { 
                // ì¢…ëª©ì´ ì†í•œ ì„¹í„°ë¥¼ ì°¾ìŠµë‹ˆë‹¤. (Flat Mapì— ì €ì¥ëœ sector ì •ë³´ ì‚¬ìš©)
                const sectorName = stock.sector || 'ê¸°íƒ€';

                if (!finalStocksBySector[sectorName]) {
                    finalStocksBySector[sectorName] = [];
                    totalCapBySector[sectorName] = 0;
                }
                
                finalStocksBySector[sectorName].push(stock);
                totalCapBySector[sectorName] += stock.cap;
            });
            
            // ì„¹í„°ë³„ í‰ê·  ë“±ë½ë¥  ê³„ì‚° ë° ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            sectorPerformance = {};
            Object.keys(finalStocksBySector).forEach(sectorName => {
                const stocks = finalStocksBySector[sectorName];
                if (stocks.length > 0) {
                    const totalChange = stocks.reduce((sum, s) => sum + s.change, 0);
                    sectorPerformance[sectorName] = totalChange / stocks.length;
                } else {
                    sectorPerformance[sectorName] = 0;
                }
            });
            
            // Market Breadth ê³„ì‚° ë° ì—…ë°ì´íŠ¸
            const totalCount = stocksToRender.length;
            const upCount = stocksToRender.filter(s => s.change > 0).length;
            const downCount = stocksToRender.filter(s => s.change < 0).length;
            const neutralCount = totalCount - upCount - downCount;
            const upPercent = totalCount > 0 ? (upCount / totalCount) * 100 : 0;
            const downPercent = totalCount > 0 ? (downCount / totalCount) * 100 : 0;
            const neutralPercent = totalCount > 0 ? (neutralCount / totalCount) * 100 : 0;


            document.getElementById('breadth-up-count').textContent = `${upCount}ê°œ (${upPercent.toFixed(1)}%)`;
            document.getElementById('breadth-down-count').textContent = `${downCount + neutralCount}ê°œ (${(downPercent + neutralPercent).toFixed(1)}%)`;
            
            const upBar = document.getElementById('breadth-up-bar');
            upBar.style.width = `${upPercent}%`;
            upBar.classList.toggle('breadth-bar-red', upPercent > 50); // 50%ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìƒ‰ìƒ ë³€ê²½
            upBar.classList.toggle('bg-blue-500', upPercent <= 50);
            
            // 4. ëª¨ë“  ì¢…ëª©ì„ ìˆœì„œëŒ€ë¡œ ë Œë”ë§
            const container = document.getElementById('market-map-container');
            let globalStockCount = stocksToRender.length;

            if (stocksToRender.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-slate-400">ì„ íƒëœ ëª¨ë“œ(${filterMode})ì— í•´ë‹¹í•˜ëŠ” ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }
            
            let stockCountMessage = filterMarket ? `${filterMarket} Top ${maxStocks} ì¤‘ ${globalStockCount}ê°œ í‘œì‹œë¨` : `ì´ ${globalStockCount}ê°œ í‘œì‹œë¨`;
            
            const isCapSort = currentSortBy === 'cap';

            // ì´ ì‹œê°€ì´ì•¡ í‘œì‹œ ì˜ì—­ ì¶”ê°€
            const totalCapHtml = `<span class="text-blue-600 dark:text-blue-400 font-extrabold" id="total-market-cap">${formatCap(totalMarketCap)}</span>`;

            let mapContentHtml = `
                <div class="text-sm text-slate-500 dark:text-slate-400 mb-4 font-semibold flex justify-between items-center">
                    <span>${isCapSort ? 'ì‹œê°€ì´ì•¡ ì§€ë„ ë³´ê¸° (ì¢…ëª©ë³„ ë¹„ë¡€ í¬ê¸°)' : 'ì—…ì¢…ë³„ ëª©ë¡ ë³´ê¸°'} (${stockCountMessage})</span>
                    <span>ì´ ì‹œê°€ì´ì•¡: ${totalCapHtml}</span>
                </div>
            `;

            if (sortBy === 'sector_list') {
                // --- SECTOR LIST VIEW (ì—…ì¢…ë³„ ëª©ë¡ ë³´ê¸° - ê¸°ì¡´ ë¡œì§ ìœ ì§€) ---
                mapContentHtml += `<div class="bg-white p-4 rounded-2xl shadow-xl border border-slate-200 dark:bg-slate-800 dark:border-slate-700 space-y-6">`;
                
                const sortedSectors = Object.keys(finalStocksBySector).sort((a, b) => {
                    return totalCapBySector[b] - totalCapBySector[a]; 
                });

                sortedSectors.forEach(sectorName => {
                    const stocks = finalStocksBySector[sectorName];
                    if (stocks.length > 0) {
                        stocks.sort((a, b) => b.cap - a.cap); 
                        
                        const sectorBorderClass = getSectorBorderColor(sectorName);
                        const avgChange = sectorPerformance[sectorName];
                        const avgChangeColorClass = getColor(avgChange);
                        const avgChangeSign = avgChange > 0 ? '+' : '';

                        mapContentHtml += `
                            <div class="border-l-4 ${sectorBorderClass} pl-4 p-3 bg-slate-50/50 dark:bg-slate-700/30 rounded-lg shadow-sm">
                                <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200 mb-2 flex justify-between items-center">
                                    <span>
                                        <i class="fa-solid fa-layer-group mr-1 text-slate-500"></i> ${sectorName} 
                                        <span class="text-sm text-slate-500">(${stocks.length}ê°œ)</span>
                                    </span>
                                    <span class="text-xs font-bold ${avgChangeColorClass} bg-white dark:bg-slate-800 px-3 py-1 rounded-full border border-slate-200 dark:border-slate-700">
                                        í‰ê· : ${avgChangeSign}${formatNum(avgChange.toFixed(2))}%
                                    </span>
                                </h3>
                                
                                <div class="flex text-xs font-bold text-slate-500 dark:text-slate-400 border-b border-slate-200 dark:border-slate-700 pb-1 mt-3">
                                    <div class="w-[30%] pl-8">ì¢…ëª©ëª…</div>
                                    <div class="w-[20%] text-right">í˜„ì¬ê°€</div>
                                    <div class="w-[15%] text-center">ë“±ë½ë¥ </div>
                                    <div class="w-[25%] text-center">ì„¹í„° ê°•ë„</div>
                                    <div class="w-[10%] text-right">ì‹œì´</div>
                                </div>
                                
                                <div class="space-y-1 mt-1">
                        `;

                        stocks.forEach(stock => {
                            const colorClass = getColor(stock.change);
                            const changeSign = stock.change > 0 ? '+' : '';
                            const formattedCap = formatCap(stock.cap);
                            
                            const relativeStrength = stock.change - avgChange;
                            const relativeStrengthBarHtml = getRelativeStrengthBarHtml(relativeStrength);

                            const rank = stock.rank;
                            let rankIcon = rank <= 3 ? (rank === 1 ? 'ğŸ¥‡' : (rank === 2 ? 'ğŸ¥ˆ' : 'ğŸ¥‰')) : '';
                            let rankTitle = `ì‹œì´ ìˆœìœ„: ${rank}ìœ„`;

                            mapContentHtml += `
                                <div onclick="document.getElementById('symbol-input').value='${stock.code}'; fetchAllData()" 
                                     class="flex items-center p-2 bg-white hover:bg-slate-100 dark:bg-slate-800 dark:hover:bg-slate-700 rounded-xl cursor-pointer transition-shadow border border-slate-200 dark:border-slate-700 hover:shadow-md">

                                    <!-- 1. Name & Code (30%) + Rank -->
                                    <div class="w-[30%] font-medium text-sm text-slate-800 dark:text-slate-100 truncate flex-1 flex items-center">
                                        <!-- Rank Badge (Updated) -->
                                        <span class="text-sm mr-2" title="${rankTitle}">${rankIcon || rank}</span>
                                        ${stock.name} 
                                        <span class="text-xs font-normal text-slate-400 ml-1">(${stock.code})</span>
                                    </div>

                                    <!-- 2. Price (20%) -->
                                    <div class="w-[20%] text-right font-bold text-base dark:text-white">
                                        ${formatNum(stock.price)}
                                    </div>

                                    <!-- 3. Change % (15%) - Highlighted -->
                                    <div class="w-[15%] text-center text-xs ml-2">
                                        <span class="font-bold ${colorClass} bg-red-500/10 dark:bg-red-900/30 px-2.5 py-1 rounded-full whitespace-nowrap">
                                            ${changeSign}${formatNum(stock.change)}%
                                        </span>
                                    </div>
                                    
                                    <!-- 4. Sector Strength Bar (25%) - New Visual -->
                                    <div class="w-[25%] text-center px-4">
                                        ${relativeStrengthBarHtml}
                                    </div>


                                    <!-- 5. Cap (10%) - Simplified -->
                                    <div class="w-[10%] text-right text-xs text-slate-500 dark:text-slate-400">
                                        ${formattedCap.replace('ì¡° ì›', 'ì¡°')}
                                    </div>
                                </div>
                            `;
                        });

                        mapContentHtml += `
                                </div>
                            </div>
                        `;
                    }
                });

                mapContentHtml += `</div>`;
            } else {
                // --- PROPORTIONAL BASKET VIEW (ì‹œê°€ì´ì•¡ ì§€ë„ - DYNAMIC PROPORTIONAL FLOW) ---
                
                // 1. ì„¹í„°ë³„ ì‹œê°€ì´ì•¡ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
                const sortedSectors = Object.keys(finalStocksBySector).sort((a, b) => totalCapBySector[b] - totalCapBySector[a]);
                
                // 2. Global Min/Max Cap ê³„ì‚° (4ë°° ë¹„ìœ¨ ê³„ì‚°ì„ ìœ„í•¨)
                const global_min_cap = stocksToRender.length > 0 
                    ? stocksToRender.reduce((min, s) => Math.min(min, s.cap), Infinity) 
                    : 0;
                const global_max_cap = stocksToRender.length > 0 
                    ? stocksToRender.reduce((max, s) => Math.max(max, s.cap), -Infinity) 
                    : 0;

                const CAP_RANGE = global_max_cap - global_min_cap;
                const MIN_CARD_WIDTH_PX = 100; // ê°€ì¥ ì‘ì€ ì¢…ëª© í¬ê¸° (100px)
                const MAX_CARD_WIDTH_PX = 400; // ê°€ì¥ í° ì¢…ëª© í¬ê¸° (4ë°°ì¸ 400px)
                const WIDTH_RANGE = MAX_CARD_WIDTH_PX - MIN_CARD_WIDTH_PX;
                // âœ… FIX: ë‚´ìš© ì˜ë¦¼ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ìµœì†Œ ë†’ì´ë¥¼ 120pxë¡œ ì¦ê°€
                const FIXED_CARD_HEIGHT_PX = 120; // ì¢…ëª© ì¹´ë“œì˜ ë†’ì´ëŠ” ê³ ì •

                
                // 3. ë©”ì¸ ì»¨í…Œì´ë„ˆ ì„¤ì •: ê° ì„¹í„°ë¥¼ w-fullë¡œ ë°°ì¹˜
                let proportionalHtml = `<div id="treemap-visualizer" class="flex flex-col gap-4 w-full h-auto min-h-[500px] rounded-2xl overflow-y-auto shadow-xl border border-slate-200 dark:border-slate-700 bg-slate-100 dark:bg-slate-800 transform-gpu p-3">`;

                
                // 4. ê°œë³„ ì„¹í„° ë°•ìŠ¤ ìƒì„±
                sortedSectors.forEach((sectorName) => {
                    const sectorCap = totalCapBySector[sectorName];
                    const marketShare = totalMarketCap > 0 ? sectorCap / totalMarketCap : 0;
                    const stocks = finalStocksBySector[sectorName];
                    const avgChange = sectorPerformance[sectorName];
                    const sectorBorderClass = getSectorBorderColor(sectorName);
                    const bgColorClass = getCardGradient(avgChange);
                    
                    const hoverTitle = `ì‹œì´ ë¹„ì¤‘: ${(marketShare * 100).toFixed(1)}%`;
                    
                    proportionalHtml += `
                        <!-- Proportional Basket for ${sectorName} (w-full) -->
                        <div title="${hoverTitle}"
                            class="treemap-basket w-full p-2 border border-slate-300 dark:border-slate-700 ${bgColorClass} min-h-[120px] transition-all duration-300 rounded-lg shadow-inner">
                            
                            <!-- Sector Header -->
                            <div class="text-sm lg:text-base font-extrabold text-slate-800 dark:text-slate-200 mb-2 border-l-4 ${sectorBorderClass} pl-2 flex justify-between items-center">
                                <span><i class="fa-solid fa-layer-group mr-1 text-slate-500"></i> ${sectorName} (${stocks.length})</span>
                                <span class="text-xs font-bold ${getColor(avgChange)}">${avgChange > 0 ? 'â–²' : 'â–¼'}${avgChange.toFixed(2)}%</span>
                            </div>

                            <!-- Individual Stocks Proportional Flow Container (flex-wrapìœ¼ë¡œ ìë™ ë°°ì¹˜) -->
                            <div class="flex flex-wrap gap-1 w-full proportional-basket-stocks">
                    `;

                    // Render stocks inside this sector basket
                    stocks.sort((a, b) => b.cap - a.cap); 
                    
                    stocks.forEach(stock => {
                        // --- Calculate Card Width ---
                        let cardWidth = MIN_CARD_WIDTH_PX;
                        
                        if (CAP_RANGE > 0) {
                            // 1. ì‹œì´ì„ 0ê³¼ 1 ì‚¬ì´ë¡œ ì •ê·œí™” (ì „ì²´ ì‹œì¥ ê¸°ì¤€)
                            const normalizedCap = (stock.cap - global_min_cap) / CAP_RANGE;
                            // 2. ì •ê·œí™”ëœ ê°’ì— ë”°ë¼ 100pxì—ì„œ 400px ì‚¬ì´ë¡œ í¬ê¸° ì¡°ì •
                            cardWidth = MIN_CARD_WIDTH_PX + (normalizedCap * WIDTH_RANGE);
                            // 3. ì•ˆì „ ë²”ìœ„ ë³´ì¥
                            cardWidth = Math.min(MAX_CARD_WIDTH_PX, Math.max(MIN_CARD_WIDTH_PX, cardWidth));
                        }

                        const stockHtml = generateStockCardHtml(stock, sectorName);
                        
                        proportionalHtml += `
                            <!-- Stock Item Wrapper: Calculated Width, Fixed Height -->
                            <div style="width: ${cardWidth.toFixed(2)}px; height: ${FIXED_CARD_HEIGHT_PX}px; padding: 2px;" 
                                 class="flex-grow-0 flex-shrink-0 transition-all duration-300">
                                ${stockHtml}
                            </div>
                        `;
                    });
                    
                    proportionalHtml += `
                            </div>
                        </div>
                    `;
                });
                
                proportionalHtml += `</div>`; 
                mapContentHtml += proportionalHtml;
            }

            container.innerHTML = mapContentHtml;
        }


        // Mock Data í•¨ìˆ˜ ì´ë¦„ì„ getSimulatedStockDataë¡œ ë³€ê²½
        function getSimulatedStockData(symbol, name = '') {
            let basePrice = 1000; 
            let fixedChangePercent = 0; 
            
            // 1. ì£¼ì‹ ë°ì´í„° (FLAT_STOCK_MAP ì‚¬ìš©)
            const stock = FLAT_STOCK_MAP[symbol];

            if (stock) {
                // ì£¼ì‹ì˜ ê²½ìš° ë¯¸ë¦¬ ì„¤ì •ëœ Mock ë°ì´í„°ë¥¼ ì‚¬ìš©
                const fixedChangePercent = stock.change;
                const price = stock.price;
                const change = price * (fixedChangePercent / (100 + fixedChangePercent)); // ê¸ˆì•¡ ë³€í™”ë¥¼ ì—­ì‚°ìœ¼ë¡œ ì •í™•íˆ ê³„ì‚°
                
                return {
                    symbol: symbol,
                    name: stock.name,
                    price: price,
                    change: change,
                    change_percent: fixedChangePercent,
                    news: [],
                    dart_url: null,
                    is_mock: false
                };
            }
            
            // 2. ì§€ìˆ˜/í™˜ìœ¨ ë°ì´í„° (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            if (symbol === '^KS11') { basePrice = 2700; fixedChangePercent = 0.5; name = 'KOSPI'; }
            else if (symbol === '^KQ11') { basePrice = 880; fixedChangePercent = 1.2; name = 'KOSDAQ'; }
            else if (symbol === 'NQ=F') { basePrice = 18500; fixedChangePercent = -0.8; name = 'NASDAQ ì„ ë¬¼'; }
            else if (symbol === 'KRW=X') { basePrice = 1350; fixedChangePercent = -0.1; name = 'USD/KRW'; }
            else if (symbol === 'BTC-KRW') { basePrice = 95000000; fixedChangePercent = 3.5; name = 'Bitcoin'; }
            else if (symbol === 'XAG=X') { basePrice = 24.50; fixedChangePercent = 0.7; name = 'Silver'; } 
            else if(symbol === 'EUR=X') { basePrice = 1450; fixedChangePercent = 0.0; name = 'EUR/KRW'; } 
            else if(symbol === 'JPY=X') { basePrice = 9.50; fixedChangePercent = -0.5; name = 'JPY/KRW'; } 
            
            // ìµœì¢… ê°€ê²© ë° ë³€í™” ê³„ì‚°
            const price = basePrice * (1 + fixedChangePercent / 100);
            const change = price - basePrice;

            return {
                symbol: symbol,
                name: name,
                price: price,
                change: change,
                change_percent: fixedChangePercent,
                news: [],
                dart_url: null,
                is_mock: true // ì§€ìˆ˜/í™˜ìœ¨ì€ ì¼ë°˜ Mock
            };
        }
        function mockStock(sym) { return getSimulatedStockData(sym); }

        // ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ ê¸°ëŠ¥
        function manualRefresh() {
            const refreshButton = document.getElementById('btn-refresh');
            const refreshIcon = refreshButton.querySelector('i');

            refreshButton.disabled = true;
            refreshIcon.className = 'fa-solid fa-spinner fa-spin text-blue-600';
            refreshIcon.classList.remove('text-slate-500');

            fetchMarketData();

            setTimeout(() => {
                refreshButton.disabled = false;
                refreshIcon.className = 'fa-solid fa-arrows-rotate';
                refreshIcon.classList.remove('fa-spin');
                refreshIcon.classList.remove('text-blue-600');
                refreshIcon.classList.add('text-slate-500');
            }, 1000); 
        }
        
        // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•˜ì—¬ ìº”ë²„ìŠ¤ í¬ê¸° ì¬ì„¤ì •
        window.addEventListener('resize', () => {
             // í˜„ì¬ ì„ íƒëœ ì‹¬ë³¼ì˜ ë°ì´í„°ë¡œ ì°¨íŠ¸ë§Œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            if (currentSymbol) {
                const data = getSimulatedStockData(currentSymbol);
                drawStockChart(data.price, data.change_percent);
            }
            // ë§ˆì¼“ë§µ ë Œë”ë§ì„ ë‹¤ì‹œ ì‹¤í–‰í•˜ì—¬ ë ˆì´ì•„ì›ƒ ì¡°ì •
            renderMarketMap(currentFilterMode, currentSortBy);
        });


        // === ì´ˆê¸°í™” ===
        function init() {
            flattenStocks(); // ğŸ’¡ ì¶”ê°€: ë°ì´í„° í‰íƒ„í™” (ìµœìš°ì„ )
            initDarkMode();
            initApiKeyInput(); // ğŸ’¡ ìˆ˜ì •: API Key ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” (ë§Œë£Œ ì²´í¬ í¬í•¨)
            
            // 1. ì§€í‘œ ì¹´ë“œ ìƒì„±
            const idxBox = document.getElementById('indices-container');
            idxBox.innerHTML = INDICES.map(i => `
                <a href="${i.link}" target="_blank" class="bg-white p-3 rounded-xl border border-slate-200 dark:bg-slate-800 dark:border-slate-700 block transition-all duration-200 shadow-md hover:shadow-lg hover:ring-2 hover:ring-offset-2 hover:ring-blue-400" title="${i.name} ìƒì„¸ ë³´ê¸°">
                    <div class="text-xs text-slate-500 mb-1 dark:text-slate-400">${i.name}</div>
                    <div class="font-black text-xl dark:text-white" id="idx-p-${i.id}">-</div>
                    <div class="text-xs font-bold mt-1 index-change" id="change-${i.id}">-</div>
                </a>
            `).join('');

            // 2. í‰ë‹¨ê°€ ê³„ì‚°ê¸° ì´ˆê¸°í™”
            initAverageCalculator();

            // 3. ë§ˆì¼“ ë§µ ë Œë”ë§ (ì´ˆê¸°: KOSDAQ Top 60, ì‹œì´ ìˆœ)
            // KOSDAQ Top 60 í•„í„° ë²„íŠ¼ì„ ì´ˆê¸°í™” ì‹œ í™œì„±í™”
            currentFilterMode = 'KOSDAQ_TOP_60';
            renderMarketMap(currentFilterMode, currentSortBy); 

            // ì´ˆê¸° ë¡œë“œ (ì‚¼ì„±ì „ì)
            fetchAllData(); 
        }
        
        init();
    </script>
</body>
</html>